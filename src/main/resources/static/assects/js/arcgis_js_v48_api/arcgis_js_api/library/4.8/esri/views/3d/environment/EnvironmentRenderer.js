// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Accessor ../../../core/Handles ../../../core/watchUtils ../../../core/accessorSupport/decorators ./PanoramicAtmosphere ./RealisticAtmosphere ./SimpleAtmosphere ./Stars ../webgl-engine/lib/RenderSlot".split(" "),function(v,w,m,h,n,p,e,f,q,k,r,t,l){var u=[l.POSTPROCESSING_ATMOSPHERE_OPAQUE,l.POSTPROCESSING_ATMOSPHERE_TRANSPARENT];return function(g){function b(){var a=null!==g&&g.apply(this,
arguments)||this;a.needsRender=!1;a.didRender=!0;a._handles=new p;a._initContext=null;a._atmosphereReadyPromise=null;a._atmosphere=null;a._stars=null;return a}m(b,g);b.prototype.initialize=function(){this.view._stage.addExternalRenderer(u,this)};b.prototype.destroy=function(){this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=null);this._stars&&(this._stars.destroy(),this._stars=null);this._handles&&this._handles.removeAll();this.view&&(this.view._stage.removeExternalRenderer(this),this.view=
null)};b.prototype.initializeRenderContext=function(a){this._initContext=a;this.setup(a)};b.prototype.setup=function(a){var c=this;this._handles.add(e.when(this.view,"basemapTerrain",function(){return c._updateBasemapTerrain()}));this._handles.add([e.init(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],function(){return c._updateAtmosphere()}),e.init(this.view,"environment.starsEnabled",function(){return c._updateStars()})])};b.prototype.uninitializeRenderContext=
function(a){this._stars&&(this._stars.uninitializeRenderContext(a),this._stars.destroy(),this._stars=null);this._atmosphere&&(this._atmosphere.uninitializeRenderContext(a),this._atmosphere.destroy(),this._atmosphere=null)};b.prototype.render=function(a){var c=this.view.basemapTerrain;if(!(c&&c.loaded||"global"!==this.view.viewingMode))return!1;c=!0;this._stars&&(c=this._stars.render(a)&&c);this._atmosphere&&(c=this._atmosphere.render(a)&&c);return c};b.prototype._updateStars=function(){var a=this.view.get("environment.starsEnabled")||
!1;a&&!this._stars?(this._stars=new t(this.view),this._stars.initializeRenderContext(this._initContext),this.needsRender=!0):!a&&this._stars&&(this._stars.destroy(),this._stars=null,this.needsRender=!0)};b.prototype._updateAtmosphere=function(){var a=this,c=this._getAtmosphereType(this._initContext);if(this.atmosphereType!==c){this.atmosphereType=c;var b=null;switch(c){case "realistic":b=k;break;case "panoramic":b=q;break;case "simple":b=r}if(b){var d=new b(this.view);this._atmosphereReadyPromise&&
(this._atmosphereReadyPromise.cancel(),this._atmosphereReadyPromise=null);d.initializeRenderContext(this._initContext);null==this._atmosphere&&(this._atmosphere=d,this.needsRender=!0);this._atmosphereReadyPromise=d.when(function(){a._atmosphere!==d&&(a._atmosphere&&(a._atmosphere.destroy(),a._atmosphere=null),a._atmosphere=d);a._atmosphereReadyPromise=null;a.needsRender=!0;a._updateBasemapTerrain()})}else this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=null),this._updateBasemapTerrain()}};
b.prototype._getAtmosphereType=function(a){var b=this.view.get("environment.atmosphereEnabled"),e=this.view.get("environment.atmosphere.quality"),d=this.view.viewingMode;return b&&null!=e?"local"===d?"panoramic":"high"===e&&k.isSupported(a)?"realistic":"simple":"none"};b.prototype._updateBasemapTerrain=function(){var a=this.view.basemapTerrain;a&&(a.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)};h([f.property()],b.prototype,"view",void 0);return b=h([f.subclass("esri.views.3d.environment.EnvironmentRenderer")],
b)}(f.declared(n))});