// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../geometry ../../../../../core/Error ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../core/workers ../../../../../core/accessorSupport/decorators ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/support/FeatureProcessing ../../../../../tasks/support/QuantizationParameters ../../../../../tasks/support/Query ./BaseController ../../../tiling/TileInfoView ../../../tiling/TileQueue".split(" "),
function(m,n,t,k,p,u,v,w,q,x,g,r,y,z,A,B,C,D){Object.defineProperty(n,"__esModule",{value:!0});var E=w.getLogger("esri.views.2d.layers.features.controllers.MemoryController");m=function(l){function b(){var a=null!==l&&l.apply(this,arguments)||this;a.type="memory";a._processingInMainThread=!1;a._promises=new Map;return a}t(b,l);b.prototype.initialize=function(){var a=this;this._tileQueue=new D({tileInfoView:new C(this.tileStore.tileInfo),process:function(c){return a._fetchFeatureSet(c)}});this._memorySource=
x.open(this.service.source,{client:this});this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))};b.prototype.destroy=function(){this._promises.forEach(function(a){return a.cancel()});this._promises.clear()};Object.defineProperty(b.prototype,"processing",{get:function(){return y.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._promises.size},enumerable:!0,configurable:!0});b.prototype.setViewState=
function(a){};b.prototype.queryFeatures=function(a){return this._memorySource.invoke("queryFeatures",a)};b.prototype.queryFeatureCount=function(a){return this._memorySource.invoke("queryFeatureCount",a)};b.prototype.queryObjectIds=function(a){return this._memorySource.invoke("queryObjectIds",a)};b.prototype.queryExtent=function(a){return this._memorySource.invoke("queryExtent",a)};b.prototype.redraw=function(){};b.prototype.onTileUpdate=function(a){this._tileQueue.pause();for(var c=0,d=a.removed;c<
d.length;c++){var e=d[c],b=this._promises.get(e);b&&(b.cancel(),this._promises.delete(e),this.notifyChange("updating"))}c=0;for(a=a.added;c<a.length;c++)e=a[c],this._fetchTile(e);this._tileQueue.resume()};b.prototype._switchProcessor=function(a,c){this._tileQueue.pause();this._tileQueue.clear();a=0;for(c=this.tileStore.tiles;a<c.length;a++){var d=c[a];this._tileQueue.has(d.key.id)||this._fetchTile(d)}this._tileQueue.resume()};b.prototype._fetchTile=function(a){var c=this,d=this._tileQueue.push(a.key).then(function(e){c._cleanupPromise(a);
c.processor.onTileData(a,{addOrUpdate:e&&e.features})}).catch(function(e){c._cleanupPromise(a);"cancel"!==e.dojoType&&(c.processor.onTileError(a,e.message),E.error("query-error",{error:e}));return q.reject(e)});this._promises.set(a,d);this.notifyChange("updating")};b.prototype._fetchFeatureSet=function(a){var c=this,d=this.tileStore.findByKey(a);a=this._getQuantizationParameters(d);var e=this.processor.queryInfo,b=e.pixelBuffer*d.resolution,d=d.bounds.slice();d[0]-=b;d[1]-=b;d[2]+=b;d[3]+=b;return this._query(d,
e,a).then(function(a){var c=e.orderByFields;if(c){var c=c[0].split(" "),d=c[0];"DESC"===c[1]&&a.features.sort(function(a,c){return c.attributes[d]-a.attributes[d]})}return a}).then(function(a){return c._wrapPoints(a,e)}).then(function(a){return a.features.length?a:null})};b.prototype._query=function(a,c,d){var e=this;a=this._createQuery(a,d,c);return this.queryFeatures(a.toJSON()).then(function(a){return e._applyProcessing(a)})};b.prototype._createQuery=function(a,c,d){var e=new A;e.outFields=this.processor.queryInfo.outFields;
e.where=this.processor.queryInfo.definitionExpression||"1\x3d1";e.geometry=u.Extent.fromJSON({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.spatialReference});this.service.capabilities.query.supportsQuantization?(e.quantizationParameters=c,"esriGeometryPolyline"===this.service.geometryType&&(e.maxAllowableOffset=c.tolerance)):e.maxAllowableOffset=c.tolerance;e.resultType="tile";e.returnExceededLimitFeatures=!1;e.returnGeometry=!0;e.returnCentroid=d.returnCentroid;e.orderByFields=d.orderByFields;
return e};b.prototype._applyProcessing=function(a){var c=this.processing;if(!c)return a;if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:a});try{var d=c.process(a,c.options);return d?d:q.reject(new v("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(e){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:a})}};b.prototype._getQuantizationParameters=function(a){return z.default.fromJSON({mode:"view",
originPosition:"upperLeft",tolerance:a.resolution,extent:{xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}})};b.prototype._wrapPoints=function(a,c){if(0===a.features.length)return a;var d=c.returnCentroid;c=c.pixelBuffer;var e=a.geometryType,b=a.spatialReference,h=a.transform;if("esriGeometryPoint"!==e&&"esriGeometryMultipoint"!==e&&!d||!r.isWrappable(b))return a;d=a.features;b=r.getInfo(b);h=Math.round((b.valid[1]-b.valid[0])/h.scale[0]);
if(512===h){b=[];for(e=0;e<d.length;e++){var g=d[e],f=g.geometry,g=g.attributes;f&&(f.x<c?(f={geometry:p({},f),attributes:g},f.geometry.x+=h,b.push(f)):f.x>512-c&&(f={geometry:p({},f),attributes:g},f.geometry.x-=h,b.push(f)))}d.push.apply(d,b)}else for(b=0;b<d.length;b++)if(f=d[b].geometry)f.x<-c?f.x+=h:f.x>512+c&&(f.x-=h);return a};b.prototype._cleanupPromise=function(a){this._promises.delete(a);this.notifyChange("updating")};k([g.property()],b.prototype,"configuration",void 0);k([g.property({readOnly:!0,
dependsOn:["configuration"]})],b.prototype,"processing",null);k([g.property()],b.prototype,"updating",null);return b=k([g.subclass()],b)}(g.declared(B.default));n.default=m});