// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper @dojo/shim/Map ../../../../../core/Logger ../../../../../core/libs/gl-matrix/mat2d ../../../../../core/libs/gl-matrix/vec2 ../definitions ./CollisionBucket ../util/iterator ../../../../2d/tiling/TileKey ../../../../3d/support/mathUtils ../../../../vectorTiles/GeometryUtils".split(" "),function(v,C,K,D,F,w,z,x,G,E,p,r,H){Object.defineProperty(C,"__esModule",{value:!0});var I=F.getLogger("esri/views/2d/engine/webgl/collisions/CollisionEngine"),
A=x.TILE_SIZE/x.COLLISION_BUCKET_SIZE;v=function(){function d(a){this._layers=new D.default;this._collisionBuckets=new D.default;this._v3Buf1=z.create();this._v3Buf2=z.create();this._mat2dBuf=w.create();this._tileInfo=a}d.prototype.registerLayer=function(a,b){if(a&&!this._layers.has(a.uid)){var c=this._createInfo(b,a.labelingInfo);this._layers.set(a.uid,c);this._collisionBuckets.forEach(function(a){return a.onRegisterLayer(c.index)})}};d.prototype.unregisterLayer=function(a){var b=this;if(a&&this._layers.has(a.uid)){var c=
this._layers.get(a.uid);this._deleteInfo(c);this._layers.delete(a.uid);this._collisionBuckets.forEach(function(a,e){var h=a.getTile(c.index);h&&(h.dirty=!1,a.onUnregisterLayer(c.index),a.canDelete()&&b._collisionBuckets.delete(e))})}};d.prototype.addTile=function(a,b){var c=b.key.id;this._layers.has(a)&&(this._collisionBuckets.has(c)||this._collisionBuckets.set(c,new G.default(this._layers.size)),this._collisionBuckets.get(c).getTile(this._getIndex(a)).reference=b)};d.prototype.removeTile=function(a,
b){this._layers.has(a)&&this._collisionBuckets.has(b)&&(this._collisionBuckets.get(b).getTile(this._getIndex(a)).reference=null)};d.prototype.run=function(a,b){var c=[],g=p.pool.acquire(0,0,0,0);E.forEachIter(this._collisionBuckets.keys(),function(a){g.set(a);g.level===b&&c.push(a)});p.pool.release(g);for(var c=p.sort(c),e=a.state.rotation,h=this._checkRotation(e),f=0,m=c;f<m.length;f++){var k=m[f];this._computeNeighbors(k)}for(var m=0,d=c;m<d.length;m++)for(k=d[m],h=h||this._collisionBuckets.get(k).isDirty,
f=0;f<this._layers.size;f++){var n=this._getCollisionInfo(f);this._resetCollisionBucket(n,k,a,h)}a=0;for(h=c;a<h.length;a++)for(k=h[a],f=0;f<this._layers.size;f++)m=this._getCollisionInfo(f).zoomRanges,this._runCollisionBucket(f,k,b,!!e,m);e=0;for(f=c;e<f.length;e++)k=f[e],this._cleanCollisionBucket(k)};d.prototype._computeNeighbors=function(a){var b=this._collisionBuckets.get(a);a=p.from(a);b.neighbors=[this._getNeighboringBucket(a,-1,-1),this._getNeighboringBucket(a,0,-1),this._getNeighboringBucket(a,
1,-1),this._getNeighboringBucket(a,-1,0),b,this._getNeighboringBucket(a,1,0),this._getNeighboringBucket(a,-1,1),this._getNeighboringBucket(a,0,1),this._getNeighboringBucket(a,1,1)]};d.prototype._getNeighboringBucket=function(a,b,c){a=p.getId(a.level,a.row+c,a.col+b,a.world);return this._collisionBuckets.has(a)?this._collisionBuckets.get(a):null};d.prototype._checkRotation=function(a){if(!this._lastRotation)return this._lastRotation=a,!1;var b=a!==this._lastRotation;this._lastRotation=a;return b};
d.prototype._collectCollisionInfos=function(){var a=[];E.forEachIter(this._layers.values(),function(b){return a.push(b)});return a};d.prototype._createInfo=function(a,b){for(var c=this,g=this._collectCollisionInfos().sort(function(a,b){return a.order-b.order}),e=!1,h=-1,f=0;f<g.length;f++){var d=g[f];!e&&d.order>a&&(h=d.index,e=!0);e&&d.index++}e||(h=g.length);b=b.map(function(a){return c._convertLabelClass(a)});return{index:h,order:a,zoomRanges:b}};d.prototype._convertLabelClass=function(a){var b=
!!a.maxScale,c=!!a.minScale&&this._tileInfo.scaleToZoom(a.minScale)||0;a=b&&this._tileInfo.scaleToZoom(a.maxScale)||255;return{minZoom:Math.floor(10*c),maxZoom:Math.floor(10*a)}};d.prototype._deleteInfo=function(a){a=a.order;for(var b=!1,c=0,g=this._collectCollisionInfos().sort(function(a,b){return a.order-b.order});c<g.length;c++){var e=g[c];e.order>a&&(b=!0);b&&e.index--}};d.prototype._resetCollisionBucket=function(a,b,c,g){a=this._collisionBuckets.get(b).getTile(a.index);if(!a)return!1;a=a.reference;
if(!a)return!1;b=this._v3Buf1;var e=this._mat2dBuf;c=c.state;c.toScreen(b,a.coords);a.tileTransform.screenCoord[0]=b[0];a.tileTransform.screenCoord[1]=b[1];w.identity(e);w.rotate(e,e,c.rotation*H.C_DEG_TO_RAD);a.tileTransform.screenTransform.set(e);g&&(a.isDirty=!0);if(!a.isDirty)return!1;g=0;for(c=a.displayObjects;g<c.length;g++)for(a=0,b=c[g].metrics;a<b.length;a++)b[a].maxZoom=0;return!0};d.prototype._runCollisionBucket=function(a,b,c,g,e){b=this._collisionBuckets.get(b);var h=b.getTile(a);if(h){var f=
h.reference;if(f&&f.isDirty)for(var d=0;d<f.displayObjects.length;d++)for(var k=f.displayObjects[d],B=k.id,n=0;n<k.metrics.length;n++){var l=k.metrics[n],y=e[l.index],J=this._computeLabelVisibility(a,d,n,B,b,h,k,k.anchor,l,c,f,g,y);l.minZoom=J;l.maxZoom=y.maxZoom;f.setVisibilityRange(B,n,l.minZoom,l.maxZoom)}}};d.prototype._cleanCollisionBucket=function(a){this._collisionBuckets.get(a).clean()};d.prototype._computeLabelVisibility=function(a,b,c,d,e,h,f,m,k,B,n,l,y){b=y.minZoom;c=n.tileTransform.screenTransform;
c=l?z.transformMat2d(this._v3Buf1,m,c):m;h=k.bounds.center;var g=n.tileTransform.screenCoord;m=c[0]+h[0]+g[0];c=c[1]+h[1]+g[1];h=f.xBucket;var t=f.yBucket,g=f.xOverflow,q=f.yOverflow;f=h-g;h=h+g+1;g=t+q+1;for(t-=q;t<g;t++)for(q=f;q<h;q++)if(!(q<-A||t<-A||q>A||t>A))for(var p=0;p<=a;p++){var w=a===p,u=this._getRelativeSubBucket(p,e,n,q,t);if(u)for(var x=u.neighborTile,r=0,u=u.bucket;r<u.length;r++){var v=u[r];w&&v.id===d||(b=Math.max(this._compareLabelToDisplayObject(d,k,m,c,v,B,x,l,y),b))}}return b};
d.prototype._getRelativeSubBucket=function(a,b,c,d,e){var g=r.sign(Math.floor(d/4)),f=r.sign(Math.floor(e/4));return(a=this._getNeighboringTile(a,b,c,g,f))&&a.index?{bucket:a.index[e-4*f][d-4*g],neighborTile:a.reference}:null};d.prototype._getNeighboringTile=function(a,b,c,d,e){return(a=(b=b.neighbors[3*(1+e)+(1+d)])&&b.getTile(a))&&a.reference&&a.reference.hasData?a:null};d.prototype._compareLabelToDisplayObject=function(a,b,c,d,e,h,f,m,k){a=k.minZoom;k=10*(h+x.COLLISION_MAX_ZOOM_DELTA);var g=f.tileTransform.screenTransform;
m=m?z.transformMat2d(this._v3Buf2,e.anchor,g):e.anchor;g=0;for(e=e.metrics;g<e.length;g++){var n=e[g];if(n.maxZoom&&!(n.minZoom>k||a>=n.maxZoom)){var l=n.bounds.center,p=f.tileTransform.screenCoord,l=this._updateMinZoom(c,d,b.bounds,m[0]+l[0]+p[0],m[1]+l[1]+p[1],n.bounds),l=Math.min(Math.max(Math.ceil(10*(l+h)),0),255);if(!(n.minZoom>=l)){if(255<=l){a=255;break}a=Math.max(a,l)}}}return a};d.prototype._updateMinZoom=function(a,b,c,d,e,h){return r.log2(Math.min((h.width+c.width)/2/Math.abs(d-a),(h.height+
c.height)/2/Math.abs(e-b)))};d.prototype.onLabelsRendered=function(){this._collisionBuckets.forEach(function(a){a.onLabelsRendered()})};d.prototype._getIndex=function(a){return this._layers.get(a).index};d.prototype._getCollisionInfo=function(a){for(var b=0,c=this._collectCollisionInfos();b<c.length;b++){var d=c[b];if(d.index===a)return d}I.error("Tried to get a LayerCollisionInfo for an index that doesn't exist!");return null};return d}();C.default=v});