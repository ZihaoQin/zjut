// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/Accessor ../../../core/Collection ../../../core/Error ../../../core/Promise ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../tasks/QueryTask ../../../tasks/support/StatisticDefinition".split(" "),function(h,v,l,e,m,n,p,q,r,k,b,t,u){var f;(function(b){b[b.Snapshot=0]="Snapshot";b[b.OnDemand=1]="OnDemand"})(f||(f={}));return function(g){function a(){var d=
null!==g&&g.apply(this,arguments)||this;d.maxPointCountForAuto=4E3;d.maxRecordCountForAuto=2E3;d.maxVertexCountForAuto=25E4;return d}l(a,g);a.prototype.initialize=function(){var d=this,a=this.layer.when(function(){d._verifyCapabilities()}).then(function(){return d._figureOutMode().then(function(a){return d._createController(a)})}).then(function(a){return d._set("activeController",a)});this.addResolvingPromise(a)};a.prototype.destroy=function(){this.activeController&&(this.activeController.destroy(),
this._set("activeController",null))};Object.defineProperty(a.prototype,"countThresholdForAuto",{get:function(){var a=this.layer.geometryType,c;"polyline"===a||"polygon"===a||"multipoint"===a?c=this.maxRecordCountForAuto:"point"===a&&(c=this.maxPointCountForAuto);return c},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return!1===this.isFulfilled()||!0===this.get("activeController.updating")},enumerable:!0,configurable:!0});a.prototype._figureOutMode=function(){return this._isStatisticsSupported()?
this._checkByStatistics():this._checkByCount()};a.prototype._isStatisticsSupported=function(){return this.layer.source.parsedUrl?/(https?:)?\/\/services.*\.arcgis\.com/i.test(this.layer.source.parsedUrl.path):!1};a.prototype._checkByStatistics=function(){var a=this,c=this.layer,b=c.source.parsedUrl.path,c=c.createQuery();c.outStatistics=[new u({statisticType:"exceedslimit",maxPointCount:this.maxPointCountForAuto,maxRecordCount:this.maxRecordCountForAuto,maxVertexCount:this.maxVertexCountForAuto,outStatisticFieldName:"exceedslimit"})];
return(new t({url:b+"/query"})).execute(c).then(function(b){b=b&&b.features&&b.features[0];if(0===(b&&b.attributes&&b.attributes.exceedslimit)){b=a.layer;var c=b.maxRecordCount;if(b.get("capabilities.query.supportsPagination")||c>=a.countThresholdForAuto)return f.Snapshot}return f.OnDemand})};a.prototype._checkByCount=function(){var a=this,b=this.layer;return b.queryFeatureCount().then(function(c){return c<=a.countThresholdForAuto&&c<=b.maxRecordCount?f.Snapshot:f.OnDemand})};a.prototype._createController=
function(a){var b=this;return(a===f.OnDemand?k.create(function(a){return h(["./OnDemandController2D"],a)}):k.create(function(a){return h(["./SnapshotController"],a)})).then(function(a){return new a({layer:b.layer,layerView:b.layerView,graphics:b.graphics})}).catch(function(b){throw Error("Module path not found for controller type: "+(a===f.Snapshot?"snapshot":"on demand"));})};a.prototype._verifyCapabilities=function(){if(!this.layer.get("capabilities.operations.supportsQuery"))throw new q("graphicscontroller:query-capability-required",
"Service requires query capabilities to be used as a feature layer",{layer:this.layer});};e([b.property()],a.prototype,"activeController",void 0);e([b.property({dependsOn:["layer.geometryType"]})],a.prototype,"countThresholdForAuto",null);e([b.property({type:p.ofType(m)})],a.prototype,"graphics",void 0);e([b.property()],a.prototype,"layer",void 0);e([b.property()],a.prototype,"layerView",void 0);e([b.property({dependsOn:["activeController.updating"]})],a.prototype,"updating",null);e([b.aliasOf("activeController.update")],
a.prototype,"update",void 0);return a=e([b.subclass("esri.layers.graphics.controllers.AutoController2D")],a)}(b.declared(n,r))});