// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/arrayUtils ./ModelContentType ./Texture ./Util ../../../webgl/Texture".split(" "),function(r,t,m,g,n,p,q){return function(){function c(a,b){this.dirty=!1;this.elementsToAdd={};this.elementsToRemove={};this.elementsToRender={};this.elements={};this.stageObjects={};this.id=n.idGen.gen(a);this.stage=b._stage;this.controller=b.resourceController;this.canvas=this.create2DCanvas();this.ctx=this.canvas.getContext("2d");this.stage.add(g.TEXTURE,this);a=this.computeAtlasResolution(b.width,
b.height);this.createAtlasRegion(a);this.update2DCanvasSize()}c.prototype.setUnloadFunc=function(a){this.unloadFunc=a};c.prototype.unload=function(){null!=this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=null)};c.prototype.deferredLoading=function(){return!1};c.prototype.getWidth=function(){return this.atlas.size.width};c.prototype.getHeight=function(){return this.atlas.size.height};c.prototype.initializeThroughRender=function(a,b){b.wrapMode=33071;b.samplingMode=9987;b.flipped=!0;b.preMultiplyAlpha=
!0;b.hasMipmap=!0;return this.glTexture=new q(a,b,this.canvas)};c.prototype.dispose=function(){this.elementsToRender=this.elementsToRemove=this.elementsToAdd=this.elements=null;this.glTexture&&(this.glTexture=null,this.stage.remove(g.TEXTURE,this.id))};c.prototype.create2DCanvas=function(){var a=document.createElement("canvas");a.setAttribute("id","canvas2d");a.setAttribute("style","display:none");a.setAttribute("width",(512).toString());a.setAttribute("height",(512).toString());return a};c.prototype.update2DCanvasSize=
function(){this.canvas.setAttribute("width",this.atlas.size.width.toString());this.canvas.setAttribute("height",this.atlas.size.height.toString())};c.prototype.generateTextId=function(a){return JSON.stringify(a.getParams())+"_"+a.getText()};c.prototype.createAtlasRegion=function(a){void 0===a&&(a=512);this.atlas={size:{width:a,height:a},cursor:{x:0,y:0},lineHeight:0}};c.prototype.computeAtlasResolution=function(a,b){a=Math.max(a,b);a=p.nextHighestPowerOfTwo(a+256);return a=Math.min(a,4096)};c.prototype.resizeAtlas=
function(a,b){b=b||a;var d=this.atlas;d.size.width=a;d.size.height=b;this.glTexture&&this.glTexture.resize(a,b);this.update2DCanvasSize()};c.prototype.resetAtlasCursor=function(){var a=this.atlas;a.cursor.x=0;a.cursor.y=0;a.lineHeight=0};c.prototype.getAtlasUsage=function(){var a=this.atlas;return(a.cursor.x+a.cursor.y*a.size.width)/(a.size.width*a.size.height)};c.prototype.getExpectedAtlasUsage=function(){var a=Object.keys(this.elementsToRemove).length,b=Object.keys(this.elementsToAdd).length,d=
Object.keys(this.elements).length;return this.getAtlasUsage()/d*(d+b-a)};c.prototype.addAtlasElement=function(a,b,d,c,f){var e=this.atlas;a.placement.offset.x=e.cursor.x;a.placement.offset.y=e.cursor.y;a.placement.size.width=b;a.placement.size.height=d;a.placement.uvMinMax=[a.placement.offset.x/e.size.width,1-(a.placement.offset.y+d)/e.size.height,(a.placement.offset.x+b)/e.size.width,1-a.placement.offset.y/e.size.height];e.cursor.x+=c;e.lineHeight=Math.max(e.lineHeight,f)};c.prototype.removeAtlasElement=
function(a){if(a&&this.elements[a.textId]){var b=a.placement.offset,d=a.placement.size;this.ctx.clearRect(b.x,b.y,d.width,d.height);delete this.elements[a.textId]}};c.prototype.addStageObject=function(a,b){this.stageObjects[a]||(this.stageObjects[a]=[]);-1===this.stageObjects[a].indexOf(b)&&this.stageObjects[a].push(b)};c.prototype.removeStageObject=function(a,b){this.stageObjects[a]&&m.removeUnordered(this.stageObjects[a],b)&&(b.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),
b.geometryVertexAttrsUpdated(0))};c.prototype.processAdditionRequest=function(a){var b=this.atlas,d=a.textId,c=a.textTexture.renderedWidth,f=a.textTexture.renderedHeight,e=c+2,h=f+2+2;if(b.cursor.x+e<b.size.width&&b.cursor.y+h<b.size.height)this.addAtlasElement(a,c,f,e,h),this.elements[d]=a,this.elementsToRender[d]=a,delete this.elementsToAdd[d];else if(b.cursor.y+h+b.lineHeight<b.size.height)b.cursor.x=2,b.cursor.y+=b.lineHeight,b.lineHeight=0,this.addAtlasElement(a,c,f,e,h),this.elements[d]=a,this.elementsToRender[d]=
a,delete this.elementsToAdd[d];else{a=this.getExpectedAtlasUsage();.85<a&&4096>b.size.width&&this.resizeAtlas(2*b.size.width,2*b.size.height);for(var k in this.elementsToRemove)0===this.stageObjects[k].length&&this.removeAtlasElement(this.elementsToRemove[k]),delete this.elementsToRemove[k];if(!(.95<a&&4096===b.size.width)){for(var l in this.elements)b=this.elements[l],b.rendered=!1,this.elementsToAdd[l]=b,delete this.elements[l];this.resetAtlasCursor();this.elementsToRender={}}}};c.prototype.processRenderingRequest=
function(a){var b=a.textId;this.ctx.clearRect(a.placement.offset.x,a.placement.offset.y,a.placement.size.width,a.placement.size.height);a.textTexture.renderText(a.placement.size.width,a.placement.size.height,this.ctx,a.placement.offset.x,a.placement.offset.y);for(var d=0,b=this.stageObjects[b];d<b.length;d++){var c=b[d];c.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(a.placement.uvMinMax);c.geometries[0].data.vertexAttributes.size.data=new Float32Array([a.placement.size.width,a.placement.size.height]);
c.geometryVertexAttrsUpdated(0)}a.rendered=!0};c.prototype.run=function(a){if(this.dirty){for(var b in this.elementsToAdd)if(this.elements[b]&&this.elements[b].rendered){for(var c=0,g=this.stageObjects[b];c<g.length;c++){var f=g[c],e=f.geometries[0].data.vertexAttributes;e.uv0.data=new Float32Array(this.elements[b].placement.uvMinMax);e.size.data=new Float32Array([this.elements[b].placement.size.width,this.elements[b].placement.size.height]);f.geometryVertexAttrsUpdated(0)}delete this.elementsToAdd[b]}else this.processAdditionRequest(this.elementsToAdd[b]);
c=!1;for(b in this.elementsToRender){if(!a.remaining()){c&&this.glTexture.setData(this.canvas);return}this.processRenderingRequest(this.elementsToRender[b]);delete this.elementsToRender[b];c=!0}c&&this.glTexture.setData(this.canvas);this.dirty=!1;this.frameWorker.remove();this.frameWorker=null}};c.prototype.addTextTexture=function(a,b){var c=this.generateTextId(a);this.elementsToAdd[c]||(this.elementsToAdd[c]={textId:c,placement:{offset:{x:0,y:0},size:{width:0,height:0},uvMinMax:[]},textTexture:a,
rendered:!1});this.addStageObject(c,b);delete this.elementsToRemove[c];this.setDirty()};c.prototype.removeTextTexture=function(a,b){a=this.generateTextId(a);this.elementsToRemove[a]=this.elements[a];this.removeStageObject(a,b);delete this.elementsToAdd[a]};Object.defineProperty(c.prototype,"textureId",{get:function(){return this.id},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"isDirty",{get:function(){return this.dirty},enumerable:!0,configurable:!0});c.prototype.setDirty=function(){var a=
this;this.dirty||(this.dirty=!0,this.frameWorker=this.controller.registerFrameWorker(function(b){return a.run(b)}))};return c}()});