// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../geometry ../../../../Graphic ../../../../core/Accessor ../../../../core/Handles ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../layers/GraphicsLayer ../../../../symbols/SimpleMarkerSymbol ./drawUtils ./GraphicMover".split(" "),function(E,F,q,f,h,r,t,u,p,e,v,g,w,x){var y=function(){return function(d,b){this.graphic=d;this.targetGraphic=b;
this.type="reshape-start"}}(),z=function(){return function(d,b){this.graphic=d;this.targetGraphic=b;this.type="reshape"}}(),A=function(){return function(d,b){this.graphic=d;this.targetGraphic=b;this.type="reshape-stop"}}(),B=function(){return function(d,b,a){this.graphic=d;this.dx=b;this.dy=a;this.type="move-start"}}(),C=function(){return function(d,b,a){this.graphic=d;this.dx=b;this.dy=a;this.type="move"}}(),D=function(){return function(d,b,a){this.graphic=d;this.dx=b;this.dy=a;this.type="move-stop"}}();
return function(d){function b(a){a=d.call(this,a)||this;a._handleSymbol=new g({type:"simple-marker",style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}});a._handleHoverSymbol=new g({type:"simple-marker",style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}});a._handleSelectionSymbol=new g({type:"simple-marker",style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}});a._handles=new u;a._mover=null;a._selectedGraphics=[];a.callbacks=
{onReshapeStart:function(a){},onReshape:function(a){},onReshapeStop:function(a){},onMoveStart:function(a){},onMove:function(a){},onMoveStop:function(a){}};a.graphic=null;a.handleGraphics=[];a.layer=new v({listMode:"hide"});a.view=null;return a}q(b,d);b.prototype.initialize=function(){var a=this;this.graphic&&(this._setUpGraphics(),this._setUpMover());this._handles.add([p.whenOnce(this,"view.ready",function(){a.view&&a.view.map&&a.view.map.add(a.layer)}),p.pausable(this,"graphic",function(){a.refresh()})])};
b.prototype.destroy=function(){this._reset();this._handles.removeAll();this._handles=null;this.view&&this.view.map&&this.view.map.remove(this.layer);this.layer.destroy();this._set("layer",null)};b.prototype.refresh=function(){this._reset();this.graphic&&(this._setUpGraphics(),this._setUpMover())};b.prototype._reset=function(){this._selectedGraphics=[];this.layer&&this.layer.removeMany(this.handleGraphics);this.handleGraphics=[];this.view.container.style.cursor="default";this._mover&&this._mover.destroy();
this._mover=null};b.prototype._setUpGraphics=function(){this.handleGraphics=this._createHandleGraphics(this.graphic.geometry);this.layer.addMany(this.handleGraphics)};b.prototype._createHandleGraphics=function(a){var b=this,d=[];this._getVertices(a).forEach(function(a,m){a.forEach(function(a,c){d.push(new r({geometry:new h.Point({x:a[0],y:a[1],spatialReference:b.view.spatialReference}),symbol:b._handleSymbol,attributes:{pathIndex:m,pointIndex:c,handleIndex:d.length}}))})});d.forEach(function(a,b){var c=
[],m=a.geometry;d.forEach(function(a,d){b!==d&&(a=a.geometry,m.x===a.x&&m.y===a.y&&c.push(d))});a.attributes.relatedGraphicIndices=c});return d};b.prototype._clearSelection=function(){var a=this;this._selectedGraphics.forEach(function(b){b.set("symbol",a._handleSymbol)});this._selectedGraphics=[]};b.prototype._setUpMover=function(){var a=this,b=this.graphic.geometry,d=this.handleGraphics.concat(this.graphic);this._mover=new x({graphics:d,view:this.view,callbacks:{onGraphicClick:function(b){var c=
b.graphic;c!==a.graphic&&(b.viewEvent.native.shiftKey||a._clearSelection(),-1===a._selectedGraphics.indexOf(c)?(a._selectedGraphics.push(c),c.set("symbol",a._handleSelectionSymbol)):(b=a._selectedGraphics.indexOf(c),a._selectedGraphics.splice(b,1),c.set("symbol",a._handleHoverSymbol)))},onGraphicMoveStart:function(b){var c=b.graphic;c===a.graphic?(a._clearSelection(),a.callbacks.onMoveStart(new B(a.graphic,b.dx,b.dy))):-1===a._selectedGraphics.indexOf(c)&&(a._clearSelection(),a._selectedGraphics.push(c),
c.set("symbol",a._handleSelectionSymbol),a.callbacks.onReshapeStart(new y(a.graphic,c)))},onGraphicMove:function(c){var d=c.graphic;if(d===a.graphic){var k=a._getVertices(a.graphic.geometry);a.handleGraphics.forEach(function(b,c){c=b.attributes;c=k[c.pathIndex][c.pointIndex];b.set("geometry",new h.Point(c[0],c[1],a.view.spatialReference))});a.callbacks.onMove(new C(a.graphic,c.dx,c.dy))}else{var e=d.attributes,f=d.geometry,g=f.x,n=f.y,f=e.relatedGraphicIndices,l=a._getVertices(a.graphic.geometry);
l[e.pathIndex][e.pointIndex]=[g,n];f.forEach(function(b){b=a.handleGraphics[b];var c=b.attributes;l[c.pathIndex][c.pointIndex]=[g,n];b.set("geometry",new h.Point(g,n,a.view.spatialReference))});1<a._selectedGraphics.length&&a._selectedGraphics.forEach(function(b,e){if(b!==d){e=b.attributes;var k=w.move(b.geometry,c.dx,c.dy,a.view),f=k.x,g=k.y;b.set("geometry",k);l[e.pathIndex][e.pointIndex]=[f,g]}});e=null;e="polyline"===b.type?new h.Polyline({paths:l,spatialReference:a.view.spatialReference}):new h.Polygon({rings:l,
spatialReference:a.view.spatialReference});a.graphic.set("geometry",e);a.callbacks.onReshape(new z(a.graphic,d))}},onGraphicMoveStop:function(b){if(b.graphic===a.graphic)a.callbacks.onMoveStop(new D(a.graphic,b.dx,b.dy));else a.callbacks.onReshapeStop(new A(a.graphic,b.graphic))},onGraphicPointerOver:function(b){b=b.graphic;"pointer"!==a.view.container.style.cursor&&(a.view.container.style.cursor="pointer");if(b!==a.graphic){var c=-1<a._selectedGraphics.indexOf(b)?a._handleSelectionSymbol:a._handleHoverSymbol;
b.set("symbol",c)}},onGraphicPointerOut:function(b){b=b.graphic;"default"!==a.view.container.style.cursor&&(a.view.container.style.cursor="default");b!==a.graphic&&(-1<a._selectedGraphics.indexOf(b)||b.set("symbol",a._handleSymbol))}}})};b.prototype._getVertices=function(a){if("polyline"===a.type)return a.paths.map(function(a){return Array.apply([],a)});a=a.rings.map(function(a){return Array.apply([],a)});a.forEach(function(a){a[0][0]===a[a.length-1][0]&&a[0][1]===a[a.length-1][1]&&a.pop()});return a};
f([e.property()],b.prototype,"callbacks",void 0);f([e.property()],b.prototype,"graphic",void 0);f([e.property()],b.prototype,"handleGraphics",void 0);f([e.property({readOnly:!0})],b.prototype,"layer",void 0);f([e.property()],b.prototype,"view",void 0);return b=f([e.subclass("esri.views.2d.draw.support.Reshape")],b)}(e.declared(t))});