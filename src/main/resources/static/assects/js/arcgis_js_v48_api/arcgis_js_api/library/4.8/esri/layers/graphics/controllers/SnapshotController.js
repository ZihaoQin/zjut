// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper ../../../core/Accessor ../../../core/Error ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/Promise ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../geometry/support/scaleUtils ../../support/GraphicsManager ../../../views/3d/layers/graphics/Graphics3DVerticalScale".split(" "),function(x,y,n,d,z,p,
g,q,r,t,u,h,c,k,v,w){var l=t.getLogger("esri.layers.graphics.controllers.SnapshotController");return function(m){function a(b){b=m.call(this)||this;b.type="snapshot";b._gManager=null;b._verticalScale=null;b._handles=new r;b._source=null;b._started=!1;b._pendingQueries=new Map;b.extent=null;b.hasAllFeatures=!1;b.hasFeatures=!1;b.layer=null;b.layerView=null;b.maxPageSize=null;b.defaultReturnZ=void 0;b.defaultReturnM=void 0;b.pageSize=null;b.paginationEnabled=!1;return b}n(a,m);a.prototype.initialize=
function(){var b=this,e=this.layer.when(function(){return b._verifyCapabilities()}).then(function(){return b._init()});this.addResolvingPromise(e)};a.prototype.destroy=function(){this.cancelQuery();this._gManager&&(this._gManager.destroy(),this._gManager=null);this._handles.destroy();this._pendingQueries=this._handles=null};Object.defineProperty(a.prototype,"updating",{get:function(){return!!(this._pendingQueries&&0<this._pendingQueries.size)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"graphics",{set:function(b){var e=this._get("graphics");e!==b&&(this._handles.remove("graphics"),b&&(this._collectionChanged({added:b.toArray(),removed:e&&e.toArray()}),this._handles.add(b.on("change",this._collectionChanged.bind(this)),"graphics")),this._set("graphics",b))},enumerable:!0,configurable:!0});a.prototype.cancelQuery=function(){var b=this;this._pendingQueries&&(this._pendingQueries.forEach(function(e,f){e.isFulfilled()||e.cancel(Error(b._cancelErrorMsg))}),this._pendingQueries.clear(),
this.notifyChange("updating"))};a.prototype.refresh=function(){this.isResolved()&&this._started&&this._queryFeatures()};a.prototype.startup=function(){this._started||(this._started=!0,this._resolutionParams=this._getResolutionParams(),this._queryFeatures())};a.prototype.update=function(){this.startup()};a.prototype._init=function(){var b=this.layer;this.paginationEnabled=!!b.get("capabilities.query.supportsPagination");this._source=b.source;var e=b.maxRecordCount||4E3;this.pageSize=null==this.maxPageSize?
e:Math.min(e,this.maxPageSize);this._gManager=new v({graphics:this.graphics,objectIdField:b.objectIdField});this._verticalScale=new w({sourceSpatialReference:b.spatialReference,destSpatialReference:this.layerView.view.spatialReference});this._setupStateWatchers()};a.prototype._getResolutionParams=function(){var b=this.layer,e=b.get("capabilities.query.supportsQuantization"),f;if("polyline"===b.geometryType||"polygon"===b.geometryType){var a=k.getMetersPerUnit(this.layerView.view.spatialReference);
null!=a&&(f=this._featureResolution.scale,a=this._featureResolution.value/a,f=b.maxScale?b.maxScale:b.minScale?Math.min(f,b.minScale):Math.min(f,k.getScale(this.layerView.view,b.fullExtent)),f*=a/this._featureResolution.scale)}return f?{maxAllowableOffset:e?null:f,quantizationParameters:e?{mode:"view",originPosition:"upperLeft",tolerance:f,extent:b.fullExtent}:null}:null};a.prototype._setupStateWatchers=function(){var b=this;this._handles.add([this.watch("extent",this.refresh.bind(this)),this.layer.watch("outFields",
function(e,a){e&&a?-1===a.indexOf("*")&&(e.sort(),a.sort(),JSON.stringify(e)!==JSON.stringify(a)&&b.refresh()):b.refresh()}),this.layer.watch("definitionExpression, historicMoment",this.refresh.bind(this)),this.layer.on("edits",this._editsHandler.bind(this))])};a.prototype._createQueryParams=function(){var b=this.layer,e=this.layerView,a=b.createQuery();a.outSpatialReference=e.view.spatialReference;a.geometry=this.extent;(b=b.capabilities&&b.capabilities.data)&&b.supportsZ&&null==a.returnZ&&null!=
this.defaultReturnZ&&(a.returnZ=this.defaultReturnZ);b&&b.supportsM&&null==a.returnM&&null!=this.defaultReturnM&&(a.returnM=this.defaultReturnM);a.set(this._resolutionParams);this.paginationEnabled&&(a.start=0,a.num=this.pageSize);return a};a.prototype._queryFeatures=function(){this.cancelQuery();this.hasAllFeatures=this.hasFeatures=!1;this._gManager.beginPagedUpdate();this.emit("query-start");this._executeQuery(this._createQueryParams())};a.prototype._executeQuery=function(b){var a=this,f=this._source.queryFeatures(b),
c=this._gManager.createIntentToAdd();this._querySetup(c,f);f.then(this._processFeatureSet.bind(this,b,c)).catch(function(b){return a._queryError(c,b)}).always(function(){return a._queryTeardown(c)})};a.prototype._processFeatureSet=function(b,a,f){var e=f.exceededTransferLimit,c=f.features,d=this._maxFeatures[this.layer.geometryType]||0,g=c?c.length:0,h=this._gManager.numGraphics+g,k=h>=d;k&&(l.warn('Feature limit exceeded on layer "',this.layer.title,'". Not all features are shown.'),(d=h-d)&&c.splice(g-
d,d));b=e&&this.paginationEnabled&&!k?this._queryNextPage(b):!1;this._verticalScale.adjust(c);c&&this._gManager.addPage(c,a);this.hasFeatures=!0;b||(this._gManager.endPagedUpdate(),this.hasAllFeatures=!e,this.emit("query-end",{success:!0}));return f};a.prototype._queryNextPage=function(b){b.start+=this.pageSize;this._executeQuery(b);return!0};a.prototype._queryError=function(b,a){a&&"cancel"===a.dojoType&&!this.hasFeatures?this._gManager.revertPagedUpdate():this._gManager.endPagedUpdate();this.emit("query-end",
{success:!1});if(a&&"cancel"===a.dojoType)return h.reject(a);b=new g("snapshotcontroller:tile-request-failed","Failed to query for features",{error:a});l.error(b);return h.reject(b)};a.prototype._querySetup=function(b,a){this._pendingQueries.set(b,a);this.notifyChange("updating")};a.prototype._queryTeardown=function(b){this._gManager.removeIntent(b);this._pendingQueries.delete(b);this.notifyChange("updating")};a.prototype._processRefetch=function(b,a){(a=a.features)&&this._gManager.add(a,b)};a.prototype._refetchError=
function(b,a){};a.prototype._verifyCapabilities=function(){if(!this.layer.get("capabilities.operations.supportsQuery"))throw new g("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:this.layer});};a.prototype._collectionChanged=function(b){var a=b.added;if(a)for(var c=0;c<a.length;c++)a[c].layer=this.layer,a[c].sourceLayer=this.layer;if(a=b.removed)for(c=0;c<a.length;c++)a[c].layer=null,a[c].sourceLayer=null};a.prototype._editsHandler=
function(b){var a=function(a){return a.objectId},c=b.deletedFeatures.map(a);this._gManager.delete(c);b=b.addedFeatures.concat(b.updatedFeatures).map(a);b.length&&(a=this._createQueryParams(),a.objectIds=b,a=this._source.queryFeatures(a),b=this._gManager.createIntentToAdd(b),this._querySetup(b,a),a.then(this._processRefetch.bind(this,b)).catch(this._refetchError.bind(this,b)).always(this._queryTeardown.bind(this,b)))};d([c.shared("SnapshotController: query cancelled")],a.prototype,"_cancelErrorMsg",
void 0);d([c.property({readOnly:!0})],a.prototype,"type",void 0);d([c.shared({value:.25,scale:945})],a.prototype,"_featureResolution",void 0);d([c.shared({point:16E3,multipoint:8E3,polyline:4E3,polygon:4E3,multipatch:4E3})],a.prototype,"_maxFeatures",void 0);d([c.property()],a.prototype,"_pendingQueries",void 0);d([c.property({dependsOn:["_pendingQueries"]})],a.prototype,"updating",null);d([c.property()],a.prototype,"graphics",null);d([c.property()],a.prototype,"extent",void 0);d([c.property()],a.prototype,
"hasAllFeatures",void 0);d([c.property()],a.prototype,"hasFeatures",void 0);d([c.property()],a.prototype,"layer",void 0);d([c.property()],a.prototype,"layerView",void 0);d([c.property()],a.prototype,"maxPageSize",void 0);d([c.property()],a.prototype,"defaultReturnZ",void 0);d([c.property()],a.prototype,"defaultReturnM",void 0);d([c.property()],a.prototype,"pageSize",void 0);d([c.property()],a.prototype,"paginationEnabled",void 0);return a=d([c.subclass("esri.layers.graphics.controllers.SnapshotController")],
a)}(c.declared(p,u,q))});