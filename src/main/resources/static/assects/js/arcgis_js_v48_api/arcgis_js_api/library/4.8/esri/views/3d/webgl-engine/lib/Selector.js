// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports dojo/has ./gl-matrix ./Object3D ./PerformanceTimer".split(" "),function(m,v,w,b,u,x){var q=b.vec3d.create(),r=b.vec3d.create();m=function(){function a(f,c,a,g,l,h,d,e){void 0===e&&(e=!1);this.dir=b.vec3d.create();this.normalDir=null;this.minResult=new p;this.maxResult=new p;this.transform=b.mat4d.create();this._transformInverse=new k({value:this.transform},b.mat4d.inverse,b.mat4d.create);this._transformInverseTranspose=new k(this._transformInverse,b.mat4d.transpose,b.mat4d.create);
this._transformTranspose=new k({value:this.transform},b.mat4d.transpose,b.mat4d.create);this._transformInverseRotation=new k({value:this.transform},b.mat4d.toInverseMat3,b.mat3d.create);this.enableTerrain=this.enableHUDSelection=!0;this.enableInvisibleTerrain=!1;this.enableBackfacesTerrain=!0;this.performanceInfo={queryDuration:0,numObjectsTested:0};this.viewingMode=f||"global";this.intersectObject=this.intersectObject.bind(this);this.init(c,a,g,l,h,d,e)}a.prototype.init=function(f,c,a,g,l,h,d){c&&
a&&b.vec3d.subtract(a,c,this.dir);this.minResult.init(c,a);this.maxResult.init(c,a);this.numObjectsTested=0;this.point=g;this.camera=l;this.isSelection=d;this.layers=f;this.p0=c;this.p1=a;this.hudResults=[];null==h&&(h=1E-5);this.tolerance=h;if(this.layers)for(f=0;f<this.layers.length;++f)if(c=this.layers[f],a=c.getSpatialQueryAccelerator?c.getSpatialQueryAccelerator():void 0)a.forEachAlongRay(this.p0,this.dir,this.intersectObject),d&&a.forEachDegenerateObject(this.intersectObject);else for(c=c.getObjects(),
a=0;a<c.length;++a)this.intersectObject(c[a])};Object.defineProperty(a.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0});a.prototype.getDirection=function(){this.normalDir||(this.normalDir=b.vec3d.create(),b.vec3d.normalize(this.dir,this.normalDir));return this.normalDir};a.prototype.intersectObject=function(f){var a=this;this.numObjectsTested++;for(var n=f.id,g=f.getGeometryRecords(),l=f.objectTransformation,h,d=0;d<g.length;d++){var e=g[d],k=e.geometry,m=e.materials,t=e.instanceParameters;t.hidden||(h=k.id,
b.mat4d.set(l,this.transform),b.mat4d.multiply(this.transform,e.getShaderTransformation()),this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate(),b.mat4d.multiplyVec3(this.transformInverse,this.p0,q),b.mat4d.multiplyVec3(this.transformInverse,this.p1,r),m[0].intersect(k,t,this.transform,this,q,r,function(b,c,e,d,g,l){0<=b&&(g?(g=new p,g.init(a.p0,a.p1),g.set(f,n,b,c,d,l,h,e),a.hudResults.push(g)):
((null==a.minResult.priority||d>=a.minResult.priority)&&(null==a.minResult.dist||b<a.minResult.dist)&&a.minResult.set(f,n,b,c,d,null,h,e),(null==a.maxResult.priority||d>=a.maxResult.priority)&&(null==a.maxResult.dist||b>a.maxResult.dist)&&a.maxResult.set(f,n,b,c,d,null,h,e)))},e.customTransformation))}};a.prototype.getMinResult=function(){return this.minResult};a.prototype.getMaxResult=function(){return this.maxResult};a.prototype.getHudResults=function(){return this.hudResults};a.DEFAULT_TOLERANCE=
1E-5;return a}();var p=function(){function a(a,c){this.normal=b.vec3d.create();this.init(a,c)}a.prototype.getIntersectionPoint=function(a){if(null==this.dist)return!1;b.vec3d.lerp(this.p0,this.p1,this.dist,a);return!0};a.prototype.set=function(a,c,k,g,l,h,d,e){a instanceof u&&(a={type:"stage",obj:a});this.dist=k;b.vec3d.set(g,this.normal);this.target=a;this.name=c;this.priority=l;this.center=h?b.vec3d.create(h):null;this.geometryId=d;this.triangleNr=e};a.prototype.copyFrom=function(a){this.p0=a.p0;
this.p1=a.p1;this.dist=a.dist;this.target=a.target;this.name=a.name;this.priority=a.priority;this.center=a.center?b.vec3d.create(a.center):null;this.geometryId=a.geometryId;this.triangleNr=a.triangleNr;this.intersector=a.intersector;b.vec3d.set(a.normal,this.normal)};a.prototype.setIntersector=function(a){this.intersector=a};a.prototype.init=function(a,b){this.priority=this.name=this.target=this.dist=void 0;this.triangleNr=this.geometryId=this.center=null;this.intersector="Stage";this.p0=a;this.p1=
b};return a}(),k=function(){function a(a,b,k){this.original=a;this.update=b;this.dirty=!0;this.transform=k()}a.prototype.invalidate=function(){this.dirty=!0};Object.defineProperty(a.prototype,"value",{get:function(){this.dirty&&(this.update(this.original.value,this.transform),this.dirty=!1);return this.transform},enumerable:!0,configurable:!0});return a}();return m});