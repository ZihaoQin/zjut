// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Basemap ../../../core/Collection ../../../core/Error ../../../core/Handles ../../../core/Loadable ../../../core/Logger ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../portal/Portal ./LocalBasemapsSource".split(" "),function(v,w,h,d,k,l,m,n,p,q,r,c,e,t){var f=l.ofType(k),u=q.getLogger("esri.widgets.BasemapGallery.support.PortalBasemapsSource");return function(g){function b(a){a=
g.call(this)||this;a._handles=new n;a.basemaps=new f;a.filterFunction=null;a.portal=e.getDefault();a.query=null;a.updateBasemapsCallback=null;return a}h(b,g);b.prototype.initialize=function(){var a=this;this._handles.add([r.init(this,["filterFunction","portal.basemapGalleryGroupQuery","portal.user","query","updateBasemapsCallback"],function(){return a.refresh()})])};b.prototype.destroy=function(){this._handles.destroy();this.portal=this.filterFunction=this._handles=null};Object.defineProperty(b.prototype,
"state",{get:function(){return"not-loaded"===this.loadStatus?"not-loaded":"loading"===this.loadStatus||this._lastPortalBasemapFetch?"loading":"ready"},enumerable:!0,configurable:!0});b.prototype.load=function(){this.addResolvingPromise(this.portal.load());this.notifyChange("state");return this.when()};b.prototype.refresh=function(){var a=this;if("not-loaded"!==this.state){this._lastPortalBasemapFetch&&(this._lastPortalBasemapFetch.cancel(),this._lastPortalBasemapFetch=null);var b=this.portal,c=!1;
this._lastPortalBasemapFetch={cancel:function(){c=!0}};b.fetchBasemaps(this._toQueryString(this.query)).then(function(b){c||a._updateBasemaps(b)}).catch(function(b){c||(u.warn(new m("basemap-source:fetch-basemaps-error","Could not fetch basemaps from portal.",{error:b})),a._updateBasemaps())}).then(function(){c||(a._lastPortalBasemapFetch=null,a.notifyChange("state"))});this.notifyChange("state")}};b.prototype._toQueryString=function(a){return a&&"string"!==typeof a?Object.keys(a).map(function(b){return b+
":"+a[b]}).join(" AND "):a};b.prototype._updateBasemaps=function(a){void 0===a&&(a=[]);a=this.filterFunction?a.filter(this.filterFunction):a;a=this.updateBasemapsCallback?this.updateBasemapsCallback(a):a;this.basemaps.removeAll();this.basemaps.addMany(a)};d([c.property({readOnly:!0,type:f})],b.prototype,"basemaps",void 0);d([c.property()],b.prototype,"filterFunction",void 0);d([c.property({type:e})],b.prototype,"portal",void 0);d([c.property()],b.prototype,"query",void 0);d([c.property({readOnly:!0})],
b.prototype,"state",null);d([c.property()],b.prototype,"updateBasemapsCallback",void 0);return b=d([c.subclass("esri.widgets.BasemapGallery.support.PortalBasemapsSource")],b)}(c.declared(t,p))});