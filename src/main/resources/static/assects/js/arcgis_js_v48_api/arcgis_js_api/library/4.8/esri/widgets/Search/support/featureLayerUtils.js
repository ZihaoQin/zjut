// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports dojo/date/locale ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./geometryUtils".split(" "),function(S,v,H,x,I,J,l,K,z){function B(a,b){var c=a.filter,f=a.searchExtent;b=b&&b.extent;a=a.withinViewEnabled&&b?b:void 0;return c&&c.geometry||f||a}function C(a){return a?a.load().then(l.resolve).catch(l.reject):l.resolve()}function D(a){return a&&!!a.get("capabilities.query.supportsPagination")}function E(a){var b=
"";a&&(a=a.fields)&&a.some(function(a){if("string"===a.type)return b=a.name,!0});return b}function A(a,b){return a&&b?b.every(function(b){return!!a.getField(b)}):!1}function L(a){for(var b=0;b<a.length;b++)if(255<a.charCodeAt(b))return!0;return!1}function M(a,b,c){var f=null;(a=a.codedValues)&&a.some(function(a){var g=a.name,g=c?g:g.toLowerCase();if((c?b:b.toLowerCase())===g)return f=a.code.toString(),!0});return f}function t(a,b){return(b=b&&b.where)?"("+a+") AND ("+b+")":a}function F(a,b,c,f,q){var g=
"";if(a){var d=N.test(b.url)&&L(a)?"N":"";c&&c.forEach(function(c){var e=b.getField(c);c=((c="function"===typeof b.getFieldDomain&&b.getFieldDomain(c))&&"coded-value"===c.type?M(c,a,q):null)||a||null;if(null!==c){var k=e.type,e=e.name;"string"===k||"date"===k?q?e=t(e+" \x3d "+d+"'"+c+"'",f):(c=c.toUpperCase(),e=t("UPPER("+e+") LIKE "+d+"'%"+c+"%'",f)):"oid"===k||"small-integer"===k||"integer"===k||"single"===k||"double"===k?(c=parseFloat(c),e=isNaN(c)?null:t(e+" \x3d "+c,f)):e=t(e+" \x3d "+c,f);e&&
(g+=g?" OR ("+e+")":"("+e+")")}})}return g}function O(a,b){var c=null;(a=a.codedValues)&&a.length&&a.some(function(a){if(a.code===b)return c=a.name,!0});return c}function G(a,b,c,f){var q=a.layer,g=a.attributes;f="function"===typeof q.getFieldDomain&&q.getFieldDomain(c);return b?I.substitute(g,b):c&&a.hasOwnProperty("attributes")&&g.hasOwnProperty(c)?(a=g[c],c=q.getField(c),f&&"coded-value"===f.type?O(f,a):c&&"date"===c.type?H.format(new Date(a)):a):""}function P(a,b,c,f){return a.features.map(function(a){var g=
a.attributes[a.layer.objectIdField];return{text:G(a,b.suggestionTemplate,f,b),key:g,sourceIndex:c}})}function Q(a,b,c,f,l,g,d){return a.features.map(function(a){var e=a.clone(),k=a.layer,k=(k=k&&k.objectIdField)&&a.attributes[k];a=G(a,c.searchTemplate,l,c);var h=z.createExtentFromGeometry(e.geometry,b,g);return{extent:d?z.scaleExtent(h.clone(),b,d):h,feature:e,key:k,name:a,sourceIndex:f}})}Object.defineProperty(v,"__esModule",{value:!0});var N=/https?:\/\/services.*\.arcgis\.com/i,R=/(?:\{([^}]+)\})/g,
y=J.getLogger("esri.widgets.Search.support.featureLayerUtils");v.getResults=function(a){var b=a.exactMatch,c=void 0===b?!1:b,f=a.location,q=a.maxResults,g=a.spatialReference,d=a.source,t=a.sourceIndex,e=a.suggestResult,k=a.view,h=d.featureLayer,r=d.filter,m=d.zoomScale,p=k&&k.scale,w=B(d,k);return C(h).then(function(){var a=d.displayField||d.featureLayer.displayField||E(d.featureLayer);if(!h.getField(a))return y.error("invalid-field: displayField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field",
"displayField is invalid."));var b=h.get("popupTemplate.requiredFields"),b=b&&b.length?b:null,n=d.outFields||b||[a],b=n&&-1!==n.indexOf("*");-1!==n.indexOf(h.objectIdField)||b||n.push(h.objectIdField);if(!b&&!A(h,n))return y.error("invalid-field: outField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));var b=h.createQuery(),u=d.searchQueryParams;u&&b.set(u);g&&(b.outSpatialReference=g,u=K.getMetersPerUnitForSR(g))&&(b.maxAllowableOffset=u);b.returnGeometry=
!0;n&&(b.outFields=n);if(f)b.geometry=f;else if(e.key)b.objectIds=[parseInt(e.key,10)];else{n=d.searchFields||[a];if(!A(h,n))return y.error("invalid-field: search field is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));D(h)&&(b.num=q);w&&(b.geometry=w);u=e.text.trim();if(!u)return l.resolve();var v=d.prefix,z=d.suffix,u=(""+(void 0===v?"":v)+u+(void 0===z?"":z)).replace(/\'/g,"''"),n=F(u,h,n,r,c);if(!n)return l.resolve();b.where=n}return h.queryFeatures(b).then(function(b){return Q(b,
k,d,t,a,p,m)})})};v.getSuggestions=function(a){var b=a.source,c=a.spatialReference,f=a.suggestTerm,q=a.maxSuggestions,g=a.sourceIndex,d=b.featureLayer,v=b.filter,e=B(b,a.view);return C(d).then(function(){if(!D(d))return l.resolve();var a=b.displayField||b.featureLayer.displayField||E(b.featureLayer),h=b.searchFields||[a],r=[];b.suggestionTemplate?b.suggestionTemplate.replace(R,function(a,b){r.push(b);return a}):r.push(a);var m=r&&-1!==r.indexOf("*");-1!==r.indexOf(d.objectIdField)||m||r.push(d.objectIdField);
var p=!!d.getField(a),m=m||A(d,r),w=A(d,h);if(!p)return y.error("invalid-field: displayField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","displayField is invalid."));if(!m)return y.error("invalid-field: outField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));if(!w)return y.error("invalid-field: search field is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));p=d.createQuery();(m=b.suggestQueryParams)&&
p.set(m);p.outSpatialReference=c;p.returnGeometry=!1;p.num=q;p.outFields=r;e&&(p.geometry=e);m=f.trim();if(!m)return l.resolve();var w=b.prefix,t=b.suffix,m=(""+(void 0===w?"":w)+m+(void 0===t?"":t)).replace(/\'/g,"''"),h=F(m,d,h,v,!1);if(!h)return l.resolve();p.where=h;return d.queryFeatures(p).then(function(c){return P(c,b,g,a)})})}});