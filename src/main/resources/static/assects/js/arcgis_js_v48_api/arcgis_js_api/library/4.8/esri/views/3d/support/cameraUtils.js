// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../Camera ../../../config ../../../core/Logger ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/support/scaleUtils ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ../lib/glMatrix ./cameraUtilsPlanar ./cameraUtilsSpherical ./earthUtils ./mathUtils ./projectionUtils ../webgl-engine/lib/Camera".split(" "),function(U,g,N,y,E,O,t,u,P,z,Q,q,F,G,w,v,r,R){function x(a){return"global"===a.viewingMode?
G:F}function H(a,b,c){var e=a.renderSpatialReference,d=q.vec3d.set(b.viewForward,S),d=I(a,b.eye,d,b.up,T);a=a.spatialReference||u.WGS84;r.vectorToVector(b.eye,e,n,a)||(a=u.WGS84,r.vectorToVector(b.eye,e,n,a));return c?(c.position.x=n[0],c.position.y=n[1],c.position.z=n[2],c.position.spatialReference=a,c.heading=d.heading,c.tilt=d.tilt,c.fov=v.rad2deg(b.fov),c):new y(new t(n,a),d.heading,d.tilt,v.rad2deg(b.fov))}function J(a,b,c){var e=a.state.camera,d=e.fovX,e=e.width/2;"global"===a.viewingMode&&
null!=c&&(b*=Math.cos(v.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return e/(39.37*E.screenDPI/b)/Math.tan(d/2)}function K(a,b,c){var e=a.state.camera;b=39.37*E.screenDPI/(e.width/2/(b*Math.tan(e.fovX/2)));"global"===a.viewingMode&&(b/=Math.cos(v.deg2rad(c)));return b*=a.renderCoordsHelper.unitInMeters}function L(a,b,c,e,d,f){var k=a.renderSpatialReference;b=A(a,e.heading,e.tilt,b,c,d);a=r.vectorToPoint(b.eye,k,a.spatialReference||u.WGS84);if(!a)return null;if(!f)return new y(a,b.heading,b.tilt,
e.fov);f.position=a;f.heading=b.heading;f.tilt=b.tilt;f.fov=e.fov;return f}function I(a,b,c,e,d){return x(a).directionToHeadingTilt(b,c,e,d)}function A(a,b,c,e,d,f){var k=q.vec3d.create(),h=a.renderSpatialReference;if(e)if(e instanceof t){var l=e;r.pointToVector(l,k,a.renderSpatialReference);null==l.z&&null!=a.basemapTerrain&&(l=a.basemapTerrain.getElevation(l),null!=l&&a.renderCoordsHelper.setAltitude(l,k))}else e&&q.vec3d.set(e,k);else q.vec3d.set(a.state.camera.center,k);e&&e instanceof t||(e=
r.vectorToPoint(k,h,a.spatialReference||u.WGS84));d=Math.max(d,a.state.constraints.minimumPoiDistance);h=c;c=d;if(!(l=f&&f.noReset))var l=e,m=a.engineToScreen(a.state.camera.center),p=a.toScreen(l),l=m.x-p.x,m=m.y-p.y,p=a.pointsOfInterest.centerOnSurfaceFrequent.distance,p=Math.log(Math.max(c,p)/Math.min(c,p))/Math.LN2,l=!(Math.sqrt(l*l+m*m)>5*Math.max(a.width,a.height)||8<p&&8E5<c);l?(h=x(a).eyeTiltToLookAtTilt(k,c,h),h=a.state.constraints.clampTilt(c,h),h=x(a).lookAtTiltToEyeTilt(k,c,h)):(b=0,h=
a.state.constraints.tilt(c).min);c=h;h=x(a).eyeForCenterWithHeadingTilt;b=h(k,d,b,c);k={eye:b.eye,up:b.up,center:k,heading:b.heading,tilt:b.tilt};return f&&f.noReset||"global"!==a.viewingMode||(b=a.renderCoordsHelper.fromRenderCoords(k.eye,C,a.spatialReference)?a.basemapTerrain&&(a.basemapTerrain.getElevation(C)||0)>C.z-1:!1,!b)?k:(k=a.state.constraints.tilt(d).min,A(a,0,k,e,d,N({},f,{noReset:!0})))}Object.defineProperty(g,"__esModule",{value:!0});var M=O.getLogger("esri.views.3d.support.cameraUtils"),
n=q.vec3d.create(),B=q.vec3d.create(),S=q.vec3d.create(),T={heading:0,tilt:0},C=new t,D=new v.Cyclical(-2.0037508342788905E7,2.0037508342788905E7);g.externalToInternal=function(a,b){var c=a.renderSpatialReference,e=x(a).headingTiltToDirectionUp,d=q.vec3d.create();return r.pointToVector(b.position,d,c)?(c=e(d,b.heading,b.tilt),q.vec3d.add(c.direction,d),a=Q.cameraOnContentAlongViewDirection(a,d,c.direction,c.up),a.fov=v.deg2rad(b.fov),a):null};g.internalToExternal=H;g.scaleToDistance=J;g.distanceToScale=
K;g.fromCenterScale=function(a,b,c,e,d,f){c=J(a,c,b.latitude);return L(a,b,c,e,d,f)};g.fromCenterDistance=L;g.directionToHeadingTilt=I;g.eyeHeadingTiltForCenterPointAtDistance=A;g.fromExtent=function(a,b,c,e,d,f){var k;d instanceof y?(f=d,k={noReset:!1}):k=d;var h="global"===a.viewingMode;d=a.renderSpatialReference;var l=a.spatialReference||u.WGS84,m=u.WebMercator,p=b.spatialReference||m,g,q=0;null!=b.zmax&&null!=b.zmin&&(g=(b.zmax+b.zmin)/2,q=b.zmax-b.zmin);if(h){var h=new t(b.xmin,b.ymin,p),n=new t(b.xmax,
b.ymax,p),h=z.project(h,m),n=z.project(n,m);if(null===h||null===n)return;b=new t(D.center(h.x,n.x),(n.y+h.y)/2,m);null!=g&&(b.z=g);g=w.getGreatCircleSpanAt(b,h,n);m=g.lon;p=g.lat;D.diff(h.x,n.x)>D.range/2&&(m+=w.halfEarthCircumference);m=Math.min(m,w.halfEarthCircumference);p=Math.min(p,w.halfEarthCircumference)}else z.canProject(b,l)&&(b=z.project(b,l)),m=b.xmax-b.xmin,p=b.ymax-b.ymin,b=new t({x:b.xmin+.5*m,y:b.ymin+.5*p,z:g,spatialReference:l});g=a.state.camera;c=A(a,c,e,b,Math.max(1/Math.tan(g.fovX/
2)*m*.5,1/Math.tan(g.fovY/2)*p*.5,1/Math.tan(g.fov/2)*q*.5)/1,k);e=r.vectorToPoint(c.eye,d,l);if(!e)return null;f||(f=new y);f.position=e;f.heading=c.heading;f.tilt=c.tilt;f.fov=a.camera.fov;return f};g.toExtent=function(a,b,c,e,d){var f;f=a.renderSpatialReference;b||(c||(c=a.state.camera),b=H(a,c,d));if(c)d=r.vectorToPoint(c.center,f,a.spatialReference||u.WGS84),f=c.distance;else{d=a.toMap(a.screenCenter);if(!d)return null;f=w.computeCarthesianDistance(b.position,d)}c||(c=a.state.camera);b=2*f*Math.tan(c.fovX/
2)*1;c=2*f*Math.tan(c.fovY/2)*1;return"global"===a.viewingMode?G.toExtent(a,d,b,c,e):F.toExtent(a,d,b,c,e)};g.scaleToZoom=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.levelAtScale(b);M.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};g.zoomToScale=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.scaleAtLevel(b);M.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};g.scaleToResolution=
function(a,b){return a.spatialReference?P.getResolutionForScale(b,a.spatialReference):void 0};g.computeScale=function(a,b,c){var e=a.renderSpatialReference;b||(b=a.state.camera);var d;d=u.WGS84;b instanceof R?(r.vectorToVector(b.center,e,B,d),d=B[1],b=b.distance):(d=b.position.latitude,r.pointToVector(b.position,n,e),r.pointToVector(c,B,e),b=q.vec3d.dist(n,B));return K(a,b,d)}});