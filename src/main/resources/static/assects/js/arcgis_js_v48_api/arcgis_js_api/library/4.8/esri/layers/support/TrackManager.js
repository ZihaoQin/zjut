// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["../../core/declare","../../Graphic","../../geometry/Polyline","../GraphicsLayer"],function(m,n,p,q){return m(null,{declaredClass:"esri.layers.support.TrackManager",constructor:function(a){this.layer=a;this.trackMap={};this.trackLineMap={}},initialize:function(a){this.map=a;var c=this.layer,b=c._getRenderer(),b=b&&b.trackRenderer;if("point"===c.geometryType){var d=this.container=new q._GraphicsLayer({id:c.id+"_tracks",_child:!0});d.loaded=!0;d.onLoad(d);d._setMap(a,c._div);d.setRenderer(b)}},
addFeatures:function(a){var c=this.trackMap,b=this.layer,d=b._trackIdField,e=[];a.forEach(function(a){var b=a.attributes[d];(c[b]=c[b]||[]).push(a);-1===e.indexOf(b)&&e.push(b)});var f=b._startTimeField,g=b.objectIdField,k=function(b,a){var c=b.attributes[f],e=a.attributes[f];return c===e?b.attributes[g]<a.attributes[g]?-1:1:c<e?-1:1};e.forEach(function(b){c[b].sort(k)})},trimTracks:function(a){function c(a){for(a=b[a]||[];a.length>d;)e.push(a.shift())}var b=this.trackMap,d=this.layer.maximumTrackPoints||
0,e=[],f;if(!d)return e;if(a)a.forEach(function(a){c(a)});else for(f in b)b.hasOwnProperty(f)&&c(f);return e},drawTracks:function(a){function c(a){var c=e[a],k,h,l;h=b.trackLineMap[a];d.remove(h);delete b.trackLineMap[a];h=null;if(!c||2>c.length)return!1;h=[];for(k=c.length-1;0<=k;k--)(l=c[k].geometry)&&h.push([l.x,l.y]);c={};c[g]=a;1<h.length&&(h=new n(new p({paths:[h],spatialReference:f}),null,c),d.add(h),b.trackLineMap[a]=h)}var b=this,d=this.container,e,f,g,k;if(d)if(e=this.trackMap,f=this.map.spatialReference,
g=this.layer._trackIdField,a)a.forEach(function(a){c(a)});else for(k in e)e.hasOwnProperty(k)&&c(k)},refreshTracks:function(a){function c(a){var c,g;b.drawTracks([a]);if(f&&f.latestObservationRenderer)for(a=d[a]||[],c=a.length,g=0;g<c;g++)e._repaint(a[g],null,!0)}var b=this,d=this.trackMap,e=this.layer,f=e._getRenderer(),g;if(a)a.forEach(function(a){c(a)});else for(g in d)d.hasOwnProperty(g)&&c(g);this.moveLatestToFront()},moveLatestToFront:function(a){this.getLatestObservations(a).forEach(function(a){var b=
a._shape;b&&b._moveToFront();this._repaint(a,null,!0)},this.layer)},getLatestObservations:function(a){function c(a){a=e[a];return a[a.length-1]}var b=[],d=this.layer._getRenderer(),e=this.trackMap,f;if(!d.latestObservationRenderer)return b;if(a)a.forEach(function(a){b.push(c(a))});else for(f in e)e.hasOwnProperty(f)&&b.push(c(f));return b},clearTracks:function(a){var c=this.getLatestObservations(a),b=this.container,d;a?a.forEach(function(a){delete this.trackMap[a];b&&(d=this.trackLineMap[a],b.remove(d),
delete this.trackLineMap[a])},this):(this.trackMap={},this.trackLineMap={},b&&b.removeAll());c.forEach(function(a){this._repaint(a,null,!0)},this.layer)},isLatestObservation:function(a){var c=this.trackMap[a.attributes[this.layer._trackIdField]];return c?c[c.length-1]===a:!1},destroy:function(){var a=this.container;a&&(a.removeAll(),a._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}})});