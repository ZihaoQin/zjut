// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/Handles ../../../../core/Logger ../../../../core/now ../../../../core/PooledArray ../../../../geometry/support/aaBoundingRect ./deconflictorDebug ../../lib/glMatrix ../../support/ResourceController ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),function(F,W,X,L,B,C,u,p,x,q,M,N,G,O,y){function z(b){return!!b&&
"selection"===b.type}F=q.vec2d;q=q.vec4d;var H=G.VertexAttrConstants,P=B.getLogger("esri.views.3d.graphics.Deconflictor"),I=q.create(),A=q.create(),J=q.create(),Q=q.create(),R=p.create(),S=p.create(),T=new Set,K=G.lerp,U=function(){function b(a,c){this.creator=a;this.disposer=c;this.list=[];this.currentIndex=0}b.prototype.alloc=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];this.currentIndex>=this.list.length&&this.list.push(new this.creator(a));return this.list[this.currentIndex++]};
b.prototype.freeAll=function(){for(var a=this.currentIndex,c=this.disposer,v=this.list;0<=--a;)c(v[a]);this.currentIndex=0};return b}(),D=function(){function b(){this.graphics3DGraphic=null;this.posView=this.yMax=this.yMin=this.xMax=this.xMin=0;this.graphicsOwner=null;this.id=0}b.release=function(a){a.graphics3DGraphic=null;a.graphicsOwner=null};b.copyMetadata=function(a,c){c.graphics3DGraphic=a.graphics3DGraphic;c.graphicsOwner=a.graphicsOwner;c.iconDeconflictionEnabled=a.iconDeconflictionEnabled;
c.labelDeconflictionEnabled=a.labelDeconflictionEnabled;return c};return b}(),d;(function(b){b[b.Idle=0]="Idle";b[b.Collect=1]="Collect";b[b.Process=2]="Process";b[b.SortIcons=3]="SortIcons";b[b.SortLabels=4]="SortLabels";b[b.Deconflict=5]="Deconflict"})(d||(d={}));B=function(){function b(a){var c=this;this.graphicsOwners=[];this.lastRunTimestamp=0;this.nextRunTimestamp=Number.POSITIVE_INFINITY;this.syncBudget=null;this.state=d.Idle;this.collectIndex=0;this.collectGraphics=null;this.collectGraphicsIndex=
0;this.handles=new L;this.graphicInfosToProcess=new u;this.graphicInfoPool=new U(D,D.release);this.nextGraphicInfoId=0;this.visibleObjects={icons:new u,labels:new u};this.accBinsNumX=15;this.accBinsNumY=20;this.accBinsSizeY=this.accBinsSizeX=0;this.accBins=null;this.accNumTests=0;this.iconMarginFactor=-.1;this.view=a;this.handles.add([a.watch("state.camera",function(){c.setDirty({async:!0,forceMaxIntervalRun:!0})})]);this.frameWorker=a.resourceController.registerFrameWorker(function(a){return c.run(a)})}
b.prototype.destroy=function(){this.handles.destroy();this.handles=null;this.graphicInfoPool.freeAll();this.graphicInfoPool=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.view=null};b.prototype.addGraphicsOwner=function(a){var c=this;this.graphicsOwners.push(a);this.setDirty();a.layer&&"function"===typeof a.layer.watch&&a.layer.watch("featureReduction",function(b,e){z(b)?(c._setIconVisibilityFlags(a,!1),c.setDirty()):z(e)&&(c._setIconVisibilityFlags(a,void 0),c.setDirty())})};
b.prototype.removeGraphicsOwner=function(a){a=this.graphicsOwners.indexOf(a);0<=a&&this.graphicsOwners.splice(a,1);this.setDirty()};Object.defineProperty(b.prototype,"isDirty",{get:function(){return this.nextRunTimestamp!==Number.POSITIVE_INFINITY},enumerable:!0,configurable:!0});b.prototype.setDirty=function(a){var c=a?a.async:!0;a=a?a.forceMaxIntervalRun:!1;this.state!==d.Idle&&(this.state=d.Idle);var b=C();this.nextRunTimestamp=a&&1E3<b-this.lastRunTimestamp?this.lastRunTimestamp=b:b+200;c||this.syncBudget||
(this.syncBudget=new M.Budget(C),this.syncBudget.enabled=!1)};b.prototype.setClean=function(){this.graphicInfoPool.freeAll();this.graphicInfosToProcess.clear();this.nextGraphicInfoId=0;this.state=d.Idle;this.lastRunTimestamp=C();this.nextRunTimestamp=Number.POSITIVE_INFINITY;this.syncBudget=null};b.prototype.setInitialIconVisibilityFlag=function(a,c){a=!z(a?a.featureReduction:null);c.setVisibilityFlag(2,a)};b.prototype.doesIntersectExistingPoly=function(a){var c=a.graphics3DGraphic.graphic.uid;T.clear();
for(var b=Math.floor(a.xMin/this.accBinsSizeX);b<=Math.floor(a.xMax/this.accBinsSizeX);b++)if(!(0>b||b>=this.accBinsNumX))for(var e=Math.floor(a.yMin/this.accBinsSizeY);e<=Math.floor(a.yMax/this.accBinsSizeY);e++)if(!(0>e||e>=this.accBinsNumY))for(var m=this.accBins[b][e],d=0;d<m.length;d++){var g=m.data[d];if(g.graphics3DGraphic.graphic.uid!==c&&(this.accNumTests++,!(g.xMin>a.xMax||g.xMax<a.xMin||g.yMin>a.yMax||g.yMax<a.yMin)))return!0}return!1};b.prototype.initBins=function(a,c){if(null==this.accBins){this.accBins=
[];for(var b=0;b<this.accBinsNumX;b++){this.accBins.push([]);for(var e=this.accBins[this.accBins.length-1],d=0;d<this.accBinsNumY;d++)e.push(new u({initialSize:10}))}}for(b=0;b<this.accBinsNumX;b++)for(d=0;d<this.accBinsNumY;d++)this.accBins[b][d].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=c/this.accBinsNumY;this.accNumTests=0};b.prototype.addToBins=function(a){for(var c=Math.floor(a.xMin/this.accBinsSizeX);c<=Math.floor(a.xMax/this.accBinsSizeX);c++)if(!(0>c||c>=this.accBinsNumX))for(var b=
Math.floor(a.yMin/this.accBinsSizeY);b<=Math.floor(a.yMax/this.accBinsSizeY);b++)0>b||b>=this.accBinsNumY||this.accBins[c][b].push(a)};b.prototype.run=function(a){if(this.view.ready&&!(a.now()<this.nextRunTimestamp))switch(x.prepare(this.view),this.syncBudget&&(a=this.syncBudget),this.state){case d.Idle:this.collectIndex=0,this.collectGraphics=null,this.visibleObjects.icons.clear(),this.visibleObjects.labels.clear(),this.graphicInfosToProcess.clear();case d.Collect:this.state=d.Collect;if(!this._collectVisibleObjects(a))break;
if(0===this.graphicInfosToProcess.length){this.setClean();break}case d.Process:this.state=d.Process;if(a.done())break;for(;this.graphicInfosToProcess.length&&!a.done();)this._processVisibleObject(this.graphicInfosToProcess.pop());if(0<this.graphicInfosToProcess.length)break;case d.SortIcons:this.state=d.SortIcons;if(a.done())break;this.visibleObjects.icons.sort(function(a,b){return a.posView-b.posView});case d.SortLabels:this.state=d.SortLabels;if(a.done())break;this.visibleObjects.labels.sort(function(a,
b){return a.posView-b.posView});case d.Deconflict:this.state=d.Deconflict,a.done()||(this._deconflictVisibleObjects(this.visibleObjects.icons,!1,a),this.visibleObjects.labels.length&&this._deconflictVisibleObjects(this.visibleObjects.labels,!0,a),x.drawAccelerationStruct(this,this.visibleObjects.icons),x.drawAccelerationStruct(this,this.visibleObjects.labels),0===this.visibleObjects.icons.length&&0===this.visibleObjects.labels.length&&this.setClean())}};b.prototype._collectVisibleObjects=function(a){for(var b=
this.view.state.camera,d=b.fullWidth,b=b.fullHeight;this.collectIndex<this.graphicsOwners.length;++this.collectIndex){var e=this.graphicsOwners[this.collectIndex],m=e.graphics3DGraphics;if(m){var k=e.labelsEnabled,g=z(e.layer?e.layer.featureReduction:null);if(k||g)if(this.collectGraphics||(this.collectGraphics=e.graphics3DGraphicsKeys,this.collectGraphicsIndex=0),this.collectGraphics){if(this.collectGraphics!==e.graphics3DGraphicsKeys)return this.collectIndex=0,this.collectGraphics=null,!1;for(;this.collectGraphicsIndex<
this.collectGraphics.length&&!a.done();++this.collectGraphicsIndex){var p=m[this.collectGraphics[this.collectGraphicsIndex]];if(p&&p.areVisibilityFlagsSet(void 0,2)){var n=this.graphicInfoPool.alloc();n.id=this.nextGraphicInfoId++;n.graphicsOwner=e;n.graphics3DGraphic=p;n.iconDeconflictionEnabled=g;n.labelDeconflictionEnabled=k;this.graphicInfosToProcess.push(n)}}this.collectGraphicsIndex>=this.collectGraphics.length&&(this.collectGraphics=null)}}}if(this.collectIndex===this.graphicsOwners.length&&
!this.collectGraphics){this.collectIndex=0;if(0===this.graphicInfosToProcess.length)return!0;this.initBins(d,b);return!0}this.collectGraphics&&--this.collectIndex;return!1};b.prototype._processVisibleObject=function(a){var b=this.view.state.camera;a.iconDeconflictionEnabled&&this._collectGraphics(a,b,0);a.labelDeconflictionEnabled&&(a=a.iconDeconflictionEnabled?D.copyMetadata(a,this.graphicInfoPool.alloc()):a,a.id=this.nextGraphicInfoId++,this._collectGraphics(a,b,1))};b.prototype._collectGraphics=
function(a,b,d){var c=a.graphics3DGraphic,m=a.graphicsOwner,k=1===d,g=k?this.visibleObjects.labels:this.visibleObjects.icons,q=k?c._labelGraphics:c._graphics,k=k?0:this.iconMarginFactor;if(q.length){for(var n=p.empty(R),v,h,u=0;u<q.length;u++){var l=q[u];if(l&&"object3d"===l.type){var r=l.stageObject,w=r?r.getNumGeometryRecords():0;if(!(1>w)){var t=r.getGeometryRecord(0),f=t.materials[0];if(f instanceof O)if(1<w)P.warn("Graphic objects with more than 1 geometry record are not supported");else{w=t.geometry.getData().getVertexAttr();
if(!h){h=r.getCenter();t=t.origin.vec3;y.transformToWorld(h,t,I);y.transformToView(I,t,b.viewMatrix,A);f.applyVerticalOffsetTransformation(A,w[H.NORMAL].data,r.objectTransformation,b,E);r=w[H.AUXPOS1].data;t="screen"!==f.getParams().centerOffsetUnits;y.transformToProjection(A,b.projectionMatrix,t?r:[0,0,0],J);h=y.transformToNDC(J,Q);t||(h[0]+=r[0]/b.fullWidth*2,h[1]+=r[1]/b.fullHeight*2);if(-1>h[0]||-1>h[1]||-1>h[2]||1<=h[0]||1<=h[1])break;v=A[2];c.areVisibilityFlagsSet(2,void 0,d)&&(v*=.7)}l=l.getScreenSize(V);
N.applyPrecomputedScaleFactorVec2(l,E.factor,l);f=p.offset(f.calculateRelativeScreenBounds(l,E.scaleAlignment,S),K(0,b.fullWidth,.5+.5*h[0]),K(0,b.fullHeight,.5+.5*h[1]));0!==k&&(l=k*Math.min(p.width(f),p.height(f)),f[0]-=l,f[1]-=l,f[2]+=l,f[3]+=l);p.expand(n,f)}}}}null!=v&&(a.xMin=n[0],a.yMin=n[1],a.xMax=n[2],a.yMax=n[3],a.graphics3DGraphic=c,a.posView=v,a.graphicsOwner=m,g.push(a))}};b.prototype._deconflictVisibleObjects=function(a,b,d){for(var c=b?1:0;0<a.length&&!d.done();){var m=a.pop(),k=m.graphics3DGraphic,
g=!(b&&!1===k.areVisibilityFlagsSet(2))&&!this.doesIntersectExistingPoly(m);g&&this.addToBins(m);k.setVisibilityFlag(2,g,c);b&&this.view.labeler.setLabelGraphicVisibility(k,g);x.drawPoly(m,g?"green":"red")}};b.prototype._setIconVisibilityFlags=function(a,b){var c=a.graphics3DGraphics;a=a.graphics3DGraphicsKeys;if(null!=c&&null!=a)for(var d=0;d<a.length;d++)c[a[d]].setVisibilityFlag(2,b)};return b}();var E={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},
V=F.create();return B});