// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/Evented ../../../core/Handles ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/support/webMercatorUtils ./EnvironmentRenderer ../lib/glMatrix ../support/earthUtils ../support/sunUtils ../webgl-engine/lighting/Lightsources ../../../webscene/background/ColorBackground".split(" "),
function(f,l,w,h,x,y,z,A,p,k,g,q,r,B,C,e,t,m,n,D){Object.defineProperty(l,"__esModule",{value:!0});var u=[.5773502691896258,-.5773502691896258,.5773502691896258];f=function(f){function b(a){a=f.call(this)||this;a.referencePointUpdateDelay=200;a.referencePointUpdateInterval=3E3;a.referencePointUpdateDistThreshold=1E6;a._referencePosUpdateQuery=null;a._referencePosMapCoordsRequested=null;a._viewHandles=new A;a._preserveAbsoluteDateTime=!1;a._trackingEnabled=!1;a._viewConnected=!1;a._referencePosResetPreserveAbsoluteTime=
!1;a._referencePosUpdateTimer=null;a._referencePosWGS84=null;a._referencePosMapCoords=null;a._mainLight=new n.MainLight;a._ambientLight=new n.AmbientLight;a._moonLight=new n.FillLight;a._environmentRenderer=null;a._resetReferencePosition();return a}w(b,f);b.prototype.destroy=function(){this._viewHandles.destroy();this.disposeRendering()};Object.defineProperty(b.prototype,"updating",{get:function(){return!this.noReferencePositionQueries&&(!!this._referencePosUpdateQuery||!!this._referencePosMapCoordsRequested)},
enumerable:!0,configurable:!0});b.prototype.updateReadyChange=function(a){a&&!this._viewConnected?(this._viewConnected=!0,this.connectView(this.view)):!a&&this._viewConnected&&(this._viewConnected=!1,this.disconnectView(this.view))};b.prototype.disposeRendering=function(){this._environmentRenderer&&(this._environmentRenderer.destroy(),this._environmentRenderer=null);this._resetReferencePosition(!0)};b.prototype.connectView=function(a){this._environmentRenderer=new C({view:a});this._viewHandles.add([k.on(this.view,
"environment.lighting","date-will-change",this._lightingDateHandler.bind(this)),this.view.watch("interacting,stationary",this._interactingStationaryHandler.bind(this)),this.view.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.background.color"],this._updateRenderParamsHandler.bind(this)),this.view.watch("spatialReference",this._spatialReferenceHandler.bind(this)),k.init(this.view,"viewingMode",this._viewingModeHandler.bind(this)),k.init(this.view,
"environment.lighting.cameraTrackingEnabled",this._updateCameraTracking.bind(this),!0),this.watch("noReferencePositionQueries",this._cameraHandler.bind(this,null))]);this._updateRenderParamsHandler();this._updateLightParams();this._cameraHandler()};b.prototype._updateCameraTracking=function(a){if(this._trackingEnabled=a)a=k.init(this,"view.state.camera",this._cameraHandler.bind(this,null),!0),this._viewHandles.add(a,"camera");else{if(a=this.get("view.environment.lighting"))a.positionTimezoneInfo.autoUpdated=
!1;this._viewHandles.remove("camera")}};b.prototype.disconnectView=function(a){this.disposeRendering();this._viewHandles.removeAll()};b.prototype._lightingDateHandler=function(a){if(a=a.date){var d=this.view.environment.lighting;if(!d.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var c=this.view.spatialReference;if(!(c.isWGS84||c.isWebMercator||(c=this.view.camera.position,this._referencePosMapCoords&&this._referencePosMapCoords.equals(c)))){this._requestReferencePositionUpdate(c);
return}this._preupdateTracking(a);this._referencePosWGS84&&(c=t.positionToTimezone(this._referencePosWGS84,v),d.autoUpdate(null,c),this._trackingEnabled&&(d.positionTimezoneInfo.autoUpdated=!0))}this._updateLightParams(a)}};b.prototype._preupdateTracking=function(a){!this._trackingEnabled&&this.get("view.environment.lighting.cameraTrackingEnabled")&&this._cameraHandler(a)};b.prototype._cameraHandler=function(a){void 0===a&&(a=null);if(this.view.ready){var d=this.view.camera;if(d){var c=this.view.spatialReference;
c.isWGS84||c.isWebMercator?this._cameraHandlerGlobal(d,a):this._cameraHandlerLocal(d,a)}}};b.prototype._cameraHandlerGlobal=function(a,d){a=a.position;this._referencePosWGS84||(this._referencePosWGS84=new q({spatialReference:r.WGS84}));a.spatialReference.isWebMercator?B.webMercatorToGeographic(a,!1,this._referencePosWGS84):(this._referencePosWGS84.x=a.x,this._referencePosWGS84.y=a.y);this._referencePosWGS84.z=a.z;this._autoUpdateTimezone(a,d)||this._updateLightParams(d)};b.prototype._cameraHandlerLocal=
function(a,d){a=a.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(a))&&this._requestReferencePositionUpdate(a,!0);this.view.mapCoordsHelper&&this._referencePosWGS84&&(this._referencePosWGS84.z=a.z*this.view.mapCoordsHelper.unitInMeters,this._referencePosChanged())};b.prototype._interactingStationaryHandler=function(){!this.view.interacting&&this.view.stationary&&this._executePendingReferencePositionUpdate()};b.prototype._updateLightParams=
function(a){void 0===a&&(a=null);var d=this.view.environment.lighting;a=a||d.date;var d=this.view._stage,c;this._referencePosWGS84?(c=m.computeColorAndIntensity(a,this._referencePosWGS84),m.computeDirection(a,this._referencePosWGS84,this.view.viewingMode,c.diffuse.direction)):c={diffuse:{color:[1,1,1],intensity:.55,direction:u},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0};e.vec3d.scale(c.diffuse.color,c.diffuse.intensity*Math.PI,this._mainLight.intensity);e.vec3d.negate(c.diffuse.direction,
this._mainLight.direction);e.vec3d.scale(c.ambient.color,c.ambient.intensity,this._ambientLight.intensity);e.vec3d.lerp(E,F,c.globalFactor,this._moonLight.intensity);e.vec3d.scale(this._moonLight.intensity,(1-.5*c.globalFactor)*(1-.4*c.noonFactor*(1-c.globalFactor)));e.vec3d.set(c.diffuse.direction,this._moonLight.direction);d.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:c.globalFactor,groundLightingFactor:1-c.noonFactor});this._updateRenderParamsHandler()};
b.prototype._autoUpdateTimezone=function(a,d){void 0===d&&(d=null);if(!this.view.get("environment.lighting.cameraTrackingEnabled"))return!1;var c=G;c.setTime((d||this.view.environment.lighting.date).getTime());a=t.positionToTimezone(a,v);var b=this.view.environment.lighting.positionTimezoneInfo;if(!b.autoUpdated)b=a;else if(b.hours===a.hours&&b.minutes===a.minutes&&b.seconds===a.seconds)return!1;var e=c.getUTCHours()-(a.hours-b.hours),f=c.getUTCMinutes()-(a.minutes-b.minutes),b=c.getUTCSeconds()-
(a.seconds-b.seconds);c.setUTCHours(e);c.setUTCMinutes(f);c.setUTCSeconds(b);return d?!1:this.view.environment.lighting.autoUpdate(c,a)};b.prototype._updateRenderParamsHandler=function(){var a=this.view._stage,b=!0;this._referencePosWGS84&&(b=m.computeShadowsEnabled(this._referencePosWGS84,this.view.viewingMode));var c=this.view.environment.background,c=c instanceof D?{type:"color",color:x.toUnitRGBA(c.color)}:{type:"color",color:[0,0,0,1]};a&&a.setRenderParams({shadowMap:this.view.environment.lighting.directShadowsEnabled&&
b,ssao:this.view.environment.lighting.ambientOcclusionEnabled,background:c})};b.prototype._spatialReferenceHandler=function(){this._resetReferencePosition()};b.prototype._viewingModeHandler=function(){this._resetReferencePosition()};b.prototype._resetReferencePosition=function(a){void 0===a&&(a=!1);this._cancelReferencePosUpdates();this._referencePosWGS84=this._referencePosResetPreserveAbsoluteTime=this._referencePosMapCoordsRequested=this._referencePosMapCoords=null;a||this.notifyChange("updating")};
b.prototype._requestReferencePositionUpdate=function(a,b){var c=this;void 0===b&&(b=!1);if(this.view.mapCoordsHelper.canProject()&&!this.noReferencePositionQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(a):this._referencePosMapCoordsRequested=a.clone(),this._referencePosResetPreserveAbsoluteTime=!!b,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&!this.view.interacting&&this.view.stationary)){var d=this._referencePosUpdateQuery=p.after(this.referencePointUpdateDelay).then(function(){if(c._referencePosUpdateQuery===
d)return c._doReferencePositionUpdateQuery(function(){return c._referencePosUpdateQuery!==d})}).always(function(){c._referencePosUpdateQuery===d&&(c._referencePosUpdateQuery=null,c._referencePosUpdateTimer||c._executePendingReferencePositionUpdate(),c.notifyChange("updating"))}),e=this._referencePosUpdateTimer=p.after(this.referencePointUpdateInterval).then(function(){c._referencePosUpdateTimer===e&&(c._referencePosUpdateTimer=null,c._referencePosUpdateQuery||c._executePendingReferencePositionUpdate())});
this.notifyChange("updating")}};b.prototype._doReferencePositionUpdateQuery=function(a){var b=this;this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1);this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone();this._referencePosMapCoordsRequested=this._referencePosResetPreserveAbsoluteTime=null;return this.view.mapCoordsHelper.toGeographic(this._referencePosMapCoords).then(function(c){if(!a()&&
!isNaN(c[0])&&!isNaN(c[1])){var d=b._referencePosMapCoords.z*b.view.mapCoordsHelper.unitInMeters;b._referencePosWGS84?(b._referencePosWGS84.x=c[0],b._referencePosWGS84.y=c[1],b._referencePosWGS84.z=d):b._referencePosWGS84=new q({x:c[0],y:c[1],z:d,spatialReference:r.WGS84});b._referencePosChanged()}})};b.prototype._executePendingReferencePositionUpdate=function(){var a=this._referencePosMapCoordsRequested;a&&this._requestReferencePositionUpdate(a,this._referencePosResetPreserveAbsoluteTime)};b.prototype._referencePosChanged=
function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84)||this._updateLightParams()};b.prototype._exceedsReferencePosDistThreshold=function(a){return this._referencePosMapCoords?(a=this._referencePosMapCoords.distance(a),this.view.mapCoordsHelper&&(a*=this.view.mapCoordsHelper.unitInMeters),a>this.referencePointUpdateDistThreshold):!0};b.prototype._cancelReferencePosUpdates=function(){this._referencePosUpdateTimer=this._referencePosUpdateQuery=
null};b.FIXED_LIGHT_DIRECTION=u;h([g.property({type:Boolean,dependsOn:["noReferencePositionQueries"],readOnly:!0})],b.prototype,"updating",null);h([g.property()],b.prototype,"noReferencePositionQueries",void 0);h([g.property({constructOnly:!0})],b.prototype,"view",void 0);h([g.property()],b.prototype,"_environmentRenderer",void 0);return b=h([g.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],b)}(g.declared(y,z));l.SceneViewEnvironmentManager=f;var G=new Date,v={hours:0,minutes:0,
seconds:0},E=e.vec3d.createFrom(.22,.22,.33),F=e.vec3d.createFrom(.22,.22,.22);l.default=f});