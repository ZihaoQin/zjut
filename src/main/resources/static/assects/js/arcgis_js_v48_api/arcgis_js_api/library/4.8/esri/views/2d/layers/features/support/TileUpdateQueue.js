// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../core/scheduling","../../../tiling","../../../libs/gl-matrix/vec2"],function(c,d,h,e,k){Object.defineProperty(d,"__esModule",{value:!0});var f=[0,0];c=function(){function b(a){this._queue=new Map;this._onGoingPromise=this._onGoingTileId=null;this._isPaused=!1;this.tileInfoView=this._scheduledNextHandle=null;this.tileInfoView=a.tileInfoView;this.process=a.process;this._next=this._next.bind(this);this._finalize=this._finalize.bind(this)}Object.defineProperty(b.prototype,
"length",{get:function(){return this._queue.size},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._queue.size&&null!=this._onGoingPromise},enumerable:!0,configurable:!0});b.prototype.cancel=function(a){this._onGoingTileId===a&&(this._onGoingPromise.cancel(),this._onGoingTileId=this._onGoingPromise=null);this._queue.delete(a)};b.prototype.clear=function(){this._queue.clear();this._onGoingPromise&&(this._onGoingPromise.cancel(),this._onGoingTileId=
this._onGoingPromise=null)};b.prototype.has=function(a){return this._queue.has(a)};b.prototype.isOngoing=function(a){return this._onGoingTileId===a};b.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.prototype.push=function(a){this._queue.has(a)||(this._queue.set(a,e.TileKey.pool.acquire(a)),this._scheduleNext())};b.prototype.reset=function(){var a=this._onGoingTileId;a&&(this._onGoingPromise.cancel(),this.push(a))};b.prototype.resume=function(){this._isPaused&&
(this._isPaused=!1,this._scheduleNext())};b.prototype._finalize=function(){this._onGoingPromise=this._onGoingTileId=null;this._scheduleNext()};b.prototype._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)};b.prototype._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTileId||(this._scheduledNextHandle=h.schedule(this._next))};b.prototype._next=function(){if(null==this._scheduledNextHandle||
0===this._queue.size||this._onGoingTileId)this._scheduledNextHandle=null;else{this._scheduledNextHandle=null;var a=this._peekByCenterFirst();e.TileKey.pool.release(this._queue.get(a));this._queue.delete(a);this._onGoingTileId=a;(a=this._onGoingPromise=this.process(a))&&"function"===typeof a.then?this._onGoingPromise.then(this._finalize,this._finalize):this._finalize()}};b.prototype._peekByCenterFirst=function(){if(!this.state)throw Error("state not set");var a=this.tileInfoView,b=this.state.center,
c=Number.POSITIVE_INFINITY,d=null;this._queue.forEach(function(e){a.getTileCoords(f,e);var g=k.distance(f,b);g<c&&(c=g,d=e)});return d.id};return b}();d.default=c});