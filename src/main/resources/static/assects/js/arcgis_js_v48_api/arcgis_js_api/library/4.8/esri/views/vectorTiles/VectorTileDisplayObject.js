// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/ObjectPool ../../core/libs/gl-matrix/mat4 ../../core/libs/gl-matrix/vec2 ../../geometry/support/spatialReferenceUtils ../2d/engine/DisplayObject ../2d/tiling/enums ../2d/tiling/TileKey ./RenderBucket ../webgl/BufferObject".split(" "),function(B,C,t,u,v,w,x,y,n,z,q,g){var A="fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer".split(" ");
return function(p){function h(){for(var b,d=[],f=0;f<arguments.length;f++)d[f]=arguments[f];f=p.call(this)||this;f._renderBuckets=[];f._vectorTileData=null;f._symbolUpdateData=null;f.status=n.TileStatus.INITIALIZED;f.coords=[0,0];f.bounds=[0,0,0,0];f.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]};f.stencilData={mask:0,reference:0};f.status=n.TileStatus.INITIALIZED;f.tileTransform.transform=v.create();f.tileTransform.displayCoord=w.create();0<d.length&&(b=f.acquire).call.apply(b,
[f].concat(d));return f}t(h,p);h.prototype.reset=function(){z.pool.release(this.key);this.refKey=this.key=null;this.coords[0]=0;this.coords[1]=0;this.bounds[0]=0;this.bounds[1]=0;this.bounds[2]=0;this.height=this.width=this.bounds[3]=0;this.resolution=null;this.rotation=0;this.id=this.client=this.styleLayers=this._vectorTileData=null;this.tileTransform.transform.fill(0);this.tileTransform.displayCoord.fill(0);this.stencilData.mask=0;this.stencilData.reference=0;this._renderBuckets.length=0;this._symbolUpdateData=
null;this.status=n.TileStatus.INITIALIZED};h.prototype.acquire=function(b,d,f,a,l){this.key=b;this.refKey=d;d=f.lodAt(b.level).resolution;var c=f.size[0]*d,e=f.origin,k=b.col*c,g=b.row*c,m=f.spatialReference,h=0;m&&(m._isWrappable?m._isWrappable():m.isWrappable)&&(m=x.getInfo(m),h=m.valid[1]-m.valid[0]);k=e.x+k+b.world*h;e=e.y-g;this.coords[0]=k;this.coords[1]=e;this.bounds[0]=k;this.bounds[1]=e;this.bounds[2]=k+c;this.bounds[3]=e-c;this.widthInPixels=f.size[1];this.coordRange=4096;this.resolution=
d;this.rotation=l;this.styleLayers=a;this.id=b.id};h.prototype.setData=function(b,d){this._vectorTileData=b;this.client=d;b&&b.bufferDataInfo||(this.status=n.TileStatus.NO_DATA)};h.prototype.updateSymbolData=function(b){b&&(this._symbolUpdateData=b,this.requestRender())};h.prototype.dispose=function(){this.fillVertexArrayObject&&(this.fillVertexArrayObject.dispose(),this.fillVertexArrayObject=null);this.fillDDVertexArrayObject&&(this.fillDDVertexArrayObject.dispose(),this.fillDDVertexArrayObject=
null);this.outlineVertexArrayObject&&(this.outlineVertexArrayObject.dispose(),this.outlineVertexArrayObject=null);this.outlineDDVertexArrayObject&&(this.outlineDDVertexArrayObject.dispose(),this.outlineDDVertexArrayObject=null);this.lineVertexArrayObject&&(this.lineVertexArrayObject.dispose(),this.lineVertexArrayObject=null);this.lineDDVertexArrayObject&&(this.lineDDVertexArrayObject.dispose(),this.lineDDVertexArrayObject=null);this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=
null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null);this.circleVertexArrayObject&&(this.circleVertexArrayObject.dispose(),this.circleVertexArrayObject=null);this.fillVertexBuffer&&(this.fillVertexBuffer.dispose(),this.fillVertexBuffer=null);
this.fillDDVertexBuffer&&(this.fillDDVertexBuffer.dispose(),this.fillDDVertexBuffer=null);this.fillIndexBuffer&&(this.fillIndexBuffer.dispose(),this.fillIndexBuffer=null);this.outlineVertexBuffer&&(this.outlineVertexBuffer.dispose(),this.outlineVertexBuffer=null);this.outlineDDVertexBuffer&&(this.outlineDDVertexBuffer.dispose(),this.outlineDDVertexBuffer=null);this.outlineIndexBuffer&&(this.outlineIndexBuffer.dispose(),this.outlineIndexBuffer=null);this.lineVertexBuffer&&(this.lineVertexBuffer.dispose(),
this.lineVertexBuffer=null);this.lineDDVertexBuffer&&(this.lineDDVertexBuffer.dispose(),this.lineDDVertexBuffer=null);this.lineIndexBuffer&&(this.lineIndexBuffer.dispose(),this.lineIndexBuffer=null);this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.textVertexBuffer&&(this.textVertexBuffer.dispose(),
this.textVertexBuffer=null);this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null);this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null);this.circleVertexBuffer&&(this.circleVertexBuffer.dispose(),this.circleVertexBuffer=null);this.circleIndexBuffer&&(this.circleIndexBuffer.dispose(),this.circleIndexBuffer=null);this.texture&&(this.texture.dispose(),this.texture=null);this._renderBuckets.length=0;this.status=n.TileStatus.INITIALIZED};h.prototype.getCpuMemoryUsage=
function(){return null!=this._vectorTileData&&this._vectorTileData.bufferData?this._vectorTileData.bufferData.reduce(function(b,d){return b+d.byteLength},0)+this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength:0};h.prototype.getGpuMemoryUsage=function(){var b=this,d=A.reduce(function(d,a){return b[a]?d+b[a].size:d},0);this.texture&&(d+=this.texture.descriptor.width*this.texture.descriptor.height*4);return d};h.prototype.attach=function(b){if(this.status!==
n.TileStatus.INITIALIZED)return!0;if(0===this._renderBuckets.length)for(var d=new Uint32Array(this._vectorTileData.bucketDataInfo),f=d.length,a=0;a<f;){var l=d[a],c=d[a+1];if(0===c)c=new q.BackgroundRenderBucket,c.layerID=l,this._renderBuckets.push(c),a+=2;else if(1===c)c=new q.FillRenderBucket,c.layerID=l,c.triangleElementStart=d[a+2],c.triangleElementCount=d[a+3],c.outlineElementStart=d[a+4],c.outlineElementCount=d[a+5],this._renderBuckets.push(c),a+=6;else if(2===c)c=new q.LineRenderBucket,c.layerID=
l,c.triangleElementStart=d[a+2],c.triangleElementCount=d[a+3],this._renderBuckets.push(c),a+=4;else if(3===c){c=new q.SymbolRenderBucket;c.layerID=l;c.isSDF=0!==d[a+2];var e=a+3,l=d[e];e++;if(0<l)for(var k=void 0,r=void 0,m=void 0,h=0;h<l;h++)k=d[e],r=d[e+1],m=d[e+2],c.markerPerPageElementsMap.set(k,[r,m]),e+=3;var p=d[e];e++;if(0<p)for(m=r=k=void 0,h=0;h<p;h++)k=d[e],r=d[e+1],m=d[e+2],c.glyphPerPageElementsMap.set(k,[r,m]),e+=3;this._renderBuckets.push(c);a+=5+3*l+3*p}else 4===c?(c=new q.CircleRenderBucket,
c.layerID=l,c.triangleElementStart=d[a+2],c.triangleElementCount=d[a+3],this._renderBuckets.push(c),a+=4):console.error("Bad bucket type!")}b=b.context;d=new Uint32Array(this._vectorTileData.bufferDataInfo);f=d.length;for(c=a=0;c<f;c+=2,a++)if(!(0>=d[c+1]||0===this._vectorTileData.bufferData[a].byteLength))switch(d[c]){case 1:this.fillVertexBuffer?this.fillVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.fillVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;
case 2:this.fillDDVertexBuffer?this.fillDDVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.fillDDVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 3:this.fillIndexBuffer?this.fillIndexBuffer.setData(this._vectorTileData.bufferData[a]):this.fillIndexBuffer=g.createIndex(b,35044,this._vectorTileData.bufferData[a]);break;case 4:this.outlineVertexBuffer?this.outlineVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.outlineVertexBuffer=g.createVertex(b,
35044,this._vectorTileData.bufferData[a]);break;case 5:this.outlineDDVertexBuffer?this.outlineDDVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.outlineDDVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 6:this.outlineIndexBuffer?this.outlineIndexBuffer.setData(this._vectorTileData.bufferData[a]):this.outlineIndexBuffer=g.createIndex(b,35044,this._vectorTileData.bufferData[a]);break;case 7:this.lineVertexBuffer?this.lineVertexBuffer.setData(this._vectorTileData.bufferData[a]):
this.lineVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 8:this.lineDDVertexBuffer?this.lineDDVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.lineDDVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 9:this.lineIndexBuffer?this.lineIndexBuffer.setData(this._vectorTileData.bufferData[a]):this.lineIndexBuffer=g.createIndex(b,35044,this._vectorTileData.bufferData[a]);break;case 10:this.iconVertexBuffer?this.iconVertexBuffer.setData(this._vectorTileData.bufferData[a]):
this.iconVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 11:this.iconDDVertexBuffer?this.iconDDVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.iconDDVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 12:this.iconIndexBuffer?this.iconIndexBuffer.setData(this._vectorTileData.bufferData[a]):this.iconIndexBuffer=g.createIndex(b,35044,this._vectorTileData.bufferData[a]);break;case 13:this.textVertexBuffer?this.textVertexBuffer.setData(this._vectorTileData.bufferData[a]):
this.textVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 14:this.textDDVertexBuffer?this.textDDVertexBuffer.setData(this._vectorTileData.bufferData[a]):this.textDDVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 15:this.textIndexBuffer?this.textIndexBuffer.setData(this._vectorTileData.bufferData[a]):this.textIndexBuffer=g.createIndex(b,35044,this._vectorTileData.bufferData[a]);break;case 16:this.circleVertexBuffer?this.circleVertexBuffer.setData(this._vectorTileData.bufferData[a]):
this.circleVertexBuffer=g.createVertex(b,35044,this._vectorTileData.bufferData[a]);break;case 17:this.circleIndexBuffer?this.circleIndexBuffer.setData(this._vectorTileData.bufferData[a]):this.circleIndexBuffer=g.createIndex(b,35044,this._vectorTileData.bufferData[a])}this._vectorTileData=null;this.status=n.TileStatus.READY;return!0};h.prototype.detach=function(b){this.client&&this.status!==n.TileStatus.INVALID&&this.status!==n.TileStatus.INITIALIZED&&this.client.invoke("destructTileData",this.id);
this.dispose();p.prototype.detach.call(this,b)};h.prototype.doRender=function(b){if(this.visible&&this.status===n.TileStatus.READY){var d=b.context,f=b.renderer;if(d&&f){var a=b.drawphase;this._symbolUpdateData&&this._updateSymbolData(b);d.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var l=this.styleLayers,c=void 0!==b.layerOpacity?b.layerOpacity:1;if(0!==c){var e,k=this._renderBuckets.length,g=0;if(0===a)for(g=k-1;0<=g;g--)e=this._renderBuckets[g],3!==e.type&&4!==e.type&&
e.hasData()&&f.renderBucket(d,e,b.displayLevel,b.requiredLevel,a,this,l.layers[e.layerID],c);else for(g=0;g<k;g++)e=this._renderBuckets[g],e.hasData()&&f.renderBucket(d,e,b.displayLevel,b.requiredLevel,a,this,l.layers[e.layerID],c)}}}};h.prototype._updateSymbolData=function(b){if(!this._symbolUpdateData.bucketDataInfo)return!0;var d=new Uint32Array(this._symbolUpdateData.bucketDataInfo),f=d.length;if(0===f)return this._symbolUpdateData=null,!0;if(this.status!==n.TileStatus.READY)return this.requestRender(),
!1;b=b.context;for(var a=new Uint32Array(this._symbolUpdateData.bufferDataInfo),l=a.length,c=0,e=0;e<l;e+=2,c++)switch(a[e]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconVertexBuffer=g.createVertex(b,35044,this._symbolUpdateData.bufferData[c]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconDDVertexBuffer=g.createVertex(b,35044,this._symbolUpdateData.bufferData[c]);break;case 12:this.iconIndexBuffer&&
(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.iconIndexBuffer=g.createIndex(b,35044,this._symbolUpdateData.bufferData[c]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null);this.textVertexBuffer=g.createVertex(b,35044,this._symbolUpdateData.bufferData[c]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null);this.textDDVertexBuffer=g.createVertex(b,35044,this._symbolUpdateData.bufferData[c]);
break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=g.createIndex(b,35044,this._symbolUpdateData.bufferData[c])}b=this._renderBuckets.length;for(a=0;a<b;a++)this._renderBuckets[a]instanceof q.SymbolRenderBucket&&(l=this._renderBuckets[a],l.markerPerPageElementsMap.clear(),l.glyphPerPageElementsMap.clear());for(b=0;b<f;){l=d[b];c=-1;e=this._renderBuckets.length;for(a=0;a<e;a++)if(this._renderBuckets[a].layerID===l){c=a;break}a=this._renderBuckets[c];
a||(a=new q.SymbolRenderBucket,a.layerID=l,a.isSDF=0!==d[b+2],this._renderBuckets.push(a));var k=b+3,l=d[k];k++;if(0<l)for(var h=e=c=void 0,m=0;m<l;m++)c=d[k],e=d[k+1],h=d[k+2],a.markerPerPageElementsMap.set(c,[e,h]),k+=3;var p=d[k];k++;if(0<p)for(h=e=c=void 0,m=0;m<p;m++)c=d[k],e=d[k+1],h=d[k+2],a.glyphPerPageElementsMap.set(c,[e,h]),k+=3;b+=5+3*l+3*p}this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),
this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null);this._symbolUpdateData=null;return!0};h.pool=new u(h);return h}(y)});