// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../geometry/support/aaBoundingBox ../../lib/ComponentUtils ../../lib/doublePrecisionUtils ../../lib/gl-matrix ../../lib/screenSizePerspectiveUtils ../../lib/Util ../../../../webgl/Util".split(" "),function(ga,g,C,K,aa,m,L,H,ba){function z(a,b,d,c,e,f){if(void 0===e||3!==f)for(e=0;e<f;++e)d[c+e]=a[b+e];else{var t=a[b],l=a[b+1];a=a[b+2];d[c]=e[0]*t+e[4]*l+e[8]*a+e[12];d[c+1]=e[1]*t+e[5]*l+e[9]*a+e[13];d[c+2]=e[2]*t+e[6]*l+e[10]*a+e[14]}return f}function M(a,b,d,c,
e,f){for(var t=a.length,l=0;l<t;++l){for(var q=d*a[l],g=0;g<d;++g)c[e+g]=b[q+g];e+=f}}function N(a,b,d,c,e,f){c=new Uint8Array(c);e*=4;f*=4;var g=a.length;if(4===d)for(d=0;d<g;++d){var l=4*a[d];c[e]=b[l];c[e+1]=b[l+1];c[e+2]=b[l+2];c[e+3]=b[l+3];e+=f}else if(3===d)for(d=0;d<g;++d)l=3*a[d],c[e]=b[l],c[e+1]=b[l+1],c[e+2]=b[l+2],c[e+3]=255,e+=f}function O(a,b,d,c,e){var f=P(b,d,Q);C.setMin(A,a.getBBMin());C.setMax(A,a.getBBMax());if(G(A,b,f,c)){var f=a.getPrimitiveIndices(),g=a.getIndices(),l=a.getPosition(),
q=f?f.length:g.length/3;if(q>ca&&(a=a.getChildren(),void 0!==a)){for(f=0;8>f;++f)void 0!==a[f]&&O(a[f],b,d,c,e);return}J(b,d,0,q,g,l,f,e)}}function J(a,b,d,c,e,f,g,l){var q=f.data,m=f.offsetIdx;f=f.strideIdx;var n=a[0],k=a[1];a=a[2];var h=b[0]-n,t=b[1]-k;for(b=b[2]-a;d<c;d++){var p=g?g[d]:d,u=m+f*e[3*p],x=m+f*e[3*p+1],r=m+f*e[3*p+2],v=q[u],w=q[u+1],y=q[u+2],u=q[x]-v,z=q[x+1]-w,x=q[x+2]-y,A=q[r]-v,C=q[r+1]-w,r=q[r+2]-y,B=t*r-C*b,E=b*A-r*h,G=h*C-A*t,D=u*B+z*E+x*G,v=n-v,F=k-w,I=a-y,w=F*x-z*I,y=I*u-x*
v,H=v*z-u*F;if(D>R){B=v*B+F*E+I*G;if(0>B||B>D)continue;E=h*w+t*y+b*H;if(0>E||B+E>D)continue}else if(D<-R){B=v*B+F*E+I*G;if(0<B||B<D)continue;E=h*w+t*y+b*H;if(0<E||B+E<D)continue}else continue;D=(A*w+C*y+r*H)/D;0<=D&&(u=S(u,z,x,A,C,r,da),l(D,u,p))}}function S(a,b,d,c,e,f,g){m.vec3d.set3(a,b,d,T);m.vec3d.set3(c,e,f,U);return m.vec3d.normalize(m.vec3d.cross(T,U,g))}function P(a,b,d){return m.vec3d.set3(1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]),d)}function G(a,b,d,c){var e=(a[0]-c-b[0])*d[0],f=(a[3]+
c-b[0])*d[0],g=Math.min(e,f),e=Math.max(e,f),f=(a[1]-c-b[1])*d[1],l=(a[4]+c-b[1])*d[1],g=Math.max(g,Math.min(f,l)),e=Math.min(e,Math.max(f,l));if(g>e)return!1;f=(a[2]-c-b[2])*d[2];a=(a[5]+c-b[2])*d[2];g=Math.max(g,Math.min(f,a));e=Math.min(e,Math.max(f,a));return g<=e}function V(a,b){b=b?V(b):{};for(var d in a){var c=a[d];c&&c.forEach&&(c=ea(c));null==c&&d in b||(b[d]=c)}return b}function ea(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(g,"__esModule",{value:!0});
var W=m.mat4d.create(),A=C.create(),F=H.VertexAttrConstants;g.IDENTITY=m.mat4d.identity();g.fill=z;g.fillColor=function(a,b,d,c,e){for(var f=0;f<e;++f)d[c+f]=a[b+f];return e};g.fillInterleaved=function(a,b,d,c,e,f,g,l){for(var q=ba.getStride(e)/4,m=0;m<e.length;m++){var n=e[m],k=g+n.offset/4,n=n.name,h=a.vertexAttr[n];if(null!=h&&(null==l||null!=l[n]))switch(n){case "uv0":M(a.indices[n],h.data,h.size,f,k,q);break;case "region":for(var n=a.indices[n],t=h.data,p=h.size,h=q,u=new Uint16Array(f.buffer),
k=2*k,h=2*h,x=n.length,r=0;r<x;++r){for(var v=p*n[r],w=0;w<p;++w)u[k+w]=t[v+w];k+=h}break;case "color":if(c&&c.color)if(n=a.indices[n],t=h.data,p=c.color,r=h.size,h=q,u=new Uint8Array(f.buffer),k*=4,h*=4,x=n.length,4===r)for(r=0;r<x;++r)v=4*n[r],u[k]=t[v]*p[0],u[k+1]=t[v+1]*p[1],u[k+2]=t[v+2]*p[2],u[k+3]=t[v+3]*p[3],k+=h;else{if(3===r)for(w=255*p[3],r=0;r<x;++r)v=3*n[r],u[k]=t[v]*p[0],u[k+1]=t[v+1]*p[1],u[k+2]=t[v+2]*p[2],u[k+3]=w,k+=h}else N(a.indices[n],h.data,h.size,f.buffer,k,q);break;case "symbolColor":N(a.indices[n],
h.data,h.size,f.buffer,k,q);break;default:if(p=n===F.POSITION?b:n===F.NORMAL?d:void 0,void 0!==p&&3===h.size)for(n=a.indices[n],t=h.data,h=f,u=q,x=n.length,r=0;r<x;++r){var y=3*n[r],v=t[y],w=t[y+1],y=t[y+2];h[k]=p[0]*v+p[4]*w+p[8]*y+p[12];h[k+1]=p[1]*v+p[5]*w+p[9]*y+p[13];h[k+2]=p[2]*v+p[6]*w+p[10]*y+p[14];k+=u}else M(a.indices[n],h.data,h.size,f,k,q)}}};g.triangleVertexArrayToWireframeLines=function(a,b,d,c){for(d=Math.floor(d/3)-1;0<=d;d--){var e=b+3*d*c,f=b+6*d*c+5*c;z(a,e,a,f,null,c);f-=c;z(a,
e+c,a,f,null,c);f-=c;z(a,e+c,a,f,null,c);f-=c;z(a,e+2*c,a,f,null,c);f-=c;z(a,e+2*c,a,f,null,c);f-=c;z(a,e,a,f,null,c)}};g.intersectTriangleGeometry=function(a,b,d,c,e,f,g){H.assert("triangle"===a.data.primitiveType);b=b&&b.componentVisibilities;c=c.tolerance;if(1<a.getComponentCount()){d=P(e,f,Q);var l=a.getBoundingInfo();C.setMin(A,l.getBBMin());C.setMax(A,l.getBBMax());if(G(A,e,d,c))for(var q=a.data,l=a.getComponentCount(),m=q.getIndices(F.POSITION),n=q.getAttribute(F.POSITION),q=q.componentOffsets,
k=0;k<l;k++)if(!b||K.getVisibility(b,k)){var h=a.getComponentAABB(k,A);G(h,e,d,c)&&J(e,f,q[k]/3,q[k+1]/3,m,n,void 0,g)}}else b&&!K.getVisibility(b,0)||O(a.getBoundingInfo(),e,f,c,g)};var Q=m.vec3d.create(),R=Math.pow(2,-52),da=m.vec3d.create();g.intersectTriangles=J;var T=m.vec3d.create(),U=m.vec3d.create();g.computeNormal=S;g.intersectAabbInvDir=G;g.transformToWorld=function(a,b,d){return m.vec4d.set4(a[0]-b[0],a[1]-b[1],a[2]-b[2],1,d)};g.transformToView=function(a,b,d,c){m.mat4d.translate(d,b,W);
d=W;return m.mat4d.multiplyVec4(d,a,c)};g.transformToProjection=function(a,b,d,c){c[0]=a[0]+d[0];c[1]=a[1]+d[1];c[2]=a[2]+d[2];c[3]=a[3];return m.mat4d.multiplyVec4(b,c)};g.transformToNDC=function(a,b){return m.vec4d.scale(a,1/Math.abs(a[3]),b)};g.applyScreenSizePerspectiveScale=function(a,b,d,c,e){return L.scale(a,c,d,e)};g.verticalOffsetAtDistance=function(a,b,d,c,e){var f=d.screenLength||0;e&&(f=L.scale(f,c,b,e));return H.clamp(f*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,d.minWorldLength||0,null!=
d.maxWorldLength?d.maxWorldLength:Infinity)};g.aquireIfNotUndefined=function(a,b,d){if(void 0!==a)return b.aquire(a,d)};g.releaseIfNotUndefined=function(a,b){void 0!==a&&b.release(a)};var X=m.mat4.create();g.bindView=function(a,b,d){m.mat4d.translate(b,a,X);d.setUniform3fv("localOrigin",a);d.setUniformMatrix4fv("view",X)};g.bindCamPos=function(a,b,d){d.setUniform3f("camPos",b[3]-a[0],b[7]-a[1],b[11]-a[2])};var Y=m.vec3d.create(),Z=m.vec3d.create();g.bindViewOriginDouble=function(a,b){aa.encodeDoubleArraySplit(a,
Y,Z,3);b.setUniform3fv("viewOriginHi",Y);b.setUniform3fv("viewOriginLo",Z)};g.bindVerticalOffset=function(a,b,d){if(a){var c=b.fovY;b=b.viewport[3];var e=void 0;void 0===e&&(e=fa);e.screenLength=a.screenLength;e.perDistance=Math.tan(.5*c)/(.5*b);e.minWorldLength=a.minWorldLength;e.maxWorldLength=a.maxWorldLength;a=e;d.setUniform4f("verticalOffset",a.screenLength,a.perDistance,a.minWorldLength,a.maxWorldLength)}};g.bindScreenSizePerspective=function(a,b,d){void 0===d&&(d="screenSizePerspectiveAlignment");
if(a){var c=a.parameters;b.setUniform4f(d,c.divisor,c.offset,c.minPixelSize,a.paddingPixelsOverride)}};g.copyParameters=V;g.updateParameters=function(a,b){var d=!1,c;for(c in b){var e=b[c];void 0!==e&&(d=!0,Array.isArray(e)?a[c]=e.slice():a[c]=e)}return d};g.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ca=1E3,fa={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});