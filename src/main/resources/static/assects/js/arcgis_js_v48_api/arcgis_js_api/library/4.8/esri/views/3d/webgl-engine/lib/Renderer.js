// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/iteratorUtils ./ComponentUtils ./DefaultVertexAttributeLocations ./ExternalRendererContainer ./Float32ArrayList ./FxaaRenderPass ./gl-matrix ./HighlightTextureHelper ./InstanceBufferData ./IntervalUtilities ./LinearDepthTextureHelper ./NormalTextureHelper ./RenderContext ./RenderPass ./RenderSlot ./SmaaRenderPass ./StencilRenderingHelper ./Util ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../../../webgl/BufferObject ../../../webgl/Profiling ../../../webgl/Texture ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),
function(X,sa,U,Y,R,da,Z,ea,S,fa,ga,aa,ha,ia,ja,x,p,ka,la,B,ba,ma,na,O,oa,ca,D,P){function T(e){return e.instanceParameters.hidden?[]:Y.generateVisibleIndexRanges(e.instanceParameters.componentVisibilities,e.componentOffsets)}function V(e,a,b){var d=e.origin.vec3;B.setMatrixTranslation3(K,-d[0],-d[1],-d[2]);C.multiply(K,e.transformation,a);C.inverse(a,b);C.transpose(b)}function F(e,a,b){for(var d in e){var c=e[d];a(d,c);c.origin2data.forEach(function(a,c){b(c,a)})}}function L(e){return!1===e.preinterleaved?
B.getFirstObjectValue(e.indices).length:e.indexCount}X=S.vec2d;var C=S.mat4d,M=C.identity();S=function(){function e(a,b,d,c,h){this._lighting=new ma.SceneLighting;this._mat2DataMerged={};this._mat2DataInstanced={};this._mat2DataPreinterleaved={};this._renderOrder=[];this._externalRenderers=new da;this._renderContext=new ja;this._isRendering=!1;this._highlights=[];this._pixelRatio=1;this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=null;this._stats=new pa;this._edgeView=null;
this.ssaoEnabled=this._edgeViewLoaded=!1;this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._orderedRendering=h;this._rctx=c;this._fxaaPass=new ea(c);this._smaaPass=new ka(c);this._renderContext.rctx=c;this._renderContext.lightingData=this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,
fovY:0,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null};this._linearDepthTextureHelper=new ha(c);this._normalTextureHelper=new ia(c);this._highlightTextureHelper=new fa(c);this._stencilRenderingHelper=new la(c);this._initializeFramebufferTexture()}e.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?a.RGBA:a.RGB,b=new ca(this._rctx,{target:3553,pixelFormat:a,
dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}};e.prototype.dispose=function(){var a=this,b=function(b){a._releaseMaterials(b)},d=function(a,b){if(b.type===r.Preinterleaved)for(var c in b.instances)b.instances[c].vao.dispose(!0);else b.vao.dispose(!0)};F(this._mat2DataMerged,b,d);F(this._mat2DataInstanced,b,d);F(this._mat2DataPreinterleaved,b,d);this._mat2DataPreinterleaved=this._mat2DataInstanced=this._mat2DataMerged=null;this._framebuffer.texture.dispose();
this._framebuffer.texture=null;this._linearDepthTextureHelper.enabled=!1;this._normalTextureHelper.enabled=!1;this._highlightTextureHelper.enabled=!1;this._stencilRenderingHelper.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)};Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,
"edgeView",{get:function(){var a=this;this._edgeViewLoaded||(this._edgeViewLoaded=!0,ba.EdgeView.isSupported(this._rctx)&&(this._edgeView=new ba.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){a._needsRender=!0}}),this._edgeView.initialize()));return this._edgeView},enumerable:!0,configurable:!0});e.prototype.setLighting=function(a){this._lighting.set(a)};e.prototype.setPixelRatio=function(a){this._pixelRatio=a;this._needsRender=!0};e.prototype.getPixelRatio=function(){return this._pixelRatio};
e.prototype.addExternalRenderer=function(a,b){this._externalRenderers.addRenderer(a,b);return!0};e.prototype.removeExternalRenderer=function(a){this._externalRenderers.removeRenderer(a);return!0};e.prototype.getExternalRenderers=function(){return this._externalRenderers};e.prototype.resetNeedsRender=function(){this._needsRender=!1;this._externalRenderers.resetNeedsRender()};e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()};e.prototype.getCombinedStats=
function(){var a=this;this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;var b=function(){},d=function(b,d){if(d.type===r.Preinterleaved)for(var c in d.instances)b=d.instances[c].vao.size,a._stats.VBOallocatedSize+=b/4,a._stats.VBOusedSize+=b/4,a._stats.VBOoptimalSize+=b/4;else a._stats.VBOallocatedSize+=d.buffer.getArray().length,a._stats.VBOusedSize+=d.buffer.getSize(),a._stats.VBOoptimalSize+=d.optimalCount};F(this._mat2DataMerged,b,d);F(this._mat2DataInstanced,
b,d);F(this._mat2DataPreinterleaved,b,d);this._stats.VBOallocatedSize*=.00390625;this._stats.VBOusedSize*=.00390625;this._stats.VBOoptimalSize*=.00390625;return this._stats};e.prototype._addHighlight=function(a){var b=this._getInstance(a);if(null===b)console.error("No instance found for RenderGeometry {name: '"+a.name+"', uniqueName: '"+a.uniqueName+"'}");else if(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights)};
e.prototype._removeHighlight=function(a){var b=this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});if(b!==this._highlights.length){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights);this._needsRender=!0}};Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,configurable:!0});e.prototype._renderHUDVisibility=function(a){var b=this,d=na.shouldRenderVisibilityDuringRenderPass(a.pass),
c=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.enabled,h=!1;d&&c&&a.offscreenRenderingHelper.renderHUDVisibility(function(){h=b._renderInternalSlot(p.OCCLUSION_PIXELS,a)});return h};e.prototype.renderGeometrySlotsPt1=function(a){this._externalRenderers.render(p.INTERNAL_MATERIAL,a);this._renderInternalSlot(p.STENCIL_MATERIAL,a);this._externalRenderers.render(p.OPAQUE_TERRAIN,a);this._renderInternalSlot(p.OPAQUE_MATERIAL,a);this._externalRenderers.render(p.OPAQUE_EXTERNAL,a);a.ssaoHelper&&
a.ssaoHelper.bindAll(this._programRep);this._externalRenderers.render(p.POSTPROCESSING_ATMOSPHERE_OPAQUE,this._renderContext);this._renderInternalSlot(p.TRANSPARENT_MATERIAL,a);this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(a),this._renderInternalSlot(p.LINE_CALLOUTS,this._renderContext));this._externalRenderers.render(p.TRANSPARENT_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep)};e.prototype.renderTransparentTerrain=function(a){return this._externalRenderers.render(p.TRANSPARENT_TERRAIN,
a)};e.prototype.renderGeometrySlots=function(a){this.renderGeometrySlotsPt1(a);this.renderTransparentTerrain(a)};e.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this._renderInternalSlot(p.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL2,this._renderContext)};e.prototype._renderHighlights=function(a,b,d){var c=!!d&&d.enabled&&(this.hasHighlights||this._externalRenderers.needsHighlight());
if(this._highlightTextureHelper.enabled=c)c=null,d.profilingCallback&&(c=oa.startMeasurement(this._renderContext.rctx)),this._highlightTextureHelper.setupFBOs(a),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(x.MATERIAL_HIGHLIGHT,a,null,null),this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT),this.renderHUD("both"),this._highlightTextureHelper.finish(b),d.render(a,b,this._highlightTextureHelper.framebuffer),null!==c&&d.profilingCallback&&c.stop(function(a){d.profilingCallback&&
d.profilingCallback(a)})};e.prototype._needsRenderOccluded=function(a){for(var b in this._mat2DataInstanced){var d=this._mat2DataInstanced[b][0];if(d&&d.renderOccluded&&d.beginSlot(a)&&d.isVisible())return!0}return!1};e.prototype._renderOccluded=function(a,b,d){if(b&&d&&d.enabled){var c=this._needsRenderOccluded(p.OPAQUE_MATERIAL)||this._needsRenderOccluded(p.TRANSPARENT_MATERIAL);if(b.enabled=c)c=this._renderContext,b.setupFBOs(a),b.prepareColorPass(),c.pass=x.MATERIAL,c.renderOccludedOnly=!0,this._renderInternalSlot(p.OPAQUE_MATERIAL,
c),this._renderInternalSlot(p.TRANSPARENT_MATERIAL,c),c.renderOccludedOnly=!1,b.finish(d.framebuffer),b.apply()}};e.prototype._renderUnordered=function(a,b,d,c){var h=this,f=this._rctx;this._isRendering=!0;this._stats.reset();this._updateGlobalUniforms(a.projectionMatrix);this._renderContext.pass=x.MATERIAL;this._renderContext.camera=a;this._renderContext.pixelRatio=this._pixelRatio;this._renderContext.shadowMap=b;this._renderContext.ssaoHelper=c.ssao;this._renderContext.offscreenRenderingHelper=
c.offscreenRendering;this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper;this._renderContext.depth=this._linearDepthTextureHelper.framebuffer;this._renderContext.normals=this._normalTextureHelper.framebuffer;this._renderContext.highlight=this._highlightTextureHelper.framebuffer;this._renderContext.options=this.renderOptions;c.offscreenRendering.enabled=!0;c.offscreenRendering.initializeFrame(a);this._externalRenderers.render(p.BACKGROUND,this._renderContext);this.renderGeometrySlotsPt1(this._renderContext);
this._edgeView&&this.edgeView.shouldRender()&&c.offscreenRendering.renderSeparateAndComposite(function(){h._edgeView.render(h._bindParameters)},void 0,"alpha");var e=b=!1;this.renderOptions.earlyOcclusionPixelDraw||(b=this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(p.LINE_CALLOUTS,this._renderContext));(e=this.renderTransparentTerrain(this._renderContext))&&b&&(c.offscreenRendering.compositeTransparentTerrainOntoHUDVisibility(),c.offscreenRendering.renderToTargets(function(){return h.renderHUD("occluded")},
c.offscreenRendering.mainColor,c.offscreenRendering.tmpDepth,void 0,!0));e&&c.offscreenRendering.compositeTransparentTerrainOntoMain();c.offscreenRendering.renderToTargets(function(){h._externalRenderers.render(p.POSTPROCESSING_ATMOSPHERE_TRANSPARENT,h._renderContext);h._externalRenderers.render(p.POSTPROCESSING_EXTERNAL,h._renderContext);h._renderOccluded(a,c.renderOccluded,c.offscreenRendering)},c.offscreenRendering.mainColor,c.offscreenRendering.mainDepth);b=this.renderOptions.antialiasing;"smaa"===
b&&this._smaaPass.loadResources(function(){h._needsRender=!0});"smaa"===b&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:c.offscreenRendering.colorTexture},null)):"fxaa"===b&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:c.offscreenRendering.colorTexture},null)):(c.offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable());f.bindFramebuffer(null);this._renderContext.framebufferTex=c.offscreenRendering.colorTexture;
this.renderHUD("notOccluded");this._renderHighlights(a,d,c.highlight);this._isRendering=!1};e.prototype._renderGeometryPassOrderedHighlight=function(a){this._renderInternalHighlights(this._highlights)};e.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var h=c.instanced||c.merged,f=h[a.pass];f&&f.isVisible()&&(this._renderInternalInstanced(h,f,this._bindParameters,Infinity),b=null)}c.merged&&(h=
c.merged,(f=h[a.pass])&&f.isVisible()&&(c=f.getProgram(),c!==b&&(c.setUniformMatrix4fv("model",M),c.hasUniform("modelNormal")&&c.setUniformMatrix4fv("modelNormal",M)),b=c,this._renderInternalMerged(h,f,this._bindParameters,Infinity)))}};e.prototype._renderGeometryPassOrdered=function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;J[0]=b.near;J[1]=b.far;this._bindParameters.nearFar=
J;this._bindParameters.lightingData=a.lightingData;this._bindParameters.viewport=b.fullViewport;this._bindParameters.framebufferTex=this._framebuffer.texture;this._bindParameters.pixelRatio=a.pixelRatio;a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):this._renderGeometryPassOrderedMaterial(a)};e.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,b)};e.prototype.prepareRender=function(a){this._externalRenderers.prepareRender(a);this._renderContext.rctx.setDepthFunction(513)};
e.prototype.render=function(a,b,d){this._orderedRendering?this._renderOrdered(x.MATERIAL,a):this._renderUnordered(a,d.shadowMap,b,d)};e.prototype.renderAuxiliaryBuffers=function(a,b,d){var c=d.ssao;d=d.shadowMap;var h=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();if(this._linearDepthTextureHelper.enabled=h)this._linearDepthTextureHelper.setupFBOs(a),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(x.MATERIAL_DEPTH,a,d,c),this._linearDepthTextureHelper.finish(b);
if(this._normalTextureHelper.enabled=this.ssaoEnabled)this._normalTextureHelper.setupFBOs(a),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(x.MATERIAL_NORMAL,a,d,c),this._normalTextureHelper.finish(b);this.ssaoEnabled&&c.computeSSAO(a,b,this._linearDepthTextureHelper.framebuffer,this._normalTextureHelper.framebuffer);c.bindAll(this._programRep)};e.prototype.renderGeometryPass=function(a,b,d,c){this._isRendering=!0;this._updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=
a;this._renderContext.camera=b;this._renderContext.pixelRatio=this._pixelRatio;this._renderContext.shadowMap=d;this._renderContext.ssaoHelper=c;this._renderContext.depth=this._linearDepthTextureHelper.framebuffer;this._renderContext.normals=this._normalTextureHelper.framebuffer;this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext);this._isRendering=!1};e.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)};
e.prototype._renderInternalHighlights=function(a,b){void 0===b&&(b=null);for(var d=!1,c=0;c<a.length;++c){var h=a[c],f=h.matData[x.MATERIAL_HIGHLIGHT];f&&(null===b||f.beginSlot(b))&&f.isVisible()&&(d=this._renderInternalHighlight(h,this._bindParameters,x.MATERIAL_HIGHLIGHT)||d)}return d};e.prototype._renderInternalSlotOccluded=function(a,b){var d=!1,c;for(c in this._mat2DataInstanced){var h=this._mat2DataInstanced[c],f=h[b.pass];f&&f.renderOccluded&&f.beginSlot(a)&&f.isVisible()&&(d=this._renderInternalInstanced(h,
f,this._bindParameters,a)||d)}return d};e.prototype._renderInternalSlotMaterial=function(a,b){var d=!1,c;for(c in this._mat2DataInstanced){var h=this._mat2DataInstanced[c],f=h[b.pass];f&&f.beginSlot(a)&&f.isVisible()&&(d=this._renderInternalInstanced(h,f,this._bindParameters,a)||d)}for(var h=this._programRep.getProgramsUsingUniform("model"),f=this._programRep.getProgramsUsingUniform("modelNormal"),e=0;e<h.length;e++){var k=h[e];k.setUniformMatrix4fv("model",M);-1<f.indexOf(k)&&k.setUniformMatrix4fv("modelNormal",
M)}for(c in this._mat2DataMerged)h=this._mat2DataMerged[c],(f=h[b.pass])&&f.beginSlot(a)&&f.isVisible()&&(d=this._renderInternalMerged(h,f,this._bindParameters,a)||d);for(c in this._mat2DataPreinterleaved)h=this._mat2DataPreinterleaved[c],(f=h[b.pass])&&f.beginSlot(a)&&f.isVisible()&&(d=this._renderInternalPreinterleaved(h,f,this._bindParameters,a)||d);a===p.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish();return d};e.prototype._renderInternalSlotHighlights=function(a,b){return this._renderInternalHighlights(this._highlights,
a)};e.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;J[0]=b.camera.near;J[1]=b.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=J;this._bindParameters.lightingData=b.lightingData;this._bindParameters.viewport=
b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.colorTexture:null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.enabled;this._bindParameters.pixelRatio=b.pixelRatio;this._bindParameters.hudVisibilityTexture=d?d.hudVisibilityTexture:null;return b.isHighlightPass?this._renderInternalSlotHighlights(a,b):b.renderOccludedOnly?this._renderInternalSlotOccluded(a,
b):this._renderInternalSlotMaterial(a,b)};e.prototype._renderInternalInstanced=function(a,b,d,c){var h=this,f=this._rctx,e=f.gl,k=!1,g=b.getDrawMode(f),m=f.capabilities.instancing,n=!1;a.origin2data.forEach(function(a){d.origin=a.origin;c===p.STENCIL_MATERIAL&&(h._stencilRenderingHelper.enabled=!0,h._stencilRenderingHelper.prepareStencilWritePass());var y=!1;if(b.instanced)for(var l in a.perGeometryDataInfo){var t=a.perGeometryDataInfo[l];k||(b.bind(f,d),k=!0);f.bindVAO(t.vao);var E=b.getProgram();
D.assertCompatibleVertexAttributeLocations(t.vao,E);y||(b.bindView(f,d),y=!0);var E=t.to-t.from,r=t.refCount;g===e.TRIANGLES&&(h._stats.trianglesRendered+=r*E/3);m.drawArraysInstanced(g,t.from,E,r);n=!0;h._stats.drawCallsAngleInstanced++;h._stats.instancesDrawnAngle+=r}else for(t in l=a.instances,l)E=l[t],r=E.displayedIndexRange,r&&0===r.length||(k||(b.bind(f,d),k=!0),y||(f.bindVAO(a.vao),b.bindView(f,d),y=!0),b.bindInstance(f,E),h._stats.drawCallsInstanced++,g===e.TRIANGLES&&(h._stats.trianglesRendered+=
(E.to-E.from)/3),r?h._drawArraysFaceRange(r,E.from,g):f.drawArrays(g,E.from,E.to-E.from),n=!0)});f.bindVAO(null);k&&b.release(f,d);return n};e.prototype._renderInternalHighlight=function(a,b,d){var c=this._rctx,h=c.gl;d=a.matData[d];var f=d.getDrawMode(c),e=a.instance,k=e.highlightedIndexRange,g=this._renderContext.offscreenRenderingHelper,g=(g?g.depthTexture:null)||this._getFallbackDepthTexture(),m=d.getProgram(),n=c.capabilities.instancing;b.origin=a.originData.origin;var l=!1;if(d.instanced&&a.type===
r.Instanced)for(a=a.instancedVAO,d.bind(c,b),c.bindVAO(a),D.assertCompatibleVertexAttributeLocations(a,m),d.bindView(c,b),a=0;a<k.length;a++){var q=k[a],l=q.range?q.range[0]+e.from:e.from,q=q.range?q.range[1]-q.range[0]+1:e.to-e.from;c.bindTexture(g,5);m.setUniform1i("depthTex",5);m.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);n.drawArraysInstanced(f,l,q,1);f===h.TRIANGLES&&(this._stats.trianglesRendered+=1*q/3);this._stats.drawCallsHighlight++;
l=!0}else if(a.type===r.Instanced&&d.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{d.bind(c,b);d.bindView(c,b);n=null;switch(a.type){case r.Merged:q=a.originData;c.bindVAO(q.vao);m.setUniformMatrix4fv("model",M);break;case r.Instanced:q=a.originData;c.bindVAO(q.vao);d.bindInstance(c,e);break;case r.Preinterleaved:q=a.originData,a=q.instances[a.uniqueName].vao,c.bindVAO(a),d.bindInstance(c,e),n=a.indexBuffer&&a.indexBuffer.indexType}for(a=0;a<k.length;a++){q=
k[a];l=q.range?q.range[0]+e.from:e.from;q=q.range?q.range[1]-q.range[0]+1:e.to-e.from;c.bindTexture(g,5);d.getProgram().setUniform1i("depthTex",5);m.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);if(n){var qa=D.getBytesPerElement(n);c.drawElements(f,q,n,l*qa)}else c.drawArrays(f,l,q);f===h.TRIANGLES&&(this._stats.trianglesRendered+=q/3);this._stats.drawCallsHighlight++;l=!0}}c.bindVAO(null);d.release(c,b);return l};e.prototype._drawArraysFaceRange=
function(a,b,d){for(var c=this._rctx,h=0;h<a.length;h++){var f=a[h];c.drawArrays(d,f[0]+b,f[1]-f[0]+1)}this._stats.drawCallsFragmented+=a.length-1};e.prototype._drawElementsFaceRange=function(a,b,d,c){for(var h=this._rctx,f=D.getBytesPerElement(c),e=0;e<a.length;e++){var k=a[e];h.drawElements(d,k[1]-k[0]+1,c,(k[0]+b)*f)}this._stats.drawCallsFragmented+=a.length-1};e.prototype._renderInternalMerged=function(a,b,d,c){var h=this,f=this._rctx,e=f.gl,k=!1,g=!1;a.origin2data.forEach(function(a){d.origin=
a.origin;c===p.STENCIL_MATERIAL&&(h._stencilRenderingHelper.enabled=!0,h._stencilRenderingHelper.prepareStencilWritePass());if(!a.displayedIndexRange||0!==a.displayedIndexRange.length){g||(b.bind(f,d),g=!0);var y=b.getProgram();f.bindVAO(a.vao);D.assertCompatibleVertexAttributeLocations(a.vao,y);b.bindView(f,d);h._stats.drawCallsMerged++;y=b.getDrawMode(f);y===e.TRIANGLES&&(h._stats.trianglesRendered+=a.vao.vertexBuffers.geometry.size/3);a.displayedIndexRange?h._drawArraysFaceRange(a.displayedIndexRange,
0,y):f.drawArrays(y,0,D.vertexCount(a.vao,"geometry"));k=!0}});g&&b.release(f,d);return k};e.prototype._renderInternalPreinterleaved=function(a,b,d,c){var h=this,f=this._rctx,e=f.gl,k=!1,g=!1,m=b.getDrawMode(f);a.origin2data.forEach(function(a){d.origin=a.origin;var l=!1;c===p.STENCIL_MATERIAL&&(h._stencilRenderingHelper.enabled=!0,h._stencilRenderingHelper.prepareStencilWritePass());for(var y in a.instances){var n=a.instances[y],t=n.instance,r=n.vao,n=t.displayedIndexRange;if(!n||0!==n.length){g||
(b.bind(f,d),g=!0);var x=b.getProgram();D.assertCompatibleVertexAttributeLocations(r,x);f.bindVAO(r);l||(b.bindView(f,d),l=!0);b.bindInstance(f,t);h._stats.drawCallsPreinterleaved++;m===e.TRIANGLES&&(h._stats.trianglesRendered+=(t.to-t.from)/3);r=r.indexBuffer&&r.indexBuffer.indexType;n?r?h._drawElementsFaceRange(n,t.from,m,r):h._drawArraysFaceRange(n,t.from,m):r?(n=D.getBytesPerElement(r),f.drawElements(m,t.to-t.from,r,t.from*n)):f.drawArrays(m,t.from,t.to-t.from);k=!0}}});f.bindVAO(null);g&&b.release(f,
d);return k};e.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}};e.prototype.print=function(){var a=Object.keys(this._mat2DataMerged).length,
b=Object.keys(this._mat2DataInstanced).length,d=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+a+"/"+b+"/"+d);var c=0;F(this._mat2DataMerged,function(){},function(a,b){c+=Object.keys(b.instances).length});var h=0;F(this._mat2DataInstanced,function(){},function(a,b){h+=Object.keys(b.instances).length});var f=0;F(this._mat2DataPreinterleaved,function(){},function(a,b){f+=Object.keys(b.instances).length});console.log("number of instances (merged/instanced/preinterleaved): "+
c+"/"+h+"/"+f)};e.prototype.isEmpty=function(){for(var a in this._mat2DataInstanced){var b=this._mat2DataInstanced[a];if(!U.forEachUntilMap(b.origin2data,function(a){return B.objectEmpty(a.instances)}))return!1}for(a in this._mat2DataMerged)if(b=this._mat2DataMerged[a],!U.forEachUntilMap(b.origin2data,function(a){return B.objectEmpty(a.instances)}))return!1;for(a in this._mat2DataPreinterleaved)if(b=this._mat2DataPreinterleaved[a],!U.forEachUntilMap(b.origin2data,function(a){return B.objectEmpty(a.instances)}))return!1;
return!0};e.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var h=[],f=[],e=[];this._classifyRenderGeometry(a,h,f,e);a=[];var k=[],g=[];this._classifyRenderGeometry(b,a,k,g);var m={};d&&this._performUpdates(d,m);d=[];this._modifyMerged(h,a,d,m);this._modifyInstanced(f,k,d);this._modifyPreinterleaved(e,g,d);this._updateMergedFaceranges(m);this._releaseMaterials(d);h=this._highlights.length;if(b&&0<b.length&&0<h&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===
a.uniqueName})}),h!==this._highlights.length&&this.onHasHighlightsChanged))this.onHasHighlightsChanged(this.hasHighlights);this._updateHighlightVAOs();c&&this._modifyMaterials(c);this._needsRender=!0};e.prototype._classifyRenderGeometry=function(a,b,d,c){for(var h=0;h<a.length;h++){var f=a[h];if(1<=L(f.data))switch(this._getType(f)){case r.Merged:b.push(f);break;case r.Instanced:d.push(f);break;case r.Preinterleaved:c.push(f)}}};e.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=
a[d],h=c.updateType,c=c.renderGeometry,f=this._getType(c)===r.Merged;if(1<=L(c.data)){h&2&&this._updateFaceranges(c,b);if(h&32){var e=this._getInstance(c);e&&this._updateHighlightFaceranges(c,e.instance)}h&4||f&&h&16?this._updateVertexAttributes(c,!f):!f&&h&16&&this._updateInstanceTransformation(c)}}};e.prototype._updateFaceranges=function(a,b){var d=a.material.id,c=a.origin.id,h=this._getType(a),f;if(h===r.Preinterleaved){var e=this._getOriginData(h,d,c);f=e.instances[a.uniqueName].instance}else e=
this._getOriginData(h,d,c),(f=e.instances[a.uniqueName])&&h===r.Merged&&(b[this._modifiedMergedFacerangesKey(d,c)]=e);f&&(f.displayedIndexRange=T(a),this._updateHighlightFaceranges(a,f))};e.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=a.instanceParameters.hidden?[]:Y.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):
!c&&d&&this._removeHighlight(a)}};e.prototype._updateMergedFaceranges=function(a){for(var b in a){var d=a[b];d.displayedIndexRange=[];var c=d.instances,h=!0,f;for(f in c){var e=c[f];e.displayedIndexRange?(d.displayedIndexRange.push.apply(d.displayedIndexRange,aa.offsetIntervals(e.displayedIndexRange,e.from)),h=!1):d.displayedIndexRange.push([e.from,e.to-1])}d.displayedIndexRange=h?null:aa.mergeIntervals(d.displayedIndexRange)}};e.prototype._updateVertexAttributes=function(a,b){var d=a.material,c=
d.id,h=a.origin.id,f=D.getStride(d.getVertexBufferLayout())/4,e=this._getType(a);if(e===r.Preinterleaved)console.error("Updating Preinterleaved geometry not supported");else{var e=this._getOriginData(e,c,h),c=e.instances[a.uniqueName],h=e.buffer.getArray(),e=e.vao,k,g;b||(V(a,N,Q),k=N,g=Q);d.fillInterleaved(a.data,k,g,a.instanceParameters,h,c.from*f);B.assert(c.from+d.getOutputAmount(L(a.data))/f===c.to,"material VBO layout has changed");e.vertexBuffers.geometry.setSubData(h,c.from*f*4,c.from*f*4,
c.to*f*4)}};e.prototype._updateInstanceTransformation=function(a){var b=this._getType(a),d=a.material.id,c=a.origin.id;b===r.Preinterleaved?(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName].instance,V(a,c.transformation,c.transformationNormal)):(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName],b=b.perGeometryDataInfo[a.data.id],d=b.instanceBufferData,V(a,c.transformation,c.transformationNormal),d&&(a=d.getSlot(a.idx),d.fill(a,0,c.transformation),d.fill(a,16,c.transformationNormal),
a=4*d.getOffset(a),c=D.getStride(b.vao.layout.instance),b.vao.vertexBuffers.instance.setSubData(d.getArray(),a,a,a+c)))};e.prototype._modifyMerged=function(a,b,d,c){a=this._compMatToDelta(a,b,r.Merged);b=this._mat2DataMerged;for(var e in a){var f=a[e],y;for(y in f){var k=f[y],g=k.optimalCount,m=k.sparseCount,n=k.material,l=n.getVertexBufferLayout(),q=D.getStride(l)/4,p=b[e];null==p&&(B.assert(0<g),p=this._initializeMatData(n),b[e]=p,this._orderedRendering&&this._insertIntoRenderOrder(p,n.renderPriority,
"merged"));var t=p.origin2data.get(y);null==t&&(B.assert(0<g),t=this._createMergedData(l,g,k.origin),p.origin2data.set(y,t));if(0===g)t.vao.dispose(!0),t.vao=null,p.origin2data.delete(y),0===p.origin2data.size&&(d.push(e),delete b[e],this._orderedRendering&&this._removeFromRenderOrder(p,"merged"));else{var x=(l=g<k.sparseCount/2)?g:m,g=ra,m=t.buffer.getSize(),p=t.buffer.getArray(),x=t.buffer.resize(x);l||x?this._rebuildMerged(t,k.toRemove,q,p,g):0<k.toRemove.length?(this._removeMergedByErasing(t,
k.toRemove,q,g),0<k.toAdd.length&&(g.end=m)):(g.begin=m,g.end=m);l=K;B.setMatrixTranslation3(l,-k.origin[0],-k.origin[1],-k.origin[2]);this._appendMerged(t,n,k.toAdd,q,l,g);k=t.vao.vertexBuffers.geometry;k.byteSize!==t.buffer.getArray().buffer.byteLength?k.setData(t.buffer.getArray()):(l=g.begin,n=g.end,l<n&&(q=t.buffer.getArray(),l*=4,k.setSubData(q,l,l,4*n)));if(g.updatedDisplayedIndexRange||t.displayedIndexRange)c[this._modifiedMergedFacerangesKey(e,y)]=t}}}};e.prototype._createMergedData=function(a,
b,d){return{type:r.Merged,instances:{},vao:new P(this._rctx,R.Default3D,{geometry:a},{geometry:O.createVertex(this._rctx,35044)}),buffer:new Z(b),optimalCount:0,origin:d}};e.prototype._rebuildMerged=function(a,b,d,c,e){for(var f=0;f<b.length;++f){var h=a.instances[b[f].uniqueName];a.optimalCount-=(h.to-h.from)*d;delete a.instances[b[f].uniqueName]}b=0;f=a.buffer.getArray();e.begin=0;e.end=0;var k=-1,g=-1,m=0,n;for(n in a.instances){var h=a.instances[n],l=h.from*d,q=h.to*d,r=q-l;k!==g&&g!==l?(f.set(c.subarray(k,
g),m),m+=g-k,k=l):-1===k&&(k=l);g=q;h.from=b/d;b+=r;h.to=b/d}k!==g&&f.set(c.subarray(k,g),m);e.end=b};e.prototype._removeMergedByErasing=function(a,b,d,c){if(0!==b.length){c.begin=Infinity;c.end=-Infinity;for(var e=-1,f=-1,r=0;r<b.length;r++){var k=b[r].uniqueName,g=a.instances[k].from*d,m=a.instances[k].to*d;e!==f&&f!==g?(a.buffer.erase(e,f),e=g):-1===e&&(e=g);f=m;delete a.instances[k];a.optimalCount-=m-g;g<c.begin&&(c.begin=g);m>c.end&&(c.end=m)}e!==f&&a.buffer.erase(e,f)}};e.prototype._appendMerged=
function(a,b,d,c,e,f){f.updatedDisplayedIndexRange=!1;for(var h=0;h<d.length;h++){var k=d[h],g=k.data;C.multiply(e,k.transformation,N);C.inverse(N,Q);C.transpose(Q);var m=f.end;b.fillInterleaved(g,N,Q,k.instanceParameters,a.buffer.getArray(),f.end);var g=b.getOutputAmount(L(g)),n=m+g;B.assert(null==a.instances[k.uniqueName]);var l=T(k),m=new W(k.name,m/c,n/c,l,void 0,void 0,k.idx);a.instances[k.uniqueName]=m;this._updateHighlightFaceranges(k,m);l&&(f.updatedDisplayedIndexRange=!0);a.optimalCount+=
g;f.end+=g}};e.prototype._modifyInstanced=function(a,b,d){var c=this._rctx,e=r.Instanced;a=this._compMatToDelta(a,b,e);b=this._mat2DataInstanced;for(var f in a){var y=a[f],k;for(k in y){var g=y[k];if(0===g.optimalCount)g=b[f],g.origin2data.get(k).vao.dispose(!0),g.origin2data.delete(k),0===g.origin2data.size&&(d.push(f),delete b[f],this._orderedRendering&&this._removeFromRenderOrder(g,"instanced"));else{var m=g.material,n=b[f];if(null==n){var l=m.renderPriority,n=this._initializeMatData(m);b[f]=n;
this._orderedRendering&&this._insertIntoRenderOrder(n,l,"instanced")}var q=m.getVertexBufferLayout(),p=n[x.MATERIAL].instanced?m.getInstanceBufferLayout():void 0,t=p&&D.findAttribute(p,"instanceColor"),E=p&&D.findAttribute(p,"instanceFeatureAttribute"),I=D.getStride(q)/4,l=n.origin2data.get(k);null==l&&(l={type:e,instances:{},vao:new P(c,R.Default3D,{geometry:q},{geometry:O.createVertex(c,35044)}),buffer:new Z(g.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:g.origin},n.origin2data.set(k,
l));var n=l.buffer.getSize(),F=l.buffer.getArray(),A=g.optimalCount<g.sparseCount/2,w=l.buffer.resize(A?g.optimalCount:g.sparseCount),z;for(z in g.perGeometryDelta){var u=l.perGeometryDataInfo[z];if(u&&u.instanceBufferData){var v=g.perGeometryDelta[z].removeCount;0<v&&u.instanceBufferData.prepareFree(v)}}var G=g.toRemove;if(A||w){for(A=0;A<G.length;++A){w=G[A];delete l.instances[w.uniqueName];z=w.data.id;var H=u=l.perGeometryDataInfo[z];0===--H.refCount&&null==g.dataId2refCount[z]?(l.optimalCount-=
(H.to-H.from)*I,delete l.perGeometryDataInfo[z]):u.instanceBufferData&&u.instanceBufferData.free(w.idx)}var n=0,A=l.buffer.getArray(),w={},J;for(J in l.perGeometryDataInfo)H=l.perGeometryDataInfo[J],B.assert(null==w[H.from]),w[H.from]=H;for(var M in w)H=w[M],v=H.from*I,u=H.to*I,A.set(F.subarray(v,u),n),H.from=n/I,n+=u-v,H.to=n/I;for(var N in l.instances)v=l.instances[N],v.from=l.perGeometryDataInfo[v.dataId].from,v.to=l.perGeometryDataInfo[v.dataId].to}else for(A=0;A<G.length;++A)w=G[A],delete l.instances[w.uniqueName],
z=w.data.id,u=l.perGeometryDataInfo[z],0===--u.refCount&&null==g.dataId2refCount[z]?(v=u.from*I,u=u.to*I,l.buffer.erase(v,u),l.optimalCount-=u-v,delete l.perGeometryDataInfo[z]):u.instanceBufferData&&u.instanceBufferData.free(w.idx);B.setMatrixTranslation3(K,-g.origin[0],-g.origin[1],-g.origin[2]);for(z in g.perGeometryDelta)(u=l.perGeometryDataInfo[z])&&u.instanceBufferData&&(A=g.perGeometryDelta[z].addCount,0<A&&u.instanceBufferData.prepareAllocate(A));F=g.toAdd;for(A=0;A<F.length;++A)if(w=F[A],
v=w.data,z=v.id,u=l.perGeometryDataInfo[z],null==u?(m.fillInterleaved(v,void 0,void 0,void 0,l.buffer.getArray(),n),G=m.getOutputAmount(L(v)),v=n/I,n+=G,u=n/I,l.optimalCount+=G,u={refCount:1,from:v,to:u,vao:null,instanceBufferData:null},p&&(v=D.getStride(p)/4,u.vao=new P(c,R.Default3D,{geometry:q,instance:p},{geometry:l.vao.vertexBuffers.geometry,instance:O.createVertex(c,35044)}),u.instanceBufferData=new ga(v,g.perGeometryDelta[z].addCount)),l.perGeometryDataInfo[z]=u):++u.refCount,B.assert(u.from*
I<=l.buffer.getSize()&&u.to*I<=l.buffer.getSize()),v=C.create(),C.multiply(K,w.transformation,v),G=T(w),v=new W(w.name,u.from,u.to,G,v,w.instanceParameters,w.idx,z),l.instances[w.uniqueName]=v,this._updateHighlightFaceranges(w,v),u=u.instanceBufferData)G=u.allocate(w.idx),u.fill(G,0,v.transformation),u.fill(G,16,v.transformationNormal),t&&u.fill(G,t.offset/4,w.instanceParameters.color),E&&u.fill(G,E.offset/4,w.instanceParameters.featureAttribute);B.assert(l.optimalCount===g.optimalCount);m=new Float32Array(l.buffer.getArray().buffer,
0,l.buffer.getSize());l.vao.vertexBuffers.geometry.setData(m);for(z in l.perGeometryDataInfo)if(q=l.perGeometryDataInfo[z],q.vao&&(m=q.vao.vertexBuffers.instance))p=g.perGeometryDelta[z],0<p.addCount+p.removeCount&&(q=q.instanceBufferData.compact(),m.setData(q))}}}};e.prototype._modifyPreinterleaved=function(a,b,d){for(var c=this._rctx,e=r.Preinterleaved,f=this._mat2DataPreinterleaved,p=0;p<a.length;p++){var k=a[p],g=k.material,m=g.id,n=k.origin.id,l=k.origin.vec3,q=f[m];null==q&&(q=this._initializeMatData(g),
f[m]=q);m=q.origin2data.get(n);null==m&&(m={type:e,origin:l,count:0,instances:{}},q.origin2data.set(n,m));B.setMatrixTranslation3(K,-l[0],-l[1],-l[2]);q=C.create();C.multiply(K,k.transformation,q);l=T(k);n=k.data;n.preinterleaved?null==n.vertexData?B.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available."):(q=new W(k.name,0,n.indexCount,l,q,k.instanceParameters,k.idx,n.id),l=n.indexData?O.createIndex(c,35044,n.indexData):null,g=g.getVertexBufferLayout(),g=new P(c,R.Default3D,
{geometry:g},{geometry:O.createVertex(c,35044)},l),g.vertexBuffers.geometry.setData(n.vertexData),n.vertexData=null,m.count+=1,m.instances[k.uniqueName]={instance:q,vao:g},this._updateHighlightFaceranges(k,q)):B.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(a=0;a<b.length;a++)k=b[a],l=k.origin,g=k.material,m=g.id,n=l.id,k=k.uniqueName,q=f[m],c=q.origin2data.get(n),c.instances[k].vao.dispose(),delete c.instances[k],--c.count,0===c.count&&q.origin2data.delete(n),0===
q.origin2data.size&&(d.push(m),delete f[m])};e.prototype._compMatToDelta=function(a,b,d){var c={};this._updateMatToDelta(a,!0,d,c);this._updateMatToDelta(b,!1,d,c);return c};e.prototype._updateMatToDelta=function(a,b,d,c){d=d===r.Instanced;for(var e=0;e<a.length;e++){var f=a[e],p=f.origin,k=f.material,g=k.id,m=d?this._mat2DataInstanced[g]:this._mat2DataMerged[g],m=m&&m.origin2data.get(p.id),n=c[g];null==n&&(n={},c[g]=n);g=n[p.id];if(null==g){g={optimalCount:null==m?0:m.optimalCount,sparseCount:null==
m?0:m.buffer.getSize(),material:k,toAdd:[],toRemove:[],perGeometryDelta:null,origin:p.vec3};if(d){var l={};if(void 0!==m)for(var q in m.perGeometryDataInfo)l[q]=m.perGeometryDataInfo[q].refCount;g.dataId2refCount=l;g.perGeometryDelta={}}n[p.id]=g}p=k.getOutputAmount(L(f.data));d?(k=f.data.id,m=g.perGeometryDelta[k],m||(m={addCount:0,removeCount:0},g.perGeometryDelta[k]=m),b?(m.addCount++,null==g.dataId2refCount[k]&&(g.dataId2refCount[k]=0),1===++g.dataId2refCount[k]&&(g.optimalCount+=p,g.sparseCount+=
p),g.toAdd.push(f)):(m.removeCount++,0===--g.dataId2refCount[k]&&(delete g.dataId2refCount[k],g.optimalCount-=p),g.toRemove.push(f))):b?(g.optimalCount+=p,g.sparseCount+=p,g.toAdd.push(f)):(g.optimalCount-=p,g.toRemove.push(f))}};e.prototype._getType=function(a){if(a.data.preinterleaved)return r.Preinterleaved;var b=!1,d=L(a.data),b=(b=(b=b||!1===a.material.canBeMerged)||a.material.instanced)||!0===a.material.renderOccluded;a.singleUse||(b=b||d>this._threshold);return b?r.Instanced:r.Merged};e.prototype._getTargetMat2Data=
function(a){switch(a){case r.Merged:return this._mat2DataMerged;case r.Instanced:return this._mat2DataInstanced;case r.Preinterleaved:return this._mat2DataPreinterleaved}};e.prototype._getOriginData=function(a,b,d){return this._getTargetMat2Data(a)[b].origin2data.get(d)};e.prototype._modifiedMergedFacerangesKey=function(a,b){return a+"_"+b};e.prototype._insertIntoRenderOrder=function(a,b,d){for(var c=a[x.MATERIAL].materialId,e=this._renderOrder.length,f=0;f<e&&this._renderOrder[f][0]>=b;){var p=this._renderOrder[f][1];
if(p.id===c){B.assert(!p[d],"matData for type already exists");p[d]=a;return}f++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(f,0,[b,c])};e.prototype._removeFromRenderOrder=function(a,b){var d=a[x.MATERIAL].materialId;for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;d.instanced||d.merged||this._renderOrder.splice(a,1)};e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(a,b){a=a.matData[x.MATERIAL].renderPriority;
b=b.matData[x.MATERIAL].renderPriority;return a>b?-1:b>a?1:0})};e.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;c<d&&b[c][1].id!==a;)c++;if(c<d){a=b[c][1];a=(a.merged||a.instanced)[x.MATERIAL].renderPriority;var e=b[c][0];if(a!==b[c][0])for(b[c][0]=a,e=a>e?-1:1,c+=e;-1<c&&c<d&&e*b[c][0]>e*a;){var f=b[c];b[c]=b[c-e];b[c-e]=f;c+=e}}};e.prototype._modifyMaterials=function(a){var b=this;a.forEach(function(a){b._materialRep.updateMaterialParameters(a)})};e.prototype.modifyRenderOrder=
function(a){var b=this;this._orderedRendering&&(a.forEach(function(a){b._updateRenderOrder(a,b._renderOrder)}),this._sortHighlightsByRenderOrder(),this._needsRender=!0)};e.prototype._initializeMatData=function(a){var b={origin2data:new Map};b[x.MATERIAL]=this._materialRep.aquire(a);b[x.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(a);b[x.MATERIAL_NORMAL]=this._materialRep.aquireNormal(a);b[x.MATERIAL_DEPTH]=this._materialRep.aquireDepth(a);b[x.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(a);
return b};e.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),this._materialRep.releaseDepth(a),this._materialRep.releaseHighlight(a)};e.prototype._getInstance=
function(a){var b=a.uniqueName,d=a.material.id,c=this._getType(a),d=this._getTargetMat2Data(c)[d];if(!d)return null;a=d.origin2data.get(a.origin.id);if(!a)return null;var e;return(e=a.type===r.Preinterleaved?a.instances[b].instance:a.instances[b])?{type:c,uniqueName:b,instance:e,matData:d,originData:a,instancedVAO:null,instancedVAOBaseInstance:null}:null};e.prototype._createBaseInstanceVAO=function(a){var b=this._rctx,d=a.instance,c=a.originData;if(a.type===r.Instanced&&c.perGeometryDataInfo){var c=
c.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==d&&(e=D.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new P(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}};e.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])};e.prototype._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=
new ca(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255])));return this._fallbackDepthStencilTexture};return e}();var pa=function(){function e(){this.reset()}e.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsPreinterleaved=this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=
0};return e}(),W=function(){return function(e,a,b,d,c,h,f,p){this.name=e;this.from=a;this.to=b;this.displayedIndexRange=d;this.transformation=c;this.instanceParameters=h;this.idx=f;this.dataId=p;null!=c&&(this.transformationNormal=C.create(),C.set(c,this.transformationNormal),C.inverse(this.transformationNormal,this.transformationNormal),C.transpose(this.transformationNormal,this.transformationNormal))}}(),r;(function(e){e[e.Merged=0]="Merged";e[e.Instanced=1]="Instanced";e[e.Preinterleaved=2]="Preinterleaved"})(r||
(r={}));var ra={updatedDisplayedIndexRange:!1,begin:0,end:0},J=X.create(),K=C.identity(),N=C.create(),Q=C.create();return S});