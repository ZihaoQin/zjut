// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/TimeProfiler ../../support/debugFlags ../lib/depthRange ../lib/depthRangeUtils ../lib/gl-matrix ../lib/HighlightHelper ../lib/OffscreenRenderingHelper ../lib/Renderer ../lib/RenderOccludedHelper ../lib/RenderPass ../lib/ShadowMap ../lib/SSAOHelper ../lib/Util".split(" "),function(B,C,k,l,p,q,m,r,t,u,v,w,x,y,n){var e=m.vec3d,h=m.mat4d,z=n.assert;return function(){function b(a,d,b,c,g){this._drawSSAOMapDebugQuad=this._drawShadowMapDebugQuad=!1;this._needsRender=
!0;this._content=new Map;this._stage=a;this._rctx=g;this._renderer=new u(d,b,c,this._rctx,!1);this._programRep=d;this._helpers={shadowMap:new x(d,this._rctx),ssao:new y(d,c,this._rctx,this.setNeedsRender.bind(this)),highlight:new r(d,c,this._rctx),renderOccluded:new v(d,c,this._rctx),offscreenRendering:new t(d,this._rctx)}}Object.defineProperty(b.prototype,"isLoadingResources",{get:function(){return this._renderer.isLoadingResources},enumerable:!0,configurable:!0});b.prototype.getCombinedStats=function(){return this._renderer.getCombinedStats()};
b.prototype.dispose=function(){this._renderer.dispose();this._helpers.shadowMap.enabled=!1;this._helpers.shadowMap.dispose();this._helpers.ssao.enabled=!1;this._helpers.ssao.dispose();this._helpers.highlight.enabled=!1;this._helpers.renderOccluded.enabled=!1;this._helpers.offscreenRendering.enabled=!1};b.prototype.setLighting=function(a){this._renderer.setLighting(a)};b.prototype.getViewParams=function(a){var d=a||{};if(!a||a.pixelRatio)d.pixelRatio=this._renderer.getPixelRatio();return d};b.prototype.setViewParams=
function(a){null!=a.pixelRatio&&this._renderer.setPixelRatio(a.pixelRatio)};b.prototype.setRenderParams=function(a){void 0!==a.shadowMapResolution&&!1===this._helpers.shadowMap.enabled&&(this._helpers.shadowMap.textureResolution=a.shadowMapResolution);void 0!==a.shadowMap&&(this._helpers.shadowMap.enabled=a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._helpers.shadowMap.maxCascades=a.shadowMapMaxCascades);this._helpers.highlight.enabled=!0;void 0!==a.ssao&&(this._helpers.ssao.enabled=a.ssao);
void 0!==a.ssaoAttenuation&&(this._helpers.ssao.attenuation=a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._helpers.ssao.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._helpers.ssao.samples=a.ssaoSamples);void 0!==a.drawShadowMapDebugQuad&&(this._drawShadowMapDebugQuad=a.drawShadowMapDebugQuad);void 0!==a.drawSSAODebugQuad&&(this._drawSSAOMapDebugQuad=a.drawSSAODebugQuad);
this._renderer.ssaoEnabled=this._helpers.ssao.enabled;void 0!==a.offscreenRendering&&(this._helpers.offscreenRendering.enabled=a.offscreenRendering);a.background&&(this._helpers.offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this._renderer.renderOptions.antialiasing=a.antialiasingEnabled?"smaa":"none");void 0!==a.earlyOcclusionPixelDraw&&(this._renderer.renderOptions.earlyOcclusionPixelDraw=a.earlyOcclusionPixelDraw);void 0!==a.defaultHighlightOptions&&this._helpers.highlight.setDefaultOptions(a.defaultHighlightOptions);
this._needsRender=!0};b.prototype.getRenderParams=function(){var a={};this._helpers.shadowMap.isSupported&&(a.shadowMap=this._helpers.shadowMap.enabled,a.shadowMapResolution=this._helpers.shadowMap.textureResolution,a.shadowMapMaxCascades=this._helpers.shadowMap.maxCascades);this._helpers.ssao.isSupported&&(a.ssao=this._helpers.ssao.enabled,a.ssaoAttenuation=this._helpers.ssao.attenuation,a.ssaoRadius=this._helpers.ssao.radius,a.ssaoFilterRadius=this._helpers.ssao.filterRadius,a.ssaoSamples=this._helpers.ssao.samples);
return a};b.prototype.modify=function(a,d,b,c){this._renderer.modify(a,d,b,c);for(c=0;c<d.length;++c)this._content.delete(d[c].uniqueName);for(c=0;c<a.length;++c)this._content.set(a[c].uniqueName,a[c]);for(c=0;c<b.length;++c)z(this._content.get(b[c].renderGeometry.uniqueName)===b[c].renderGeometry)};b.prototype.getContent=function(){return this._content};b.prototype.getPickRay=function(a,d,b,c,g,A){e.unproject(e.createFrom(a[0],a[1],0),c,b.projectionMatrix,b.fullViewport,g);e.unproject(e.createFrom(a[0],
a[1],1),c,b.projectionMatrix,b.fullViewport,A)};b.prototype.getProjectionMatrix=function(a,b,f,c,g){b=n.fovx2fovy(b,a[2],a[3]);h.perspective(180*b/Math.PI,a[2]/a[3],f,c,g)};b.prototype.addExternalRenderer=function(a,b){return this._renderer.addExternalRenderer(a,b)};b.prototype.removeExternalRenderer=function(a){return this._renderer.removeExternalRenderer(a)};b.prototype.getExternalRenderers=function(){return this._renderer.getExternalRenderers()};b.prototype.resetNeedsRender=function(){this._needsRender=
!1;this._renderer.resetNeedsRender()};b.prototype.needsRender=function(){return this._needsRender||this._renderer.needsRender()};b.prototype.setNeedsRender=function(){this._needsRender=!0};b.prototype.render=function(a,b,f){var c=a.viewport;this._renderer.prepareRender(a);if(this._helpers.shadowMap.enabled){l.ENABLE_PROFILE_DEPTH_RANGE&&k.begin("depthRange");var d=this.computeDepthRange(a);l.ENABLE_PROFILE_DEPTH_RANGE&&k.end("depthRange");this._helpers.shadowMap.prepare(a,b,this._content,d);b=this._helpers.shadowMap.getCascades();
for(d=0;d<b.length;++d){var e=b[d];e.camera.setGLViewport(this._rctx);this._renderer.renderGeometryPass(w.MATERIAL_DEPTH_SHADOWMAP,e.camera)}this._helpers.shadowMap.finish(f);a.setGLViewport(this._rctx)}this._helpers.shadowMap.bindAll(this._programRep);this._renderer.renderAuxiliaryBuffers(a,f,this._helpers);this._renderer.render(a,f,this._helpers);this._drawShadowMapDebugQuad&&this._helpers.shadowMap.enabled&&(a=h.ortho(c[0],c[2],c[1],c[3],-1,1),this._helpers.shadowMap.drawDebugQuad(a));this._drawSSAOMapDebugQuad&&
this._helpers.ssao.enabled&&(a=h.ortho(c[0],c[2],c[1],c[3],-1,1),this._helpers.ssao.drawQuad(a))};b.prototype.getEdgeView=function(){return this._renderer.edgeView};b.prototype.computeDepthRange=function(a){var b=q.depthRangeFromScene(a,this._content,this._stage.getLayers());p.union(b,this.getExternalRenderers().queryDepthRange(a));b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b};return b}()});