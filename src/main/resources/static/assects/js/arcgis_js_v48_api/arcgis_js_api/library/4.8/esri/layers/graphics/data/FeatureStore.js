// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports @dojo/shim/array @dojo/shim/Map @dojo/shim/Set dojo/has ../../../geometry ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../core/libs/rbush/rbush ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../../../geometry/support/normalizeUtils ../../../geometry/support/scaleUtils ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./FeatureStoreCapabilities ./FeatureStoreItem ./FeatureStoreResult ./projectionSupport ./SpatialQueryCache ./spatialQuerySupport ../../../tasks/support/Query".split(" "),
function(F,G,O,H,I,P,J,q,Q,l,R,S,p,T,B,K,U,r,V,C,t,u,W,v,z){function w(d,a){x.minX=a[0];x.minY=a[1];x.maxX=a[2];x.maxY=a[3];return d.search(x)}function L(d){return d?JSON.parse(JSON.stringify(d,["latestWkid","wkid","wkt"])):d}function D(d,a,c,b,g,f){if(g&&!b)for(a=0;a<c.length;a++)b=c[a],d.push({attributes:b.getAttributes(),centroid:b.getCentroidQuantized(f)});else if(b&&!g)for(g=0;g<c.length;g++)b=c[g],a.add(b.oid),d.push(new M(b.getAttributes(),b.getGeometryQuantized(f)));else for(g=0;g<c.length;g++)b=
c[g],a.add(b.oid),d.push(new M(b.getAttributes(),b.getGeometryQuantized(f),b.getCentroidQuantized(f)))}Object.defineProperty(G,"__esModule",{value:!0});var N=Q.getLogger("esri.layers.graphics.data.FeatureStore"),A=[],x={minX:0,minY:0,maxX:0,maxY:0},M=function(){return function(d,a,c){this.attributes=d;this.geometry=a;this.centroid=c}}(),y={},E=new I.default;F=function(){function d(a){var c=this;this._itemsMap=new H.default;this._index=R(9,P("csp-restrictions")?function(a){return{minX:a.bounds[0],
minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);this.capabilities={query:V.queryCapabilities};this.fieldsMap=new H.default;this.geometryType=a.geometryType;this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.cacheSpatialQueries=a.cacheSpatialQueries||!1;this.gdbVersion=a.gdbVersion;this.historicMoment=a.historicMoment;this.cacheSpatialQueries&&
(this._geometryQueryCache=new W.default);a.fields.forEach(function(a){c.fieldsMap.set(a.name.trim(),a);c.fieldsMap.set(a.name.trim().toLowerCase(),a)})}d.prototype.destroy=function(){this.clear();this.fieldsMap.clear()};d.prototype.clear=function(){this._itemsMap.forEach(function(a){C.default.release(a)});this._itemsMap.clear();this._index.clear();this._clearCache()};Object.defineProperty(d.prototype,"size",{get:function(){return this._itemsMap.size},enumerable:!0,configurable:!0});d.prototype.load=
function(a){var c=K.getInfo(this.spatialReference),b=this._itemsMap,g=this.objectIdField;this._clearCache();for(var f=0;f<a.length;f++){var e=a[f];if(e.geometry.coords.length){var d=e.attributes[g];if(null==d)N.error(new q("featurestore:invalid-feature","feature id is invalid, "+g+" is missing",{feature:e}));else{var h=void 0;b.has(d)?(h=b.get(d),this._index.remove(h),h.set(e)):(h=C.default.acquire(e,this),b.set(d,h));c&&(h.bounds[0]<c.valid[0]||h.bounds[2]>c.valid[1])?N.error(new q("load:invalid-bounds",
"The feature has bounds outside of the valid coordinate range",{valid:c.valid,feature:e})):A.push(h)}}}A.length&&this._index.load(A);A.length=0};d.prototype.delete=function(a){for(var c=this._index,b=this._itemsMap,g=0;g<a.length;g++){var f=a[g],e=this._itemsMap.get(f);e&&(c.remove(e),b.delete(f),C.default.release(e))}this._clearCache()};d.prototype.searchBounds=function(a){return w(this._index,a)};d.prototype.executeQuery=function(a){var c=this;void 0===a&&(a=new z);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).catch(function(a){if(a===
y)return new t.default([],c);throw a;}).then(function(a){return a.createQueryResponse(b)})};d.prototype.executeQueryForCount=function(a){var c=this;void 0===a&&(a=new z);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){return a.size}).catch(function(a){if(a===y)return 0;throw a;
})};d.prototype.executeQueryForExtent=function(a){var c=this;void 0===a&&(a=new z);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){var g=a.size;if(!g)return{count:g,extent:null};for(var e={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,
ymax:Number.NEGATIVE_INFINITY,spatialReference:L(c.spatialReference)},d=0,h=a.items;d<h.length;d++){var k=h[d].bounds;k&&(e.xmin=Math.min(k[0],e.xmin),e.ymin=Math.min(k[1],e.ymin),e.xmax=Math.max(k[2],e.xmax),e.ymax=Math.max(k[3],e.ymax))}a=u.project(e,a.spatialReference,b.outSpatialReference);a.spatialReference=L(b.outSpatialReference&&b.outSpatialReference.toJSON()||c.spatialReference);0===a.xmax-a.xmin&&(e=B.getMetersPerUnitForSR(a.spatialReference),a.xmin-=e,a.xmax+=e);0===a.ymax-a.ymin&&(e=B.getMetersPerUnitForSR(a.spatialReference),
a.ymin-=e,a.ymax+=e);return{count:g,extent:a}}).catch(function(a){if(a===y)return{count:0,extent:null};throw a;})};d.prototype.executeQueryForIds=function(a){var c=this;void 0===a&&(a=new z);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){a=a.items;for(var b=[],c=0;c<a.length;c++)b[c]=
a[c].oid;return b}).catch(function(a){if(a===y)return[];throw a;})};d.prototype.executeTileQuery=function(a,c){var b=c.returnGeometry,g=c.returnCentroid,f=c.pixelBuffer;c=new I.default;var e=[],f=f*a.resolution,d=p.pad(a.bounds,f,p.create()),h;h=w(this._index,d);h.sort(function(a,b){return a.oid-b.oid});D(e,c,h,b,g,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]});if("esriGeometryPoint"===this.geometryType||g){var k=K.getInfo(this.spatialReference);
if(k){var n=k.valid,k=n[0],n=n[1];d[0]<k&&(h=p.fromValues(n-f,d[1],n,d[3]),h=w(this._index,h),h.sort(function(a,b){return a.oid-b.oid}),D(e,c,h,b,g,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[n,a.bounds[3]]}));d[2]>n&&(f=p.fromValues(k,d[1],k+f,d[3]),h=w(this._index,f),h.sort(function(a,b){return a.oid-b.oid}),D(e,c,h,b,g,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[k-n+a.bounds[0],a.bounds[3]]}))}}return{features:e,objectIds:c}};d.prototype._clearCache=
function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._allItems=null};d.prototype._getAll=function(){this._allItems||(this._allItems=new t.default(O.from(this._itemsMap,function(a){return a[1]}),this));return this._allItems};d.prototype._normalizeQuery=function(a){var c=this,b=this.definitionExpression,g=a.where,d=a.geometry,e=a.outFields,m=a.orderByFields,h=a.groupByFieldsForStatistics,k=a.outStatistics;a.where=g=g&&g.trim();if(!g||/^1 *= *1$/.test(g)||b&&b===g)a.where=null;
if(e)for(b=0;b<e.length;b++)e[b]=e[b].trim();if(m)for(b=0;b<m.length;b++)m[b]=m[b].trim();if(h)for(b=0;b<h.length;b++)h[b]=h[b].trim();if(k)for(b=0;b<k.length;b++)k[b].onStatisticField=k[b].onStatisticField.trim();if(!d)return l.resolve(a);a.outSpatialReference||(a.outSpatialReference=d.spatialReference);return this._getInputGeometry(a).then(function(b){return a.geometry=b}).then(function(b){return u.checkProjectionSupport(a,b.spatialReference,c.spatialReference)}).then(function(){return T.normalizeCentralMeridian(a.geometry)}).then(function(a){return u.project(a[0].toJSON(),
a[0].spatialReference,c.spatialReference)}).then(function(b){if(!b)throw y;b.spatialReference=c.spatialReference;return a.read({geometry:b})})};d.prototype._executeGeometryQuery=function(a){var c=this,b=a.geometry,d=a.outSpatialReference,f=a.spatialRelationship,e=d&&!U.equals(this.spatialReference,d),m=e?JSON.stringify({geometry:b,spatialRelationship:f,outSpatialReference:d}):JSON.stringify({geometry:b,spatialRelationship:f});if(this.cacheSpatialQueries&&this._geometryQueryCache.size&&this._geometryQueryCache.has(m))return l.resolve(this._geometryQueryCache.get(m));
var h=null;if(b){var k=this._searchSpatialIndex(this._getQueryBBoxes(b));if(!k.length)return b=new t.default([],this),this.cacheSpatialQueries&&this._geometryQueryCache.set(m,b),l.resolve(b);h="envelope-intersects"===a.spatialRelationship||"esriGeometryPoint"===this.geometryType&&v.canQueryWithRBush(b)?l.resolve(new t.default(k,this)):v.getSpatialQueryOperator(f,b,this.geometryType).then(function(a){if(a){var b=k.filter(function(b){return a(b.getGeometry())});return new t.default(b,c)}})}else h=l.resolve(this._getAll());
return h.then(function(b){if(e&&(a.returnGeometry||a.returnCentroid))return b.project(d).then(function(a){c.cacheSpatialQueries&&c._geometryQueryCache.set(m,a);return a});c.cacheSpatialQueries&&c._geometryQueryCache.set(m,b);return b})};d.prototype._getInputGeometry=function(a){var c=a.geometry,b=a.distance,d=a.units;if(null==b)return l.resolve(c);var f=c.spatialReference,e=d||B.getUnitString(f),d=null,d=f&&(f.isGeographic||f.isWebMercator)?l.resolve(c):u.checkProjectionSupport(a,f,J.SpatialReference.WGS84).then(function(){return S.project(c,
J.SpatialReference.WGS84)});return d.then(function(a){return v.getGeodesicBufferOperator().then(function(c){return c(a,b,e)})})};d.prototype._getQueryBBoxes=function(a){if("point"===a.type)return[p.fromValues(a.x,a.y,a.x,a.y)];a=v.canQueryWithRBush(a)?a:a.extent;switch(a.type){case "extent":return[p.fromExtent(a)];case "polygon":return a.rings.map(function(a){return p.fromValues(a[0][0],a[0][1],a[2][0],a[2][1])})}};d.prototype._searchSpatialIndex=function(a){for(var c=[],b=0;b<a.length;b++)for(var d=
0,f=w(this._index,a[b]);d<f.length;d++){var e=f[d];E.has(e)||(c.push(e),E.add(e))}E.clear();return c};d.prototype._checkQuerySupport=function(a){return 0>a.distance||null!=a.geometryPrecision||null!=a.maxAllowableOffset||a.multipatchOption||a.pixelSize||a.relationParameter||a.text||a.timeExtent?l.reject(new q("feature-store:unsupported-query","Unsupported query options",{query:a})):l.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),v.checkSpatialQuerySupport(a,this.geometryType,
this.spatialReference),u.checkProjectionSupport(a,this.spatialReference,a.outSpatialReference)]).then(function(){return a})};d.prototype._checkAttributesQuerySupport=function(a){var c=a.outFields,b=a.orderByFields,d=a.returnDistinctValues;b&&0<b.length&&(b=b.map(function(a){return-1<a.indexOf(" ASC")?a.split(" ASC")[0]:-1<a.indexOf(" DESC")?a.split(" DESC")[0]:a}),r.validateFields(this.fieldsMap,b,"orderByFields contains missing fields",!1));if(c&&0<c.length)r.validateFields(this.fieldsMap,c,"outFields contains missing fields");
else if(d)throw new q("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});r.validateWhere(this.fieldsMap,a.where)};d.prototype._checkStatisticsQuerySupport=function(a){var c=a.outStatistics,b=a.groupByFieldsForStatistics;if(c&&c.length){c=c.map(function(a){return a.onStatisticField.trim()});r.validateFields(this.fieldsMap,c,"onStatisticFields contains missing fields");for(var d=0;d<c.length;d++){var f=c[d];if((!b||!b.length)&&r.hasInvalidFieldType(f,
this.fieldsMap))return l.reject(new q("feature-store:unsupported-query","outStatistics contains non-numeric fields",{fieldName:f,query:a}))}}};return d}();G.default=F});