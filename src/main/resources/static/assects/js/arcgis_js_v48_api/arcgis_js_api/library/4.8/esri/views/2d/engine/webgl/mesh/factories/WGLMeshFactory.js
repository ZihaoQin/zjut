// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../symbols/SimpleLineSymbol ../../definitions ../../enums ../../MaterialInfo ../../Utils ../../visualVariablesUtils ../../WGLDisplayObject ../VertexVector ../templates/meshTemplateUtils ../templates/WGLLabelTemplate ../templates/WGLLineTemplate ../templates/WGLMarkerTemplate ../../util/Matcher ../../util/serializationUtils ../../util/vvFlagUtils ../../util/Writer".split(" "),
function(A,B,T,z,L,M,u,e,D,E,I,N,n,x,O,P,J,F,G,w,K){Object.defineProperty(B,"__esModule",{value:!0});var t=L.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),Q={esriGeometryPoint:"above-right above-center above-left center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:null,esriGeometryMultipoint:null,esriGeometryEnvelope:null},C=function(){function c(){this._materials=[];this._materialsIndex=new Map}
c.prototype.insert=function(a){var b=this._materials.length;this._materials.push(a);return b};c.prototype._hashGlyph=function(a,b,d){return"G-"+b+"-"+d+"-"+a.page};c.prototype._hashSprite=function(a,b,d){return"S-"+b+"-"+d+"-"+(a?a.page:-1)};c.prototype.createSpriteMaterial=function(a,b,d){var g=this._hashSprite(a,b,d);if(this._materialsIndex.has(g))return this._materialsIndex.get(g);var f=this._materials.length;a=D.default.fromSprite(a,b,d);this._materials.push(a);this._materialsIndex.set(g,f);return f};
c.prototype.createGlyphMaterial=function(a,b,d){var g=this._hashGlyph(a,b,d);if(this._materialsIndex.has(g))return this._materialsIndex.get(g);var f=this._materials.length;a=D.default.fromGlyph(a,b,d);this._materials.push(a);this._materialsIndex.set(g,f);return f};c.prototype.get=function(a){return this._materials[a]};c.prototype.serialize=function(a){G.serializeList(a,this._materials);return a};c.deserialize=function(a){var b=new c;b._materials=G.deserializeList(a,D.default);return b};return c}();
B.MaterialStore=C;A=function(){function c(a){this._bucketSize=a;this._rowsLength=u.TILE_SIZE/a;this._colsLength=u.TILE_SIZE/a;this._grid=this._initGrid()}c.prototype.checkOverlap=function(a,b){a=Math.floor(a/this._bucketSize);b=Math.floor(b/this._bucketSize);if(0>a||a>=this._rowsLength||0>b||b>=this._colsLength||this._grid[b][a])return!0;this._grid[b][a]=!0;return!1};c.prototype.reset=function(){this._grid=this._initGrid()};c.prototype._initGrid=function(){for(var a=[],b=0;b<this._rowsLength;b++)a.push(Array(this._colsLength));
return a};return c}();B.LabelGrid=A;var R=function(){function c(a,b,d){this.displayObjects=a;this.vertexVectorsMap=b;this._materials=d}c.prototype.get=function(a){return this.vertexVectorsMap[a]};c.prototype.pushDisplayObject=function(a){this.displayObjects.push(a)};c.prototype.encode=function(a,b){var d=G.serializeList(new K.default(Uint32Array,this._guessSize()),this.displayObjects).buffer(),g=this._materials.serialize(new K.default(Uint32Array)).buffer(),f={};b.push(d);b.push(g);for(var c in this.vertexVectorsMap){var h=
this.vertexVectorsMap[c];f[c]={};h.transfer(f[c],b)}a.displayObjects=d;a.materialStore=g;a.vertexBuffersMap=f;this.destroy()};c.prototype.destroy=function(){this.displayObjects=this.vertexVectorsMap=null};c.prototype._guessSize=function(){for(var a=this.displayObjects,b=Math.min(a.length,4),d=0,g=0;g<b;g++)d=Math.max(d,a[g].displayRecords.length);return 2*(12*a.length+a.length*d*40)};return c}(),S=function(){function c(){this._vvMap=new Map}c.prototype.set=function(a,b){this._vvMap.set(a,b)};c.prototype.getValue=
function(a,b,d){return this._vvMap.has(a)?this._vvMap.get(a)(b,d):0};return c}();A=function(){function c(a,b,d,g,f,c,h,e,y,m){var q=this;this._labelsDebugTemplate=null;this._matcher=a;this._materials=d;this._geometryType=g;this._idField=f;this._pixelRatio=y;this._vvMap=null;this._vvFlags=h;this._vvBuf=new ArrayBuffer(16);this._vvBufU32=new Uint32Array(this._vvBuf);this._vvBufF32=new Float32Array(this._vvBuf);this._createVVFunctionMap(c,b,e);m&&(this._validateLabelingInfo(m)?this._labelTemplates=m.map(function(a){return O.default.fromText(q._materials,
0,a.symbol,y,a.labelPlacement)}):t.error(new z("mapview-labeling:unsupported-geometry","LabelingInfo failed validation - unable to create labels for layer.")))}c.from=function(a,b,d,g,f,e,h,H){switch(a.type){case "simple":return c._fromSimpleRenderer(a,b,d,g,f,e,h,H);case "unique-value":case "uniqueValue":return c._fromUniqueValueRenderer(a,b,d,g,f,e,h,H);case "class-breaks":case "classBreaks":return c._fromClassBreaksRenderer(a,b,d,g,f,e,h,H);default:return t.error(new z("mapview-mesh:invalid-renderer",
"Unable to handle unknown renderer type")),null}};Object.defineProperty(c.prototype,"materials",{get:function(){return this._materials},enumerable:!0,configurable:!0});c.prototype.createMeshData=function(a){var b=Array(5),d=this._matcher.getDefault(),g=!!w.getMarkerVVFlags(this._vvFlags),f=!!w.getFillVVFlags(this._vvFlags),c=!!w.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),h=!!w.getTextVVFlags(this._vvFlags);!this._labelTemplates&&d&&1===d.length&&d[0]instanceof J.default?
(b[e.WGLGeometryType.MARKER]=new n.VertexVectors(e.WGLGeometryType.MARKER,g,a),b[e.WGLGeometryType.FILL]=new n.VertexVectors(e.WGLGeometryType.FILL,f,0),b[e.WGLGeometryType.LINE]=new n.VertexVectors(e.WGLGeometryType.LINE,c,0),b[e.WGLGeometryType.TEXT]=new n.VertexVectors(e.WGLGeometryType.TEXT,h,0),b[e.WGLGeometryType.LABEL]=new n.VertexVectors(e.WGLGeometryType.LABEL,!1,0)):(b[e.WGLGeometryType.MARKER]=new n.VertexVectors(e.WGLGeometryType.MARKER,g,a),b[e.WGLGeometryType.FILL]=new n.VertexVectors(e.WGLGeometryType.FILL,
f,a),b[e.WGLGeometryType.LINE]=new n.VertexVectors(e.WGLGeometryType.LINE,c,a),b[e.WGLGeometryType.TEXT]=new n.VertexVectors(e.WGLGeometryType.TEXT,h,a),b[e.WGLGeometryType.LABEL]=new n.VertexVectors(e.WGLGeometryType.LABEL,!1,this._labelTemplates&&0<this._labelTemplates.length?a:0));return new R([],b,this._materials)};c.prototype.write=function(a,b,d,g,c){var f=1===this._matcher.size()&&this._matcher.getDefault()||this._matcher.match(b,d),h=b.attributes[this._idField],e=new N(h),y=!!g&&!!this._labelTemplates&&
g.has(h);this._computeVV(b,d);if(f&&(b.geometry||b.centroid)){d=e.displayRecords;for(var m=0;m<f.length;m++){var l=f[m],k=a.get(l.geometryType);l.writeMesh(d,k,this._geometryType,h,b,this._pixelRatio,this._vvBufU32)}y&&(f=this._getLabelReference(f),this._writeLabelMesh(e,a,h,b,c,g.get(h),f));a.pushDisplayObject(e)}};c.prototype._hasBadLabelClass=function(a,b){var d=a.labelPlacement,c=Q[b];if(!c)return t.error(new z("mapview-labeling:unsupported-geometry-type","Unable to create labels for WebGL Feature Layer, "+
b+" is not supported")),!0;c.some(function(a){return a===d})||(c=c[0],d&&t.warn("Found invalid label placement type "+d+" for "+b+". Defaulting to "+c),a.labelPlacement=c);return!1};c.prototype._validateLabelingInfo=function(a){var b=this;return!a.some(function(a){return b._hasBadLabelClass(a,b._geometryType)})};c.prototype._getLabelReference=function(a){for(var b=0;b<a.length;b++){var d=a[b];if(d instanceof J.default)return d}return null};c.prototype._writeLabelMesh=function(a,b,d,c,f,e,h){for(var g=
a.displayRecords,y=0,m=0,l=-1,k=-1,p=0;p<e.labelingInfo.length;p++){var r=e.labelingInfo[p],q=e.text[p],v=this._labelTemplates[r],n=b.get(v.geometryType),x=f.get(v.symbolId).glyphMosaicItems,w=g.length;v.bindReferenceTemplate(h);var t=v.computeAnchor(this._geometryType,c);0===p&&(l=Math.floor(t[0]/u.COLLISION_BUCKET_SIZE),k=Math.floor(t[1]/u.COLLISION_BUCKET_SIZE));v.computeGlyphs(x,q)||(q=v.bounds,v.writeMesh(g,n,this._geometryType,d,c,this._pixelRatio,this._vvBufU32),a.anchor=t,a.addMetric(q,w,
g.length-w,r),r=q.center,y=Math.max(q.halfWidth+Math.abs(r[0]),y),m=Math.max(q.halfHeight+Math.abs(r[1]),m))}a.metrics.length&&(d=2.5*Math.max(y,m),b=Math.ceil(Math.abs((d-a.anchor[0]%u.COLLISION_BUCKET_SIZE)/u.COLLISION_BUCKET_SIZE)),d=Math.ceil(Math.abs((d-a.anchor[1]%u.COLLISION_BUCKET_SIZE)/u.COLLISION_BUCKET_SIZE)),a.xBucket=l,a.yBucket=k,a.xOverflow=b,a.yOverflow=d)};c.prototype._debugLabels=function(a,b,d,c,f){c={geometry:{paths:[[[c[0]+f.center[0]-f.width/2,c[1]+f.center[1]+f.height/2],[0,
-f.height],[f.width,0],[0,f.height],[-f.width,0]]]},attributes:{}};f=this._getLabelDebugTemplate();b=b.get(f.geometryType);f.writeMesh(a,b,"esriGeometryPolyline",d,c,this._pixelRatio,this._vvBufU32)};c.prototype._getLabelDebugTemplate=function(){this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate());return this._labelsDebugTemplate};c.prototype._createLabelsDebugTemplate=function(){var a=new M({style:"solid",width:1,color:[255,0,0,1]});return P.default.fromSimpleLine(this._materials,
0,a,null,this._pixelRatio)};c.prototype._isErrorVV=function(a){return null===a||isNaN(a)||Infinity===a};c.prototype._computeVV=function(a,b){if(!this._vvMap)return 0;var c=this._vvMap.getValue(e.VVType.SIZE,a,b),g=this._vvMap.getValue(e.VVType.COLOR,a,b),f=this._vvMap.getValue(e.VVType.OPACITY,a,b);a=this._vvMap.getValue(e.VVType.ROTATION,a,b);this._vvBufF32[e.VVType.SIZE]=this._isErrorVV(c)?NaN:c;this._vvBufF32[e.VVType.COLOR]=this._isErrorVV(g)?NaN:g;this._vvBufF32[e.VVType.OPACITY]=this._isErrorVV(f)?
NaN:f;this._vvBufF32[e.VVType.ROTATION]=this._isErrorVV(a)?NaN:a;return 0};c.prototype._createVVFunctionMap=function(a,b,c){if(a&&a.length)for(var d=0;d<a.length;d++){var f=a[d],e=E.getVVType(f.type);if(f=this._createGetValueFunction(f,b,c))this._vvMap||(this._vvMap=new S),this._vvMap.set(e,f)}};c.prototype._createGetValueFunction=function(a,b,c){if(E.getVVType(a.type)===e.VVType.SIZE){var d=I.getTypeOfSizeVisualVariable(a);return d===e.WGLVVFlag.SIZE_SCALE_STOPS?null:this._createNormalizedFunction(a,
b,c,d===e.WGLVVFlag.SIZE_UNIT_VALUE&&function(b){return I.getVisualVariableSizeValueRepresentationRatio(b,a.valueRepresentation)})}return this._createNormalizedFunction(a,b,c)};c.prototype._createNormalizedFunction=function(a,b,c,e){var d=a.field;if(d){if("string"===typeof d){var g=a.normalizationField;return g?function(a){if(a.attributes[d]&&a.attributes[g])return a=a.attributes[d]/a.attributes[g],e?e(a):a}:e?function(a){return e(a.attributes[d])}:function(a){return a.attributes[d]}}if("function"===
typeof d)return t.error(new z("mapview-rendering:unsupported-feature","Function field types are not currently supported. Please use a valueExpression instead")),function(a){};t.error(new z("mapview-rendering:invalid-type","The field for a vv must be a string or a number, but got "+typeof d));return function(a){}}if(a.valueExpression&&"$view.scale"!==a.valueExpression)return E.createArcadeFunction({valueExpression:a.valueExpression,spatialReference:c,layer:b},e);t.error("Unable to create a normalized function for visual variable: "+
a);return function(a){}};c._fromSimpleRenderer=function(a,b,d,e,f,q,h,n){var g=a.getSymbols();a=a.visualVariables;var m=w.getVVFlags(a),l=new F.default,k=new C;g.length&&l.setDefault(x.createMeshTemplates([],k,g[0],d,m,h));return new c(l,b,k,e,f,a,m,q,h,n)};c._fromUniqueValueRenderer=function(a,b,d,e,f,q,h,n){var g=a.uniqueValueInfos,m=a.visualVariables,l=w.getVVFlags(m),k=[a.field];a.field2&&k.push(a.field2);a.field3&&k.push(a.field3);for(var p=a.valueExpression,k=new F.MapMatcher(k,a.fieldDelimiter,
p?{valueExpression:p,spatialReference:q,layer:b}:null),p=new C,r=a.backgroundFillSymbol,r=r&&x.createMeshTemplates([],p,r,d,l,h),t=0;t<g.length;t++){var v=g[t],u=x.createMeshTemplates([],p,v.symbol,d,l,h);k.add(v.value,r?r.concat(u):u)}if(a=a.defaultSymbol)d=x.createMeshTemplates([],p,a,d,l,h),k.setDefault(r?r.concat(d):d);return new c(k,b,p,e,f,m,l,q,h,n)};c._fromClassBreaksRenderer=function(a,b,d,e,f,n,h,t){for(var g=a.isMaxInclusive,m=a.visualVariables,l=a.valueExpression,k=a.normalizationField,
p=a.normalizationTotal,r=a.normalizationType,q=w.getVVFlags(m),g=new F.IntervalMatcher(a.field,g,l?{valueExpression:l,spatialReference:n,layer:b}:null,{normalizationField:k,normalizationTotal:p,normalizationType:r}),l=new C,k=(k=a.backgroundFillSymbol)&&x.createMeshTemplates([],l,k,d,q,h,!0),p=0,r=a.classBreakInfos;p<r.length;p++){var v=r[p],u=x.createMeshTemplates([],l,v.symbol,d,q,h);g.add({min:v.minValue,max:v.maxValue},k?k.concat(u):u)}if(a=a.defaultSymbol)d=x.createMeshTemplates([],l,a,d,q,h),
g.setDefault(k?k.concat(d):d);return new c(g,b,l,e,f,m,q,n,h,t)};return c}();B.default=A});