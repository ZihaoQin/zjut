// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(y,z,u,v,w,l,r){var q=new l("0/0/0/0"),x=function(){function d(b,a,c,p,d,e,k,h){this.x=b;this.ymin=a;this.ymax=c;this.invM=p;this.leftAdjust=d;this.rightAdjust=e;this.leftBound=k;this.rightBound=h}d.create=function(b,a){var c;b[1]>a[1]&&(c=[a,b],b=c[0],a=c[1]);c=b[0];b=b[1];var p=a[0];a=a[1];var t=p-c,e=a-b,e=0!==e?t/e:0,k=(Math.ceil(b)-b)*e,h=(Math.floor(b)-b)*
e;return new d(c,Math.floor(b),Math.ceil(a),e,0>t?k:h,0>t?h:k,0>t?p:c,0>t?c:p)};d.prototype.incrRow=function(){this.x+=this.invM};d.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};d.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return d}(),f=[[0,0],[0,0],[0,0],[0,0]];return function(){function d(b,a){var c=this;this.tileInfo=b;this.fullExtent=a;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel=
{};var p=b.lods.slice();p.sort(function(a,b){return b.scale-a.scale});var d=this._lodInfos=p.map(function(c){return v.create(b,c,a)});p.forEach(function(a,b){c._infoByLevel[a.level]=d[b];c._infoByScale[a.scale]=d[b];c.scales[b]=a.scale},this);this._wrap=b.isWrappable}d.prototype.getLODInfoAt=function(b){return this._infoByLevel[b.level]};d.prototype.getTileBounds=function(b,a,c){void 0===c&&(c=!1);q.set(a);return(a=this._infoByLevel[q.level])?a.getTileBounds(b,q,c):b};d.prototype.getTileCoords=function(b,
a,c){void 0===c&&(c=!1);q.set(a);return(a=this._infoByLevel[q.level])?a.getTileCoords(b,q,c):b};d.prototype.getTileCoverage=function(b,a){void 0===a&&(a=192);var c=this.getClosestInfoForScale(b.scale),p=w.pool.acquire(c),d=this._wrap,e;e=Infinity;var k=-Infinity,h,n,l=p.spans;f[0][0]=f[0][1]=f[1][1]=f[3][0]=-a;f[1][0]=f[2][0]=b.size[0]+a;f[2][1]=f[3][1]=b.size[1]+a;for(a=0;a<f.length;a++){var g=f[a];b.toMap(g,g);g[0]=c.getColumnForX(g[0]);g[1]=c.getRowForY(g[1])}b=[];g=3;for(a=0;4>a;a++){if(f[a][1]!==
f[g][1]){var m=x.create(f[a],f[g]);e=Math.min(m.ymin,e);k=Math.max(m.ymax,k);void 0===b[m.ymin]&&(b[m.ymin]=[]);b[m.ymin].push(m)}g=a}if(null==e||null==k||100<k-e)return null;for(g=[];e<k;){null!=b[e]&&(g=g.concat(b[e]));h=Infinity;n=-Infinity;for(a=g.length-1;0<=a;a--)m=g[a],h=Math.min(h,m.getLeftCol()),n=Math.max(n,m.getRightCol());h=Math.floor(h);n=Math.floor(n);if(e>=c.first[1]&&e<=c.last[1])if(d)if(c.size[0]<c.worldSize[0])for(m=Math.floor(n/c.worldSize[0]),a=Math.floor(h/c.worldSize[0]);a<=
m;a++)l.push(new r(e,Math.max(c.getFirstColumnForWorld(a),h),Math.min(c.getLastColumnForWorld(a),n)));else l.push(new r(e,h,n));else h>c.last[0]||n<c.first[0]||(h=Math.max(h,c.first[0]),n=Math.min(n,c.last[0]),l.push(new r(e,h,n)));e+=1;for(a=g.length-1;0<=a;a--)m=g[a],m.ymax>=e?m.incrRow():g.splice(a,1)}return p};d.prototype.getTileIdAtParent=function(b,a){a=l.pool.acquire(a);var c=this._infoByLevel[a.level];if(b.resolution<c.resolution)throw Error("Cannot calculate parent tile. destination LOD's resolution "+
b.resolution+" is not a parent resolution of "+c.resolution);return b.resolution===c.resolution?a.id:l.getId(b.level,Math.floor(a.row*c.resolution/b.resolution+.01),Math.floor(a.col*c.resolution/b.resolution+.01),a.world)};d.prototype.getTileParentId=function(b){b=l.pool.acquire(b);var a=this._lodInfos.indexOf(this._infoByLevel[b.level])-1;if(0>a)return l.pool.release(b),null;a=this.getTileIdAtParent(this._lodInfos[a],b);l.pool.release(b);return a};d.prototype.getTileResolution=function(b){return(b=
this._infoByLevel["object"===typeof b?b.level:b])?b.resolution:-1};d.prototype.getTileScale=function(b){return(b=this._infoByLevel[b.level])?b.scale:-1};d.prototype.intersects=function(b,a){var c=l.pool.acquire(a);a=this._infoByLevel[c.level];var d=b.lodInfo;if(d.resolution>a.resolution){var f=l.pool.acquire(this.getTileIdAtParent(d,c)),e=d.denormalizeCol(f.col,f.world);a=b.spans.some(function(a){return a.row===f.row&&a.colFrom<=e&&a.colTo>=e});l.pool.release(c);l.pool.release(f);return a}if(d.resolution<
a.resolution){var k=b.spans.reduce(function(a,b){a[0]=Math.min(a[0],b.row);a[1]=Math.max(a[1],b.row);a[2]=Math.min(a[2],b.colFrom);a[3]=Math.max(a[3],b.colTo);return a},[Infinity,-Infinity,Infinity,-Infinity]);b=k[0];var h=k[1],n=k[2],k=k[3],q=a.denormalizeCol(c.col,c.world),g=d.getColumnForX(a.getXForColumn(q)),m=d.getRowForY(a.getYForRow(c.row)),q=d.getColumnForX(a.getXForColumn(q+1))-1;a=d.getRowForY(a.getYForRow(c.row+1))-1;l.pool.release(c);return!(g>k||q<n||m>h||a<b)}var r=d.denormalizeCol(c.col,
c.world);a=b.spans.some(function(a){return a.row===c.row&&a.colFrom<=r&&a.colTo>=r});l.pool.release(c);return a};d.prototype.normalizeBounds=function(b,a,c){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];this._wrap&&(a=u.getInfo(this.tileInfo.spatialReference),c=-c*(a.valid[1]-a.valid[0]),b[0]+=c,b[2]+=c);return b};d.prototype.getClosestInfoForScale=function(b){var a=this.scales;this._infoByScale[b]||(b=a.reduce(function(a,d,f,e){return Math.abs(d-b)<Math.abs(a-b)?d:a},a[0]));return this._infoByScale[b]};
return d}()});