// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../../../../../core/screenUtils ../../color ../../definitions ../../enums ../../Geometry ../../number ../../TextShaping ../../WGLDisplayRecord ../../collisions/BoundingBox ./WGLMeshTemplate ../../util/BidiText".split(" "),function(w,v,D,E,n,x,F,u,q,r,y,z,G,H,I){Object.defineProperty(v,"__esModule",{value:!0});var J=E.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),A=24*1.2,C=function(){function n(b,
k,a,c,d,e,f,g,h){this.materialId=b;this.vertexOffsetUpperLeft=k;this.vertexOffsetUpperRight=a;this.vertexOffsetLowerLeft=c;this.vertexOffsetLowerRight=d;this.texFontSizeUpperLeft=e;this.texFontSizeUpperRight=f;this.texFontSizeLowerLeft=g;this.texFontSizeLowerRight=h}n.from=function(b,k,a,c,d){var e=b.glyphMosaicItem,f=e.rect,g=e.metrics,h=Math.round(f.x/4),l=Math.round(f.y/4),e=h+Math.round(f.width/4),B=l+Math.round(f.height/4);if(b.codePoint){var t=b.x+0+g.left;b=b.y+-17-g.top;b=new q.Point(t-4,
b-4);f=new q.Point(b.x+f.width,b.y+f.height)}else t=b.x,b=b.y,b=new q.Point(t,b),f=new q.Point(b.x+g.width,b.y+g.height);g=new q.Point(b.x,f.y);t=new q.Point(f.x,b.y);if(a){var p=Math.cos(a);a=Math.sin(a);b.rotate(p,a);f.rotate(p,a);g.rotate(p,a);t.rotate(p,a)}a=r.i1616to32(8*b.x,8*b.y);b=r.i1616to32(8*t.x,8*t.y);g=r.i1616to32(8*g.x,8*g.y);f=r.i1616to32(8*f.x,8*f.y);t=r.i8888to32(h,l,c,d);l=r.i8888to32(e,l,c,d);h=r.i8888to32(h,B,c,d);c=r.i8888to32(e,B,c,d);return new n(k,a,b,g,f,t,l,h,c)};return n}();
v.ComputedGlyph=C;w=function(q){function b(b,a,c){var d=q.call(this)||this;d.geometryType=u.WGLGeometryType.TEXT;var e=c.haloColor;d.color=(c.color&&x.premultiplyAlphaRGBA(c.color))|0;d.textSize=n.pt2px(c.font.size);var f=c.yoffset/c.font.size;d.shapingXOffset=c.xoffset/c.font.size*24;d.shapingYOffset=24*f;d.haloColor=(e&&x.premultiplyAlphaRGBA(e))|0;d.haloSize=10*n.pt2px(n.toPt(c.haloSize||0));d.textPropColor=d.color||F.PICTURE_FILL_COLOR;d.textPropSize=n.pt2px(c.font.size);d.textPropAngle=c.angle*
Math.PI/180;d.xOffset=n.pt2px(c.xoffset);d.yOffset=n.pt2px(c.yoffset);d.textPropHAnchor="left"===c.horizontalAlignment?0:"right"===c.horizontalAlignment?1:.5;d.textPropVAnchor="top"===c.verticalAlignment?0:"bottom"===c.verticalAlignment?1:.5;d.textPropHaloColor=d.haloColor||4294967295;d.textPropHaloSize=n.pt2px(n.toPt(c.haloSize||0));d._materialStore=b;d.vvFlags=a;return d}D(b,q);b.fromText=function(k,a,c,d,e){k=new b(k,a,c);k.computeGlyphs(e,c.text,!1);return k};b.prototype.writeMesh=function(b,
a,c,d,e,f,g){f=a.indexVector;var k=a.get("geometry");a=a.get("visibility");var l=this._getOffset(k);switch(c){case "esriGeometryPoint":e=e.geometry;c=e.x;e=e.y;this._writeVertices(b,f,k,a,l,d,c,e,g);break;case "esriGeometryPolygon":if(e.centroid){e=e.centroid;c=e.x;e=e.y;this._writeVertices(b,f,k,a,l,d,c,e,g);break}default:J.error("Unable to handle geometryType: "+c)}};b.prototype.computeGlyphs=function(b,a,c){if(!a||!a.length)return this._computedGlyphs=[],null;b=this._computeShaping(b,240,A,0,this.shapingXOffset,
this.shapingYOffset,this.textPropHAnchor,this.textPropVAnchor,.5);a=I.bidiText(a);a=b.getShaping(a[0],a[1]);b=Array(a.length);for(var d=0;d<a.length;d++){var e=this.textPropAngle,f=this.textSize,g=this.haloSize,k=this._materialStore.createGlyphMaterial(a[d].glyphMosaicItem,u.WGLGeometryType.TEXT,this.vvFlags);b[d]=C.from(a[d],k,e,f,g)}this._computedGlyphs=b;if(!c)return null;c=y.getBox(a);c.width*=this.textSize/24;c.height*=this.textSize/24;return new G.default(c.x,c.y,c.width,c.height)};b.prototype._computeShaping=
function(b,a,c,d,e,f,g,h,l){return this._shaping=new y([b],240,A,0,[e,f],g,h,.5)};b.prototype._getOffset=function(b){return b.length/(this.vvFlags?9:5)};b.prototype._writeVertices=function(b,a,c,d,e,f,g,h,l){var k=this._computedGlyphs,n=r.i1616to32(2*g,2*h);g=r.i1616to32(2*g+1,2*h);h=0;if(this.haloSize)for(var p=0;p<k.length;p++,h+=4){var m=k[p].materialId,q=this._materialStore.get(m),m=new z(f,this.geometryType,m);m.vertexFrom=e+h;m.indexFrom=a.length;this._writeVertex(m,c,d,f,g,this.haloColor,k[p],
q,l);this._writeIndices(m,a,e+h);b.push(m)}for(p=0;p<k.length;p++,h+=4)m=k[p].materialId,q=this._materialStore.get(m),m=new z(f,this.geometryType,m),m.vertexFrom=e+h,m.indexFrom=a.length,this._writeVertex(m,c,d,f,n,this.color,k[p],q,l),this._writeIndices(m,a,e+h),b.push(m)};b.prototype._writeVertex=function(b,a,c,d,e,f,g,h,l){a.push(e);a.push(d);a.push(f);a.push(g.vertexOffsetUpperLeft);a.push(g.texFontSizeUpperLeft);this._writeVV(a,l,h);a.push(e);a.push(d);a.push(f);a.push(g.vertexOffsetUpperRight);
a.push(g.texFontSizeUpperRight);this._writeVV(a,l,h);a.push(e);a.push(d);a.push(f);a.push(g.vertexOffsetLowerLeft);a.push(g.texFontSizeLowerLeft);this._writeVV(a,l,h);a.push(e);a.push(d);a.push(f);a.push(g.vertexOffsetLowerRight);a.push(g.texFontSizeLowerRight);this._writeVV(a,l,h);c.push(4294967295);b.vertexCount+=4};b.prototype._writeVV=function(b,a,c){c.materialKeyInfo.hasVV()&&(b.push(a[u.VVType.SIZE]),b.push(a[u.VVType.COLOR]),b.push(a[u.VVType.OPACITY]),b.push(a[u.VVType.ROTATION]))};b.prototype._writeIndices=
function(b,a,c){a.push(c+0);a.push(c+1);a.push(c+2);a.push(c+1);a.push(c+3);a.push(c+2);b.indexCount+=6};return b}(H.default);v.default=w});