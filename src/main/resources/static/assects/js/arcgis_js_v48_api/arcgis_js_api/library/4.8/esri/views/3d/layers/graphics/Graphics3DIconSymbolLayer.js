// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper dojo/when dojo/errors/CancelError ../../../../Color ../../../../core/Error ../../../../core/lang ../../../../core/screenUtils ../../../../core/sniff ../../../../core/urlUtils ../../../../symbols/support/symbolUtils ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./SignedDistanceFunctions ../support/FastSymbolUpdates ../../lib/glMatrix ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(x,fa,G,H,I,J,K,y,L,n,M,N,O,P,Q,R,m,u,S,p,r,v,T,t,U,z,V,W,A){function w(h){return"cross"===h||"x"===h}function X(h){var b;"primitive:"===h.substring(0,10)&&(h=h.substring(10));switch(h){case q.PRIM_CIRCLE:b=p.computeSignedDistancefieldCicle(128,64);break;case q.PRIM_SQUARE:b=p.computeSignedDistancefieldSquare(128,64,!1);break;case q.PRIM_KITE:b=p.computeSignedDistancefieldSquare(128,64,!0);break;case q.PRIM_CROSS:b=p.computeSignedDistancefieldCrossAndX(128,64,!1);break;case q.PRIM_X:b=p.computeSignedDistancefieldCrossAndX(128,
64,!0)}return new W(b,"sdf_"+h,{mipmap:!1,wrapClamp:!0,width:128,height:128,components:4})}var Y=v.vec3d;x=v.vec4d;var B=v.mat4d.identity(),C=[0,0,1],Z=[0,0,0,0],D=[0,0,0],aa=[1,1,1],E="center bottom top left right bottom-left bottom-right top-left top-right".split(" "),ba=[.25,.25,.75,.75],q={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"},ca=[64,64];u=function(h){function b(){var a=null!==h&&h.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!0,
supportsOnTheGround:!0};return a}H(b,h);b.prototype._prepareResources=function(){var a=this.symbol,c=Math.round(null!=a.size?n.pt2px(a.size):16);this._size=null;this._symbolTextureRatio=1;this._primitive=null;var f=this._getStageIdHint();if(!this._isPropertyDriven("size")){var d=S.validateSymbolLayerSize(c);if(d){this._logWarning(d);this.reject();return}}this._isPropertyDriven("size")&&64>c&&(c=64);var g=a.resource||{primitive:"circle",href:void 0},d={anchorPos:this._getAnchorPos(a)},e=this.symbolContainer;
if(this._hasVisibleVerticalOffset(e)){var e=e.verticalOffset,b=e.minWorldLength,F=e.maxWorldLength;d.verticalOffset={screenLength:n.pt2px(e.screenLength),minWorldLength:b||0,maxWorldLength:null!=F?F:Infinity}}this._context.screenSizePerspectiveEnabled&&(d.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);g.href?(this._outlineSize=this._getOutlineSize(a,null),d.color=this._getFillColor(a,null),d.outlineColor=this._getOutlineColor(a),d.outlineSize=this._outlineSize,
d.textureIsSignedDistanceField=!1,this._prepareImageResources(c,d,f)):(g=g.primitive||"circle",e="primitive:"+g,this._primitive=g,this._outlineSize=this._getOutlineSize(a,g),d.color=this._getFillColor(a,g),d.outlineColor=this._getOutlineColor(a),d.outlineSize=this._outlineSize,w(g)&&0===d.outlineSize?this.reject():(this.texture=this._context.sharedResources.textures.acquire(e,X),this._textureURI=e,d.textureIsSignedDistanceField=!0,d.distanceFieldBoundingBox=ba,d.textureId=this.texture.id,this._size=
[c,c],this._symbolTextureRatio=2,this._createMaterialsAndAddToStage(d,this._context.stage,f),this.resolve()))};b.prototype._getOutlineSize=function(a,c){var f=0,f=a.outline&&null!=a.outline.size?n.pt2px(a.outline.size):w(c)?1.5:0;return Math.max(f,0)};b.prototype._getOutlineColor=function(a){var c=this._getLayerOpacity();if(a.outline&&null!=a.outline.color){var f=K.toUnitRGB(a.outline.color);return[f[0],f[1],f[2],a.outline.color.a*c]}return[0,0,0,c]};b.prototype._getFillColor=function(a,c){return w(c)?
Z:this._getMaterialOpacityAndColor()};b.prototype._getAnchorPos=function(a){return-1<E.indexOf(a.anchor)?a.anchor:"center"};b.prototype._prepareImageResources=function(a,c,f){var d=this,b=O.getIconHref(this.symbolContainer,this.symbol);!M("esri-canvas-svg-support")&&N.isSVG(b)?(this._logWarning("IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)"),this.reject(new y("SVG Not Supported","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)"))):(I(this._context.sharedResources.textures.acquire(b,
null,a),function(e){if(!d.isRejected()){var b=e.params,g=b.width/b.height;d._size=a?1<g?[a,Math.round(a/g)]:[Math.round(a*g),a]:[b.width,b.height];c.textureId=e.id;d._createMaterialsAndAddToStage(c,d._context.stage,f);d.resolve()}},function(a){a instanceof J?d.reject():(a="IconSymbol3DLayer failed to load (Request for icon resource failed: "+b+")",d._logWarning(a),d.reject(new y("Request Failed",a)))}),this._textureURI=b)};b.prototype._createMaterialsAndAddToStage=function(a,c,f){this._fastUpdates=
r.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&L.mixin(a,this._fastUpdates.materialParameters);var d=G({},a);d.verticalOffset=null;d.screenSizePerspective=null;d.occlusionTest=!1;d.shaderPolygonOffset=0;this._drapedMaterial=new A(d,f+"_iconDraped");c.add(t.ModelContentType.MATERIAL,this._drapedMaterial);a.occlusionTest=!0;this._material=new A(a,f+"_icon");c.add(t.ModelContentType.MATERIAL,
this._material)};b.prototype.destroy=function(){h.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(t.ModelContentType.MATERIAL,this._material.id),this._material=null);this._drapedMaterial&&(this._context.stage.remove(t.ModelContentType.MATERIAL,this._drapedMaterial.id),this._drapedMaterial=null);this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=null)};b.prototype._getScaleFactor=function(a){if(this._isPropertyDriven("size")&&
a.size){for(var c=0;3>c;c++){var f=a.size[c];f&&"symbolValue"!==f&&"proportional"!==f&&(a.size[c]=n.pt2px(f))}c=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"!==a.size[0]){if(isFinite(+a.size[0]))return+a.size[0]/c;if(isFinite(+a.size[2]))return+a.size[2]/c}}return 1};b.prototype.createGraphics3DGraphic=function(a){var c=a.renderingInfo;a=a.graphic;if(!this._validateGeometry(a.geometry))return null;var f=m.placePointOnGeometry(a.geometry);if(!f)return this._logWarning("unsupported geometry type for icon symbol: "+
a.geometry.type),null;var d="graphic"+a.uid,b=this._getVertexOpacityAndColor(c),e=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(e=this._getScaleFactor(c));e*=this._symbolTextureRatio;c=[this._size[0]*e,this._size[1]*e];e=this.getGraphicElevationContext(a);return"on-the-ground"===e.mode?this._createAsOverlay(a,f,b,c,e,d,a.uid):this._createAs3DShape(a,f,b,c,e,d,a.uid)};b.prototype.layerPropertyChanged=function(a,c,f){if("opacity"===a)return c=this._getFillColor(this.symbol,this._primitive),
this._drapedMaterial.setParameterValues({color:c}),this._material.setParameterValues({color:c}),c=this._getOutlineColor(this.symbol),this._drapedMaterial.setParameterValues({outlineColor:c}),this._material.setParameterValues({outlineColor:c}),!0;if("elevationInfo"===a){a=this._elevationContext.mode;this._updateElevationContext();var d=this._elevationContext.mode;if("on-the-ground"===a&&"on-the-ground"===d)return!0;if(a!==d&&("on-the-ground"===a||"on-the-ground"===d))return!1;a=m.needsElevationUpdates2D(d)||
"absolute-height"===d;for(var b in c){var e=c[b];(d=f(e))&&"object3d"===d.type&&(e=this.getGraphicElevationContext(e.graphic),d.needsElevationUpdates=a,d.elevationContext.set(e))}return!0}return!1};b.prototype.applyRendererDiff=function(a,c,b,d){for(var f in a.diff)switch(f){case "visualVariables":if(r.updateFastSymbolUpdatesState(this._fastUpdates,c,this._fastVisualVariableConvertOptions()))this._material.setParameterValues(this._fastUpdates.materialParameters),this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);
else return!1;break;default:return!1}return!0};b.prototype.setDrawOrder=function(a,c,b){this.updateSymbolLayerOrder(a,c);this._drapedMaterial&&(this._drapedMaterial.renderPriority=a,b.add(this._drapedMaterial.id))};Object.defineProperty(b.prototype,"numberOfVertices",{get:function(){return 6},enumerable:!0,configurable:!0});b.prototype._defaultElevationInfoNoZ=function(){return da};b.prototype._createAs3DShape=function(a,c,b,d,g,e,h){var f=this,l=this.getFastUpdateAttrValues(a);a=l?function(a){return r.evaluateModelTransform(f._fastUpdates.materialParameters,
l,a)}:null;b=z.createPointGeometry(C,null,b,d,ea,null,l);b=[new U(b,e)];e=m.createStageObjectForPoint.call(this,c,b,[[this._material]],null,null,g,e,this._context.layer.uid,h,!0,a);if(null===e)return null;var k=new R(this,e.object,b,null,null,P.perObjectElevationAligner,g);k.alignedTerrainElevation=e.terrainElevation;k.needsElevationUpdates=m.needsElevationUpdates2D(g.mode)||"absolute-height"===g.mode;k.getScreenSize=this._createScreenSizeGetter(d,a);k.calculateRelativeScreenBounds=function(a){return f._material.calculateRelativeScreenBounds(k.getScreenSize(),
1,a)};m.extendPointGraphicElevationContext(k,c,this._context.elevationProvider);return k};b.prototype._createAsOverlay=function(a,c,b,d,g,e,h){var f=this;this._drapedMaterial.renderPriority=this._symbolLayerOrder;g=Y.create();T.pointToVector(c,g,this._context.overlaySR);g[2]=this._getDrapedZ();if((c=this._context.clippingExtent)&&!m.pointInBox2D(g,c))return null;var l=this.getFastUpdateAttrValues(a);a=l?function(a){return r.evaluateModelTransform(f._fastUpdates.materialParameters,l,a)}:null;b=z.createPointGeometry(C,
g,b,d,null,null,l);c=new V(b);c.material=this._drapedMaterial;c.center=g;c.bsRadius=0;c.transformation=B;c.name=e;c.uniqueName=e+"#"+b.id;var k=new Q(this,[c],null);k.getScreenSize=this._createScreenSizeGetter(d,a);k.calculateRelativeScreenBounds=function(a){return f._drapedMaterial.calculateRelativeScreenBounds(k.getScreenSize(),1,a)};return k};b.prototype._createScreenSizeGetter=function(a,c){var b=this._outlineSize+2;if(this._fastUpdates.enabled){var d=a[0]/this._symbolTextureRatio,g=a[1]/this._symbolTextureRatio;
return function(a){void 0===a&&(a=Array(2));var e=c(B);a[0]=e[0]*d+b;a[1]=e[5]*g+b;return a}}var e=a[0]/this._symbolTextureRatio+b,h=a[1]/this._symbolTextureRatio+b;return function(a){void 0===a&&(a=Array(2));a[0]=e;a[1]=h;return a}};b.prototype._supportsShaderVisualVariables=function(){return!0};b.prototype._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1],b=[a,a,a],f=n.px2pt(1),a=a*f;return{modelSize:b,symbolSize:[a,a,a],unitInMeters:f,transformation:{anchor:D,
scale:aa,rotation:D}}};b.prototype._hasVisibleVerticalOffset=function(a){return this.symbolContainer&&"point-3d"===this.symbolContainer.type&&this.symbolContainer.hasVisibleVerticalOffset()};b.PRIMITIVE_SIZE=ca;b.VALID_ANCHOR_STRINGS=E;return b}(u);var da={mode:"relative-to-ground",offset:0},ea=x.createFrom(0,0,0,1);return u});