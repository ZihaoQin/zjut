// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper dojo/promise/all ../../../../Color ../../../../core/Accessor ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/LabelClass ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DWebStyleSymbol ./labelPlacement ../../support/debugFlags ../../webgl-engine/Stage ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextTexture ../../webgl-engine/lib/TextTextureAtlas".split(" "),
function(m,u,B,p,C,v,D,E,F,w,n,x,G,H,I,J,K,y,L,z,M,N){Object.defineProperty(u,"__esModule",{value:!0});m=function(m){function b(a){a=m.call(this)||this;a.labelStageLayer=null;a.labels={};a.labelsToAdd={};a.labelsToRemove={};a.labelingContexts=[];a.idHint="__labeler";a.dirty=!1;return a}B(b,m);h=b;b.prototype.setup=function(){var a=this;this.handles||(this.handles=new E,this.handles.add([this.view.watch("state.camera",function(){return a.setDirty()})]));this.labelStageLayer||(this.labelStageLayer=
new L(this.idHint,{isPickable:!1},this.idHint+"_labels"),this.view._stage.add(y.ModelContentType.LAYER,this.labelStageLayer),this.view._stage.addToViewContent([this.labelStageLayer.id]),this.textTextureAtlas=new N(this.idHint+"_atlas",this.view),this.hudMaterialCollection=new z(this.view._stage),this.calloutMaterialCollection=new z(this.view._stage));this.handles.add(this.view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return a.needsIdleUpdate()},idleFrame:function(c){return a.idleUpdate(c)}}))};
b.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.labelStageLayer&&(this.view._stage.removeFromViewContent([this.labelStageLayer.id]),this.view._stage.remove(y.ModelContentType.LAYER,this.labelStageLayer.id),this.labelStageLayer=null,this.textTextureAtlas.dispose(),this.textTextureAtlas=null,this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null,this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=
[];this.labels={};this.labelsToAdd={};this.labelsToRemove={}};b.prototype.isActiveLabelingContext=function(a){return a.active&&this.labelsEnabled(a)};b.prototype.activateLabelingContext=function(a){for(var c in a.labels){var d=a.labels[c];this.labels[c]=d;d.graphics3DGraphic.setVisibilityFlag(0,!0,1)}a.active=!0};b.prototype.deactivateLabelingContext=function(a){for(var c in a.labels){var d=a.labels[c];d.graphics3DGraphic.setVisibilityFlag(0,!1,1);d.rendered&&(this.labelsToRemove[c]=a.labels[c]);
delete this.labels[c];delete this.labelsToAdd[c]}a.active=!1};b.prototype.addLabelTextureToAtlas=function(a){for(var c=0;c<a.graphics3DGraphic._labelGraphics.length;c++)a.textTextures[c]&&this.textTextureAtlas.addTextTexture(a.textTextures[c],a.graphics3DGraphic._labelGraphics[c].stageObject);a.rendered=!0};b.prototype.removeLabelTextureFromAtlas=function(a){for(var c=0;c<a.graphics3DGraphic._labelGraphics.length;c++)a.textTextures[c]&&this.textTextureAtlas.removeTextTexture(a.textTextures[c],a.graphics3DGraphic._labelGraphics[c].stageObject);
a.rendered=!1};b.prototype.needsIdleUpdate=function(){return this.isDirty};b.prototype.idleUpdate=function(a){if(this.view.ready){for(var c=!!a,d=!1,q=0,b=this.labelingContexts;q<b.length;q++){var e=b[q];if(this.isActiveLabelingContext(e)){if(!this.hasValidLabelClassContext(e)){if(this.hasInvalidLabelClassContext(e)){this.deactivateLabelingContext(e);continue}this.createLabelClassContext(e);if(this.hasPendingLabelClassContext(e)){d=!0;continue}if(!this.hasValidLabelClassContext(e))continue}for(var g in e.labelsToInitialize){if(c&&
a.done())return;var k=e.labelsToInitialize[g];!k.hasGraphics3DResources&&this.createGraphics3DResources(k)&&(this.labels[g]=k,c&&this.view.deconflictor.setDirty());k.hasGraphics3DResources&&!k.hasTextTextureResources&&k.visible&&this.createTextTextureResources(k);(k.visible&&k.hasTextTextureResources||!k.visible&&k.hasGraphics3DResources)&&delete e.labelsToInitialize[g]}}}for(g in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[g]),delete this.labelsToRemove[g];for(g in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[g]),
delete this.labelsToAdd[g];d||(this.dirty=!1)}};b.prototype.hasPendingLabelClassContext=function(a){return a.labelClassPromise&&!a.labelClassPromise.isResolved()};b.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};b.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};b.prototype.createLabelClassContext=function(a){if(a.labelClassPromise)return a.labelClassPromise;a.labelClassPromise=a.layer.when(function(){a.scaleVisibility&&
a.scaleVisibility.updateScaleRangeActive();var c=a.graphics3DCore,d=c.layer.labelingInfo&&c.layer.labelingInfo.filter(function(a){return!!a.symbol});if(!d||0===d.length)return null;var q=Array(d.length),d=d.map(function(a,d){var e=a.symbol,b;b=c.getOrCreateGraphics3DSymbol(e);b=b instanceof I?b.graphics3DSymbol:b;var f=null;G.isCalloutSupport(e)&&e.hasVisibleCallout()&&(f=H.make(e,c.symbolCreationContext));q[d]={labelClass:a,graphics3DSymbol:b,graphics3DCalloutSymbolLayer:f,options:a.getOptions()};
return b});return C(d).then(function(){return q})}).then(function(c){c&&(a.labelClassContexts=c)}).catch(function(){a.labelClassContexts=null});return a.labelClassPromise};b.prototype.destroyLabelClassContext=function(a){a.labelClassContexts=[];a.labelClassPromise=null};b.prototype.createLabelText=function(a,c,d,b){if(!x.evaluateWhere(c.where,a.attributes))return null;c=c.getLabelExpression();return c.expression?x.buildLabelText(c.expression,a,b.fields,d):null};b.prototype.createTextSymbolGraphic=
function(a,c,d,b,f){a={text:a,centerOffset:d.centerOffset,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,anchor:d.anchor,needsOffsetAdjustment:d.needsOffsetAdjustment,centerOffsetUnits:d.centerOffsetUnits,verticalOffset:d.verticalOffset,debugDrawBorder:K.LABELS_SHOW_BORDER};h.tmpGraphicCreationContext.graphic=c;h.tmpGraphicCreationContext.renderingInfo=null;h.tmpGraphicCreationContext.layer=b;return f.createGraphics3DGraphic(h.tmpGraphicCreationContext,a,this.hudMaterialCollection,
this.textTextureAtlas)};b.prototype.createLineCalloutGraphic=function(a,c,d,b,f){h.tmpGraphicCreationContext.graphic=a;h.tmpGraphicCreationContext.renderingInfo={symbol:c,needsOffsetAdjustment:b.needsOffsetAdjustment,translation:b.translation,elevationOffset:b.elevationOffset,screenOffset:b.screenOffset,centerOffset:b.centerOffset,centerOffsetUnits:b.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};h.tmpGraphicCreationContext.layer=f;return d.createGraphics3DGraphic(h.tmpGraphicCreationContext)};
b.prototype.createGraphics3DResources=function(a){var c=a.labelingContext,d=!1,b=a.graphics3DGraphic,f=b.graphic,e=c.labelClassContexts,g=c.layer,k=this.labelsEnabled(c);if(e&&0!==e.length&&b._graphics[0]){for(var t=0;t<e.length;t++){var l=e[t],h=l.labelClass,m=this.createLabelText(f,h,l.options,g);if(m){var n=null;l.graphics3DSymbol&&l.graphics3DSymbol.symbol&&"label-3d"===l.graphics3DSymbol.symbol.type&&(n=l.graphics3DSymbol.symbol);var p=l.graphics3DSymbol.childGraphics3DSymbols[0],r=J.get({graphics3DGraphic:b,
labelSymbol:n,labelClass:l.labelClass});if(p&&r.isValid){if(d=this.createTextSymbolGraphic(m,f,r,g,p)){if(d._labelClass=h,b.addLabelGraphic(d,this.labelStageLayer,this.view._stage),c.spatialIndex&&c.spatialIndex.add(b),b.setVisibilityFlag(0,k,1),b.setVisibilityFlag(1,void 0,1),b.setVisibilityFlag(2,!1,1),d=!0,l.graphics3DCalloutSymbolLayer&&r.hasLabelVerticalOffset&&(f=this.createLineCalloutGraphic(f,n,l.graphics3DCalloutSymbolLayer,r,g)))l.calloutSymbolLayerIndex=b._labelGraphics.length,b.addLabelGraphic(f,
this.labelStageLayer,this.view._stage)}else return!1;break}}}c.scaleVisibility&&d&&c.scaleVisibility.updateGraphicLabelScaleVisibility(b);return a.hasGraphics3DResources=!0}};b.prototype.destroyGraphics3DResources=function(a){a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};b.prototype.createTextTextureResources=function(a){var c=a.labelingContext,d=a.graphics3DGraphic,b=c.labelClassContexts,c=c.layer,f=d.graphic;if(b&&0!==b.length&&d._graphics[0]){for(d=0;d<b.length;d++){var e=
b[d],g=this.createLabelText(f,e.labelClass,e.options,c)||f.symbol&&f.symbol.text;if(g&&!(1>g.length)){var e=e.graphics3DSymbol.childGraphics3DSymbols[0].symbol,k=e.material?v.toUnitRGBA(e.material.color):A,h=e.halo&&e.halo.color&&0<e.halo.size,l=h?v.toUnitRGBA(e.halo.color):A,h=h?w.pt2px(e.halo.size):0,m=w.pt2px(e.size)||12,g=new M(g,{size:m,color:k,font:{family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:
"normal"},halo:{size:h,color:l}},c.id+"_label_"+f.uid);a.textTextures.push(g)}}a.hasTextTextureResources=!0}};b.prototype.destroyTextTextureResources=function(a){a.textTextures=[];a.hasTextTextureResources=!1};b.prototype.addGraphic=function(a,c){var d={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:a,graphics3DGraphic:c,textTextures:[]};c=c.graphic.uid;a.labels[c]=d;this.isActiveLabelingContext(a)&&this.hasValidLabelClassContext(a)&&this.createGraphics3DResources(d)?
this.labels[c]=d:a.labelsToInitialize[c]=d;a=a.graphics3DCore.asyncUpdates;this.setDirty(a);this.view.deconflictor.setDirty({async:a})};b.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var d=a.labels[c];d&&(this.labels[c]&&(this.removeLabelTextureFromAtlas(d),delete this.labels[c],delete this.labelsToAdd[c],delete this.labelsToRemove[c]),d.hasTextTextureResources&&this.destroyTextTextureResources(d),d.hasGraphics3DResources&&this.destroyGraphics3DResources(d),delete a.labels[c],delete a.labelsToInitialize[c],
a=a.graphics3DCore.asyncUpdates,this.setDirty(a),this.view.deconflictor.setDirty({async:a}))};b.prototype.labelsEnabled=function(a){return!0===a.layer.labelsVisible};b.prototype.elevationInfoChange=function(a){for(var c=function(c){c.graphics3DSymbol.layerPropertyChanged("elevationInfo",{});if(c.graphics3DCalloutSymbolLayer){var b={},d;for(d in a.labels){var f=a.labels[d].graphics3DGraphic;b[f.graphic.uid]=f}c.graphics3DCalloutSymbolLayer.layerPropertyChanged("elevationInfo",b,function(a){return a._labelGraphics[c.calloutSymbolLayerIndex]})}},
d=0,b=a.labelClassContexts;d<b.length;d++)c(b[d])};b.prototype.visibilityInfoChange=function(a){var c=a.layer.labelsVisible;c&&!a.active&&this.activateLabelingContext(a);!c&&a.active&&this.deactivateLabelingContext(a);a=a.graphics3DCore.asyncUpdates;this.setDirty(a);this.view.deconflictor.setDirty({async:a})};b.prototype.resetLabels=function(a){for(var c in a.labels){var b=a.labels[c];this.labels[c]&&(this.removeLabelTextureFromAtlas(b),delete this.labels[c],delete this.labelsToAdd[c],delete this.labelsToRemove[c]);
b.hasTextTextureResources&&this.destroyTextTextureResources(b);b.hasGraphics3DResources&&this.destroyGraphics3DResources(b);b.visible=!1;b.rendered=!1;a.labelsToInitialize[c]=b}this.destroyLabelClassContext(a);this.labelStageLayer.invalidateSpatialQueryAccelerator();a=a.graphics3DCore.asyncUpdates;this.setDirty(a);this.view.deconflictor.setDirty({async:a})};b.prototype.findLabelingContext=function(a){for(var c=0;c<this.labelingContexts.length;c++)if(this.labelingContexts[c].graphics3DCore===a)return this.labelingContexts[c];
return null};b.prototype.addGraphicsOwner=function(a,c,b){var d=this;if(!this.findLabelingContext(a)){var f={graphics3DCore:a,layer:a.layer,scaleVisibility:c,spatialIndex:b,active:a.layer.labelsVisible,labelClassPromise:null,labelClassContexts:[],labels:{},labelsToInitialize:{}};this.labelingContexts.push(f);this.setDirty();return{addGraphic:function(a){return d.addGraphic(f,a)},removeGraphic:function(a){return d.removeGraphic(f,a)},layerLabelsEnabled:function(){return d.labelsEnabled(f)},labelingInfoChange:function(a){if(a){for(var c=
0;c<a.length;c++){var b=f.labels[a[c]];b&&(d.removeGraphic(f,b.graphics3DGraphic),d.addGraphic(f,b.graphics3DGraphic))}return F.create(function(a){return!0})}d.resetLabels(f);return d.createLabelClassContext(f)},elevationInfoChange:function(){d.elevationInfoChange(f)},visibilityInfoChange:function(){d.visibilityInfoChange(f)},clear:function(){d.resetLabels(f)}}}};b.prototype.removeGraphicsOwner=function(a){if(a=this.findLabelingContext(a)){var c=this.labelingContexts.indexOf(a);this.labelingContexts.splice(c,
1);for(var b in a.labels)this.removeGraphic(a,a.labels[b].graphics3DGraphic);this.setDirty()}};b.prototype.setLabelGraphicVisibility=function(a,c){a=a.graphic.uid;var b=this.labels[a];b&&(c&&!b.rendered?(this.labelsToAdd[a]=b,b.hasTextTextureResources||(b.labelingContext.labelsToInitialize[a]=b)):!c&&b.rendered&&(this.labelsToRemove[a]=b),b.visible=c,this.setDirty(b.labelingContext.graphics3DCore.asyncUpdates))};Object.defineProperty(b.prototype,"labelStageLayerId",{get:function(){return this.labelStageLayer.id},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isDirty",{get:function(){return this.dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0});b.prototype.setDirty=function(a){void 0===a&&(a=!0);this.dirty=!0;a||this.idleUpdate()};Object.defineProperty(b.prototype,"updating",{get:function(){return this.labelingContexts.some(function(a){return a.labelClassPromise&&!a.labelClassPromise.isResolved()})},enumerable:!0,configurable:!0});var h;b.tmpGraphicCreationContext=
{graphic:null,renderingInfo:null,layer:null};p([n.property({constructOnly:!0})],b.prototype,"view",void 0);p([n.property({type:Boolean,readOnly:!0})],b.prototype,"updating",null);return b=h=p([n.subclass()],b)}(n.declared(D));u.Labeler=m;var A=[0,0,0,1]});