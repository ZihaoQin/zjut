// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/PooledArray ../../support/intersectionUtils ./ComponentUtils ./depthRange ./gl-matrix ./Util".split(" "),function(x,q,D,y,E,p,h,F){function z(d,a){var b=p.empty(),c=a.getObjects();a.getSpatialQueryAccelerator()?G(b,d,a.getSpatialQueryAccelerator()):H(b,d,c);return b}function G(d,a,b){var c=a.eye,f=a.viewForward,g=a.frustumPlanes,e=function(a){return!a.areAllComponentsHidden()},n=b.objectCount;500>n?(p.set(k,a.near,Math.min(d.near,a.far)),b.forEachInDepthRange(c,
f,"front-to-back",k,function(b,c){u(d,a,b);k.far=d.near;c.setRange(k)},g,e),p.set(k,Math.max(d.far,a.near),a.far),b.forEachInDepthRange(c,f,"back-to-front",k,function(b,c){u(d,a,b);k.near=d.far;c.setRange(k)},g,e)):(n=Math.max(Math.min(n,500),Math.ceil(.1*n)),c=b.findClosest(f,"front-to-back",g,e,n),b=b.findClosest(f,"back-to-front",g,e,n),c&&b&&(A(d,a,c.getCenter(),c.getBSRadius()),A(d,a,b.getCenter(),b.getBSRadius())))}function H(d,a,b){r.clear();b.forEach(function(a){a.areAllComponentsHidden()||
r.add(a)});r.empty||(r.sort(a),p.set(k,a.near,Math.min(d.near,a.far)),r.forEachInDepthRange(k,"front-to-back",function(b,f,g){f<d.near&&u(d,a,b)}),p.set(k,Math.max(d.far,a.near),a.far),r.forEachInDepthRange(k,"back-to-front",function(a,b,g){d.far=Math.max(d.far,g)}))}function u(d,a,b){if(!b.areAllComponentsHidden()&&y.frustumSphere(a.frustumPlanes,b.getCenter(),b.getBSRadius())){var c=b.objectTransformation,f=I;b.geometryRecords.forEach(function(b){h.mat4d.multiply(c,b.getShaderTransformation(),f);
var e=h.mat4d.maxScale(f);b=b.geometry.getBoundingInfo();B(d,a,b,f,e)})}}function B(d,a,b,c,f){var g=a.eye,e=a.viewForward;h.mat4d.multiplyVec3(c,b.center,m);g=e[0]*(m[0]-g[0])+e[1]*(m[1]-g[1])+e[2]*(m[2]-g[2]);e=b.bsRadius*f;if(!(g-e>d.near&&g+e<d.far)&&y.frustumSphere(a.frustumPlanes,m,e))if(100<b.bsRadius&&b.getChildren())for(b=b.getChildren(),g=0;8>g;++g)b[g]&&B(d,a,b[g],c,f);else v.unionDepthRangeWithAABB(d,a.viewProjectionMatrix,c,b.bbMin,b.bbMax)}function A(d,a,b,c){var f=a.eye;a=a.viewForward;
b=(b[0]-f[0])*a[0]+(b[1]-f[1])*a[1]+(b[2]-f[2])*a[2];d.near=Math.min(d.near,b-c);d.far=Math.max(d.far,b+c)}Object.defineProperty(q,"__esModule",{value:!0});q.depthRangeFromScene=function(d,a,b){if(1E4>a.size)return J.compute(d,a);a=p.empty();for(var c in b)p.union(a,z(d,b[c]));return a};q.depthRangeFromLayer=z;x=function(){function d(){this._items=new D({allocator:function(){return{obj:null,distance:0,near:0,far:0}}})}Object.defineProperty(d.prototype,"length",{get:function(){return this._items.length},
enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"empty",{get:function(){return 0===this._items.length},enumerable:!0,configurable:!0});d.prototype.clear=function(){this._items.clear()};d.prototype.add=function(a){this._items.pushNew().obj=a};d.prototype.sort=function(a){var b=a.eye,c=a.viewForward;this._items.forEach(function(a){var f=a.obj,e=f.getCenter(),f=f.getBSRadius(),e=(e[0]-b[0])*c[0]+(e[1]-b[1])*c[1]+(e[2]-b[2])*c[2];a.distance=e;a.near=e-f;a.far=e+f});this._items.sort(function(a,
b){return a.distance-b.distance})};d.prototype.forEachInDepthRange=function(a,b,c){if("front-to-back"===b)for(b=0;b<this._items.length;++b){var f=this._items.data[b];f.far<a.near||f.near>a.far||c(f.obj,f.near,f.far)}else for(b=this._items.length-1;0<=b;--b)f=this._items.data[b],f.far<a.near||f.near>a.far||c(f.obj,f.near,f.far)};return d}();var C=function(){function d(){this.view=h.mat4d.create();this.viewProj=h.mat4d.create();this.planes=[h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),
h.vec4d.create(),h.vec4d.create()];this.geometries=[];this.near=[];this.far=[];this.nearCandidates=[];this.farCandidates=[];this.range={near:0,far:0};this.looseRange={near:0,far:0}}d.prototype.compute=function(a,b){var c=this;this.reset();h.mat4d.set(a.viewMatrix,this.view);h.mat4d.multiply(a.projectionMatrix,this.view,this.viewProj);a.copyFrustumPlanes(this.planes);a=this.view;var f=a[2],d=a[6],e=a[10],n=a[14];a=this.range;var k=0;b.forEach(function(a){if(!E.isAllHidden(a.instanceParameters.componentVisibilities,
a.componentOffsets)&&a.castShadow){var b,g;a.hasShaderTransformation?(b=a.getBoundingSphere(a.getShaderTransformation(),1,m),g=m):(b=a.bsRadius,g=a.center);g=f*g[0]+d*g[1]+e*g[2]+n;c.geometries[k]=a;c.near[k]=-(g+b);c.far[k]=-(g-b);++k}});if(0===this.geometries.length)return a;for(b=0;b<this.geometries.length;++b)this.near[b]>a.far&&(a.far=this.near[b]),2<this.near[b]&&this.far[b]<a.near&&(a.near=this.far[b]);var l=this.looseRange;l.near=Math.max(.5*a.near,2);l.far=2*a.far;var t=0,p=0;for(b=0;b<this.geometries.length;++b)this.near[b]<
a.near&&(this.near[b]>=l.near?a.near=this.near[b]:this.nearCandidates[t++]=b),this.far[b]>a.far&&(this.far[b]<=l.far?a.far=this.far[b]:this.farCandidates[p++]=b);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return a;this.nearCandidates.sort(function(a,b){return c.near[a]<c.near[b]?-1:c.near[a]>c.near[b]?1:0});this.farCandidates.sort(function(a,b){return c.far[a]<c.far[b]?1:c.far[a]>c.far[b]?-1:0});for(b=0;b<this.nearCandidates.length;++b)l=this.nearCandidates[b],this.near[l]<a.near&&
(l=this.geometries[l],t=l.boundingInfo,this.includeNearBoundingInfoRec(t,l.getShaderTransformation()));for(b=0;b<this.farCandidates.length;++b)l=this.farCandidates[b],this.far[l]>a.far&&(l=this.geometries[l],t=l.boundingInfo,this.includeFarBoundingInfoRec(t,l.getShaderTransformation()));return a};d.prototype.reset=function(){this.geometries.length=0;this.near.length=0;this.far.length=0;this.nearCandidates.length=0;this.farCandidates.length=0;this.range.near=Number.MAX_VALUE;this.range.far=-Number.MAX_VALUE};
d.prototype.includeNearBoundingInfoRec=function(a,b){var c=a.getBSRadius(),f=a.getCenter();h.mat4d.multiplyVec3(b,f,m);var f=h.mat4d.maxScale(b),g=m[0],e=m[1],d=m[2],c=c*f;if(!(this.planes[0][0]*g+this.planes[0][1]*e+this.planes[0][2]*d+this.planes[0][3]>c||this.planes[1][0]*g+this.planes[1][1]*e+this.planes[1][2]*d+this.planes[1][3]>c||this.planes[2][0]*g+this.planes[2][1]*e+this.planes[2][2]*d+this.planes[2][3]>c||this.planes[3][0]*g+this.planes[3][1]*e+this.planes[3][2]*d+this.planes[3][3]>c||
(f=this.view[2]*g+this.view[6]*e+this.view[10]*d+this.view[14],g=f+c,2>-(f-c)||-g>=this.range.near)))if(-g>this.looseRange.near)this.range.near=-g;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(a=0;8>a;++a)void 0!==c[a]&&this.includeNearBoundingInfoRec(c[a],b);return}v.unionDepthRangeWithAABB(this.range,this.viewProj,b,a.getBBMin(),a.getBBMax())}};d.prototype.includeFarBoundingInfoRec=function(a,b){var c=a.getBSRadius(),f=a.getCenter();h.mat4d.multiplyVec3(b,f,m);var f=h.mat4d.maxScale(b),d=m[0],
e=m[1],n=m[2],c=c*f;if(!(this.planes[0][0]*d+this.planes[0][1]*e+this.planes[0][2]*n+this.planes[0][3]>c||this.planes[1][0]*d+this.planes[1][1]*e+this.planes[1][2]*n+this.planes[1][3]>c||this.planes[2][0]*d+this.planes[2][1]*e+this.planes[2][2]*n+this.planes[2][3]>c||this.planes[3][0]*d+this.planes[3][1]*e+this.planes[3][2]*n+this.planes[3][3]>c||(f=this.view[2]*d+this.view[6]*e+this.view[10]*n+this.view[14]-c,-f<=this.range.far)))if(-f<this.looseRange.far)this.range.far=-f;else{if(100<c&&(c=a.getChildren(),
void 0!==c)){for(a=0;8>a;++a)void 0!==c[a]&&this.includeFarBoundingInfoRec(c[a],b);return}v.unionDepthRangeWithAABB(this.range,this.viewProj,b,a.getBBMin(),a.getBBMax())}};return d}();q.DepthRangeFromRenderGeometries=C;q=function(){function d(){this.modelViewProj=h.mat4d.create();this.clipPosition=[h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),h.vec4d.create(),h.vec4d.create()]}d.prototype.unionDepthRangeWithAABB=function(a,b,c,f,d){var e=this.modelViewProj;
h.mat4d.multiply(b,c,e);b=!1;for(c=0;8>c;++c){var g=this.clipPosition[c],k=0===c||3===c||4===c||7===c?f[0]:d[0],l=0===c||1===c||4===c||5===c?f[1]:d[1],m=4>c?f[2]:d[2];g[0]=e[0]*k+e[4]*l+e[8]*m+e[12];g[1]=e[1]*k+e[5]*l+e[9]*m+e[13];g[2]=e[2]*k+e[6]*l+e[10]*m+e[14];g[3]=e[3]*k+e[7]*l+e[11]*m+e[15]}for(c=0;12>c;++c){f=this.clipTriangle(this.clipPosition[w[c][0]],this.clipPosition[w[c][1]],this.clipPosition[w[c][2]]);d=!0;for(e=0;e<f.length;++e)if(g=f[e][3],2<=g){d=!1;break}if(!d)for(b=!0,e=0;e<f.length;++e)g=
f[e][3],g<a.near&&(a.near=g),g>a.far&&(a.far=g)}return b};d.prototype.inside=function(a,b){if(0===b)return a[0]>=-a[3];if(1===b)return a[1]>=-a[3];if(2===b)return a[0]<=a[3];if(3===b)return a[1]<=a[3];F.assert(!1)};d.prototype.intersect=function(a,b,c){var d=0;0===c?d=(-a[3]-a[0])/(b[0]-a[0]+b[3]-a[3]):1===c?d=(-a[3]-a[1])/(b[1]-a[1]+b[3]-a[3]):2===c?d=(a[3]-a[0])/(b[0]-a[0]-b[3]+a[3]):3===c&&(d=(a[3]-a[1])/(b[1]-a[1]-b[3]+a[3]));return h.vec4d.lerp(a,b,d,h.vec4d.create())};d.prototype.clipTriangle=
function(a,b,c){a=[a,b,c];for(b=0;4>b;++b){c=a;a=[];for(var d=0;d<c.length;++d){var g=c[d],e=c[(d+1)%c.length];this.inside(e,b)?(this.inside(g,b)||a.push(this.intersect(g,e,b)),a.push(e)):this.inside(g,b)&&a.push(this.intersect(g,e,b))}}return a};return d}();var w=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],m=h.vec3d.create(),I=h.mat4d.create(),k=p.empty(),r=new x,J=new C,v=new q});