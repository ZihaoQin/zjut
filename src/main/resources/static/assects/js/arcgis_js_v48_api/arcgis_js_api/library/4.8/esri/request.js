// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ./core/tsSupport/assignHelper dojo/Deferred dojo/has!host-browser?./core/request/script dojo/has!host-webworker?./core/workers/request dojo/io-query dojo/_base/url dojo/request/xhr ./config ./core/deferredUtils ./core/Error ./core/global ./core/lang ./core/promiseUtils ./core/sniff ./core/urlUtils".split(" "),function(O,ca,v,w,P,J,E,K,F,Q,R,r,S,t,k,p,g){function T(a){var c=E.objectToQuery(a.content);c&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+c);if(!g.isDataProtocol(a.url)&&
2E3<a.url.length)return k.reject(t.mixin(Error(),{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var b=new Image;a.allowImageDataAccess&&(b.crossOrigin=a.withCredentials?"use-credentials":"anonymous");var e=!1,d=new w(function(){e=!0;b.onload=b.onerror=b.onabort=null;b.src=""}),c=function(){b.onload=b.onerror=b.onabort=null;e||d.reject(Error("Unable to load the resource"))};b.onload=function(){b.onload=b.onerror=b.onabort=null;e||d.resolve(this)};b.onerror=
c;b.onabort=c;b.alt="";b.src=a.url;return d.promise}function G(a){a=new K(a);return(a.host+(a.port?":"+a.port:"")).toLowerCase()}function U(){return H?H:H=k.create(function(a){O(["./identity/IdentityManager"],a)}).then(function(a){l=a})}function V(a,c){var b=!!a.useProxy,e=a.method||"auto",d=t.isDefined(a.crossOrigin)?a.crossOrigin:m.useCors;a=v({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));var f=a.content,q=a.url;a._token&&(a.content=a.content||{},a.content.token=a._token);var B=0,n;q&&
(n=E.objectToQuery(f),B=n.length+q.length+1,p("esri-url-encodes-apostrophe")&&(B=n.replace(/'/g,"%27").length+q.length+1));a.timeout=t.isDefined(a.timeout)?a.timeout:m.timeout;a.handleAs=a.handleAs||"json";try{var k=n=void 0,x=d&&g.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),L=g.hasSameOrigin(a.urlObj,g.appUrl)||x,y="post"===e||!!a.body||B>m.maxUrlLength,h=!L&&-1!==a.handleAs.indexOf("json")&&a.callbackParamName&&!a.body,z=!!g.getProxyRule(a.url)||m.forceProxy||
b||("image"!==a.handleAs||a.allowImageDataAccess)&&(!h||y)&&!L;z&&(g.isBlobProtocol(a.url)||g.isDataProtocol(a.url))&&(z=!1);if((p("host-browser")||p("host-webworker"))&&z)if(n=g.getProxyUrl(q,d),k=n.path,n._xo&&(x=!0),!y&&k.length+1+B>m.maxUrlLength&&(y=!0),a.url=k+"?"+q,y)a.content=t.mixin(n.query||{},f);else{var M=E.objectToQuery(t.mixin(n.query||{},f));M&&(a.url+=(-1===q.indexOf("?")?"?":"\x26")+M);a.content=null}if(h&&!y&&!z&&p("host-browser"))return a.jsonp=a.callbackParamName,a.query=a.content,
P.get(a.url,a);var A=a.headers;!p("host-browser")&&!p("host-webworker")||A&&A.hasOwnProperty("X-Requested-With")||(A=a.headers=A||{},A["X-Requested-With"]=null);if(p("host-browser")&&c){var I=a.content&&a.content.token;I&&(c.set?c.set("token",I):c.append("token",I));a.contentType=!1}if(x&&!a.hasOwnProperty("withCredentials")&&"with-credentials"===m.useCors){var b=z?k:q,r=g.getCorsConfig(b);if(r&&r.hasOwnProperty("withCredentials"))r.withCredentials&&(a.withCredentials=!0);else if(l){var u=l.findServerInfo(b);
u&&u.webTierAuth&&(a.withCredentials=!0)}}if("image"===a.handleAs)return T(a);if(y)return a.body?(a.data=c||a.body,a.query=a.content):a.data=a.content,delete a.body,delete a.content,!z&&p("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+W++),F.post(a.url,a);a.query=a.content;delete a.content;return F.get(a.url,a)}catch(X){return a=new w,a.reject(X),a.promise}}function Y(a){a=a.toLowerCase();return-1!==a.indexOf("/rest/services")||-1!==a.indexOf("/rest/admin/services")}
function Z(a){var c=m.corsStatus;try{var b=G(a.url);if(m.corsDetection&&m.useCors&&p("esri-cors")&&a.url&&Y(a.url)&&!g.hasSameOrigin(a.urlObj,g.appUrl)&&!g.canUseXhr(a.urlObj)){if(c[b])return c[b];var e=new w;c[b]=e.promise;var d=a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info";F.get(d,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*m.corsDetectionTimeout}).then(function(c){c?(g.canUseXhr(a.url)||m.corsEnabledServers.push(b),e.resolve()):e.reject()},
function(a){e.reject()});return e.promise}}catch(f){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return aa}function C(a,c,b,e){function d(a){a._pendingDfd=V(b,n);var c=!!a._pendingDfd.response;(a._pendingDfd.response||a._pendingDfd).then(function(a){if(!c||!a.data)return a;var b=a.getHeader("Content-Type");if(b&&(b=b.toLowerCase(),-1===b.indexOf("text/plain")&&-1===b.indexOf("application/json")))return a;b=a.data;if(b instanceof ArrayBuffer&&750>=b.byteLength)b=
new Blob([b]);else if(!(b instanceof Blob&&750>=b.size))return a;var d=new w,h=new FileReader;h.readAsText(b);h.onloadend=function(){if(!h.error)try{var b=JSON.parse(h.result);b.error&&(Object.isExtensible(a)||(a=v({},a)),a._jsonData=b)}catch(da){}d.resolve(a)};return d.promise}).then(function(b){var d=c?b.data:b,h=c?b.getHeader.bind(b):D;if(d&&(b=c&&b._jsonData||d,b.error||"error"===b.status))throw d=t.mixin(Error(),b.error||b),d.getHeader=h,d;a.resolve({data:d,url:e.url,requestOptions:e.requestOptions,
getHeader:h});a._pendingDfd=null}).catch(function(c){var d,f,h;c&&(d=Number(c.code),f=c.hasOwnProperty("subcode")?Number(c.subcode):null,h=(h=c.messageCode)&&h.toUpperCase());if(c&&403===d&&(4===f||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl){b._ssl=b._sslFromServer=!0;C(a,!0,b,e);return}}else if(c&&415===c.status){if(d=b.url,f=m.corsStatus,h=g.getCorsConfig(d,!0),-1<h&&m.corsEnabledServers.splice(h,1),h=new w,h.reject(new r("disabled")),
f[G(d)]=h.promise,!b._err415){b._err415=1;C(a,!0,b,e);return}}else if(q&&"no-prompt"!==b.authMode&&l._errorCodes&&-1!==l._errorCodes.indexOf(d)&&!l._isPublic(b.url)&&(403!==d||N&&-1===N.indexOf(h)&&(!t.isDefined(f)||2===f&&b._token))){ba(a,b,e,u("request:server",c,e));return}a.reject(u("request:server",c,e));a._pendingDfd=null})}var f=b.body,q=b.useIdentity,k,n=null,p=f instanceof FormData;if(p||f&&f.elements)n=p?f:new FormData(f);var x=!!(-1!==b.url.toLowerCase().indexOf("token\x3d")||b.content&&
b.content.token||n&&n.get&&n.get("token")||f&&f.elements&&f.elements.token);c||(!q||x||b._token||l._isPublic(b.url)||(c=function(a){a&&(b._token=a.token,b._ssl=a.ssl)},"immediate"===b.authMode?k=l.getCredential(b.url).then(c):"no-prompt"===b.authMode?k=l.checkSignInStatus(b.url).then(c).catch(function(){}):c(l.findCredential(b.url))),a.then(function(a){if((/\/sharing\/rest\/accounts\/self/i.test(b.url)||/\/sharing\/rest\/portals\/self/i.test(b.url))&&!x&&!b._token&&a.user&&a.user.username){var c=
m.corsEnabledServers,d=g.getCorsConfig(b.url,!0),e={host:G(b.url),withCredentials:!0};if(-1===d)c.push(e);else{var f=c[d];f instanceof RegExp?(e.host=f,c.splice(d,1,e)):"object"===typeof f?f.withCredentials=!0:c.splice(d,1,e)}}if(c=b._credential)d=(d=l.findServerInfo(c.server))&&d.owningSystemUrl,e=void 0,d&&(d=d.replace(/\/?$/,"/sharing"),(e=l.findCredential(d,c.userId))&&-1===l._getIdenticalSvcIdx(d,e)&&e.resources.splice(0,0,d));return a}).always(function(a){delete b._credential;if(a){var c=!!b._ssl;
a instanceof r?a.details.ssl=c:a.ssl=c}}));k?k.then(function(){d(a)}).catch(function(b){a.reject(b)}):d(a);return a.promise}function ba(a,c,b,e){a._pendingDfd=l.getCredential(c.url,{error:e,token:c._token});a._pendingDfd.then(function(d){c._token=d.token;c._credential=d;c._ssl=c._sslFromServer||d.ssl;C(a,!0,c,b)}).catch(function(b){a.reject(b);a._pendingDfd=null})}function u(a,c,b){var e="Error",d={url:b.url,requestOptions:b.requestOptions,getHeader:D};if(c instanceof r)return c.details?(c.details=
t.clone(c.details),c.details.url=b.url,c.details.requestOptions=b.requestOptions):c.details=d,c;if(c){var f=c.response;b=f&&f.getHeader;var f=f&&f.status,g=c.message;b=c.getHeader||b;g&&(e=g);b&&(d.getHeader=b);d.httpStatus=(t.isDefined(c.httpCode)?c.httpCode:c.code)||f;d.subCode=c.subcode;d.messageCode=c.messageCode;d.messages="string"===typeof c.details?[c.details]:c.details}a=new r(a,e,d);c&&"cancel"===c.dojoType&&(a.dojoType="cancel");return a}var m=Q.request,N=["COM_0056","COM_0057"],W=0,D=function(){return null},
aa=(new w).resolve(),l,H;return function(a,c){if(J&&S.invokeStaticMessage)return J.execute(a,c);g.isBlobProtocol(a)||g.isDataProtocol(a)||(a=g.normalize(a));var b={url:a,requestOptions:v({},c)},e=g.getInterceptor(a);if(e){if(null!=e.responseData)return k.resolve({data:e.responseData,requestOptions:b.requestOptions,getHeader:D,url:a});e.headers&&(b.requestOptions.headers=v({},b.requestOptions.headers,e.headers));e.query&&(b.requestOptions.query=v({},b.requestOptions.query,e.query));if(e.before&&(c=
e.before(b),null!=c))return c instanceof Error||c instanceof r?k.reject(u("request:interceptor",c,b)):k.resolve({data:c,requestOptions:b.requestOptions,getHeader:D,url:b.url})}var d=v({url:b.url},b.requestOptions);d.content=d.query;delete d.query;d.preventCache=!!d.cacheBust;delete d.cacheBust;d.handleAs=d.responseType;delete d.responseType;"array-buffer"===d.handleAs&&(d.handleAs="arraybuffer");if("image"===d.handleAs){if(p("host-webworker"))return k.reject(u("request:invalid-parameters",Error("responseType 'image' is not supported in Web Workers or Node environment"),
b));d.preventCache&&(d.content=d.content||{},d.content["request.preventCache"]=Date.now());d.method="auto"}else if(g.isDataProtocol(a))return k.reject(u("request:invalid-parameters",Error("Data URLs are not supported for responseType \x3d "+d.handleAs),b));var f=m.useIdentity;"anonymous"===d.authMode&&(f=!1);d.useIdentity=f;d.urlObj=new K(d.url);var q=R.makeDeferredCancellingPending();Z(d).always(function(){if(f&&!l)return U()}).always(function(){C(q,!1,d,b)});return q.then(function(a){e&&e.after&&
e.after(a);return a})}});