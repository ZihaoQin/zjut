// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports dojo/string ../../../../../core/promiseUtils ../../../../support/heatmapUtils ../../../../../support/arcadeUtils ../../../../../tasks/support/ClassBreaksDefinition ../../../../../tasks/support/generateRendererUtils".split(" "),function(W,h,M,N,F,q,O,P){function C(a,b,c){b=null==b?-Infinity:b;c=null==c?Infinity:c;return a.filter(function(a){if(null!=a&&n(a)&&a>=b&&a<=c)return a})}function r(a,b){var c=a.field,d="function"===typeof c,e=a.valueExpression,f=q.createFunction(e),
g=a.normalizationType,m=a.normalizationField,k=a.normalizationTotal,t=[],h=(a=a.view)&&q.getViewInfo({viewingMode:"2d"===a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference});if(!b)return t;b.forEach(function(a){var b=a.attributes,l;e?(l=q.createExecContext(a,h),l=q.executeFunction(f,l)):d?l=c.call(null,a):b&&(l=b[c]);g&&null!=l&&n(l)&&(b=b&&parseFloat(b[m]),"log"===g&&0!==l?l=Math.log(l)*Math.LOG10E:"percent-of-total"===g&&n(k)&&0!==k?l=l/k*100:"field"===g&&n(b)&&0!==b&&
(l/=b));t.push(l)});return t}function Q(a,b){for(var c=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,e=null,f=null,g=null,m=null,k=0;k<a.length;k++)var t=a[k],e=e+t,c=Math.min(c,t),d=Math.max(d,t);if(k=a.length){f=e/k;for(m=g=0;m<a.length;m++)t=a[m],g+=Math.pow(t-f,2);m=b?1<k?g/(k-1):0:0<k?g/k:0;g=Math.sqrt(m)}else d=c=null;return{avg:f,count:k,max:d,min:c,stddev:g,sum:e,variance:m}}function D(a){var b=a.field,c=a.classificationMethod||"equal-interval",d=a.normalizationType,e=a.normalizationField,
f=new O;f.classificationField=b;f.breakCount=a.breakCount;f.classificationMethod=c;f.standardDeviationInterval="standard-deviation"===c?a.standardDeviationInterval||1:void 0;f.normalizationType=d;f.normalizationField="field"===d?e:void 0;return f}function G(a,b){var c=b.classBreaks,d=c[0].minValue,e=c[c.length-1].maxValue,f="standard-deviation"===a.classificationMethod,g=R,c=c.map(function(a){var b=a.label;a={minValue:a.minValue,maxValue:a.maxValue,label:b};if(f&&b){var c=b.match(g).map(function(a){return+a.trim()});
2===c.length?(a.minStdDev=c[0],a.maxStdDev=c[1],0>c[0]&&0<c[1]&&(a.hasAvg=!0)):1===c.length&&(-1<b.indexOf("\x3c")?(a.minStdDev=null,a.maxStdDev=c[0]):-1<b.indexOf("\x3e")&&(a.minStdDev=c[0],a.maxStdDev=null))}return a});return{minValue:d,maxValue:e,classBreakInfos:c,normalizationTotal:b.normalizationTotal}}function v(a,b,c){b=(b-a)/c;for(var d=[],e,f=1;f<=c;f++)e=a+b,e=Number(e.toFixed(16)),d.push([a,e]),a=e;return d}function H(a){var b=a.field,c=a.normalizationType,d=a.normalizationField;a=a.normalizationTotal;
var e=b;"percent-of-total"===c?e="(("+b+" / "+a+") * 100)":"log"===c?e="(log("+b+") * "+S+")":"field"===c&&(e="("+b+" / "+d+")");return e}function T(a,b){for(var c=-1,d=a.length-1;0<=d;d--)if(b>=a[d][0]){c=d;break}return c}function I(a,b){var c;b=b.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()!==b){c=a[d];break}return c}function w(a,b){var c;b=b.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()===b){c=a[d];break}return c}function y(a,b){if(b)for(var c in a)a[c].label=b[c];return{count:a}}
function J(a,b,c,d){var e=a.count;a=[];d&&c&&"coded-value"===c.type&&c.codedValues.forEach(function(a){a=a.code;e.hasOwnProperty(a)||(e[a]={data:a,count:0})});for(var f in e)c=e[f],a.push({value:c.data,count:c.count,label:c.label});return{uniqueValueInfos:a}}function u(a){return M.pad(a,2,"0")}function K(a,b){if("date"===b||"number"===b)"number"===b&&(a=new Date(a)),a="TIMESTAMP'"+a.getUTCFullYear()+"-"+u(a.getUTCMonth()+1)+"-"+u(a.getUTCDate())+" "+u(a.getUTCHours())+":"+u(a.getUTCMinutes())+":"+
u(a.getUTCSeconds())+"'";return a}function L(a,b){var c;b instanceof Date?c="date":"number"===typeof b?c="number":"string"===typeof b&&(a=a.getField(b),"\x3cnow\x3e"===b.toLowerCase()?c="":a&&"date"===a.type&&(c="field"));return c}function n(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}Object.defineProperty(h,"__esModule",{value:!0});var U=/_value$/i,R=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,S=Math.LOG10E,V={years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,
milliseconds:1/864E5};h.statisticTypes="min max avg stddev count sum variance".split(" ");h.getSummaryStatisticsFromFeatureSet=function(a){a=(a=a&&a.features)&&a[0]&&a[0].attributes;var b={},c;for(c in a)b[c.replace(U,"").toLowerCase()]=a[c];b.min===b.max&&null!=b.min&&null==b.stddev&&(b.stddev=b.variance=0);return b};h.calculateStatsFromMemory=function(a,b,c){b=r(a,b);b=C(b,a.minValue,a.maxValue);var d=Q(b,!a.normalizationType);c&&["avg","stddev","variance"].forEach(function(a){null!=d[a]&&(d[a]=
Math.ceil(d[a]))});return d};h.getDataValues=r;h.processSummaryStatisticsResult=function(a){for(var b in a)-1<h.statisticTypes.indexOf(b)&&(n(a[b])||(a[b]=null));return a};h.createCBDefn=D;h.calculateHeatmapStats=function(a,b,c,d,e,f){void 0===b&&(b=10);var g=new Float64Array(e*f),m=F.createKernel(b);b=Math.round(4.5*b);var k=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,n=null,p=0,r=0,l=0,u=0,z=0;c=F.createValueFunction(d,c);for(d=0;d<a.length;d++)for(var q=a[d],x=q.geometry,v=x.x-b,w=x.y-
b,y=Math.max(0,v),p=Math.max(0,w),C=Math.min(f,x.y+b),x=Math.min(e,x.x+b),q=+c(q.attributes),A=p;A<C;A++)for(var D=m[A-w],B=y;B<x;B++){p=g[A*e+B]+=D*m[B-v]*q;n||(n=p);var E=p-n,r=r+p,l=l+E,u=u+E*E;p<k&&(k=p);p>h&&(h=p);z++}return z?{mean:r/z,stdDev:Math.sqrt((u-l*l/z)/z),min:k,max:h,mid:(h-k)/2}:{mean:0,stddev:0,min:0,max:0,mid:0}};h.calculateClassBreaksFromMemory=function(a,b){var c=a.normalizationTotal,d=D({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,
classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5});b=r(a,b);b=C(b,a.minValue,a.maxValue);c=P.createGenerateRendererClassBreaks({definition:d,values:b,normalizationTotal:c});return G(a,c)};h.resolveCBResult=G;h.getEqualIntervalBins=v;h.generateBinParams=function(a){var b=[],c=a.classBreaks,d=c[0].minValue,e=c[c.length-1].maxValue;c.forEach(function(a){b.push([a.minValue,a.maxValue])});return{min:d,max:e,intervals:b,sqlExpr:H({field:a.field,
normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};h.getFieldExpr=H;h.calculateHistogramFromMemory=function(a,b,c){var d=b.min,e=b.max,f=b.normTotal,g=a.numBins||10,m=b.intervals||v(d,e,g);b=m.map(function(a,b){return{minValue:m[b][0],maxValue:m[b][1],count:0}});g=0;for(a=r(a,c);g<a.length;g++)c=a[g],null!=c&&c>=d&&c<=e&&(c=T(m,c),-1<c&&b[c].count++);return{bins:b,minValue:d,
maxValue:e,normalizationTotal:f}};h.getHistogramFromFeatureSet=function(a,b,c,d){var e={};a&&a.features&&a.features.forEach(function(a){var b=a.attributes;a=I(b,"countOFExpr");b=w(b,"countOFExpr");0!==a&&(e[a]=b)});var f=[];v(b,c,d).forEach(function(a,b){b=(b+1).toString();f.push({minValue:a[0],maxValue:a[1],count:e.hasOwnProperty(b)?e[b]:0})});return{bins:f,minValue:b,maxValue:c}};h.getUniqueValuesFromFeatureSet=function(a,b,c,d){var e="countOF"+(c||"Expr"),f={},g=!1;(a&&a.features).forEach(function(a){var b=
a.attributes;a=w(b,e);b=c?w(b,c):I(b,e);null===b&&0===a&&(g=!0);if(null==b||"string"===typeof b&&""===b.trim())b=null;null==f[b]?f[b]={count:a,data:b}:f[b].count+=a});return c&&g?b.queryFeatureCount(c+" is NULL").then(function(a){f["null"].count+=a||0;return y(f,d)}).catch(function(){return y(f,d)}):N.resolve(y(f,d))};h.createUVResult=J;h.calculateUniqueValuesFromMemory=function(a,b,c){var d=a.features?"features":"features-in-memory",e={},f=0;for(b=r(a,b);f<b.length;f++){var g=b[f];if(null==g||"string"===
typeof g&&""===g.trim())g=null;null==e[g]?e[g]={count:1,data:g}:e[g].count++}return J({count:e},d,c,a.returnAllCodedValues)};h.msSinceUnixEpochSQL=function(a,b){var c=new Date(0);a="("+K(b,L(a,b))+" - "+K(c,L(a,c))+")";b=V.milliseconds;c="/";1>b&&(b=1/b,c="*");return 1===b?a:"("+a+" "+c+" "+b+")"};h.isValidNumber=n});