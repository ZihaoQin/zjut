// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("../core/kebabDictionary ../core/urlUtils ../core/promiseUtils ../geometry/Polygon ../kernel ../request ../core/lang dojo/dom-construct dojox/gfx/canvas ./Geoprocessor ./support/fileFormat ./support/layoutTemplate ./support/PrintTemplate ./support/printTaskUtils ./Task".split(" "),function(x,y,D,E,v,F,m,G,z,H,I,J,K,q,L){function w(a){return!(!a||!a.path)}var A={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},B=x({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),
M=x({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"});return L.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},_gpServerUrl:null,_cimVersion:null,_is11xService:!1,_data:null,properties:{mode:{readonly:!0,value:"sync"},_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new H(this.url,{updateDelay:this.updateDelay})}},
url:{value:null,type:String},updateDelay:{value:1E3,type:Number}},execute:function(a,e){var c=this.url,l=c.lastIndexOf("/GPServer/");0<l&&(c=c.slice(0,l+9));return D.resolve().then(function(){if(this._gpServerUrl===c)return{data:this._data};this._gpServerUrl=c;return F(c,{query:{f:"json"}})}.bind(this)).then(function(b){this._data=b.data;this._cimVersion=this._data.cimVersion;this._is11xService=!!this._cimVersion;b=this._setPrintParams(a);this._data.executionType&&(this.mode=M.fromJSON(this._data.executionType));
return this._geoprocessor["async"===this.mode?"submitJob":"execute"](b,e).then(this._handleExecuteResponse)}.bind(this))},_createOperationalLayers:function(a,e){var c=[],l,b,k,d,C=a.map.allLayers.filter(function(a){return a.parent&&"group"===a.parent.type&&!a.parent.visible?!1:!0}).items;for(l=0;l<C.length;l++)if(b=C[l],b.loaded&&b.visible)switch(d={id:b.id,title:this._legendLayerNameMap[b.id]||b.title,opacity:b.opacity,minScale:b.minScale||0,maxScale:b.maxScale||0,url:b.url&&y.normalize(b.url),token:b.token},
k=b.declaredClass,k){case "esri.layers.ImageryLayer":var f={bandIds:b.bandIds,compressionQuality:b.compressionQuality,format:b.format,interpolation:b.interpolation};b.mosaicRule&&(f.mosaicRule=b.mosaicRule.toJSON());b.renderingRule&&(f.renderingRule=b.renderingRule.toJSON());c.push(m.mixin(d,f));this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.OpenStreetMapLayer":m.mixin(d,{type:"OpenStreetMap"});c.push(d);break;case "esri.layers.GraphicsLayer":m.mixin(d,this._createFeatureCollectionJSON(b,
null,e));c.push(d);this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.VectorTileLayer":delete d.url;delete d.token;if(this._is11xService&&b.serviceUrl&&b.styleUrl){var f=v.id&&v.id.findCredential(b.styleUrl),g=v.id&&v.id.findCredential(b.serviceUrl);if(!f&&!g||"2.1.0"!==this._cimVersion){m.mixin(d,{type:"VectorTileLayer",styleUrl:y.normalize(b.styleUrl)});f&&(d.token=f.token);g&&g.token!==d.token&&(d.additionalTokens=[{url:b.serviceUrl,token:g.token}]);c.push(d);break}}d.type=
"image";g=e.exportOptions&&e.exportOptions.dpi||96;k=e.exportOptions&&e.exportOptions.width%2===a.width%2;var n=e.exportOptions&&e.exportOptions.height%2===a.height%2,p={format:"png",pixelRatio:g/96,rotation:0},f=this._vtlExtent||a.extent.clone();"MAP_ONLY"!==e.layout||!e.preserveScale||e.outScale&&e.outScale!==a.scale||96!==g||k&&n||(p.area={x:0,y:0,width:a.width,height:a.height},k||(p.area.width+=1),n||(p.area.height+=1),this._vtlExtent||(g=a.toMap({x:p.area.width,y:p.area.height}),f.ymin=g.y,f.xmax=
g.x,this._vtlExtent=f));d.extent=f.clone()._normalize(!0).toJSON();f=a.whenLayerView(b);f.isResolved()&&f.then(function(b){b=b.takeScreenshot(p,a);b.isResolved()?b.then(function(a){"data:image/png;base64,"===a.dataURL.substr(0,22)&&(d.imageData=a.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise");d.imageData&&c.push(d)});break;case "esri.layers.MapImageLayer":var h={id:b.id,subLayerIds:[]},t=[],r=a.scale,u=function(a){var b=0===r,c=0===
a.minScale||r<=a.minScale,d=0===a.maxScale||r>=a.maxScale;a.visible&&(b||c&&d)&&(a.sublayers?a.sublayers.forEach(u):(b=a.toExportImageJSON().drawingInfo,c=a.toJSON(),c.layerDefinition.drawingInfo=b,t.unshift(c),h.subLayerIds.push(a.id)))};b.sublayers&&b.sublayers.forEach(u);t.length&&(m.mixin(d,{layers:t,visibleLayers:h.subLayerIds}),c.push(d),this._legendLayers.push(h));break;case "esri.layers.KMLLayer":this._is11xService?(d={},b.write(d,{origin:"web-map"}),d.showLabels=e.showLabels,c.push(d)):a.whenLayerView(b).then(function(a){a.allVisibleMapImages.forEach(function(a,
d){d={id:b.id+"_image"+d,type:"image",title:b.id,minScale:b.minScale||0,maxScale:b.maxScale||0,opacity:b.opacity,extent:a.extent.toJSON()};"data:image/png;base64,"===a.href.substr(0,22)?d.imageData=a.href.substr(22):d.url=a.href;c.push(d)});a=a.allVisiblePoints.concat(a.allVisiblePolylines).concat(a.allVisiblePolygons);var d={id:b.id};m.mixin(d,this._createFeatureCollectionJSON(null,a,e));c.push(d)}.bind(this));break;case "esri.layers.WMSLayer":t=[];u=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(u):
a.name&&t.unshift(a.name))};b.sublayers&&b.sublayers.forEach(u);m.mixin(d,{type:"wms",transparentBackground:b.imageTransparency,visibleLayers:t,version:b.version});c.push(d);break;case "esri.layers.WMTSLayer":f=b.activeLayer;m.mixin(d,{type:"wmts",layer:f.id,style:f.styleId,format:f.imageFormat,tileMatrixSet:f.tileMatrixSetId});c.push(d);break;case "esri.layers.WebTileLayer":f=b.urlTemplate.replace(/\$\{/g,"{");m.mixin(d,{type:"WebTiledLayer",urlTemplate:f,credits:b.copyright});b.subDomains&&0<b.subDomains.length&&
(d.subDomains=b.subDomains);c.push(d);break;case "esri.layers.CSVLayer":if(this._is11xService){d={};b.write(d,{origin:"web-map"});c.push(d);break}case "esri.layers.StreamLayer":case "esri.layers.FeatureLayer":g=(f=b.renderer)&&!f.hasVisualVariables()&&!b.featureReduction&&!f.valueExpression&&"esri.layers.CSVLayer"!==k;k="esri.layers.FeatureLayer"===k&&b.source&&b.source.length||"esri.layers.StreamLayer"===k;(this._is11xService||g)&&!k&&f&&("esri.renderer.SimpleRenderer"===f.declaredClass||null==f.field||
"string"===typeof f.field&&b.getField(f.field))?(d={},b.write(d,{origin:"web-map"}),d.layerDefinition&&d.layerDefinition.drawingInfo&&d.layerDefinition.drawingInfo.renderer&&(this._convertSvgRenderer(d.layerDefinition.drawingInfo.renderer),f.visualVariables&&f.visualVariables[0]&&f.visualVariables[0].maxSize&&"number"!==typeof f.visualVariables[0].maxSize&&f.visualVariables[0].minSize&&"number"!==typeof f.visualVariables[0].minSize&&(f=f.getSizeRangeAtScale(f.visualVariables[0],a.scale),d.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=
f.minSize,d.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=f.maxSize))):(f=this._getGraphics(a,b),m.mixin(d,this._createFeatureCollectionJSON(b,f,e)));c.push(d);this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.MapNotesLayer":var q=[];b.featureCollections.map(function(a){var b=a.source.toArray();a=this._createFeatureCollectionJSON(a,b,e).featureCollection;q=q.concat(a.layers)}.bind(this));m.mixin(d,{featureCollection:{layers:q}});c.push(d);break;default:c.push(d)}a.graphics&&
a.graphics.length&&(d=this._createFeatureCollectionJSON({},a.graphics,e))&&c.push(d);return c},_createFeatureCollectionJSON:function(a,e,c){var l=q.createPolygonLayer(),b=q.createPolylineLayer(),k=q.createPointLayer(),d=q.createMultipointLayer(),m=q.createPointLayer();m.layerDefinition.name="textLayer";delete m.layerDefinition.drawingInfo;a&&("esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass?l.layerDefinition.name=b.layerDefinition.name=k.layerDefinition.name=
d.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(e=a.graphics.items));var f=a.renderer&&"esri.renderer.SimpleRenderer"===a.renderer.declaredClass;if(a&&a.renderer&&"function"!==typeof a.get("renderer.field")){var g=a.renderer.toJSON();l.layerDefinition.drawingInfo.renderer=g;b.layerDefinition.drawingInfo.renderer=g;k.layerDefinition.drawingInfo.renderer=g;d.layerDefinition.drawingInfo.renderer=g}else delete l.layerDefinition.drawingInfo,
delete b.layerDefinition.drawingInfo,delete k.layerDefinition.drawingInfo,delete d.layerDefinition.drawingInfo;var n=a&&a.fields,g=a&&a.renderer,p=[];g&&"function"!==typeof a.get("renderer.field")&&("class-breaks"===g.type?(n||(n=[{name:g.field,type:"esriFieldTypeDouble"}],g.normalizationField&&n.push({name:g.normalizationField,type:"esriFieldTypeDouble"})),g.field&&p.push(g.field),g.normalizationField&&p.push(g.normalizationField)):"unique-value"===g.type&&(n||(n=[{name:g.field,type:"esriFieldTypeString"}],
g.field2&&n.push({name:g.field2,type:"esriFieldTypeString"}),g.field3&&n.push({name:g.field3,type:"esriFieldTypeString"})),g.field&&p.push(g.field),g.field2&&p.push(g.field2),g.field3&&p.push(g.field3)));n&&(l.layerDefinition.fields=n,b.layerDefinition.fields=n,k.layerDefinition.fields=n,d.layerDefinition.fields=n);for(var n=e&&e.length,h,t=0;t<n;t++){var r=e[t]||e.getItemAt(t);if(!1!==r.visible&&r.geometry&&(h=r.toJSON(),h.hasOwnProperty("popupTemplate")&&delete h.popupTemplate,h.geometry&&h.geometry.z&&
delete h.geometry.z,!h.symbol||!h.symbol.outline||"esriCLS"!==h.symbol.outline.type||this._is11xService)){h.symbol&&h.symbol.outline&&h.symbol.outline.color&&h.symbol.outline.color[3]&&!this._is11xService&&(h.symbol.outline.color[3]=255);if(a&&a.renderer&&!h.symbol&&("function"===typeof a.renderer.field||a.renderer.compiledFunc||a.renderer.hasVisualVariables()||a.renderer)){var g=a.renderer,u=g.getSymbol(r);if(!u)continue;h.symbol=u.toJSON();g.hasVisualVariables()&&q.applyVisualVariables(h.symbol,
{renderer:g,graphic:r,symbol:u})}h.symbol&&(h.symbol.angle||delete h.symbol.angle,h.symbol.path?h.symbol=this._convertSvgToPictureMarkerSymbolJson(h.symbol):h.symbol.text&&delete h.attributes);if(!c||!c.forceFeatureAttributes)if(a&&a.renderer&&"simple"===a.renderer.type)delete h.attributes;else if(p.length){var v={};p.forEach(function(a){h.attributes&&h.attributes.hasOwnProperty(a)&&(v[a]=h.attributes[a])});h.attributes=v}"polygon"===r.geometry.type?l.featureSet.features.push(h):"polyline"===r.geometry.type?
b.featureSet.features.push(h):"point"===r.geometry.type?h.symbol&&h.symbol.text?m.featureSet.features.push(h):k.featureSet.features.push(h):"multipoint"===r.geometry.type?d.featureSet.features.push(h):"extent"===r.geometry.type&&(h.geometry=E.fromExtent(r.geometry).toJSON(),l.featureSet.features.push(h))}}a=[l,b,d,k,m].filter(function(a){return 0<a.featureSet.features.length});a.forEach(function(a){var b=a.featureSet.features.every(function(a){return a.symbol});!b&&!f||c&&c.forceFeatureAttributes||
a.featureSet.features.forEach(function(a){delete a.attributes});b&&delete a.layerDefinition.drawingInfo;a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(a.layerDefinition.drawingInfo.renderer)},this);return a.length?{featureCollection:{layers:a}}:null},_convertSvgToPictureMarkerSymbolJson:function(a){this._canvasParent||(this._canvasParent=G.create("div"),this._canvasSurface=z.createSurface(this._canvasParent,200,200));var e=this._canvasSurface.createObject(z.Path,
a.path).setFill(a.color).setStroke(a.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var c=this._canvasSurface.rawNode.getContext("2d"),e=e.getBoundingBox(),l=Math.ceil(e.width+e.x),b=Math.ceil(e.height+e.y),k=c.getImageData(e.x,e.y,l,b);c.canvas.width=l;c.canvas.height=b;c.putImageData(k,0,0);return{type:"esriPMS",imageData:c.canvas.toDataURL("image/png").substr(22),angle:-a.angle,contentType:"image/png",height:a.size?a.size:b-e.y,width:a.size?a.size:l-e.x,xoffset:a.xoffset,
yoffset:a.yoffset}},_convertSvgRenderer:function(a){var e=a.type;if("simple"===e&&w(a.symbol))a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol);else if("unique-value"===e||"class-breaks"===e)e=a["unique-value"===e?"uniqueValueInfos":"classBreakInfos"],w(a.defaultSymbol)&&(a.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(a.defaultSymbol)),e&&e.forEach(function(a){w(a)&&(a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol))},this)},_getGraphics:function(a,e){var c;a.whenLayerView(e).then(function(a){return a.queryGraphics&&
a.queryGraphics()||a.featuresView.graphics}).then(function(a){c=a&&a.features||a});return c},_getPrintDefinition:function(a,e){var c=a.view,l=c.map,b=c.spatialReference,k={operationalLayers:this._createOperationalLayers(c,e)};a=this._vtlExtent||a.extent||c.extent;b&&b.isWrappable&&(a=a.clone()._normalize(!0),b=a.spatialReference);k.mapOptions={extent:a&&a.toJSON(),spatialReference:b&&b.toJSON(),showAttribution:e.attributionVisible};this._vtlExtent=null;c.rotation&&(k.mapOptions.rotation=-c.rotation);
e.preserveScale&&(k.mapOptions.scale=e.outScale||c.scale);l.timeExtent&&(k.mapOptions.time=[l.timeExtent.startTime.getTime(),l.timeExtent.endTime.getTime()]);return k},_handleExecuteResponse:function(a){return"sync"===this.mode?a.results&&a.results[0]&&a.results[0].value:this._geoprocessor.getResultData(a.jobId,"Output_File").then(function(a){return a.value})},_setPrintParams:function(a){var e=a.template||new K;null==e.showLabels&&(e.showLabels=!0);var c=e.exportOptions,l;if(c){l={dpi:c.dpi};var b=
J.toJSON(e.layout);if("map_only"===b.toLowerCase()||""===b)l.outputSize=[c.width,c.height]}var c=e.layoutOptions,k;if(c){var d,q;if("Miles"===c.scalebarUnit||"Kilometers"===c.scalebarUnit)d="Kilometers",q="Miles";else if("Meters"===c.scalebarUnit||"Feet"===c.scalebarUnit)d="Meters",q="Feet";k={titleText:c.titleText,authorText:c.authorText,copyrightText:c.copyrightText,customTextElements:c.customTextElements,scaleBarOptions:{metricUnit:B.toJSON(d),metricLabel:A[d],nonMetricUnit:B.toJSON(q),nonMetricLabel:A[q]}}}d=
null;c&&c.legendLayers&&(d=c.legendLayers.map(function(a){this._legendLayerNameMap[a.layerId]=a.title;var b={id:a.layerId};a.subLayerIds&&(b.subLayerIds=a.subLayerIds);return b},this));c=this._getPrintDefinition(a,e);if(c.operationalLayers){var f,g=/[\u4E00-\u9FFF\u0E00-\u0E7F\u0900-\u097F\u3040-\u309F\u30A0-\u30FF\u31F0-\u31FF]/,n=/[\u0600-\u06FF]/,p=function(a){var b=a.text,c=(a=a.font)&&a.family&&a.family.toLowerCase();b&&a&&("arial"===c||"arial unicode ms"===c)&&(a.family=g.test(b)?"Arial Unicode MS":
"Arial","normal"!==a.style&&n.test(b)&&(a.family="Arial Unicode MS"))};c.operationalLayers.forEach(function(a){a.featureCollection&&a.featureCollection.layers&&a.featureCollection.layers.forEach(function(a){a.layerDefinition&&a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&a.layerDefinition.drawingInfo.renderer.symbol&&(f=a.layerDefinition.drawingInfo.renderer,"esriTS"===f.symbol.type&&p(f.symbol));a.featureSet&&a.featureSet.features&&a.featureSet.features.forEach(function(a){a.symbol&&
"esriTS"===a.symbol.type&&p(a.symbol)})})})}a.outSpatialReference&&(c.mapOptions.spatialReference=a.outSpatialReference.toJSON());m.mixin(c,{exportOptions:l,layoutOptions:k});m.mixin(c.layoutOptions,{legendOptions:{operationalLayers:null!=d?d:this._legendLayers}});e={Web_Map_as_JSON:JSON.stringify(c),Format:I.toJSON(e.format),Layout_Template:b};a.extraParameters&&m.mixin(e,a.extraParameters);return e}})});