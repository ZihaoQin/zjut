// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/QueueProcessor","../libs/gl-matrix/vec2"],function(x,y,r,v){function w(c,a){c.length=0;a.forEach(function(a){return c.push(a)});return c}var q=new Set,l=[],g=new Map,t=[0,0];return function(){function c(a){var b=this;this._keysToRequests=new Map;this.tileInfoView=null;var d=a.strategy&&"scale-first"!==a.strategy?this._peekByCenterFirst.bind(this):this._peekByScaleFirst.bind(this);this.tileInfoView=a.tileInfoView;this._queues=a.tileServers&&0<a.tileServers.length?
a.tileServers.map(function(k){return new r({concurrency:a.concurrency||6,process:function(d){d=b._keysToRequests.get(d);return a.process(d,k)},peeker:d})}):[new r({concurrency:a.concurrency||6,process:function(d){d=b._keysToRequests.get(d);return a.process(d)},peeker:d})]}Object.defineProperty(c.prototype,"length",{get:function(){return this._queues.reduce(function(a,b){return a+b.length},0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"onGoingCount",{get:function(){return this._keysToRequests.size},
enumerable:!0,configurable:!0});c.prototype.clear=function(){for(var a=0,b=this._queues;a<b.length;a++)b[a].clear();this._keysToRequests.clear()};c.prototype.find=function(a,b){var d=this;b=0;for(var c=this._queues;b<c.length;b++){var f=c[b].find(function(b){return a(d._keysToRequests.get(b).key)});if(f)return f}};c.prototype.get=function(a){a="string"===typeof a?a:a.id;for(var b=0,d=this._queues;b<d.length;b++){var c=d[b].get(a);if(c)return c}};c.prototype.getRequest=function(a){return this._keysToRequests.get("string"===
typeof a?a:a.id)};c.prototype.has=function(a){return"string"===typeof a?this._keysToRequests.has(a):this._keysToRequests.has(a.id)};c.prototype.isOngoing=function(a){var b="string"===typeof a?a:a.id;return this.has(b)&&this._queues.some(function(a){return a.isOngoing(b)})};c.prototype.pause=function(){for(var a=0,b=this._queues;a<b.length;a++)b[a].pause()};c.prototype.push=function(a){var b=this,d=a.key.id;if(this.has(d))return this.get(d);var c=this._queues[a.key.row%this._queues.length].push(d),
f=function(){return b._keysToRequests.delete(d)};this._keysToRequests.set(d,a);c.then(f,f);return c};c.prototype.reset=function(){for(var a=0,b=this._queues;a<b.length;a++)b[a].reset()};c.prototype.resume=function(){for(var a=0,b=this._queues;a<b.length;a++)b[a].resume()};c.prototype._peekByScaleFirst=function(a){if(!this.state)return a[0];for(var b=this.tileInfoView,c=Number.NEGATIVE_INFINITY,k=Number.POSITIVE_INFINITY,f=0;f<a.length;f++){var u=this._keysToRequests.get(a[f]),h=this.tileInfoView.getTileScale(u.key);
g.has(h)||(g.set(h,[]),c=Math.max(h,c),k=Math.min(h,k));g.get(h).push(u.key);q.add(h)}var e=this.state.scale;g.has(e)||(w(l,q),l.sort(),e=l.reduce(function(a,b,c,d){return Math.abs(b-e)<Math.abs(a-e)?b:a},l[0]));e=Math.min(e,c);e=Math.max(e,k);a=g.get(e);var m=b.getClosestInfoForScale(e),n=m.getColumnForX(this.state.center[0]),p=m.getRowForY(this.state.center[1]);a.sort(function(a,b){var c=m.denormalizeCol(a.col,a.world),d=m.denormalizeCol(b.col,b.world);return Math.sqrt((n-c)*(n-c)+(p-a.row)*(p-
a.row))-Math.sqrt((n-d)*(n-d)+(p-b.row)*(p-b.row))});q.clear();g.clear();return a[0].id};c.prototype._peekByCenterFirst=function(a){if(!this.state)return a[0];for(var b=this.tileInfoView,c=this.state.center,k=Number.POSITIVE_INFINITY,f=null,g=0;g<a.length;g++){var h=this._keysToRequests.get(a[g]);b.getTileCoords(t,h.key);var e=v.distance(t,c);e<k&&(k=e,f=h.key)}return f.id};return c}()});