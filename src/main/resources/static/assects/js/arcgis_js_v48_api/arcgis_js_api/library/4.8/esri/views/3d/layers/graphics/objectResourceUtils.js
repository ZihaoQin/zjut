// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/sniff dojo/errors/CancelError ../../../../request ../../../../core/Error ../../../../core/lang ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/Version ../../../../geometry/support/aaBoundingBox ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(T,k,U,C,v,I,J,K,L,t,D,E,M,F,N,O,P,Q,R){function G(c,e){e.lods&&e.lods.length===c.length&&c.forEach(function(a,b){a.lodMetrics=e.lods[b].metrics});return c}function p(c,e){e=e||{};var a=e.streamDataSupplier;if(a){var b=a.request(c,"json");return t.create(function(a,c){b.then(function(b,c){a(c)},function(a){c(a instanceof v?a:H(a))})},function(){a.cancelRequest(b)})}var x=I(c);return t.create(function(a,b){x.then(function(b){a(b.data)},function(a){b(a instanceof v?a:H(a))})},function(){x.cancel()})}
function H(c){return new J("","Request for object resource failed: "+c)}function q(c,e){var a,b,x=[],h=[],k=[],w=[],q=[],y=E.Version.parse(c.version||"1.0","wosr");S.validate(y);var y="meshsymbol_"+c.model.name,z=c.textureDefinitions,t={},u;for(u in z){var r=z[u],m=r.images[0].data;m?(a=r.encoding+";base64,"+m,m="/textureDefinitions/"+u,b={noUnpackFlip:!0,wrapClamp:!1},C("enable-feature:jkieboom/alpha-channel-usage")&&(b.wrapClamp=!0),a=new Q(a,y,b),q.push(a),t[m]={engineTexObj:a,alphaChannelUsage:"rgba"===
r.channels?r.alphaChannelUsage||"transparency":"none"}):n.warn("Externally referenced texture data is not yet supported")}u=c.model.geometries;z=c.materialDefinitions;for(m=r=0;m<u.length;m++){var g=u[m];b=g;var f=b.params,l=f.topology;a=!0;f.vertexAttributes||(n.warn("Geometry must specify vertex attributes"),a=!1);switch(f.topology){case "PerAttributeArray":break;case "Indexed":case null:case void 0:l=f.faces;if(!l)n.warn("Indexed geometries must specify faces"),a=!1;else if(f.vertexAttributes){var d=
void 0;for(d in f.vertexAttributes)(f=l[d])&&f.values?(null!=f.valueType&&"UInt32"!==f.valueType&&(n.warn("Unsupported indexed geometry indices type '"+f.valueType+"', only UInt32 is currently supported"),a=!1),null!=f.valuesPerElement&&1!==f.valuesPerElement&&(n.warn("Unsupported indexed geometry values per element '"+f.valuesPerElement+"', only 1 is currently supported"),a=!1)):(n.warn("Indexed geometry does not specify face indices for '"+d+"' attribute"),a=!1)}break;default:n.warn("Unsupported topology '"+
l+"'"),a=!1}b.params.material||(n.warn("Geometry requires material"),a=!1);b=b.params.vertexAttributes;f=void 0;for(f in b)b[f].values||(n.warn("Geometries with externally defined attributes are not yet supported"),a=!1);if(a){b=g.params;a=b.material;b=b.texture;var l=g.params.vertexAttributes,f={},p;for(p in l)d=l[p],f[p]={data:d.values,size:d.valuesPerElement};k.push([]);l={};if("PerAttributeArray"===g.params.topology){for(var g=f.position.data.length/f.position.size,d=new Uint32Array(g),A=0;A<
g;A++)d[A]=A;var g=d,v;for(v in f)l[v]=g}else{var g=g.params.faces,B;for(B in g)l[B]=new Uint32Array(g[B].values)}g=b?t[b]:null;d=w[a]?w[a][b]:null;d||(d=a.substring(a.lastIndexOf("/")+1),d=z[d].params,1===d.transparency&&(d.transparency=0),d={ambient:d.diffuse,diffuse:d.diffuse,specular:[0,0,0],opacity:1-(d.transparency||0),transparent:0<d.transparency,textureId:g?g.engineTexObj.id:void 0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:d.externalColorMixMode||"tint"},C("enable-feature:jkieboom/alpha-channel-usage")&&
g&&("transparency"===g.alphaChannelUsage||"maskAndTransparency"===g.alphaChannelUsage)&&(d.transparent=!0),e&&e.materialParamsMixin&&K.mixin(d,e.materialParamsMixin),d=new R(d,y),w[a]||(w[a]={}),w[a][b]=d,h.push(d));k[m].push(d);a=new O(new P(f,l),y);r+=l.position?l.position.length:0;x.push(a)}}return{stageResources:{textures:q,materials:h,geometries:x},materialsByComponent:k,pivotOffset:c.model.pivotOffset,numberOfVertices:r}}Object.defineProperty(k,"__esModule",{value:!0});var n=L.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),
S=new E.Version(1,2,"wosr");k.fetch=function(c,e){return p(c,e).then(function(a){return q(a,e)})};k.fetchLod=function(c,e){var a=D.removeFile(c);return p(c,e).then(function(b){return b.lods?t.all(b.lods.map(function(c){return c.href?p(D.makeAbsolute(c.href,a)):b})).then(function(a){return G(a.map(function(a){return q(a,e)}),b)}):G([q(b,e)],b)})};k.computeBoundingBox=function(c){c=c.stageResources[N.ModelContentType.GEOMETRY];for(var e=M.empty(),a=[0,0,0],b=[0,0,0],k=0;k<c.length;k++){var h=c[k].getBoundingInfo();
F.vec3d.set(h.getBBMin(),a);F.vec3d.set(h.getBBMax(),b);for(h=0;3>h;++h)e[h]=Math.min(e[h],a[h]),e[h+3]=Math.max(e[h+3],b[h])}return e};k.createStageResources=q});