// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../support/buffer/BufferView","./BackedBufferObject","../../../../webgl/Util"],function(h,g,f,m,n){Object.defineProperty(g,"__esModule",{value:!0});var d=n.assert,k=function(){return function(a,e,b){var c=0;this.modelOriginHi=new f.BufferViewVec3f(a,c,b);c+=12;this.modelOriginLo=new f.BufferViewVec3f(a,c,b);c+=12;this.model=new f.BufferViewMat3f(a,c,b);c+=36;this.modelNormal=new f.BufferViewMat3f(a,c,b);c+=36;0<=e.indexOf("color")&&(this.color=new f.BufferViewVec4f(a,
c,b),c+=16);0<=e.indexOf("featureAttribute")&&(this.featureAttribute=new f.BufferViewVec4f(a,c,b),c+=16)}}();g.View=k;h=function(){function a(e,a,c){this._tailIndex=this._headIndex=0;this._captureFirstIndex=!0;this._updating=!1;this._prevHeadIndex=0;this._resized=!1;this._rctx=e;this._optionalFields=a;this._elementSize=c[0].stride;this._capacity=1}a.prototype.destroy=function(){this._buffer&&this._buffer.destroy()};Object.defineProperty(a.prototype,"buffer",{get:function(){return this._buffer.buffer},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"size",{get:function(){var a=this._headIndex,b=this._tailIndex;return a>=b?a-b:a+this._capacity-b},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isEmpty",{get:function(){return this._headIndex===
this._tailIndex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isFull",{get:function(){return this._tailIndex===(this._headIndex+1)%this._capacity},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"headIndex",{get:function(){return this._headIndex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"tailIndex",{get:function(){return this._tailIndex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"firstIndex",{get:function(){return this._firstIndex},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"memoryUsage",{get:function(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}},enumerable:!0,configurable:!0});a.prototype.reset=function(){this._tailIndex=this._headIndex=0;this._firstIndex=null};a.prototype.startUpdateCylce=function(){this._captureFirstIndex=!0};a.prototype.beginUpdate=function(){d(!this._updating,"already updating");this._updating=!0;this._prevHeadIndex=this._headIndex};a.prototype.endUpdate=function(){d(this._updating,
"not updating");this.size<p*this.capacity&&this.shrink();this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex);this._updating=!1};a.prototype.allocateHead=function(){d(this._updating,"not updating");this.isFull&&this.grow();var a=this.headIndex;this._captureFirstIndex&&(this._firstIndex=a,this._captureFirstIndex=!1);this.incrementHead();d(this._headIndex!==this._tailIndex,"invalid pointers");return a};a.prototype.freeTail=function(){d(this._updating,
"not updating");d(0<this.size,"invalid size");var a=this._tailIndex===this._firstIndex;this.incrementTail();a&&(this._firstIndex=this._tailIndex)};a.prototype.grow=function(){this.resize(Math.max(l,Math.floor(this._capacity*q)))};a.prototype.shrink=function(){r&&this.resize(Math.max(l,Math.floor(this._capacity*t)))};a.prototype.resize=function(a){d(this._updating,"not updating");if(a!==this._capacity){var b=new m(this._rctx,34962,35044,this._elementSize,a);if(this._buffer){this._firstIndex&&(this._firstIndex=
(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);var c=this.size,e=this.compactInstances(b);d(e===c,"invalid compaction");this._buffer.destroy();this._tailIndex=0;this._headIndex=e;this._prevHeadIndex=0}this._resized=!0;this._capacity=a;this._buffer=b;this._view=new k(this._buffer.array,this._optionalFields,this._elementSize)}};a.prototype.compactInstances=function(a){var b=this._headIndex,c=this._tailIndex;return c<b?(this._buffer.copyRange(c,b,a),b-c):c>b?(this._buffer.copyRange(c,
this._capacity,a),0<b&&this._buffer.copyRange(0,b,a,this._capacity-c),b+(this._capacity-c)):0};a.prototype.incrementHead=function(a){void 0===a&&(a=1);this._headIndex=(this._headIndex+a)%this._capacity};a.prototype.incrementTail=function(a){void 0===a&&(a=1);this._tailIndex=(this._tailIndex+a)%this._capacity};a.prototype.transferRange=function(a,b){a<b?this._buffer.transferRange(a,b):a>b&&(0<b&&this._buffer.transferRange(0,b),this._buffer.transferRange(a,this._capacity))};return a}();g.RenderInstanceData=
h;var l=1024,q=2,p=.3,t=.5,r=!0});