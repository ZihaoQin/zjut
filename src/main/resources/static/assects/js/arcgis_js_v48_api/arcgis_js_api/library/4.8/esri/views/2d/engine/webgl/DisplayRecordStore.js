// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","dojo/has","./FreeList","./Utils"],function(r,t,u,n,w){function x(c){c=c.getStrides();var a={},b;for(b in c)a[p[b]]=c[b];return a}Object.defineProperty(t,"__esModule",{value:!0});var p=["FILL","LINE","MARKER","TEXT","LABEL"];r=function(){function c(a,b,e,k){this._strides=a;this._displayList=b;this._vertexAlignments={};this._freeListsAndStorage={};this._dirtyMap=null;this._dirtyMap=e;for(var d in a){e=b=!1;this._freeListsAndStorage[d]={vtxFreeList:k?new n.FreeList(k):null,
idxFreeList:k?new n.FreeList(k):null,vertexBuffers:{},indexBuffer:k?new Uint32Array(k):null};for(var g in a[d])this._freeListsAndStorage[d].vertexBuffers[g]={data:k?new Uint32Array(Math.floor(k*a[d][g]/4)):null,stride:a[d][g]},2===a[d][g]%4?b=!0:0!==a[d][g]%4&&(e=!0);this._vertexAlignments[d]=e?4:b?2:1}}c.fromTileData=function(a,b){var e=x(a),k=[0,0,0,0,0],d=[0,0,0,0,0],g=[];a.tileDisplayData.displayObjectRegistry.forEach(function(a){g.push(a)});for(var m=0;m<g.length;m++)for(var l=0,f=g[m].displayRecords;l<
f.length;l++){var h=f[l];k[h.geometryType]=Math.max(k[h.geometryType],h.vertexFrom+h.vertexCount);d[h.geometryType]=Math.max(d[h.geometryType],h.indexFrom+h.indexCount)}b=new c(e,a.tileDisplayData.displayList,b,null);for(e=0;e<a.tileBufferData.geometries.length;++e){var m=k[e],h=d[e],f=a.tileBufferData.geometries[e],l=b._storageFor(p[e]),v=a.tileBufferData.geometries[e].indexBuffer;l.indexBuffer=v;l.idxFreeList=new n.FreeList(v.length);l.idxFreeList.allocate(h);var h=void 0,q;for(q in f.vertexBuffer)f=
a.tileBufferData.geometries[e].vertexBuffer[q],l.vertexBuffers[q].data=f.data,l.vertexBuffers[q].stride=f.stride,h=4*f.data.length/f.stride;l.vtxFreeList=new n.FreeList(h);l.vtxFreeList.allocate(m)}return b};c.prototype.delete=function(a){var b=p[a.geometryType];this._freeVertices(b,a.vertexFrom,a.vertexCount);this._freeIndices(b,a.indexFrom,a.indexCount);this._displayList.removeFromList(a);a.vertexFrom=void 0;a.indexFrom=void 0};c.prototype.setMeshData=function(a,b,e,k){var d=p[a.geometryType];a.meshData=
null;var g=void 0,m=void 0;void 0===a.vertexFrom?(m=this._align(d,b.vertexCount),g=this._allocateVertices(d,m)):b.vertexCount>a.vertexCount?(this._freeVertices(d,a.vertexFrom,a.vertexCount),m=this._align(d,b.vertexCount),g=this._allocateVertices(d,m)):b.vertexCount===a.vertexCount?(g=a.vertexFrom,m=a.vertexCount):(this._freeVertices(d,a.vertexFrom+b.vertexCount,a.vertexCount-b.vertexCount),g=a.vertexFrom,m=b.vertexCount);var c=!0,f=void 0,h=void 0;void 0===a.indexFrom?(h=b.indexCount,f=this._allocateIndices(d,
h)):b.indexCount>a.indexCount?(this._displayList.removeFromList(a),this._freeIndices(d,a.indexFrom,a.indexCount),h=b.indexCount,f=this._allocateIndices(d,h)):b.indexCount===a.indexCount?(c=!1,f=a.indexFrom,h=a.indexCount):(this._displayList.removeFromList(a),this._freeIndices(d,a.indexFrom+b.indexCount,a.indexCount-b.indexCount),f=a.indexFrom,h=b.indexCount);if(-1!==g&&-1!==f){d=this._storageFor(d);w.copyMeshData(g,f,d.vertexBuffers,d.indexBuffer,b,e,k);a.vertexFrom=g;a.indexFrom=f;a.vertexCount=
b.vertexCount;a.indexCount=b.indexCount;if(this._dirtyMap){this._dirtyMap.markDirtyIndices(a.geometryType,a.indexFrom,a.indexCount);for(var n in e)this._dirtyMap.markDirtyVertices(a.geometryType,n,a.vertexFrom,a.vertexCount)}c&&this._displayList.addToList(a);return!0}-1!==g&&this._freeVertices(d,g,m);-1!==f&&this._freeIndices(d,f,h);a.setMeshDataFromBuffers(b,e,k);a.vertexFrom=void 0;a.vertexCount=0;a.indexFrom=void 0;a.indexCount=0;return!1};c.prototype._allocateVertices=function(a,b){a=this._storageFor(a);
b=a.vtxFreeList.allocate(b);return-1===b||.5<a.vtxFreeList.fragmentation?-1:b};c.prototype._freeVertices=function(a,b,e){var k=this._storageFor(a);k.vtxFreeList.free(b,e);if(u("esri-feature-tiles-debug"))for(var d in k.vertexBuffers)for(var g=k.vertexBuffers[d].data,c=this._stridesFor(a,d),l=b*c/4,c=e*c/4,f=l;f<l+c;++f)g[f]=0};c.prototype._freeIndices=function(a,b,e){a=this._storageFor(a);a.idxFreeList.free(b,e);if(u("esri-feature-tiles-debug")){a=a.indexBuffer;for(var c=b;c<b+e;++c)a[c]=0}};c.prototype._align=
function(a,b){var c=b%this._vertexAlignments[a];return 0===c?b:b+(this._vertexAlignments[a]-c)};c.prototype._allocateIndices=function(a,b){a=this._storageFor(a);b=a.idxFreeList.allocate(b);return-1===b||.5<a.idxFreeList.fragmentation?-1:b};c.prototype._storageFor=function(a){return this._freeListsAndStorage[a]};c.prototype._stridesFor=function(a,b){return this._strides[a][b]};return c}();t.default=r});