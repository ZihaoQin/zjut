// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/views/3d/layers/i3s/PointCloudPointRenderer.xml":'\x3c?xml version\x3d"1.0" encoding\x3d"UTF-8"?\x3e\r\n\r\n\x3csnippets\x3e\r\n\r\n\x3csnippet name\x3d"vsPointCloudPointRenderer"\x3e\x3c![CDATA[\r\n$vsprecisionf\r\n\r\nattribute vec3 aPosition;\r\nattribute vec3 aColor;\r\n\r\nuniform mat4 uModelViewMatrix;\r\nuniform mat4 uProjectionMatrix;\r\nuniform vec2 uScreenMinMaxSize;\r\nuniform vec2 uPointScale;\r\nuniform vec3 uClipMin;\r\nuniform vec3 uClipMax;\r\n\r\n#ifdef DEPTH_PASS\r\nuniform vec2 nearFar;\r\n\r\nvarying float depth;\r\n#else\r\nvarying vec3 vColor;\r\n#endif\r\n\r\nvoid main(void) {\r\n\r\n  // Move clipped points outside of clipspace\r\n  if (aPosition.x \x3c uClipMin.x || aPosition.y \x3c uClipMin.y || aPosition.z \x3c uClipMin.z ||\r\n      aPosition.x \x3e uClipMax.x || aPosition.y \x3e uClipMax.y || aPosition.z \x3e uClipMax.z) {\r\n    gl_Position \x3d vec4(0.0,0.0,0.0,2.0);\r\n    gl_PointSize \x3d 0.0;\r\n    return;\r\n  }\r\n\r\n  // Position in camera space\r\n  vec4 camera \x3d uModelViewMatrix * vec4(aPosition, 1.0);\r\n\r\n  float pointSize \x3d uPointScale.x;\r\n  vec4 position \x3d uProjectionMatrix * camera;\r\n\r\n  // Calculate Size\r\n  #ifdef DRAW_SCREEN_SIZE\r\n    float clampedScreenSize \x3d pointSize;\r\n  #else\r\n    float pointRadius \x3d 0.5 * pointSize;\r\n    vec4 cameraOffset \x3d camera + vec4(0.0, pointRadius, 0.0, 0.0);\r\n    vec4 positionOffset \x3d uProjectionMatrix * cameraOffset;\r\n    float radius \x3d abs(positionOffset.y - position.y);\r\n\r\n    float viewHeight \x3d uPointScale.y;\r\n\r\n    // screen diameter \x3d (2 * r / w) * (h / 2)\r\n    float screenPointSize \x3d (radius / position.w) * viewHeight;\r\n    float clampedScreenSize \x3d clamp(screenPointSize, uScreenMinMaxSize.x, uScreenMinMaxSize.y);\r\n\r\n    // Shift towards camera, to move rendered point out of terrain i.e. to\r\n    // the camera-facing end of the virtual point when considering it as a\r\n    // 3D sphere.\r\n    camera.xyz -\x3d normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;\r\n    position \x3d uProjectionMatrix * camera;\r\n  #endif\r\n\r\n  gl_PointSize \x3d clampedScreenSize;\r\n  gl_Position \x3d position;\r\n\r\n  #ifdef DEPTH_PASS\r\n  depth \x3d (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);\r\n  #else\r\n  vColor \x3d aColor;\r\n  #endif\r\n}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsPointCloudPointRenderer"\x3e\x3c![CDATA[\r\n$fsprecisionf\r\n\r\n#ifdef DEPTH_PASS\r\n$float2rgba\r\n\r\nvarying float depth;\r\n#else\r\nvarying vec3 vColor;\r\n#endif\r\n\r\nvoid main(void) {\r\n  vec2 vOffset \x3d gl_PointCoord - vec2(0.5, 0.5);\r\n  float r2 \x3d dot(vOffset, vOffset);\r\n\r\n  if (r2 \x3e 0.25) {\r\n    discard;\r\n  }\r\n\r\n  #ifdef DEPTH_PASS\r\n  gl_FragColor \x3d float2rgba(depth);\r\n  #else\r\n  gl_FragColor \x3d vec4(vColor, 1.0);\r\n  #endif\r\n}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3c/snippets\x3e\r\n'}});
define("require exports dojo/text!./PointCloudPointRenderer.xml ../../../../geometry/support/aaBoundingBox ../../support/geometryUtils ../../support/orientedBoundingBox ../../webgl-engine/lib/gl-matrix ../../webgl-engine/lib/RenderPass ../../../webgl/BufferObject ../../../webgl/Program ../../../webgl/VertexArrayObject".split(" "),function(O,P,K,n,L,D,f,x,z,p,M){function A(c,a,b,e,d){if(b.drawScreenSpace)return b.fixedSize*a*e;d=(d?256:64)*a*e;return b.drawFixedSize?Math.min(b.fixedSize/2,d):0<b.screenMinSize?
Math.min(Math.max(b.screenMinSize*a*e,c/2),d):Math.min(c/2,d)}function J(c,a,b){null==b&&(b=f.vec3d.create());b[0]=c.origin[0]+c.coordinates[3*a];b[1]=c.origin[1]+c.coordinates[3*a+1];b[2]=c.origin[2]+c.coordinates[3*a+2];return b}var l={aPosition:0,aColor:1},N={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]};return function(){function c(){this.didRender=!1;this.needsRender=!0;this.layerUid=
"";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._clipBox=n.create(n.POSITIVE_INFINITY);this._programScreenDepth=this._programWorldDepth=this._programScreen=this._programWorld=null;this.tempMatrix4=f.mat4.create();this.tempVec3=f.vec3.create();this.nodes=[]}c.prototype.initializeRenderContext=function(a){a.shaderSnippets.fsPointCloudPointRenderer||a.shaderSnippets._parse(K);var b=a.shaderSnippets.vsPointCloudPointRenderer,
e=a.shaderSnippets.fsPointCloudPointRenderer;this._programWorld=new p(a.rctx,b,e,l,[]);this._programScreen=new p(a.rctx,b,e,l,["DRAW_SCREEN_SIZE"]);this._programWorldDepth=new p(a.rctx,b,e,l,["DEPTH_PASS"]);this._programScreenDepth=new p(a.rctx,b,e,l,["DRAW_SCREEN_SIZE","DEPTH_PASS"]);this.needsRender=!0};c.prototype.uninitializeRenderContext=function(a){this._programWorld&&this._programWorld.dispose();this._programScreen&&this._programScreen.dispose();this._programWorldDepth&&this._programWorldDepth.dispose();
this._programScreenDepth&&this._programScreenDepth.dispose();this._programScreenDepth=this._programWorldDepth=this._programScreen=this._programWorld=null};c.prototype.intersect=function(a,b,e,d){var c=f.vec3d.create(),g=f.vec3d.create(),q=f.vec3d.create(),E=f.vec3d.create(),H=L.plane.create(),m=a.camera.perPixelRatio,F=a.camera.near,u=this._getSizeParams();f.vec3d.subtract(e,b,g);var l=1/f.vec3d.length(g);f.vec3d.scale(g,l,g);f.vec3d.negate(g,q);f.vec4d.set4(g[0],g[1],g[2],-f.vec3d.dot(g,b),H);d=
{};e={};var p=n.create(),G=n.create(this._clipBox);n.offset(G,-b[0],-b[1],-b[2],G);for(var x=0,z=this.nodes;x<z.length;x++){var h=z[x],B=h.splatSize*this._scaleFactor,v=D.minimumDistancePlane(h.obb,H),r=D.maximumDistancePlane(h.obb,H),v=v-(u.drawScreenSpace?0:A(B,v+F,u,m,h.isLeaf)),r=r-(u.drawScreenSpace?0:A(B,r+F,u,m,h.isLeaf)),v=null!=d.dist&&null!=e.dist&&d.dist<v*l&&e.dist>r*l;if(!(0>r||v)&&(r=A(B,r+F,u,m,h.isLeaf),D.intersectLine(h.obb,b,g,r))){r*=r;D.toAaBoundingBox(h.obb,p);n.offset(p,-b[0],
-b[1],-b[2],p);v=!n.contains(G,p);f.vec3d.subtract(h.origin,b,E);for(var w=0;w<h.pointCount;w++)if(c[0]=E[0]+h.coordinates[3*w],c[1]=E[1]+h.coordinates[3*w+1],c[2]=E[2]+h.coordinates[3*w+2],!v||n.containsPoint(G,c)){var t=f.vec3d.dot(c,g),y=t+F,I=u.drawScreenSpace?0:A(B,y,u,m,h.isLeaf);if(!(0>t-I)){var C=f.vec3d.length2(c)-t*t;if(!(C>r||(y-=I,y=A(B,y,u,m,h.isLeaf),C>y*y))){C=this.layerUid+"/"+h.id+"/"+w;t=(t-I)*l;if(null==d.dist||t<d.dist)d.point=J(h,w,d.point),d.dist=t,d.normal=q,d.pointId=C,d.layerUid=
this.layerUid;if(null==e.dist||t>e.dist)e.point=J(h,w,e.point),e.dist=t,e.normal=q,e.pointId=C,e.layerUid=this.layerUid}}}}}null!=d.dist&&(c=a.getMinResult(),null==c.dist||d.dist<c.dist)&&(b={type:"external",point:d.point,metadata:{pointId:d.pointId,layerUid:d.layerUid}},c.set(b,d.pointId,d.dist,d.normal,void 0),c.setIntersector("PointRenderer"));null!=e.dist&&(a=a.getMaxResult(),null==a.dist||e.dist>a.dist)&&(b={type:"external",point:e.point,metadata:{pointId:e.pointId,layerUid:e.layerUid}},a.set(b,
e.pointId,e.dist,e.normal,void 0),a.setIntersector("PointRenderer"))};c.prototype.render=function(a){if(a.pass!==x.MATERIAL&&a.pass!==x.MATERIAL_DEPTH)return!1;for(var b=a.pass===x.MATERIAL_DEPTH,c=a.rctx,d=0,k=this.nodes;d<k.length;d++){var g=k[d];null==g.vao&&this._initNode(a,g)}d=this._getSizeParams();k=b?d.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:d.drawScreenSpace?this._programScreen:this._programWorld;if(null==k||0===this.nodes.length)return!0;var q=this._clipBox,l=!n.equals(q,
n.POSITIVE_INFINITY,function(a,b){return a===b});l||(f.vec3.set3(-Infinity,-Infinity,-Infinity,this.tempVec3),k.setUniform3fv("uClipMin",this.tempVec3),f.vec3.set3(Infinity,Infinity,Infinity,this.tempVec3),k.setUniform3fv("uClipMax",this.tempVec3));c.setDepthTestEnabled(!0);c.bindProgram(k);k.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);b&&k.setUniform2f("nearFar",a.camera.near,a.camera.far);d.drawFixedSize&&k.setUniform2f("uPointScale",d.fixedSize,a.camera.fullHeight);for(var b=
0,p=this.nodes;b<p.length;b++){g=p[b];k.setUniform2f("uScreenMinMaxSize",d.screenMinSize,g.isLeaf?256:64);d.drawFixedSize||k.setUniform2f("uPointScale",g.splatSize*this._scaleFactor,a.camera.fullHeight);var m=g.origin;l&&(f.vec3.set3(q[0]-m[0],q[1]-m[1],q[2]-m[2],this.tempVec3),k.setUniform3fv("uClipMin",this.tempVec3),f.vec3.set3(q[3]-m[0],q[4]-m[1],q[5]-m[2],this.tempVec3),k.setUniform3fv("uClipMax",this.tempVec3));f.mat4.identity(this.tempMatrix4);f.mat4.translate(this.tempMatrix4,m,this.tempMatrix4);
f.mat4.multiply(a.camera.viewMatrix,this.tempMatrix4,this.tempMatrix4);k.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);c.bindVAO(g.vao);c.drawArrays(0,0,g.pointCount)}return!0};Object.defineProperty(c.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==
a&&(this._scaleFactor=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"sizePx",{get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"clippingBox",{set:function(a){n.set(this._clipBox,a||n.POSITIVE_INFINITY)},enumerable:!0,
configurable:!0});c.prototype.addNode=function(a){this.nodes.push({id:a.id,splatSize:a.splatSize,obb:a.obb,origin:f.vec3.create(a.origin),coordinates:a.coordinates,pointCount:a.coordinates.length/3,rgb:a.rgb,vao:null,isLeaf:a.isLeaf});this._requestRender()};c.prototype.removeNode=function(a){this.nodes=this.nodes.filter(function(b){b.id===a&&b.vao&&(b.vao.dispose(!0),b.vao=null);return b.id!==a});this._requestRender()};c.prototype.removeAll=function(){this.nodes.forEach(function(a){a.vao&&(a.vao.dispose(!0),
a.vao=null)});this.nodes=[];this._requestRender()};c.prototype._initNode=function(a,b){a=a.rctx;b.vao=new M(a,l,N,{positions:z.createVertex(a,35044,b.coordinates),colors:z.createVertex(a,35044,b.rgb)})};c.prototype._requestRender=function(){this.didRender=!1;this.needsRender=!0};c.prototype._getSizeParams=function(){var a=this._useFixedSizes,b=a&&!this._useRealWorldSymbolSizes,c=b?this._sizePx:this._size,d=this._minSizePx;a&&(d=0);return{drawScreenSpace:b,drawFixedSize:a,fixedSize:c,screenMinSize:d}};
return c}()});