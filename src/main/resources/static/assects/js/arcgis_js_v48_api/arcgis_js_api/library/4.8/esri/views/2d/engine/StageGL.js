// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper dojo/has ../../../core/promiseUtils ./Container ../engine/webgl/Fader ./webgl/BitBlitRenderer ./webgl/enums ./webgl/WGLPainter ./webgl/shaders/glShaderSnippets ../libs/gl-matrix/common ../libs/gl-matrix/mat2d ../libs/gl-matrix/vec2 ../../support/screenshotUtils ../../webgl/BufferObject ../../webgl/context-util ../../webgl/FramebufferObject ../../webgl/Program ../../webgl/RenderingContext ../../webgl/VertexArrayObject".split(" "),function(P,
Q,D,z,A,E,F,G,q,H,B,I,w,m,J,C,K,x,L,M,N){function y(m){return{state:m.state,pixelRatio:m.pixelRatio,stationary:m.stationary}}var O={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"};return function(r){function c(){var a=null!==r&&r.apply(this,arguments)||this;a._clipData=new Float32Array(8);a._upperLeft=m.create();a._upperRight=m.create();a._lowerLeft=m.create();a._lowerRight=m.create();a._mat2=w.create();a._clipRendererInitialized=!1;a._contextVersion=null;a._labelFader=new F.default(a);return a}
D(c,r);Object.defineProperty(c.prototype,"glPainter",{get:function(){return this._painter},enumerable:!0,configurable:!0});c.prototype.fadeInLabels=function(){this._labelFader.reset();this.requestRender()};c.prototype.createElement=function(){var a=document.createElement("canvas");a.setAttribute("class","esri-display-object");return a};c.prototype.setElement=function(a){this.element=a};c.prototype.useContextVersion=function(a){this._renderingContext||(this._contextVersion=a)};c.prototype.attach=function(a){if(this.attached)return!0;
this._resizeCanvas(a);var b=K.createContextOrErrorHTML(this.element,{alpha:!0,antialias:!1,depth:!0,stencil:!0},this._contextVersion);this._renderingContext=new M(b);this._contextVersion=this._renderingContext.contextVersion;this.attached=!0;this._cachedRenderParams=y(a);this._painter||(this._painter=new H.default,this._painter.initialize(this._renderingContext));return r.prototype.attach.call(this,a)};c.prototype.detach=function(a){r.prototype.detach.call(this,a);this._boundFBO=null;this._clipFBO&&
(this._clipFBO.dispose(),this._clipFBO=null);this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO1=null);this._labelsFBO2&&(this._labelsFBO2.dispose(),this._labelsFBO2=null);this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._clipVAO&&(this._clipVAO.dispose(),this._clipVBO=this._clipVAO=null);this._painter&&(this._painter.dispose(),this._painter=null);this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null);this._renderingContext&&
(this._renderingContext.dispose(),this._renderingContext=null);this._cachedRenderParams=null};c.prototype.renderChildren=function(a){var b=this.children;a.drawPhase=q.WGLDrawPhase.FILL|q.WGLDrawPhase.LINE|q.WGLDrawPhase.MARKER|q.WGLDrawPhase.TEXT;for(var k=b.length,d=0;d<k;d++){var e=b[d];e.attached&&this.renderChild(e,a)}if(z("esri-featurelayer-webgl-labeling")){var f=a.context,v=f.getBoundFramebufferObject();f.bindFramebuffer(this._labelsFBO2);d=a.stationary;f.setClearColor(0,0,0,d?0:1);f.clear(f.gl.COLOR_BUFFER_BIT);
if(d)for(a.drawPhase=q.WGLDrawPhase.LABEL_ALPHA,a.labelFBO=this._labelsFBO1,a.labelStep=this._labelFader.step(),d=0;d<k;d++)e=b[d],e.attached&&this.renderChild(e,a);else this._labelFader.reset();f.bindFramebuffer(v);a.labelFBO=this._labelsFBO2;a.drawPhase=q.WGLDrawPhase.LABEL;for(d=0;d<k;d++)e=b[d],e.attached&&this.renderChild(e,a);a=this._labelsFBO2;this._labelsFBO2=this._labelsFBO1;this._labelsFBO1=a}};c.prototype.beforeRenderChildren=function(a,b){a=b.context;var k=b.state,d=b.pixelRatio;if(b=
this._painter){a.enforceState();b.update(k,d);var e=k.width;b=k.height;var f=k.rotation,e=Math.round(e*d);b=Math.round(b*d);this._boundFBO=a.getBoundFramebufferObject();!z("esri-featurelayer-webgl-labeling")||this._labelsFBO1&&this._labelsFBO1.width===e&&this._labelsFBO1.height===b||(this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO2.dispose()),this._labelsFBO1=x.createWithAttachments(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,
height:b},{colorTarget:0,depthStencilTarget:0}),a.bindFramebuffer(this._labelsFBO1),a.setDepthWriteEnabled(!0),a.setStencilWriteMask(255),a.setClearColor(0,0,0,0),a.setClearDepth(1),a.setClearStencil(0),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT|a.gl.STENCIL_BUFFER_BIT),a.setDepthWriteEnabled(!1),a.bindFramebuffer(this._boundFBO),this._labelsFBO2=x.createWithAttachments(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:b},{colorTarget:0,
depthStencilTarget:0}));if(k.spatialReference&&(k.spatialReference._isWrappable?k.spatialReference._isWrappable():k.spatialReference.isWrappable)){var v=I.toRadian(f),g=Math.abs(Math.cos(v)),h=Math.abs(Math.sin(v)),c=Math.round(k.worldScreenWidth);if(Math.round(e*g+b*h)<=c)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===e&&this._clipFBO.height===b||(this._clipFBO=new x(a,{colorTarget:0,depthStencilTarget:3,width:e,height:b}));var q=.5*e,r=.5*b,k=1/e,p=1/b,d=.5*c*d,t=.5*(e*h+b*g),e=this._upperLeft,
g=this._upperRight,h=this._lowerLeft,c=this._lowerRight;m.set(e,-d,-t);m.set(g,d,-t);m.set(h,-d,t);m.set(c,d,t);w.identity(this._mat2);w.translate(this._mat2,this._mat2,[q,r]);0!==f&&w.rotate(this._mat2,this._mat2,v);m.transformMat2d(e,e,this._mat2);m.transformMat2d(g,g,this._mat2);m.transformMat2d(h,h,this._mat2);m.transformMat2d(c,c,this._mat2);f=this._clipData;f.set([2*h[0]*k-1,2*(b-h[1])*p-1,2*c[0]*k-1,2*(b-c[1])*p-1,2*e[0]*k-1,2*(b-e[1])*p-1,2*g[0]*k-1,2*(b-g[1])*p-1]);this._clipRendererInitialized||
this._initializeClipRenderer(a);this._clipVBO.setData(f);this._boundFBO=a.getBoundFramebufferObject();a.bindFramebuffer(this._clipFBO);a.setDepthWriteEnabled(!0);a.setStencilWriteMask(255);a.setClearColor(0,0,0,0);a.setClearDepth(1);a.setClearStencil(0);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT|a.gl.STENCIL_BUFFER_BIT);a.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1}};c.prototype.afterRenderChildren=function(a,b){this._clipFrame&&this._clipRendererInitialized&&(a=
this._renderingContext,a.bindFramebuffer(this._boundFBO),this._boundFBO=null,a.bindVAO(this._clipVAO),a.bindProgram(this._clipStencilProgram),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!0),a.setBlendingEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.setStencilOp(7680,7680,7681),a.setStencilWriteMask(255),a.setStencilFunction(519,1,255),a.drawElements(4,6,5123,0),a.bindVAO(),a.setColorMask(!0,!0,!0,!0),a.setBlendingEnabled(!0),a.setStencilFunction(514,1,255),this._blitRenderer.render(a,
this._clipFBO.colorTexture,9728,1),a.setStencilTestEnabled(!1))};c.prototype.doRender=function(a){var b=this.element.style;this.visible?(b.display="block",b.opacity=""+this.opacity,this._resizeCanvas(a),r.prototype.doRender.call(this,a),this._cachedRenderParams=y(a)):b.display="none"};c.prototype.takeScreenshot=function(a){void 0===a&&(a={});if(!this._cachedRenderParams)return A.reject();var b=a.pixelRatio||1;this._cachedRenderParams.pixelRatio=b;var k=Math.round(b*this._cachedRenderParams.state.width),
d=Math.round(b*this._cachedRenderParams.state.height),e=0,f=0,c=k,g=d,h=k,m=d;if(h=a.area)e=Math.round(b*h.x),f=Math.round(b*h.y),c=Math.round(b*h.width),g=Math.round(b*h.height);void 0!==a.width&&void 0!==a.height?(h=a.width/a.height,g*h<c?(h*=g,e+=Math.floor((c-h)/2),c=Math.floor(h)):(h=c/h,f+=Math.floor((g-h)/2),g=Math.floor(h)),h=a.width,m=a.height):(h=c,m=g);var q=document.createElement("canvas");q.width=h;q.height=m;var r=q.getContext("2d"),b=new Uint8Array(c*g*4),p=this._renderingContext,t=
x.create(p,{colorTarget:1,depthStencilTarget:3,width:k,height:d});p.bindFramebuffer(t);p.setViewport(0,0,k,d);var l=this._cachedRenderParams,n=this._renderingContext.gl;this._renderingContext.setClearColor(0,0,0,0);this._renderingContext.setClearDepth(1);this._renderingContext.setClearStencil(0);this._renderingContext.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT);l.context=this._renderingContext;l.painter=this._painter;this.beforeRenderChildren(l,l);if(void 0!==a.rotation&&null!==
a.rotation){var n=l.state,u=n.clone();u.viewpoint.rotation=a.rotation;l.state=u;this.renderChildren(l);l.state=n}else this.renderChildren(l);this.afterRenderChildren(l,l);t.readPixels(e,d-(f+g),c,g,6408,5121,b);p.bindFramebuffer();p=r.getImageData(0,0,h,m);if(0!==e||0!==f||c!==k||g!==d||h!==k||m!==d)J.resampleHermite(b,c,g,p.data,h,m,!0);else{f=g-1;g=0;t=4*c;for(u=n=e=d=k=c=l=void 0;g<f;){n=g*t;u=f*t;for(l=0;l<t;l+=4)c=b[n+l],k=b[n+l+1],d=b[n+l+2],e=b[n+l+3],b[n+l]=b[u+l],b[n+l+1]=b[u+l+1],b[n+l+
2]=b[u+l+2],b[n+l+3]=b[u+l+3],b[u+l]=c,b[u+l+1]=k,b[u+l+2]=d,b[u+l+3]=e;g++;f--}c=p.data;k=b.length;for(f=0;f<k;f++)c[f]=b[f]}g=p.data;t=g.length;for(f=0;f<t;f+=4)e=g[f+3],0<e&&(d=e/255,c=Math.floor(g[f+0]/d),k=Math.floor(g[f+1]/d),d=Math.floor(g[f+2]/d),g[f+0]=255>=c?c:255,g[f+1]=255>=k?k:255,g[f+2]=255>=d?d:255);r.putImageData(p,0,0);r=O[a.format?a.format.toLowerCase():"png"];h={dataURL:q.toDataURL(r,null!=a.quality?a.quality/100:1),x:0,y:0,width:h,height:m};a.returnByteBuffer&&(h.data=b);return A.resolve(h)};
c.prototype.prepareChildrenRenderParameters=function(a){if(!this.attached||!this._renderingContext)return null;a=y(a);var b=this._renderingContext,c=b.gl;b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);b.setClearStencil(0);b.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT);b.setViewport(0,0,this.element.width,this.element.height);b.setDepthWriteEnabled(!1);a.context=b;a.painter=this._painter;return a};c.prototype.attachChild=function(a,
b){return a.attach(b)};c.prototype.detachChild=function(a,b){return a.detach(b)};c.prototype.renderChild=function(a,b){return a.processRender(b)};c.prototype._resizeCanvas=function(a){var b=this.element,c=b.style,d=a.state,e=a.pixelRatio;a=Math.round(d.width*e);e=Math.round(d.height*e);if(b.width!==a||b.height!==e)b.width=a,b.height=e;c.width=d.width+"px";c.height=d.height+"px"};c.prototype._initializeClipRenderer=function(a){if(this._clipRendererInitialized)return!0;this._blitRenderer=new G;var b=
{a_pos:0},c=new L(a,B.stencilVS,B.stencilFS,b);if(!c)return!1;var d=C.createVertex(a,35040,32),e=new Uint16Array([0,1,2,2,1,3]),e=C.createIndex(a,35044,e);a=new N(a,b,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:d},e);this._clipStencilProgram=c;this._clipVBO=d;this._clipVAO=a;return this._clipRendererInitialized=!0};return c}(E)});