// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../support/Evented ../../../support/buffer/BufferView ../gl-matrix ../../../../webgl/Util".split(" "),function(m,k,q,r,e,h,t){Object.defineProperty(k,"__esModule",{value:!0});var n=t.assert,f;(function(d){d[d.ALLOCATED=1]="ALLOCATED";d[d.ACTIVE=2]="ACTIVE";d[d.VISIBLE=4]="VISIBLE";d[d.HIGHLIGHT=8]="HIGHLIGHT";d[d.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE";d[d.REMOVE=32]="REMOVE";d[d.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"})(f=
k.StateFlags||(k.StateFlags={}));var p=function(){return function(d,c,b){var a=0;this.modelOrigin=new e.BufferViewVec3f64(d,a,b);a+=24;this.model=new e.BufferViewMat3f(d,a,b);a+=36;this.modelNormal=new e.BufferViewMat3f(d,a,b);a+=36;this.modelScaleFactor=new e.BufferViewFloat(d,a,b);a+=4;this.boundingSphere=new e.BufferViewVec4f(d,a,b);a+=16;0<=c.indexOf("color")&&(this.color=new e.BufferViewVec4f(d,a,b),a+=16);0<=c.indexOf("featureAttribute")&&(this.featureAttribute=new e.BufferViewVec4f(d,a,b),
a+=16);this.state=new e.BufferViewUint8(d,a,b);this.lodLevel=new e.BufferViewUint8(d,a+1,b)}}();k.View=p;m=function(d){function c(b){var a=d.call(this)||this;a._capacity=0;a._size=0;a._next=0;a._optionalFields=b;a._elementSize=c.BASE_ELEMENT_SIZE;0<=a._optionalFields.indexOf("color")&&(a._elementSize+=16);0<=a._optionalFields.indexOf("featureAttribute")&&(a._elementSize+=16);return a}q(c,d);Object.defineProperty(c.prototype,"elementSize",{get:function(){return this._elementSize},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!0});c.prototype.addInstance=function(){this._size+1>this._capacity&&
this.grow();var b=this.findSlot();this._view.state.set(b,f.ALLOCATED);this._size++;this.emit("instance-added",{index:b});return b};c.prototype.removeInstance=function(b){var a=this._view.state;n(0<=b&&b<this._capacity&&a.get(b)&f.ALLOCATED,"invalid instance handle");this.getStateFlag(b,f.ACTIVE)?this.setStateFlags(b,f.REMOVE):this.notifyRemoved(b)};c.prototype.notifyRemoved=function(b){var a=this._view.state;n(0<=b&&b<this._capacity&&a.get(b)&f.ALLOCATED,"invalid instance handle");a.set(b,0);this._size--;
this.emit("instance-removed",{index:b})};c.prototype.setTransform=function(b,a){var c=this._view,d=l,e=g;h.vec3d.set3(a[12],a[13],a[14],d);c.modelOrigin.setVec(b,d);h.mat4d.toMat3(a,e);c.model.setMat(b,e);c.modelScaleFactor.set(b,h.mat4d.maxScale(a));h.mat3d.inverse(e,e);h.mat3d.transpose(e,e);c.modelNormal.setMat(b,e);this.setStateFlags(b,f.TRANSFORM_CHANGED);this.emit("instance-transform-changed",{index:b})};c.prototype.getTransform=function(b,a){var c=this._view;c.model.getMat(b,g);c.modelOrigin.getVec(b,
l);a[0]=g[0];a[1]=g[1];a[2]=g[2];a[3]=0;a[4]=g[3];a[5]=g[4];a[6]=g[5];a[7]=0;a[8]=g[6];a[9]=g[7];a[10]=g[8];a[11]=0;a[12]=l[0];a[13]=l[1];a[14]=l[2];a[15]=0};c.prototype.setTranslation=function(b,a){this._view.modelOrigin.setVec(b,a);this.emit("instance-transform-changed",{index:b})};c.prototype.getTranslation=function(b,a){this._view.modelOrigin.getVec(b,a)};c.prototype.getModel=function(b,a){this._view.model.getMat(b,a)};c.prototype.getScaleFactor=function(b){return this._view.modelScaleFactor.get(b)};
c.prototype.setFeatureAttribute=function(b,a){this._view.featureAttribute.setVec(b,a)};c.prototype.setColor=function(b,a){this._view.color.setVec(b,a)};c.prototype.getColor=function(b,a){this._view.color.getVec(b,a)};c.prototype.getFeatureAttribute=function(b,a){this._view.featureAttribute.getVec(b,a)};c.prototype.setVisible=function(b,a){a!==this.getVisible(b)&&(this.setStateFlag(b,f.VISIBLE,a),this.emit("instance-visibility-changed",{index:b}))};c.prototype.getVisible=function(b){return this.getStateFlag(b,
f.VISIBLE)};c.prototype.setHighlight=function(b,a){a!==this.getHighlight(b)&&(this.setStateFlag(b,f.HIGHLIGHT,a),this.emit("instance-highlight-changed",{index:b}))};c.prototype.getHighlight=function(b){return this.getStateFlag(b,f.HIGHLIGHT)};c.prototype.getState=function(b){return this._view.state.get(b)};c.prototype.getLodLevel=function(b){return this._view.lodLevel.get(b)};c.prototype.countFlags=function(b){for(var a=0,c=0;c<this._capacity;++c)this.getState(c)&b&&++a;return a};c.prototype.setStateFlags=
function(b,a){var c=this._view.state;a|=c.get(b);c.set(b,a)};c.prototype.clearStateFlags=function(b,a){var c=this._view.state;a=c.get(b)&~a;c.set(b,a)};c.prototype.setStateFlag=function(b,a,c){c?this.setStateFlags(b,a):this.clearStateFlags(b,a)};c.prototype.getStateFlag=function(b,a){return!!(this._view.state.get(b)&a)};c.prototype.grow=function(){var b=Math.max(u,Math.floor(this._capacity*v)),a=new ArrayBuffer(b*this.elementSize);if(this._buffer){var c=new Uint8Array(this._buffer);(new Uint8Array(a)).set(c)}this._capacity=
b;this._buffer=a;this._view=new p(this._buffer,this._optionalFields,this.elementSize)};c.prototype.findSlot=function(){for(var b=this._view.state,a=this._next;b.get(a)&f.ALLOCATED;)a=(a+1)%this._capacity;this._next=(a+1)%this._capacity;return a};c.BASE_ELEMENT_SIZE=120;return c}(r.Evented);k.InstanceData=m;var u=1024,v=2,l=h.vec3d.create(),g=h.mat3d.create()});