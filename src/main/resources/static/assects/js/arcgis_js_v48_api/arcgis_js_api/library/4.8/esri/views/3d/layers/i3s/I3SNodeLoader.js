// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred dojo/errors/CancelError ../../../../core/lang ../../../../core/promiseUtils ../../../../core/urlUtils ./I3SBinaryReader ./I3SUtil ../../webgl-engine/lib/Util".split(" "),function(l,x,t,u,v,p,n,q,r,w){l=function(){function e(a,b,c,d,g){this.loader=a;this.logger=b;this.defaultGeometrySchema=c;this.requiredAttributes=d;this.options=g;this.cancelled=!1;this.loadShared=function(a){if(null==a.sharedResource)return p.resolve({});var c=n.makeAbsolute(a.sharedResource.href,
a.baseUrl);return this.load(c,"json").then(function(a){e.fixTextureEncodings(a);e.addAbsoluteHrefTexture(a,c);return a})}}e.prototype.cancelAll=function(){this.cancelled=!0};e.prototype.load=function(a,b){b=this.loader.request(a,b);var c=new t;b.then(function(a,b){c.resolve(b)},function(d){c.reject(Error("Failed to load: "+a))});return c.promise};e.prototype.loadAttribute=function(a,b,c){a=n.makeAbsolute(c,a);return this.load(a,"binary").then(function(a){return q.readBinaryAttribute(b,a)})};e.prototype.loadAttributes=
function(a,b,c){var d=this,g=c.map(function(c){return null==a.attributeData||null==a.attributeData[c.index]?(d.logger.error("Missing attributeData for '"+c.name+"' on node '"+a.id+"'"),p.resolve(null)):d.loadAttribute(b,c.attributeStorageInfo,a.attributeData[c.index].href).catch(function(b){d.logger.error("Failed to load attributeData for '"+c.name+"' on node '"+a.id+"'");return null})});return p.all(g).then(function(a){for(var d={},b=0;b<c.length;++b)a[b]&&(d[c[b].name]=a[b]);return d})};e.prototype.prepareBinaryGeometryData=
function(a,b,c,d){v.mixin(a.geometries[0].params,c);d||null!=c.vertexAttributes.region||delete c.vertexAttributes.region;if(null!=c.featureAttributes){d=c.featureAttributes;if(d.faceRange){var g=q.createTypedView(b,d.faceRange);a.componentOffsets=r.convertFlatRangesToOffsets(g,c.header.fields.featureCount,d.faceRange.valuesPerElement)}if(d.id){a.featureIds=[];var g=1,f=q.valueType2TypedArrayClassMap[d.id.valueType];"UInt64"===d.id.valueType&&(f=Uint32Array,g=2);b=new f(b,d.id.byteOffset,d.id.count*
d.id.valuesPerElement*g);for(f=0;f<c.header.fields.featureCount;f++)if(a.featureIds[f]=b[f*d.id.valuesPerElement*g],2===g){var e=b[f*d.id.valuesPerElement*g+1];if(2097150<=e)throw Error("ID exceeded maximum range supported by javascript (max \x3d 53bit-1 \x3d 9007199254740991)");a.featureIds[f]+=4294967296*e}}}};e.prototype.loadBundleData=function(a,b){var c=this,d=a.baseUrl,g=null,e=this.loadShared(a),h=null;null!=this.requiredAttributes&&(h=this.loadAttributes(a,d,this.requiredAttributes));var k=
null;null!=a.geometryData&&(d=n.makeAbsolute(a.geometryData[b].href,d),k=this.load(d,"binary"));return e.then(function(d){c.handleCancelled();return(c.options.loadFeatureData?c.loadFeatureData(a,b):p.resolve(null)).then(function(b){c.handleCancelled();var e=c.options.loadFeatureData?c.collectGeometries(a,b,d):c.meshPyramidGeometryData(a,d);b=null!=k?k.then(function(a){g=a;var b=Object.keys(d.materialDefinitions)[0],b=d.materialDefinitions[b].params.vertexRegions,f=q.createGeometryDataIndex(a,c.defaultGeometrySchema,
b);c.prepareBinaryGeometryData(e[0],a,f,b);return e}):p.resolve(e);var f=c.loadTextures(e,d);return p.all([f,b,h])}).then(function(a){var b=a[0],e=a[1];a=a[2];c.handleCancelled();var f=null;a&&(f={attributeData:a,loadedAttributes:c.requiredAttributes});return{allGeometryData:e,attributeDataInfo:f,geometryBuffer:g,sharedResource:d,textureData:b}})})};e.addAbsoluteHrefTexture=function(a,b){a=a.textureDefinitions;if(null!=a)for(var c=0,d=Object.keys(a);c<d.length;c++)for(var e=0,f=a[d[c]].images;e<f.length;e++){var h=
f[e];Array.isArray(h.href)?h.hrefConcat=h.href.map(function(a){return n.makeAbsolute(a,b)}):h.hrefConcat=n.makeAbsolute(h.href,b)}};e.fixTextureEncodings=function(a){a=a.textureDefinitions;if(null!=a)for(var b in a){var c=a[b];if(Array.isArray(c.encoding))for(var d=0;d<c.encoding.length;d++){var e=c.encoding[d];"data:"===e.substring(0,5)&&(c.encoding[d]=e.substring(5))}else e=c.encoding,"data:"===e.substring(0,5)&&(c.encoding=e.substring(5))}};e.prototype.loadTexture=function(a,b,c,d){var e=this;
return d===r.DDS_ENCODING_STRING?this.load(a,"binary").then(function(a){e.handleCancelled();return{i3sTexId:b,data:a,encoding:d}}):this.load(a,"image").then(function(a){var f=a;e.handleCancelled();if(c&&4096<=a.width*a.height){var f=Math.ceil(a.width/2),g=Math.ceil(a.height/2),m=document.createElement("canvas");m.width=f;m.height=g;m.getContext("2d").drawImage(a,0,0,f,g);f=m}return{i3sTexId:b,data:f,encoding:d}})};e.prototype.loadTextures=function(a,b){for(var c=[],d=0;d<a.length;d++){var g=a[d].geometries;
if(null!=g)for(var f=0;f<g.length;f++){var h=g[f].params.textureID||"none";if("none"!==h){null!=b.textureDefinitions&&null!=b.textureDefinitions[h]||this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+h);var k=b.textureDefinitions[h];w.assert(void 0!==k,"geometry wants unknown texture "+h);if(0!==k.images.length){var m=k.images[k.images.length-1],n=this.options.textureFormat===e.TextureFormat.Downsampled,l=r.getAppropriateTextureEncoding(k.encoding,this.options.textureFormat===
e.TextureFormat.Compressed),k=-1<l?k.encoding[l]:k.encoding,m=-1<l?m.hrefConcat[l]:m.hrefConcat;this.options.loadTextureData?c.push(this.loadTexture(m,h,n,k)):c.push({i3sTexId:h,encoding:k,data:null})}}}}return p.all(c)};e.prototype.meshPyramidGeometryData=function(a,b){a=b.materialDefinitions?Object.keys(b.materialDefinitions)[0]:null;b=b.textureDefinitions?Object.keys(b.textureDefinitions)[0]:null;return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:a,textureID:b}}],featureDataPosition:[0,
0,0]}]};e.prototype.collectGeometries=function(a,b,c){a=[];c=0;for(b=b.featureData;c<b.length;c++){var d=b[c],e=d.geometries;if(null!=e)for(var f=0;f<e.length;f++)a.push({featureIds:[d.id],featureDataPosition:d.position,geometries:[d.geometries[f]]});else null!=d.position&&a.push({featureIds:[d.id],featureDataPosition:d.position,geometries:null})}return a};e.prototype.loadFeatureData=function(a,b){a=n.makeAbsolute(a.featureData[b].href,a.baseUrl);return this.load(a,"json")};e.prototype.handleCancelled=
function(){if(this.cancelled)throw new u;};return e}();(function(e){e=e.TextureFormat||(e.TextureFormat={});e[e.Compressed=0]="Compressed";e[e.Normal=1]="Normal";e[e.Downsampled=2]="Downsampled"})(l||(l={}));return l});