// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../request ../../../core/arrayUtils ../../../core/lang ./AsyncQuotaRoundRobinQueue ./PromiseLightweight ../webgl-engine/lib/Performance ../webgl-engine/lib/Util".split(" "),function(t,u,l,m,n,p,q,k,r){var f;(function(b){b[b.QUEUED=1]="QUEUED";b[b.DOWNLOADING=2]="DOWNLOADING";b[b.CANCELLED=4]="CANCELLED"})(f||(f={}));return function(){function b(a){this.tasks=new Map;this.clientPromiseToTask=new Map;this.loadQueue=new p(this.startLoading.bind(this),this.doneLoadingCallback,
this,a)}b.prototype.destroy=function(){var a=this;this.tasks.forEach(function(c){for(var g=0,b=c.clientPromises;g<b.length;g++){var d=b[g];d.isRejected()||d.reject(c.url,null);a.cancelTask(d)}});this.loadQueue.clear();this.clientPromiseToTask=this.tasks=this.loadQueue=null};b.prototype.request=function(a,c,b){var g=this,d=new q.Promise(function(){g.cancel(d)});this.createOrUpdateTask(a,c,b,d);return d};b.prototype.createTask=function(a,c,b,e,d){a={url:a,docType:c,clientType:b,key:e,result:null,status:f.QUEUED,
clientPromises:[],downloadObj:null,_cancelledInQueue:!1,startTime:0,duration:0,size:0};this.updateTask(a,d);this.tasks.set(e,a);this.loadQueue.push(a)};b.prototype.cancel=function(a){this.cancelTask(a)};b.prototype.hasPendingDownloads=function(){return 0<this.tasks.size};Object.defineProperty(b.prototype,"tests",{get:function(){return{loadQueue:this.loadQueue}},enumerable:!0,configurable:!0});b.prototype.taskKey=function(a,c,b){return a+":"+c+":"+b};b.prototype.updateTask=function(a,c){this.clientPromiseToTask.set(c,
a);a.clientPromises.push(c)};b.prototype.createOrUpdateTask=function(a,c,b,e){var d=this.taskKey(a,c,b),g=this.tasks.get(d);g?this.updateTask(g,e):this.createTask(a,c,b,d,e)};b.prototype.cancelTask=function(a){var b=this.clientPromiseToTask.get(a);b&&(m.removeUnordered(b.clientPromises,a),this.clientPromiseToTask.delete(a),0===b.clientPromises.length&&(b.status===f.DOWNLOADING&&(this.loadQueue.workerCancelled(b),b.status=f.CANCELLED,b.downloadObj.cancel(),b.downloadObj=null),b.status=f.CANCELLED,
this.tasks.delete(b.key)))};b.prototype.doneLoadingCallback=function(a,b){r.assert(a.status===f.DOWNLOADING);for(var c=a.result,e=0,d=a.clientPromises;e<d.length;e++){var h=d[e];this.clientPromiseToTask.delete(h);b?h.isRejected()||h.reject(a.url,b):(c||(c=n.clone(a.result)),h.done(a.url,c),c instanceof HTMLImageElement||(c=null))}this.tasks.delete(a.key)};b.prototype.startLoading=function(a,b){if(a.status===f.CANCELLED)return!1;a.status=f.DOWNLOADING;var c,e;switch(a.docType){case "binary":e="array-buffer";
c=0;break;case "image":e="image";break;default:e="json"}a.startTime=k.now();a.downloadObj=l(a.url,{responseType:e,timeout:c,allowImageDataAccess:"image"===a.docType});a.downloadObj.then(function(c){a.duration=k.now()-a.startTime;a.size="binary"===a.docType?c.data.byteLength:0;a.result=c.data;b(a)},function(c){a.downloadObj.isCanceled()||b(a,c)});return!0};return b}()});