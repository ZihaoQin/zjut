// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper dojo/has dojo/i18n!./nls/Search ../../Graphic ../../PopupTemplate ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/geolocationUtils ../../core/Handles ../../core/Logger ../../core/promiseUtils ../../core/requireUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/Point ../../geometry/SpatialReference ../../portal/Portal ../../styles/basic ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/TextSymbol ./FeatureLayerSearchSource ./LocatorSearchSource ./SearchSource ./support/geometryUtils ./support/locatorUtils ../support/GoTo".split(" "),
function(r,X,D,d,E,p,B,F,G,H,k,I,q,J,K,g,L,l,e,w,M,t,N,O,P,Q,R,S,x,u,T,z,U,V){function h(e,b){return e.hasOwnProperty(b)&&null!=e[b]&&""!==e[b]}var m=K.getLogger("esri.widgets.Search.SearchViewModel"),n=H.ofType({key:function(e){return e.featureLayer?"feature-layer":"locator"},base:T,typeMap:{"feature-layer":x,locator:u}}),C=M.WGS84,W=/<(?:.|\s)*?>/g;return function(y){function b(a){a=y.call(this)||this;a._handles=new J;a._gotoPromise=null;a._popupTemplate=new F({title:p.searchResult,content:"{Match_addr}"});
a._searching=null;a._loadingDefaultSources=null;a.activeSourceIndex=0;a.allPlaceholder=p.allPlaceholder;a.autoNavigate=!0;a.autoSelect=!0;a.defaultSources=new n;a.defaultSymbol=new O({url:r.toUrl(E("trident")?"../../images/search/search-symbol-32.png":"../../images/search/search-symbol-32.svg"),size:24,width:24,height:24});a.includeDefaultSources=!0;a.locationToAddressDistance=1500;a.maxInputLength=128;a.maxResults=6;a.maxSuggestions=6;a.minSuggestCharacters=1;a.popupOpenOnSelect=!0;a.popupTemplate=
null;a.popupEnabled=!0;a.portal=t.getDefault();a.resultGraphicEnabled=!0;a.resultGraphic=null;a.results=null;a.selectedSuggestion=null;a.searchAllEnabled=!0;a.selectedResult=null;a.sources=new n;a.suggestionDelay=150;a.suggestions=null;a.suggestionsEnabled=!0;a.view=null;return a}D(b,y);b.prototype.initialize=function(){var a=this;this._handles.add([l.init(this,"searchAllEnabled",function(){return a._setDefaultActiveSourceIndex()}),l.init(this,"portal",function(a){a&&!a.loaded&&a.load()}),l.init(this,
["view","portal","includeDefaultSources"],function(){return a._loadDefaultSources()}),l.on(this,["defaultSources","sources"],"change",function(){return a.notifyChange("allSources")}),l.on(this,"allSources","change",function(c){return a._allSourcesChanged(c)})])};b.prototype.destroy=function(){this.clearGraphics();this._cancelLoadingDefaultSources();this._clearLoadingDefaultSources();this._handles.destroy();this._handles=null};Object.defineProperty(b.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||
null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"allSources",{get:function(){var a=this.sources,c=this.defaultSources,f=this.includeDefaultSources,a="function"===typeof f?f.call(null,{sources:a,defaultSources:c}):f?c.concat(a):a,b=this._get("allSources")||new n;b.removeAll();a.filter(Boolean).forEach(function(a){return b.add(a)});return b},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||
q.supported()},set:function(a){if(void 0===a)this._clearOverride("locationEnabled");else{var c=q.supported();if(a&&!c){var f=new k("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});m.error(f)}this._override("locationEnabled",a&&c)}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"placeholder",{get:function(){var a=this.activeSourceIndex,c=this.allPlaceholder,c=void 0===c?p.allPlaceholder:c;return-1===a?c:(a=this.allSources.getItemAt(a))?
a.placeholder:""},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"popup",{get:function(){return this.get("view.popup")||null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(a){this._set("searchTerm",a||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==a&&this._set("selectedSuggestion",null);""===a&&this._clear()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"state",{get:function(){return this._searching?"searching":this._loadingDefaultSources?"loading":0===this.allSources.length?"disabled":"ready"},enumerable:!0,configurable:!0});b.prototype.clear=function(){this.searchTerm=""};b.prototype.clearGraphics=function(){this._closePopup();this.view&&this.view.graphics.remove(this.resultGraphic);this._set("resultGraphic",null)};b.prototype.search=function(a){var c=this;this.emit("search-start");this.clearGraphics();var f=this._createSuggestionForSearch(a);
this._searching=a=this._loadDefaultSources().then(function(){return c._getResultsFromSources(f).then(function(a){var b={activeSourceIndex:c.activeSourceIndex,searchTerm:f.text,numResults:0,numErrors:0,errors:[],results:[]};c._formatResponse(b,a,f);a=c._getFirstResult(b.results);var v=(f.location&&a?a.name:f.text).replace(W,"");c._set("searchTerm",v);(f.key&&"number"===typeof f.sourceIndex||f.location)&&c._set("selectedSuggestion",f);c._set("results",b.results);c.emit("search-complete",b);return c._selectFirstResult(a).then(function(){return b})})});
this.notifyChange("state");a.then(function(){return c._clearSearching()}).catch(function(){return c._clearSearching()});return a};b.prototype.searchNearby=function(){var a=this;if(!this.locationEnabled){var c=new k("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});m.error(c);return g.reject(c)}this._searching=c=q.getCurrentPosition().then(function(c){return q.positionToPoint(c,a.view).then(function(c){return a.search(c)})});this.notifyChange("state");
c.then(function(){return a._clearSearching()}).catch(function(){return a._clearSearching()});return c};b.prototype.select=function(a){var c=this;this.clearGraphics();if(!a){var f=new k("select:missing-parameter","Cannot select without a searchResult.",{searchResult:a});m.error(f);return g.reject(f)}var b=this.view,e=h(a,"sourceIndex")?a.sourceIndex:this._getSourceIndexOfResult(a),d=this.allSources.getItemAt(e);if(!d)return f=new k("select:missing-source","Cannot select without a source.",{source:d}),
m.error(f),g.reject(f);var f=d instanceof x?this._getSourcePopupTemplate(d):null,A=d.resultSymbol||this._getDefaultSymbol(a),l=h(d,"resultGraphicEnabled")?d.resultGraphicEnabled:this.resultGraphicEnabled,p=h(d,"autoNavigate")?d.autoNavigate:this.autoNavigate,q=h(d,"popupOpenOnSelect")?d.popupOpenOnSelect:this.popupOpenOnSelect,n=h(d,"popupEnabled")?d.popupEnabled:this.popupEnabled,u=n?f||this.popupTemplate||this._popupTemplate:null,f=a.feature,r=this.popup;if(!f)return f=new k("select:missing-feature",
"Cannot select without a feature.",{feature:f}),m.error(f),g.reject(f);var w=f.attributes,t=f.geometry,y=f.sourceLayer,f=z.getPointFromGeometry(t);return(b&&f?z.getPointWithElevation(f,b):g.resolve(f)).then(function(f){A instanceof S&&(A.text=a.name);var v=new B({geometry:t,symbol:A,attributes:w,sourceLayer:y,popupTemplate:u});return(b&&p?c._goToSearchResult(b,a.extent):g.resolve()).then(function(){c._gotoPromise=null;l&&b&&b.graphics.push(v);r&&n&&q&&r.open({features:[v],location:f});c._set("selectedResult",
a);c._set("resultGraphic",v);c.emit("select-result",{result:a,source:d,sourceIndex:e});return a})})};b.prototype.suggest=function(a,c){var f=this,b=a||this.searchTerm;this.emit("suggest-start",{searchTerm:b});return this._suggestTimer(c).then(function(){return f._suggestImmediate(b).then(function(a){f._set("suggestions",a.results);f.emit("suggest-complete",a);return a})})};b.prototype._cancelLoadingDefaultSources=function(){var a=this._loadingDefaultSources;a&&a.cancel()};b.prototype._clearLoadingDefaultSources=
function(){this._loadingDefaultSources=null;this.notifyChange("state")};b.prototype._clearSearching=function(){this._searching=null;this.notifyChange("state")};b.prototype._convertHelperServices=function(){var a=this.get("portal.helperServices.geocode");return a?a.map(function(a){if(!1!==a.placefinding&&(a=u.fromJSON(a),U.isArcGISWorldGeocoder(a.get("locator.url"))&&a.set({singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],localSearchOptions:{minScale:3E5,distance:5E4},
placeholder:p.placeholder}),a.singleLineFieldName))return a}).filter(Boolean):[]};b.prototype._convertApplicationProperties=function(){var a=this,c=this.get("view.map.applicationProperties.viewing.search"),b=this.get("view.map");if(!b||!c)return[];var d=c.hintText;return c.enabled?c.layers.map(function(c){var f=b.findLayerById(c.id);if(f){c=a._getLayerJSON(c);var e=x.fromJSON(c);e.placeholder=d;a._getFeatureLayer(f,c).then(function(a){e.featureLayer=a});return e}}).filter(Boolean):[]};b.prototype._getFeatureLayer=
function(a,c){if("feature"===a.type||"scene"===a.type)return g.resolve(a);if("map-image"===a.type)return L.when(r,"../../layers/FeatureLayer").then(function(b){return new b({url:a.url+"/"+c.subLayer})})};b.prototype._getLayerJSON=function(a){return"function"===typeof a.toJSON?a.toJSON():a};b.prototype._updateDefaultSources=function(){var a=this.defaultSources,c=this.includeDefaultSources;a.removeAll();c&&a.addMany(this._convertApplicationProperties().concat(this._convertHelperServices()));this.notifyChange("allSources")};
b.prototype._clear=function(){this._gotoPromise&&(this._gotoPromise.cancel(),this._gotoPromise=null);this._set("results",null);this._set("suggestions",null);this._set("selectedResult",null);this._set("selectedSuggestion",null);this.emit("search-clear")};b.prototype._closePopup=function(){var a=this.get("view.popup"),c=this.resultGraphic;if(a&&this.popupEnabled&&c){var b=a.selectedFeature;b&&b===c&&a.close()}};b.prototype._suggestTimer=function(a){return g.after(null!=a?a:this.suggestionDelay)};b.prototype._createLocationForSearch=
function(a){if(a instanceof B)return z.getPointFromGeometry(a.geometry);if(a instanceof w)return a;if(Array.isArray(a)&&2===a.length)return new w({longitude:a[0],latitude:a[1]})};b.prototype._createSuggestionForSearch=function(a){if(a&&h(a,"key")&&h(a,"text")&&h(a,"sourceIndex"))return a;var c=this._createLocationForSearch(a)||null,b="string"===typeof a?a:this.searchTerm,d=this.selectedSuggestion,e=this.selectedResult,g=(a=!a&&d&&e)&&d.location;return a&&d.key===e.key&&d.sourceIndex===e.sourceIndex||
g?d:{location:c,text:c?"":b,sourceIndex:null,key:null}};b.prototype._getFirstResult=function(a){var c=null;a&&a.some(function(a){a=a.results[0];var b=!!a;b&&(c=a);return b});return c};b.prototype._selectFirstResult=function(a){return this.autoSelect&&a?this.select(a):g.resolve()};b.prototype._suggestImmediate=function(a){var c=this;return this._loadDefaultSources().then(function(){return c._getSuggestionsFromSources(a)}).then(function(b){var f={activeSourceIndex:c.activeSourceIndex,searchTerm:a,numResults:0,
numErrors:0,errors:[],results:[]};c._formatResponse(f,b);return f})};b.prototype._formatSourceResponse=function(a,c,b){var f=c&&c.value||[];c=c&&c.error;var d=this.allSources.getItemAt(b);c?(a.errors.push({sourceIndex:b,source:d,error:c}),a.numErrors++):(a.results.push({sourceIndex:b,source:d,results:f}),a.numResults+=f.length)};b.prototype._formatResponse=function(a,c,b){var f=this;if(c)if(-1===a.activeSourceIndex){var d=b&&h(b,"sourceIndex")&&-1!==b.sourceIndex?b.sourceIndex:void 0;c.forEach(function(c,
b){f._formatSourceResponse(a,c,void 0!==d?d:b)})}else this._formatSourceResponse(a,c[0],a.activeSourceIndex)};b.prototype._getResultsFromSources=function(a){var c=this,b=this.allSources,d=!a.location&&h(a,"sourceIndex")?a.sourceIndex:this.activeSourceIndex,e=[];if(!b.length)return b=new k("search:no-sources-defined","At least one source is required.",{allSources:b}),m.error(b),g.reject(b);-1===d?b.forEach(function(b,f){e.push(c._getResultsFromSource(a,f))}):e.push(this._getResultsFromSource(a,d));
return g.eachAlways(e)};b.prototype._getSuggestionsFromSources=function(a){var b=this,f=this.allSources,d=this.activeSourceIndex,e=[];if(!f.length)return f=new k("suggest:no-sources-defined","At least one source is required.",{allSources:f}),m.error(f),g.reject(f);-1===d?f.forEach(function(c,f){e.push(b._getSuggestionsFromSource(a,f))}):e.push(this._getSuggestionsFromSource(a,d));return g.eachAlways(e)};b.prototype._getResultsFromSource=function(a,b){var c=this.allSources.getItemAt(b),d=a.location,
d=void 0===d?null:d,e=this.get("view.spatialReference")||C,g=h(c,"maxResults")?c.maxResults:this.maxResults,k=c instanceof x&&h(c,"exactMatch")?c.exactMatch:!1,l=c instanceof u&&h(c,"locationToAddressDistance")?c.locationToAddressDistance:this.locationToAddressDistance;return c.getResults({view:this.view,sourceIndex:b,location:d,suggestResult:a,spatialReference:e,exactMatch:k,maxResults:g,distance:l})};b.prototype._getSuggestionsFromSource=function(a,b){var c=this.allSources.getItemAt(b),d=h(c,"suggestionsEnabled")?
c.suggestionsEnabled:this.suggestionsEnabled,e=a.trim().length,k=h(c,"minSuggestCharacters")?c.minSuggestCharacters:this.minSuggestCharacters;return d&&e>=k?(d=this.get("view.spatialReference")||C,e=h(c,"maxSuggestions")?c.maxSuggestions:this.maxSuggestions,c.getSuggestions({view:this.view,sourceIndex:b,suggestTerm:a,spatialReference:d,maxSuggestions:e})):g.resolve()};b.prototype.createDefaultSymbol=function(a,b){if("point"===b)return new R({color:a.color,size:a.size,outline:{color:a.outline.color,
width:a.outline.width}});if("polyline"===b)return new Q({color:a.color,width:a.width});if("polygon"===b)return new P({color:a.color,outline:{color:a.outline.color,width:a.outline.width}})};b.prototype._setDefaultActiveSourceIndex=function(){this.activeSourceIndex=1!==this.allSources.length&&this.searchAllEnabled?-1:0;this.notifyChange("activeSource")};b.prototype._getSourcePopupTemplate=function(a){var b=a.featureLayer;if(b)return h(a,"popupTemplate")?a.popupTemplate:b.popupTemplate};b.prototype._getSourceIndexOfResult=
function(a){var b=null;this.results.some(function(c){return c.results.some(function(d){if(d===a)return b=c.sourceIndex,!0})});return b};b.prototype._goToSearchResult=function(a,b){var c=!!b;b={target:{target:b},options:{animate:c}};"3d"===a.type&&(b.target.tilt=0);a=this.callGoTo(b);c&&(this._gotoPromise=a);return a};b.prototype._whenViewAndPortalLoaded=function(){var a=this.portal,b=this.view,b=b?b.when():g.resolve(),a=a?a.when():g.resolve();return g.eachAlways([b,a]).then(function(){})};b.prototype._loadDefaultSources=
function(){var a=this,b=this.includeDefaultSources;this._cancelLoadingDefaultSources();this._clearLoadingDefaultSources();var b=b?this._whenViewAndPortalLoaded():g.resolve(),d=!1;b.catch(function(){}).then(function(){d=!0;a._clearLoadingDefaultSources();a._updateDefaultSources()});d||(this._loadingDefaultSources=b,this.notifyChange("state"));return b};b.prototype._getDefaultSymbol=function(a){var b=this.get("view.map.basemap.id");if(a=a&&a.feature&&a.feature.geometry&&a.feature.geometry.type)if(b=
(b=N.getSchemes({theme:"default",basemap:b||"topo",geometryType:a}))&&b.primaryScheme)return b.color&&h(b,"opacity")&&(b.color.a=b.opacity),this.createDefaultSymbol(b,a);return this.defaultSymbol};b.prototype._allSourcesChanged=function(a){var b=a.target.length;a=b-a.added.length+a.removed.length;a!==b&&(1>=a&&1<b||1>=b&&1<a||this._setDefaultActiveSourceIndex())};b.ALL_INDEX=-1;d([e.property({readOnly:!0,dependsOn:["activeSourceIndex","allSources.length"],value:null})],b.prototype,"activeSource",
null);d([e.property()],b.prototype,"activeSourceIndex",void 0);d([e.property()],b.prototype,"allPlaceholder",void 0);d([e.property({dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],b.prototype,"allSources",null);d([e.property()],b.prototype,"autoNavigate",void 0);d([e.property()],b.prototype,"autoSelect",void 0);d([e.property({readOnly:!0})],b.prototype,"defaultSources",void 0);d([e.property()],b.prototype,"defaultSymbol",void 0);d([e.property()],b.prototype,
"includeDefaultSources",void 0);d([e.property()],b.prototype,"locationEnabled",null);d([e.property()],b.prototype,"locationToAddressDistance",void 0);d([e.property()],b.prototype,"maxInputLength",void 0);d([e.property()],b.prototype,"maxResults",void 0);d([e.property()],b.prototype,"maxSuggestions",void 0);d([e.property()],b.prototype,"minSuggestCharacters",void 0);d([e.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],b.prototype,"placeholder",
null);d([e.property({dependsOn:["view.popup"],readOnly:!0})],b.prototype,"popup",null);d([e.property()],b.prototype,"popupOpenOnSelect",void 0);d([e.property()],b.prototype,"popupTemplate",void 0);d([e.property()],b.prototype,"popupEnabled",void 0);d([e.property({type:t})],b.prototype,"portal",void 0);d([e.property()],b.prototype,"resultGraphicEnabled",void 0);d([e.property({readOnly:!0})],b.prototype,"resultGraphic",void 0);d([e.property({readOnly:!0})],b.prototype,"results",void 0);d([e.property({readOnly:!0})],
b.prototype,"selectedSuggestion",void 0);d([e.property()],b.prototype,"searchAllEnabled",void 0);d([e.property({readOnly:!0})],b.prototype,"selectedResult",void 0);d([e.property()],b.prototype,"searchTerm",null);d([e.property({type:n})],b.prototype,"sources",void 0);d([e.property({readOnly:!0,dependsOn:["allSources.length"]})],b.prototype,"state",null);d([e.property()],b.prototype,"suggestionDelay",void 0);d([e.property({readOnly:!0})],b.prototype,"suggestions",void 0);d([e.property()],b.prototype,
"suggestionsEnabled",void 0);d([e.property()],b.prototype,"view",void 0);d([e.property()],b.prototype,"clear",null);return b=d([e.subclass("esri.widgets.Search.SearchViewModel")],b)}(e.declared(G,I,V))});