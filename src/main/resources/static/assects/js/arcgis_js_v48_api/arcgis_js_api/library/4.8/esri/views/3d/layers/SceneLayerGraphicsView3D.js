// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/Handles ../../../core/Logger ../../../core/PooledArray ../../../core/promiseUtils ../../../core/sniff ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/rbush/PooledRBush ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/contains ../../../layers/graphics/dehydratedFeatures ../../../renderers/support/renderingInfoUtils ./LayerView3D ./graphics/Graphics3DFeatureLikeLayerView ./graphics/Graphics3DVerticalScale ./i3s/I3SQueryEngine ./i3s/I3SUtil ./i3s/MemCache ./support/layerViewUpdatingProperties ../lib/glMatrix ../support/EventedArray ../support/orientedBoundingBox ../support/projectionUtils".split(" "),
function(v,fa,J,f,K,L,M,N,r,O,P,g,Q,t,I,R,C,S,T,U,V,W,w,X,Y,Z,aa,ba,D){var E=M.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D");v=function(v){function b(a){a=v.call(this)||this;a._nodesAddedToStage={};a._handles=new L;a._controllerCreated=!1;a.overlayUpdating=!1;a.supportsDraping=!0;a._queryEngine=null;a._memCache=new X(50);a._usedMemory=0;a.loadedGraphics=new aa;a.supportsHeightUnitConversion=!0;a._coordinatesOutsideExtentErrors=0;a._maxCoordinatesOutsideExtentErrors=20;a._definitionExpressionErrors=
0;a._maxDefinitionExpressionErrors=20;return a}J(b,v);b.prototype.initialize=function(){var a=this;w.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);this._handles.add([P.init(this.layer,"rangeInfos",function(c){return a._rangeInfosChanged(c)}),this.layer.watch("renderer",function(c,e){return a._rendererChange(c,e)}),this.layer.watch("objectIdFilter",function(){return a._objectIdFilterChange()}),this.watch("_controller.parsedDefinitionExpression",function(){return a._definitionExpressionChange()})]);
this.graphics3d=new U({owner:this,layer:this.layer,asyncGraphicsUpdates:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(c){return a._updateClippingExtent(c)},queryGraphicUIDsInExtent:function(c,e,d){return a._queryGraphicUIDsInExtent(c,e,d)}});this.supportsHeightUnitConversion&&(this._verticalScale=new V({sourceSpatialReference:this.layer.spatialReference,
destSpatialReference:this.view.spatialReference}));this.addResolvingPromise(this.graphics3d.setup());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this._createController();this.when(function(){a._handles.add(a.graphics3d.graphicsCore.watch("maxNumberOfFeatures",function(c){a._controller.featureTarget=c}))})};b.prototype.destroy=function(){this.graphics3d&&(this.graphics3d.destroy(),this.graphics3d=null);this._controller&&(this._controller.destroy(),this._controller=null);this._nodesAddedToStage=
this._elevationUpdateNodes=null;this._usedMemory=0;this._handles&&(this._handles.destroy(),this._handles=null)};Object.defineProperty(b.prototype,"displayLimitExceeded",{get:function(){return this.suspended?!1:!!this._controller&&!this._controller.leafsReached},enumerable:!0,configurable:!0});b.prototype.whenGraphicAttributes=function(a,c){var e=this;return w.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),c,function(){var c=e._findGraphicNodeAndIndex(a);return{node:c.node,indices:[c.index]}},
{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};b.prototype.getGraphicFromGraphicUid=function(a){if(!this.loadedGraphics)return r.reject();var c=C.hydrateGraphic(this.loadedGraphics.find(function(c){return c.uid===a}),this.layer),e=this._getObjectIdField();if(!c||!c.attributes||!c.attributes[e])return r.reject();c.layer=this.layer;c.sourceLayer=this.layer;return r.resolve(c)};b.prototype.whenGraphicBounds=function(a,c){return this.graphics3d.graphicsCore.whenGraphicBounds(a,
c)};b.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.isUpdating=function(){return this.overlayUpdating||!this._controllerCreated||this._controller&&this._controller.updating||!this.graphics3d.destroyed&&this.graphics3d.updating};b.prototype.getRenderingInfo=function(a){if((a=S.getRenderingInfo(a,{renderer:this.layer.renderer}))&&a.color){var c=a.color;c[0]/=255;c[1]/=255;c[2]/=255}return a};Object.defineProperty(b.prototype,
"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0});b.prototype._findGraphicNodeAndIndex=function(a){a=a.attributes[this.layer.objectIdField];for(var c=0,e=Object.keys(this._nodesAddedToStage);c<e.length;c++){var d=e[c],b=this._findGraphicIndex(this._nodesAddedToStage[d].bundle,a);if(0<=b)return{node:this._controller.nodeIndex[d],index:b}}return null};b.prototype._forAllFeatures=function(a,c){for(var e=0,d=Object.keys(this._nodesAddedToStage);e<
d.length;e++){for(var b=d[e],k=this._nodesAddedToStage[b].bundle,h=0;h<k.length;h++)for(var p=k[h].graphics,m=0;m<p.length;m++){var l=p[m],n=k[h].featureIds[m];l.visible&&a(n,h,l)}null!=c&&c({nodeId:b})}};b.prototype._getGraphicIndices=function(a,c){a=this._nodesAddedToStage[a];for(var e=this._getObjectIdField(),d=[],b=0;b<c.length;b++){var k=this._findGraphicIndex(a.bundle,c[b].attributes[e]);0<=k&&d.push(k)}return d};b.prototype._findGraphicIndex=function(a,c){for(var b=0;b<a.length;b++)for(var d=
0,u=a[b].featureIds;d<u.length;d++)if(u[d]===c)return b;return-1};b.prototype._queryGraphicUIDsInExtent=function(a,c,b){if(this._controller){var d=this._controller.crsIndex;D.boundingRectToBoundingRect(a,c,z,d);var e=ca;t.fromRect(e,z);e[2]=-Infinity;e[5]=Infinity;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new N({initialSize:10}));var k=this._elevationUpdateNodes;k.clear();this._controller.updateElevationChanged(e,d,k);for(d=0;d<k.length;d++){var h=this._nodesAddedToStage[k.data[d].id];
if(null!=h){if(!h.spatialIndex&&h.bundle.length>=da){for(var p=new Q.PooledRBush(9,O("csp-restrictions")?function(a){return{minX:a.extent[0],minY:a.extent[1],maxX:a.extent[2],maxY:a.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),m=H.length=0,l=h.bundle;m<l.length;m++){for(var n=l[m],g=I.empty(),f=0,r=n.graphics;f<r.length;f++)e=r[f],C.expandAABR(e.geometry,g);n.extent=g;H.push(n)}p.load(H);h.spatialIndex=p}if(h.spatialIndex)e=z,D.boundingRectToBoundingRect(a,c,z,this.view.spatialReference),
x.minX=e[0],x.minY=e[1],x.maxX=e[2],x.maxY=e[3],h.spatialIndex.search(x,function(a){var c=0;for(a=a.graphics;c<a.length;c++)b(a[c].uid)});else for(p=0,h=h.bundle;p<h.length;p++)for(n=h[p],m=0,n=n.graphics;m<n.length;m++)e=n[m],b(e.uid)}}}};b.prototype.highlight=function(a,c){return this.graphics3d.highlight(a,c,this.layer.objectIdField)};b.prototype._createController=function(){var a=this;this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:{addNodeData:function(c,b){return a._addNodeData(c,
b)},isNodeLoaded:function(c){return a._isNodeLoaded(c)},removeNodeData:function(c){return a._removeNodeData(c)},getLoadedNodeIDs:function(){return a._getLoadedNodeIDs()},getLoadedAttributes:function(c){return a._getLoadedAttributes(c)},getAttributeData:function(c){return a._getAttributeData(c)},setAttributeData:function(c,b,d){return a._setAttributeData(c.id,b,d)},getMemoryUsage:function(){return a.view.resourceController.usedMemory}},layerViewOptionalFunctions:{loadCachedNodeData:function(c,b){return a._loadCachedNodeData(c,
b)},addCachedNodeData:function(c,b,d){return a._addCachedNodeData(c,b,d)}}}).then(function(c){a._controller=c;c.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})};b.prototype._addNodeData=function(a,c){var b=c.allGeometryData,d=c.attributeDataInfo,u=this._controller.crsIndex;c=this.view.spatialReference;var k=[0,0,0],h=this._getObjectIdField();a.memory=4096;null==this._nodesAddedToStage[a.id]&&(this._nodesAddedToStage[a.id]=
{bundle:[],attributeData:d?d.attributeData:null,loadedAttributes:d?d.loadedAttributes:null});var p=[];this._nodesAddedToStage[a.id].bundle=p;if(d=this.layer.fullExtent)d=this.layer.fullExtent.clone(),d.xmin-=.5,d.ymin-=.5,d.xmax+=.5,d.ymax+=.5,d.hasZ&&(d.zmin-=.5,d.zmax+=.5),d.hasM&&(d.mmin-=.5,d.mmax+=.5);for(var m=d,d=[],l=[],f=0;f<b.length;f++){var g=b[f],v=g.featureDataPosition,t=v.length,x=g.geometries||[ea[t]],y=g.featureIds;m&&!R.extentContainsCoords3D(m,v)&&(this._coordinatesOutsideExtentErrors<
this._maxCoordinatesOutsideExtentErrors&&E.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&E.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var F=0;F<x.length;F++){var A=x[F];if("points"===A.params.type){var w=[],B=y[F<y.length?F:0],z={};null!=B&&(z[h]=B);B=void 0;"Embedded"===A.type&&(B=A.params.vertexAttributes.position);for(A=0;A<B.length;A+=
t){for(var q=0;q<t;q++)k[q]=v[q]+B[A+q];D.bufferToBuffer(k,u,0,G,c,0,1);q=C.makeDehydratedPoint(G[0],G[1],G[2],c);3>t&&(q.z=void 0);w.push({uid:K.generateUID(),geometry:q,attributes:z,visible:!0});a.obb||l.push(q.x,q.y,q.z?q.z:0)}a.memory+=16*B.length;d.push.apply(d,w);p.push({featureIds:g.featureIds,graphics:w})}}}a.numFeatures=d.length;a.memory/=1048576;b=this._nodesAddedToStage[a.id];this._setBundleAttributes(b.bundle,b.loadedAttributes,b.attributeData);0<l.length&&(u=this.view.renderSpatialReference,
k=this._controller.crsVertex,D.bufferToBuffer(l,c,0,l,u,0,l.length/3),a.obb=ba.compute({data:l,size:3,offsetIdx:0,strideIdx:3}),D.vectorToVector(a.obb.center,u,a.obb.center,k),this._controller.updateVisibility(a.id));if(!this._controller.isGeometryVisible(a))return this._memCache.put(a.id,this._nodesAddedToStage[a.id],a.memory),delete this._nodesAddedToStage[a.id],r.resolve();this._verticalScale&&this._verticalScale.adjust(d);this._usedMemory+=a.memory;this.loadedGraphics.addMany(d);this._filterNode(b);
return r.resolve()};b.prototype._isNodeLoaded=function(a){return null!=this._nodesAddedToStage[a.id]};b.prototype._removeAllNodeData=function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(c){var b=a._nodesAddedToStage[c];b&&a._memCache.put(c,b,a._controller.nodeIndex[c].memory)});this._nodesAddedToStage={};this._usedMemory=0;this.loadedGraphics.clear()};b.prototype._removeNodeData=function(a){var c=this,b=[];a.forEach(function(a){var d=c._removeNodeStageData(a,b);d&&c._memCache.put(a.id,
d,a.memory)});this.loadedGraphics.removeUnorderedMany(b)};b.prototype._removeNodeStageData=function(a,c){var b=this._nodesAddedToStage[a.id];if(!b)return null;for(var d=0,u=b.bundle;d<u.length;d++)c.push.apply(c,u[d].graphics);delete this._nodesAddedToStage[a.id];this._usedMemory-=a.memory;9.5367431640625E-7>this._usedMemory&&(this._usedMemory=0);return b};b.prototype._loadCachedNodeData=function(a,c){return r.resolve(this._memCache.get(a.id))};b.prototype._addCachedNodeData=function(a,c,b){for(var d=
[],e=0,k=c.bundle;e<k.length;e++)d.push.apply(d,k[e].graphics);this._nodesAddedToStage[a.id]=c;this._setAttributeData(a.id,b.loadedAttributes,b.attributeData);this._usedMemory+=a.memory;this.loadedGraphics.addMany(d);this._filterNode(c);return r.resolve()};b.prototype._getLoadedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)};b.prototype._getLoadedAttributes=function(a){if(a=this._nodesAddedToStage[a.id])return a.loadedAttributes};b.prototype._getAttributeData=function(a){if(a=this._nodesAddedToStage[a.id])return a.attributeData};
b.prototype._setAttributeData=function(a,c,b){if(a=this._nodesAddedToStage[a])a.loadedAttributes=c,a.attributeData=b,this._setBundleAttributes(a.bundle,c,b),this._filterNode(a),this.graphics3d.graphicsCore.labelsEnabled&&(c=a.bundle.map(function(a){return a.graphics.length&&a.graphics[0].uid}),this.graphics3d.graphicsCore.updateLabelingInfo(c))};b.prototype._setBundleAttributes=function(a,c,b){for(var d=0;d<a.length;d++)for(var e=0,k=a[d].graphics;e<k.length;e++){var h=k[e];h.attributes||(h.attributes=
{});if(c)for(var g=0,f=c;g<f.length;g++){var l=f[g].name;b[l]&&(h.attributes[l]=w.getCachedAttributeValue(b[l],d))}}};b.prototype._updateClippingExtent=function(a){this._controller&&this._controller.updateClippingArea(a);return!1};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._rendererChange=function(a,b){var c=a?a.requiredFields:[],d=b?b.requiredFields:[];c.length===d.length&&c.every(function(a,b){return c[b]===d[b]})||this._reloadAllNodes()};b.prototype._rangeInfosChanged=
function(a){null!=a&&0<a.length&&E.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};b.prototype._objectIdFilterChange=function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){return a._filterNode(a._nodesAddedToStage[b])})};b.prototype._reloadAllNodes=function(){this._removeAllNodeData();this._controller&&this._controller.restartNodeLoading()};b.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=
0};b.prototype._evaluateClause=function(a,b){try{return!!a.calculateValue(b)}catch(e){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&E.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&E.error("Further errors are ignored"),!1}};b.prototype._filterNode=function(a){var b=this._getObjectIdField(),e=null;if(this.layer.objectIdFilter)var d=this.layer.objectIdFilter.ids,
g="include"===this.layer.objectIdFilter.method,e=function(a){return 0<=d.indexOf(a)===g};var k=this._controller.parsedDefinitionExpression,h=0;for(a=a.bundle;h<a.length;h++)for(var f=0,m=a[h].graphics;f<m.length;f++){var l=m[f],n=l.visible;e&&!e(l.attributes[b])?l.visible=!1:l.visible=k?this._evaluateClause(k,l):!0;n!==l.visible&&(y.graphic=l,y.property="visible",y.oldValue=n,y.newValue=l.visible,this.layer.graphicChanged(y))}};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};
b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};b.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};b.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};b.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,graphic:null},e=this;return new W(this.layer,
{forAll:function(c,e){a._forAllFeatures(function(a,d,e){b.id=a;b.index=d;b.graphic=e;c(b)},e)},createGraphic:function(a){return C.hydrateGraphic(a.graphic,e.layer)},requestFields:function(b,c,e){return w.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),e,function(){var d=a._getGraphicIndices(b.nodeId,c);return{node:a._controller.nodeIndex[b.nodeId],indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var b=t.empty(),c=a.layer.spatialReference;return{add:function(a){return C.expandAABB(a.graphic.geometry,
b)},getExtent:function(){return t.toExtent(b,c)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};b.prototype.getUsedMemory=function(){var a=this._usedMemory;this._controller&&(a+=512*Object.keys(this._controller.nodeIndex).length/1048576);return a};b.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0};b.prototype.getCachedMemory=function(){return this._memCache.getSize()};b.prototype.removeCachedData=function(){0<this._memCache.getSize()||
this.suspended&&this._removeAllNodeData();this._memCache.clear()};b.prototype.getStats=function(){var a=this.inherited(arguments)||{};a.index=this._controller?Object.keys(this._controller.nodeIndex).length:0;a.nodes=Object.keys(this._nodesAddedToStage).length;a.features=this.loadedGraphics.length;a.cache=this._memCache.getSize().toFixed(2)+"MB, "+Math.round(100*this._memCache.getHitRate())+"% hit";this._controller&&this._controller.updateStats(a);return a};f([g.property()],b.prototype,"graphics3d",
void 0);f([g.property()],b.prototype,"drawingOrder",void 0);f([g.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],b.prototype,"hasDraped",void 0);f([g.property({type:Boolean})],b.prototype,"overlayUpdating",void 0);f([g.property({type:Boolean})],b.prototype,"supportsDraping",void 0);f([g.property()],b.prototype,"loadedGraphics",void 0);f([g.property()],b.prototype,"layer",void 0);f([g.property()],b.prototype,"_controller",void 0);f([g.property({dependsOn:["_controller.updating","graphics3d.updating",
"overlayUpdating"]})],b.prototype,"updating",void 0);f([g.property(Y.updatingPercentage)],b.prototype,"updatingPercentage",void 0);f([g.property({aliasOf:"_controller.updatingPercentage"})],b.prototype,"updatingPercentageValue",void 0);f([g.property({dependsOn:["suspended","_controller.leafsReached"]})],b.prototype,"displayLimitExceeded",null);return b=f([g.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],b)}(g.declared(T));var ea={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,
0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},da=100,z=I.create(),ca=t.create(t.POSITIVE_INFINITY),x={minX:0,minY:0,maxX:0,maxY:0},G=Z.vec3d.create(),H=[],y={graphic:null,property:null,oldValue:null,newValue:null};return v});