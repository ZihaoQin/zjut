// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Graphic ../../../core/Collection ../../../core/Error ../../../core/Evented ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/graphics/controllers/support/controllerUtils ../../../layers/graphics/sources/MemorySource ./FeatureLikeLayerView3D ../../layers/RefreshableLayerView".split(" "),
function(n,p,q,f,D,h,k,r,t,u,v,l,m,d,w,x,y,z){p=function(g){function a(b){return g.call(this)||this}q(a,g);e=a;Object.defineProperty(a.prototype,"controllerTypeForSource",{get:function(){return this.layer.source&&this.layer.source.isInstanceOf&&this.layer.source.isInstanceOf(x)?"memory":"point"===this.layer.geometryType?"feature-tile-3d":"snapshot"},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"asyncGraphicsUpdates",{get:function(){if(this.controller&&"feature-tile-3d"===this.controller.type)switch(this.controller.mode){case "snapshot":return!1;
case "tiles":return!0}switch(this.controller?this.controller.type:this.controllerTypeForSource){case "feature-tile-3d":return!0;case "memory":case "snapshot":return!1}},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"suspendResumeExtentMode",{get:function(){if(this.controller&&"feature-tile-3d"===this.controller.type)return this.controller.suspendResumeExtentMode;switch(this.controller?this.controller.type:this.controllerTypeForSource){case "feature-tile-3d":return"data";case "memory":case "snapshot":return"computed"}},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"displayLimitExceeded",{get:function(){return this.controller&&"feature-tile-3d"===this.controller.type?!(this.suspended||!this.controller.displayLimitExceeded):!1},enumerable:!0,configurable:!0});a.prototype.createController=function(){return k(this,void 0,void 0,function(){var b;return h(this,function(c){switch(c.label){case 0:b=this.controllerTypeForSource;switch(b){case "memory":return[3,1];case "snapshot":return[3,3];case "feature-tile-3d":return[3,
5]}return[3,7];case 1:return[4,this.createMemoryController()];case 2:return[2,c.sent()];case 3:return[4,this.createSnapshotController()];case 4:return[2,c.sent()];case 5:return[4,this.createFeatureTileController()];case 6:return[2,c.sent()];case 7:return[3,8];case 8:return[2]}})})};a.prototype.createMemoryController=function(){return k(this,void 0,void 0,function(){var b;return h(this,function(c){switch(c.label){case 0:return[4,l.create(function(b){n(["../../../layers/graphics/controllers/MemoryController"],
b)})];case 1:return b=c.sent(),[2,new b({layerView:this,layer:this.layer,graphics:this.layer.source})]}})})};a.prototype.createFeatureTileController=function(){return k(this,void 0,void 0,function(){var b,c,a=this;return h(this,function(d){switch(d.label){case 0:return[4,l.create(function(b){n(["../../../layers/graphics/controllers/FeatureTileController3D"],b)})];case 1:return b=d.sent(),c=new b({layerView:this,graphics:new A,extent:this.clippingExtent}),this.handles.add([c.watch("suspendResumeExtentMode",
function(){return a.notifyChange("suspendResumeExtentMode")},!0),c.watch("displayLimitExceeded",function(){return a.notifyChange("displayLimitExceeded")},!0),c.watch("mode",function(){return a.notifyChange("asyncGraphicsUpdates")},!0)]),this.handles.add(m.init(c,"serviceDataExtent",function(b){return a.graphics3d.dataExtent=b})),this.handles.add(m.init(this,"suspended",function(b){b?c.suspend():c.resume()},!0)),this.handles.add(m.init(this.graphics3d.graphicsCore,"maxNumberOfFeatures",function(b){c.displayFeatureLimit=
{min:Math.ceil(B*b),max:b,perTile:Math.ceil(C*b)}})),[2,c]}})})};a.prototype.createSnapshotController=function(){return k(this,void 0,void 0,function(){var b,a,d;return h(this,function(c){switch(c.label){case 0:return this.addResolvingPromise(this.validateMaximumFeatureCount()),[4,l.create(function(b){n(["../../../layers/graphics/controllers/SnapshotController"],b)})];case 1:return b=c.sent(),a=t.ofType(r),d=new b({layerView:this,layer:this.layer,graphics:new a,maxPageSize:300,defaultReturnZ:!0,extent:this.clippingExtent}),
[4,d.when()];case 2:return c.sent(),this.handles.add(m.whenFalseOnce(this,"suspended",function(){d.startup()})),[2,d]}})})};a.prototype.validateMaximumFeatureCount=function(){return 0>e.maximumFeatureCount||!this.layer.url?l.resolve():this.layer.queryFeatureCount().then(function(b){if(b>e.maximumFeatureCount)throw new u("featurelayerview3d:maximum-feature-count-exceeded","The maximum number of allowed features (${maximumFeatureCount}) has been exceeded (layer has ${numberOfFeatures} features)",{maximumFeatureCount:e.maximumFeatureCount,
numberOfFeatures:b});})};a.prototype.doRefresh=function(){!this.suspended&&w.isRefreshable(this.controller)&&this.controller.refresh()};var e;a.maximumFeatureCount=-1;f([d.property()],a.prototype,"layer",void 0);f([d.property()],a.prototype,"controller",void 0);f([d.property({readOnly:!0,dependsOn:["layer"]})],a.prototype,"controllerTypeForSource",null);f([d.property({readOnly:!0,dependsOn:["controllerTypeForSource","controller"]})],a.prototype,"asyncGraphicsUpdates",null);f([d.property({readOnly:!0,
dependsOn:["controllerTypeForSource","controller"]})],a.prototype,"suspendResumeExtentMode",null);f([d.property({dependsOn:["suspended","controller"]})],a.prototype,"displayLimitExceeded",null);return a=e=f([d.subclass("esri.views.3d.layers.FeatureLayerView3D")],a)}(d.declared(y,z));var A=function(g){function a(){var b=null!==g&&g.apply(this,arguments)||this;b.items=new Set;return b}q(a,g);e=a;Object.defineProperty(a.prototype,"length",{get:function(){return this.items.size},enumerable:!0,configurable:!0});
a.prototype.addMany=function(b){for(var a=0;a<b.length;a++)this.items.add(b[a]);this.emit("change",{added:b,removed:[],moved:[]})};a.prototype.removeMany=function(b){for(var a=0;a<b.length;a++)this.items.delete(b[a]);this.emit("change",{added:[],removed:b,moved:[]});return b};a.prototype.removeAll=function(){var b=this.toArray();this.emit("change",{added:[],removed:b,moved:[]})};a.prototype.toArray=function(){var b=[];this.items.forEach(function(a){return b.push(a)});return b};a.prototype.forEach=
function(b){this.items.forEach(b)};a.prototype.some=function(b){return this.toArray().some(b)};a.prototype.find=function(b){var a=null;this.forEach(function(c){!a&&b(c)&&(a=c)});return a};a.prototype.filter=function(a){var b=new e;this.forEach(function(c){a(c)&&b.items.add(c)});return b};var e;return a=e=f([d.subclass("esri.views.3d.layers.FeatureLayerView3D.SetCollection")],a)}(d.declared(v)),B=.1,C=.25;return p});