// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../Graphic ../../../../core/Error ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/fieldUtils ../../statistics/support/utils ./FeatureLayerAdapter ./LayerAdapter ./support/utils ../../../../tasks/support/FeatureSet".split(" "),function(D,E,t,y,r,v,g,z,e,n,p,A,B,
C,k,w){return function(x){function c(a){a=x.call(this,a)||this;a._handles=new z;return a}y(c,x);c.prototype._hasCachedStatistics=function(a){return this.layer.hasCachedStatistics(a)};c.prototype._fetchFeaturesFromMemory=function(a){var d=this;return a?a.whenLayerView(this.layer).then(function(a){var b=e.create(function(b,f){var l=a.watch("updating",function(){d._handles.remove("layerViewUpdate");a.queryFeatures().then(function(a){"esri.tasks.support.FeatureSet"===a.declaredClass?b(a.features):b(a)}).catch(function(a){f(a)})});
d._handles.add(l,"layerViewUpdate")});e.timeout(b,1E4,null);return b}):e.reject(new g("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};c.prototype._generateFeatureSetForCachedHistogram=function(a,d,b,f){void 0===d&&(d=a.minimum);void 0===b&&(b=a.maximum);for(var l=[],c=0;c<f;c++)l[c]=0;for(var m=a.counts.length,e=a.minimum,g=a.maximum,c=0;c<m;c++){var h=(c+.5)/m,h=((1-h)*e+h*g-d)/(b-d)*f;0<=h&&h<=f&&(l[h===f?f-1:Math.floor(h)]+=a.counts[c])}var k=
[];l.forEach(function(a,b){var d=new v({attributes:{}});d.attributes.EXPR_1=b+1;d.attributes.countOFExpr=a;k.push(d)});a=new w;a.features=k;return a};c.prototype._getCachedStatistics=function(a,d){var b=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.minValue||a.maxValue?e.reject(new g("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):b.queryCachedStatistics(d&&
d.name).then(function(a){var b=a.stats;a=b.min;var d=b.max,f=b.avg,c=b.stddev,e=b.sum,h=b.variance,b=b.count;if(0!==a||0!==d)f=0===f?null:f,e=0===e?null:e,c=0===c?null:c,h=0===h?null:h,b=0===b?null:b;null==b&&null!=e&&null!=f&&(b=Math.round(e/f));return{avg:f,count:b,max:d,min:a,stddev:c,sum:e,variance:h}})};c.prototype._getSummaryStatisticsFromMemory=function(a,d){return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(b){if(!b||!b.length)return e.reject(new g("scene-layer-adapter:insufficient-data",
"No features are available to calculate statistics"));var f=p.isDateField(d),c=t({},a);if("percent-of-total"===c.normalizationType){var q=k.calculateStatsFromMemory({field:c.field},b).sum;if(null==q)return e.reject(new g("scene-layer-adapter:invalid","invalid normalizationTotal"));c.normalizationTotal=q}b=k.calculateStatsFromMemory(c,b,f);return k.processSummaryStatisticsResult(b)})};c.prototype._getCachedStatisticsForUniqueValues=function(a,d){var b=this,c=this.layer,l=d&&d.name,q=d&&this.getFieldDomain(a.field);
return a.valueExpression||a.sqlExpression||a.sqlWhere?e.reject(new g("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):c.queryCachedStatistics(l).then(function(f){var e=f.stats;f=f.labels&&f.labels.labels;var g={},h=[];if(e.mostFrequentValues){var m="countOF"+l;e.mostFrequentValues.forEach(function(a){var b=new v({attributes:{}});b.attributes[l]=p.isNumericField(d,c)||p.isDateField(d)?Number(a.value):
a.value;b.attributes[m]=a.count;h.push(b)});f&&f.forEach(function(a){g[a.value]=a.label})}e=new w;e.features=h;return k.getUniqueValuesFromFeatureSet(e,b,a.field,g)}).then(function(b){return k.createUVResult(b,"service-cached-query",q,a.returnAllCodedValues)})};c.prototype._getUniqueValuesFromMemory=function(a,d){var b=d&&this.getFieldDomain(a.field);return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(d){return k.calculateUniqueValuesFromMemory(a,d,b)})};c.prototype._getCachedStatisticsForHistogram=
function(a,d){var b=this,c=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.normalizationType?e.reject(new g("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):c.queryCachedStatistics(d&&d.name).then(function(d){d=d.stats;var c=a.minValue,f=a.maxValue,c=null!=c?c:d.min,f=null!=f?f:d.max,e=a.numBins||10;d=b._generateFeatureSetForCachedHistogram(d.histogram,
c,f,e);return k.getHistogramFromFeatureSet(d,c,f,e)})};c.prototype._getClassBreaksFromMemory=function(a){return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(d){if(!d||!d.length)return e.reject(new g("scene-layer-adapter:insufficient-data","No features are available to calculate statistics"));var b=t({},a);if("percent-of-total"===b.normalizationType){var c=k.calculateStatsFromMemory({field:b.field},d).sum;if(null==c)return e.reject(new g("scene-layer-adapter:invalid",
"invalid normalizationTotal"));b.normalizationTotal=c}return k.calculateClassBreaksFromMemory(b,d)})};c.prototype._getHistogramFromMemory=function(a){var d=this;return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(b){if(!b||!b.length)return e.reject(new g("scene-layer-adapter:insufficient-data","No features are available to calculate histogram"));var c=a.field,l=a.normalizationType,q=a.valueExpression,m=a.classificationMethod,n=a.minValue,p=a.maxValue,h=a.view,
r=null!=n&&null!=p,u=null;m&&"equal-interval"!==m||l?(c=t({},a),c.features=b,u=d._getBinParamsFromMemory(c)):u=r?e.resolve({min:n,max:p}):d.summaryStatistics({field:c,valueExpression:q,features:b,view:h}).then(function(a){return a.count?{min:a.min,max:a.max}:e.reject(new g("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return u.then(function(d){return k.calculateHistogramFromMemory(a,d,b)})})};c.prototype._getBinParamsFromMemory=function(a){var d=
a.field,b=a.normalizationType,c=a.normalizationField;return this._getClassBreaksFromMemory({field:d,valueExpression:a.valueExpression,normalizationType:b,normalizationField:c,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,minValue:a.minValue,maxValue:a.maxValue,numClasses:a.numBins,features:a.features,view:a.view}).then(function(a){var e=a.normalizationTotal;a=a.classBreakInfos;var f=A.getSQLFilterForNormalization({field:d,normalizationType:b,normalizationField:c});
return k.generateBinParams({field:d,normalizationType:b,normalizationField:c,normalizationTotal:e,classBreaks:a,where:f})})};c.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};c.prototype.getFieldUsageInfo=function(a){a=this.getField(a);if(!a)return null;a=this.layer.getFieldUsageInfo(a.name);return{supportsLabelingInfo:a.supportsLabelingInfo,supportsPopupTemplate:a.supportsPopupTemplate,supportsRenderer:a.supportsRenderer,supportsLayerQuery:a.supportsLayerQuery,supportsStatistics:!0}};
c.prototype.getFieldDomain=function(a,d){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(a,d):null};c.prototype.summaryStatistics=function(a){var d=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatistics(a,b).catch(function(c){return d._getSummaryStatisticsFromMemory(a,b)}):this._getSummaryStatisticsFromMemory(a,b)};c.prototype.uniqueValues=function(a){var d=
this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForUniqueValues(a,b).catch(function(c){return d._getUniqueValuesFromMemory(a,b)}):this._getUniqueValuesFromMemory(a,b)};c.prototype.histogram=function(a){var c=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForHistogram(a,
b).catch(function(b){return c._getHistogramFromMemory(a)}):this._getHistogramFromMemory(a)};c.prototype.classBreaks=function(a){var c=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(a):this._hasCachedStatistics(c&&c.name)?e.reject(new g("scene-layer-adapter:not-supported","Cached stats not supported")):this._getClassBreaksFromMemory(a)};c.prototype.queryFeatureCount=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(a):
e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))};c.prototype.generateRenderer=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(a):e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))};c.prototype.heatmapStatistics=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.heatmapStatistics(a):
e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))};c.prototype.load=function(){var a=this,c=this.layer,b=c.load().then(function(){var b=c.associatedLayer;a.geometryType=c.geometryType;if(b)return a._featureLayerAdapter=new B({layer:b}),a._featureLayerAdapter.load().then(function(){a.objectIdField=a._featureLayerAdapter.objectIdField;a.supportsSQLExpression=a._featureLayerAdapter.supportsSQLExpression});a.objectIdField=
c.objectIdField;a.supportsSQLExpression=!1});this.addResolvingPromise(b);return this.when()};r([n.property({constructOnly:!0})],c.prototype,"layer",void 0);return c=r([n.subclass()],c)}(n.declared(C))});