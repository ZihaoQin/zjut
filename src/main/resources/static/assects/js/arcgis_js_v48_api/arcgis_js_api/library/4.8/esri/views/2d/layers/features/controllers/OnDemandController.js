// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper @dojo/shim/Set dojo/has ../../../../../geometry ../../../../../core/Error ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/optimizedFeatures ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/support/FeatureProcessing ../../../../../tasks/operations/query ../../../../../tasks/support/QuantizationParameters ../../../../../tasks/support/Query ./BaseController ../support/DataTileFeaturesIndex ../support/Tile ../support/TileUpdateQueue ../../../tiling/TileInfoView ../../../tiling/TileQueue".split(" "),
function(d,x,E,n,S,y,p,F,G,H,t,m,z,I,J,A,K,q,u,L,M,N,B,O){Object.defineProperty(x,"__esModule",{value:!0});var C=H.getLogger("esri.views.2d.layers.features.controllers.OnDemandController");d=p("esri-featurelayer-webgl");p=p("esri-mobile");var P=d&&"object"===typeof d&&null!=d.maxDrillLevel?d.maxDrillLevel:p?1:4,Q=d&&"object"===typeof d&&null!=d.maxRecordCountFactor?d.maxRecordCountFactor:p?1:3,R=d&&"object"===typeof d&&null!=d.enablePBFQuery?d.enablePBFQuery:!0,v=new y.default,r=[],D=function(){function d(){this.done=
!1;this.queryInfoHash=this.tile=this.displayTile=null;this.returnExceeded=!1;this.objectIds=new y.default}Object.defineProperty(d.prototype,"key",{get:function(){return this.tile.key},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"id",{get:function(){return this.tile.id},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"bounds",{get:function(){return this.tile.bounds},enumerable:!0,configurable:!0});return d}();u=function(d){function c(){var a=null!==d&&d.apply(this,
arguments)||this;a.type="on-demand";a._queryInfoHash=null;a._processingInMainThread=!1;a._dataTileIndex=new L.default;return a}E(c,d);c.prototype.initialize=function(){var a=this;this._fetchQueue=new O({concurrency:10,strategy:"center-first",tileInfoView:new B(this.tileStore.tileInfo),process:function(e){return a._fetchTile(e)}});this._updateQueue=new N.default({tileInfoView:new B(this.tileStore.tileInfo),process:function(e){return a._updateTile(e)}});this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))};
c.prototype.destroy=function(){this._fetchQueue.clear();this._updateQueue.clear();this.store&&(this.store.destroy(),this._set("store",null))};Object.defineProperty(c.prototype,"processing",{get:function(){return J.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return 0<this._fetchQueue.length+this._fetchQueue.onGoingCount||this._updateQueue.updating},enumerable:!0,configurable:!0});c.prototype.refresh=function(){};
c.prototype.setViewState=function(a){this._fetchQueue.state=a;this._updateQueue.state=a};c.prototype.queryFeatures=function(a){return this.store.executeQuery(q.fromJSON(a))};c.prototype.queryFeatureCount=function(a){return this.store.executeQueryForCount(q.fromJSON(a))};c.prototype.queryObjectIds=function(a){return this.store.executeQueryForIds(q.fromJSON(a))};c.prototype.queryExtent=function(a){return this.store.executeQueryForExtent(q.fromJSON(a))};c.prototype.redraw=function(){this._updateQueue.pause();
this._manageTiles(this.tileStore.tiles);this._updateQueue.resume()};c.prototype.onTileUpdate=function(a){this.store&&this._manageTiles(a.added,a.removed)};c.prototype._manageTiles=function(a,e){void 0===e&&(e=null);for(var b=this._dataTileIndex,c=this._fetchQueue,g=this._updateQueue,f="esriGeometryPoint"===this.service.geometryType,d=function(a){var e=b.get(a.id);e?(e.displayTile=a,f?b.forEach(function(b){M.isChildOf(b,e)&&(b.displayTile=a)}):e.done=!1):(e=new D,e.tile=a.clone(),e.displayTile=a,b.add(e));
h._processDataTile(e)},h=this,k=0;k<a.length;k++){var l=a[k];d(l)}if(e)for(a=0;a<e.length;a++)l=e[a],v.add(l),g.cancel(l.id);b.forEach(function(a){v.has(a.displayTile)&&r.push(a)});for(g=0;g<r.length;g++)l=r[g],c.has(l.id)&&c.get(l.id).cancel(),b.delete(l);r.length=0;v.clear()};c.prototype._processDataTile=function(a){var e=this,b=a.key,c=this._dataTileIndex,g=this._fetchQueue,f=b.id,d=this._queryInfoHash,b=b.level-a.displayTile.key.level>=P;c.add(a);if(a.done||g.has(f)){if(a.queryInfoHash!==d||a.returnExceeded!==
b)if(a.done)a.done=!1;else if(g.isOngoing(f))g.get(f).cancel();else{a.queryInfoHash=d;a.returnExceeded=b;return}}else a.queryInfoHash=d,a.returnExceeded=b;a.done?this._invalidateTile(a.displayTile):g.has(f)||(g.push(a).then(function(b){a.done=!0;z.hydrateOptimizedFeatureSet(b);if(b.exceededTransferLimit)if(a.returnExceeded)c.load(a,b.features);else{b=0;for(var d=a.tile.createChildTiles();b<d.length;b++){var f=d[b],g=new D;g.tile=f;g.displayTile=a.displayTile;e._processDataTile(g)}}else c.load(a,b.features);
e._invalidateTile(a.tile)}).catch(function(b){a.done=!0}).then(function(){e.notifyChange("updating")}),this.notifyChange("updating"))};c.prototype._fetchTile=function(a){a=this._createQuery(a.displayTile,a.tile,this.processor.queryInfo,a.returnExceeded);var e=this.service.source;return R&&this.service.capabilities.query.supportsFormatPBF?A.executeQueryPBF(e,a).then(function(a){return a.data}):A.executeQuery(e,a).then(function(a){return z.convertFromFeatureSet(a.data)})};c.prototype._invalidateTile=
function(a){var e=this._updateQueue,b=0;for(a=this.tileStore.intersections(a,this.processor.queryInfo.pixelBuffer);b<a.length;b++){var c=a[b].tile;e.has(c.id)||e.push(c.id)}this.notifyChange("updating")};c.prototype._updateTile=function(a){var e=this,b=this.tileStore.get(a);a=this.processor.queryInfo;a=this.store.executeTileQuery(b,{pixelBuffer:a.pixelBuffer,returnGeometry:a.returnGeometry,returnCentroid:a.returnCentroid});var c=a.features,d=a.objectIds;this.notifyChange("updating");var f={features:c,
fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:{originPosition:"upperLeft",scale:[b.resolution,b.resolution],translate:[b.bounds[0],b.bounds[3]]}};return this._applyProcessing(f).catch(function(a){a&&"cancel"!==a.dojoType&&C.error("updating-tile",a);return f}).then(function(a){var c=[];b.objectIds.forEach(function(a){d.has(a)||c.push(a)});return e.processor.onTileData(b,{addOrUpdate:a.features,remove:c}).catch(function(a){a&&"cancel"!==a.dojoType&&C.error("updating-tile",
a)}).then(function(){e.notifyChange("updating")})})};c.prototype._switchProcessor=function(a,e){var b=a.queryInfo;e=b.definitionExpression;var c=b.gdbVersion,b=b.historicMoment;a=this._createQueryInfoHash(a);this._queryInfoHash!==a&&(this._queryInfoHash=a,this.store&&this.store.destroy(),this._set("store",new I.default({definitionExpression:e,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference,
cacheSpatialQueries:!0,gdbVersion:c,historicMoment:null!=b&&new Date(b)})),this._dataTileIndex.store=this.store,this._dataTileIndex.forEach(function(a){a.done=!1;a.displayTile.objectIds.clear()}));this._fetchQueue.pause();this._updateQueue.pause();this._fetchQueue.reset();this._updateQueue.clear();this._manageTiles(this.tileStore.tiles);this._fetchQueue.resume();this._updateQueue.resume();this.notifyChange("updating")};c.prototype._createQuery=function(a,e,b,c){var d=this;void 0===c&&(c=!0);var f=
new q,w=b.historicMoment;a="esriGeometryPoint"===this.service.geometryType?e:a;a=K.default.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:a.resolution,extent:{xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}});var h=b.outFields,k=b.orderByFields;this.processing&&(h=h&&h.filter(function(a){return!d.processing.getField(a)}),k=k&&k.filter(function(a){return!d.processing.getField(a)}));h=.75<=h.length/this.service.fields.length?["*"]:
h;f.maxRecordCountFactor=Q;f.gdbVersion=b.gdbVersion;f.historicMoment=null!=w?new Date(w):null;f.outFields=h;f.where=b.definitionExpression||"1\x3d1";f.geometry=F.Extent.fromJSON({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference});this.service.capabilities.query.supportsQuantization?(f.quantizationParameters=a,"esriGeometryPolyline"===this.service.geometryType&&(f.maxAllowableOffset=a.tolerance)):f.maxAllowableOffset=a.tolerance;f.resultType=
"tile";f.returnExceededLimitFeatures=c;f.returnGeometry=!0;f.returnCentroid=b.returnCentroid;f.orderByFields=k;return f};c.prototype._applyProcessing=function(a){var c=this.processing;if(!c)return t.resolve(a);if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:a});try{var b=c.process(a,c.options);return b?"then"in b?b:t.resolve(b):t.reject(new G("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(w){return this._processingInMainThread=
!0,this.remoteClient.invoke("executeProcessing",{featureSet:a})}};c.prototype._createQueryInfoHash=function(a){var c=this,b=a.queryInfo,d=b.orderByFields,b=b.outFields,g=a.queryInfo;a=g.definitionExpression;var f=g.gdbVersion,g=g.historicMoment;this.processing&&(b=b&&b.filter(function(a){return!c.processing.getField(a)}),d=d&&d.filter(function(a){return!c.processing.getField(a)}));b&&b.sort();d&&d.sort();return JSON.stringify({definitionExpression:a,outFields:.75<=b.length/this.service.fields.length?
["*"]:b,orderByFields:d,gdbVersion:f,historicMoment:g})};n([m.property()],c.prototype,"configuration",void 0);n([m.property({readOnly:!0,dependsOn:["configuration"]})],c.prototype,"processing",null);n([m.property({readOnly:!0})],c.prototype,"store",void 0);n([m.property()],c.prototype,"updating",null);return c=n([m.subclass()],c)}(m.declared(u.default));x.default=u});