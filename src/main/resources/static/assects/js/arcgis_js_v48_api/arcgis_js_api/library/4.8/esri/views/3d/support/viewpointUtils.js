// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/Error ../../../core/promiseUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ../lib/glMatrix ./cameraUtils ./intersectionUtils ./mathUtils ./projectionUtils".split(" "),function(ga,v,E,w,Y,F,R,t,n,S,p,A,f,k,Z,T,x){function J(a){return 360-T.cyclicalDeg.normalize(a)}function B(a){return T.cyclicalDeg.normalize(360-
a)}function U(a,b,c){if(!b)return null;var d=a.spatialReference||w.SpatialReference.WGS84;if(b.camera){a=b.get("camera.position.spatialReference");if(!p.canProject(a,d))return null;b=b.camera.clone();a.equals(d)||(b.position=p.project(b.position,d));return b}var e=b.get("targetGeometry.spatialReference");if(e&&!p.canProject(e,d))return null;var e=k.internalToExternal(a,a.state.camera),g={noReset:!1};null!=b.rotation&&(e.heading=J(b.rotation),g.noReset=!0);null!=c&&(e.tilt=c);if("point"===b.targetGeometry.type){c=
b.targetGeometry;var z=void 0,f=b.targetGeometry.clone(),z=null!=b.scale?k.scaleToDistance(a,b.scale,c.latitude):a.state.camera.distance;b=k.eyeHeadingTiltForCenterPointAtDistance(a,e.heading,e.tilt,f,z,g);d=x.vectorToPoint(b.eye,a.renderSpatialReference,d);return new E(d,b.heading,b.tilt,e.fov)}return k.fromExtent(a,b.targetGeometry.extent,e.heading,e.tilt,g)}function K(a,b){var c=b.scale;null==c&&null!=b.zoom&&(c=k.zoomToScale(a,b.zoom));return c}function L(a,b){var c=!1;null!=b.heading?(a.heading=
b.heading,c=!0):null!=b.rotation&&(a.heading=J(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function G(a,b,c){var d=a.spatialReference||w.SpatialReference.WGS84;b=b||k.externalToInternal(a,c.camera);c.targetGeometry=x.vectorToPoint(b.center,a.renderSpatialReference,d);c.scale=k.computeScale(a,b);c.rotation=B(c.camera.heading);return c}function M(a,b,c){if(b){if(!p.canProject(b.spatialReference,a.spatialReference))throw new R("viewpointutils:incompatible-spatialreference",
"Spatial reference ("+(b.spatialReference?b.spatialReference.wkid:"unknown")+") is incompatible with the view ("+a.spatialReference.wkid+")",{geometry:b});var d=[];if(!b.hasZ&&a.basemapTerrain){var e=void 0;switch(b.type){case "point":e=b;break;case "multipoint":case "polyline":case "mesh":e=b.extent.center;break;case "extent":e=b.center;break;case "polygon":e=b.centroid}e&&p.canProject(e,a.basemapTerrain.spatialReference)?h[2]=a.basemapTerrain.getElevation(e)||0:h[2]=0}(0,aa[b.type])(b,function(a){d.push(a[0],
a[1],a[2])},h);var g=d.length/3;if(0!==g&&(e=Array(d.length),x.bufferToBuffer(d,b.spatialReference,0,e,a.spatialReference,0,g)))for(b.hasZ&&(c.hasZ=!0),a=0;a<e.length;a+=3)b.hasZ?(h[0]=e[a+0],h[1]=e[a+1],h[2]=e[a+2]):(h[0]=e[a+0],h[1]=e[a+1]),n.expand(c.boundingBox,h)}}function ba(a,b,c,d){return a.whenViewForGraphic(b).then(function(a){if(a&&a.whenGraphicBounds)return a.whenGraphicBounds(b,{minDemResolution:c})}).then(function(a){var b=a.boundingBox;n.expand(d.boundingBox,b);a.screenSpaceObjects&&
a.screenSpaceObjects.forEach(function(a){d.screenSpaceObjects.push(a)});isFinite(b[2])&&(d.hasZ=!0)}).catch(function(){M(a,b.geometry,d)})}function V(a,b,c,d){if(Array.isArray(b)&&2===b.length){var e=b[0],g=b[1];if("number"===typeof e&&"number"===typeof g)return l.x=e,l.y=g,l.z=void 0,l.spatialReference=w.SpatialReference.WGS84,M(a,l,d),t.resolve()}if(b&&"function"===typeof b.map)return t.eachAlways(b.map(function(b){return V(a,b,c,d)}));if(b instanceof w.BaseGeometry)try{M(a,b,d)}catch(z){return t.reject(z)}else if(b instanceof
Y)return ba(a,b,c,d);return t.resolve()}function ca(a,b,c,d){if(b.camera)return W(a,c,b.camera,d);d.scale=b.scale;d.rotation=b.rotation;d.targetGeometry=b.targetGeometry?b.targetGeometry.clone():null;d.camera=null;null!=c.heading?d.rotation=B(c.heading):null!=c.rotation&&(d.rotation=c.rotation);b=K(a,c);null!=b&&(d.scale=b);d.camera=U(a,d,c.tilt);return d}function W(a,b,c,d){d.camera=c.clone();d.camera.fov=a.camera.fov;b=a.spatialReference;c=d.camera.position.spatialReference;if(!p.canProject(c,b))return null;
c.equals(b)||(d.camera.position=p.project(d.camera.position,b));return G(a,null,d)}function N(a,b,c,d){if(!c)return null;d.targetGeometry=c.clone();var e=A.cameraOnContentAlongViewDirection(a);if(b.position){c=d.targetGeometry;var g=a.renderSpatialReference;x.pointToVector(b.position,H,g);x.pointToVector(c,O,g);d.targetGeometry=new w.Point(c);d.camera.position=new w.Point(b.position);f.vec3d.subtract(O,H,I);k.directionToHeadingTilt(a,H,I,e.up,d.camera);d.scale=k.distanceToScale(a,f.vec3d.dist(H,O),
d.targetGeometry.latitude);d.rotation=B(d.camera.heading);return d}if(b.zoomFactor){var g=e.distance/b.zoomFactor,z=f.vec3d.scale(e.viewForward,-g,h);f.vec3d.add(e.center,z,e.eye);e.markViewDirty();d.scale=k.distanceToScale(a,g,c.latitude)}k.internalToExternal(a,e,d.camera);g={noReset:!1};L(d.camera,b)&&(g.noReset=!0);return b.zoomFactor||(d.scale=K(a,b),null==d.scale&&(x.pointToVector(c,h,a.renderSpatialReference),Z.frustumPoint(e.frustumPlanes,h)?d.scale=k.distanceToScale(a,f.vec3d.dist(e.eye,h),
c.latitude):d.scale=k.computeScale(a,e)),k.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,g,d.camera))?d:null}function da(a,b,c,d){d.targetGeometry=c.clone();var e=A.cameraOnContentAlongViewDirection(a);k.internalToExternal(a,e,d.camera);e={noReset:!1};L(d.camera,b)&&(e.noReset=!0);return k.fromExtent(a,c,d.camera.heading,d.camera.tilt,e,d.camera)?d:null}function ea(a,b){if(!b||!a.spatialReference)return null;a={target:null};if("declaredClass"in b||Array.isArray(b))a.target=b;else{for(var c in b)a[c]=
b[c];b.center&&!a.target&&(a.target=b.center)}return a}function C(a){a&&(a.rotation=B(a.camera.heading));return t.resolve(a)}Object.defineProperty(v,"__esModule",{value:!0});v.DEFAULT_FRAME_COVERAGE=.66;v.rotationToHeading=J;v.headingToRotation=B;v.toCamera=U;v.fromInternalCamera=function(a,b,c){c||(c=new F({camera:new E}));k.internalToExternal(a,b,c.camera);return G(a,b,c)};v.fromCamera=function(a,b,c){c||(c=new F);c.camera=b.clone();return G(a,null,c)};v.create=function(a,b){var c=ea(a,b);if(!c)return t.reject(new R("viewpointutils-create:no-target",
"Missing target for creating viewpoint"));var d=new F({camera:new E({fov:a.camera.fov})}),e=null!=c.scale||null!=c.zoom;if(c.target instanceof F)return C(ca(a,c.target,c,d));if(c.target instanceof E)return C(W(a,c,c.target,d));if(c.target instanceof w.Extent)return b=c.target.xmin===c.target.xmax||c.target.ymin===c.target.ymax,e||b?C(N(a,c,c.target.center,d)):C(da(a,c,c.target,d));var g={boundingBox:n.empty(),hasZ:!1,screenSpaceObjects:[]};b=e?k.scaleToResolution(a,K(a,c)):void 0;return V(a,c.target,
b,g).then(function(){if(isFinite(g.boundingBox[0])){n.center(g.boundingBox,h);l.x=h[0];l.y=h[1];l.z=h[2];l.spatialReference=a.spatialReference;var b=void 0;isFinite(l.z)&&g.hasZ?b=n.isPoint(g.boundingBox):(l.z=void 0,b=S.isPoint(n.toRect(g.boundingBox,fa)));if(e||b)return N(a,c,l,d);var q=l,b=g.boundingBox,m;m=g.screenSpaceObjects;var p=v.DEFAULT_FRAME_COVERAGE;if(m.length){for(var r=Number.NEGATIVE_INFINITY,u=0;u<m.length;u++)var y=m[u].screenSpaceBoundingRect,r=Math.max(r,Math.abs(y[0]),Math.abs(y[1]),
Math.abs(y[2]),Math.abs(y[3]));m=p-r/Math.min(a.width,a.height)*2}else m=p;p=m;d.targetGeometry=q.clone();m=A.cameraOnContentAlongViewDirection(a);r=0;q.hasZ?r=q.z:a.basemapTerrain&&(r=a.basemapTerrain.getElevation(q));f.vec3d.set3(q.x,q.y,r,h);x.computeLinearTransformation(a.spatialReference,h,X,a.renderSpatialReference);f.mat4d.toMat3(X,P);f.mat3d.transpose(P);n.empty(D);q=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(u=0;u<q.length;u++){var y=q[u],t=b[y[2]];isFinite(t)||
(t=r);f.vec3d.set3(b[y[0]],b[y[1]],t,h);x.vectorToVector(h,a.spatialReference,h,a.renderSpatialReference);n.expand(D,f.mat3d.multiplyVec3(P,h))}b=n.width(D);q=n.height(D);r=n.depth(D);u=1/Math.tan(m.fovY/2);b=Math.max(.5*Math.sqrt(b*b+r*r)*Math.max(u,1/Math.tan(m.fovX/2))+.5*q,.5*q*u+.5*Math.max(b,r))/p;k.internalToExternal(a,m,d.camera);m={noReset:!1};L(d.camera,c)&&(m.noReset=!0);d.scale=k.distanceToScale(a,b,d.targetGeometry.latitude);b=k.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,m,d.camera)?
d:null;return b}if(c.position)return b=A.cameraOnContentAlongViewDirection(a),f.vec3d.set(b.viewForward,I),k.directionToHeadingTilt(a,b.eye,I,b.up,Q),d.camera.position=new w.Point(c.position),d.camera.heading=null!=c.heading?c.heading:Q.heading,d.camera.tilt=null!=c.tilt?c.tilt:Q.tilt,G(a,null,d);b=A.cameraOnContentAlongViewDirection(a);b=x.vectorToPoint(b.center,a.renderSpatialReference,l,a.spatialReference);return N(a,c,b,d)}).then(function(a){return C(a)})};var h=f.vec3d.create(),X=f.mat4d.create(),
P=f.mat3d.create(),D=n.create(),fa=S.create(),I=f.vec3d.create(),H=f.vec3d.create(),O=f.vec3d.create(),Q={heading:0,tilt:0},l=new w.Point,aa={point:function(a,b,c){c[0]=a.x;c[1]=a.y;a.hasZ&&(c[2]=a.z);b(c)},polygon:function(a,b,c){for(var d=a.hasZ,e=0;e<a.rings.length;e++)for(var g=a.rings[e],f=0;f<g.length;f++)c[0]=g[f][0],c[1]=g[f][1],d&&(c[2]=g[f][2]),b(c)},polyline:function(a,b,c){for(var d=a.hasZ,e=0;e<a.paths.length;e++)for(var f=a.paths[e],h=0;h<f.length;h++)c[0]=f[h][0],c[1]=f[h][1],d&&(c[2]=
f[h][2]),b(c)},multipoint:function(a,b,c){var d=a.points;a=a.hasZ;for(var e=0;e<d.length;e++)c[0]=d[e][0],c[1]=d[e][1],a&&(c[2]=d[e][2]),b(c)},extent:function(a,b,c){a.hasZ?(b(f.vec3d.set3(a.xmin,a.ymin,a.zmin,c)),b(f.vec3d.set3(a.xmax,a.ymin,a.zmin,c)),b(f.vec3d.set3(a.xmin,a.ymax,a.zmin,c)),b(f.vec3d.set3(a.xmax,a.ymax,a.zmin,c)),b(f.vec3d.set3(a.xmin,a.ymin,a.zmax,c)),b(f.vec3d.set3(a.xmax,a.ymin,a.zmax,c)),b(f.vec3d.set3(a.xmin,a.ymax,a.zmax,c)),b(f.vec3d.set3(a.xmax,a.ymax,a.zmax,c))):(b(f.vec3d.set3(a.xmin,
a.ymin,c[2],c)),b(f.vec3d.set3(a.xmax,a.ymin,c[2],c)),b(f.vec3d.set3(a.xmin,a.ymax,c[2],c)),b(f.vec3d.set3(a.xmax,a.ymax,c[2],c)))},mesh:function(a,b,c){if(a=a.vertexAttributes&&a.vertexAttributes.position)for(var d=0;d<a.length;d+=3)b(f.vec3d.set3(a[d+0],a[d+1],a[d+2],c))}}});