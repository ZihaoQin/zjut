// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../geometry/support/aaBoundingBox ../Camera ../DefaultVertexAttributeLocations ../gl-matrix ../RenderSlot ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData ./utils ../../materials/DefaultMaterial ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(E,u,Q,w,J,A,g,v,l,K,L,F,B,M,N,z,O){function G(c,a,b,f){B.encodeDoubleVec3(c.modelOrigin,a,b.modelOriginHi,
b.modelOriginLo,f);c.model.getMat(a,r);b.model.setMat(f,r);c.modelNormal.getMat(a,r);b.modelNormal.setMat(f,r);c.color&&b.color&&(c.color.getVec(a,m),b.color.setVec(f,m));c.featureAttribute&&b.featureAttribute&&(c.featureAttribute.getVec(a,m),b.featureAttribute.setVec(f,m))}Object.defineProperty(u,"__esModule",{value:!0});var x=z.assert,H=function(){function c(a,b){this.glMaterials={};var f=a.rctx,d=b.geometry;b=b.material;var c=d.data.toRenderData();this.materialRep=a.materialRep;b.setParameterValues({instancedDoublePrecision:!0});
a=b.getVertexBufferLayout();var e=c.indices.position.length,t=new Float32Array(a[0].stride/4*e);b.fillInterleaved(c,void 0,void 0,void 0,t,0);this.geometry=d;this.material=b;this.glMaterials=B.acquireGLMaterials(b,this.materialRep);this.vertexBufferLayout=a;this.vbo=N.createVertex(f,35044,t);this.vao=new O(f,A.Default3D,{geometry:a},{geometry:this.vbo});this.vertexCount=e}c.prototype.destroy=function(){B.releaseGLMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};Object.defineProperty(c.prototype,
"boundingInfo",{get:function(){return this.geometry.getBoundingInfo()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0});c.prototype.intersect=function(a,b,c,d,n){var e=this.geometry.id,f=d.toString();this.material.intersect(this.geometry,null,P,a,b,c,function(b,c,h,k,t,p){if(0<=b){t={type:"external",metadata:n(d)};if(null==a.minResult.priority||k>=a.minResult.priority)if(null==a.minResult.dist||
b<a.minResult.dist)a.minResult.set(t,f,b,c,k,null,e,h),a.minResult.setIntersector("LodRenderer");if(null==a.maxResult.priority||k>=a.maxResult.priority)if(null==a.maxResult.dist||b>a.maxResult.dist)a.maxResult.set(t,f,b,c,k,null,e,h),a.minResult.setIntersector("LodRenderer")}},null)};return c}();u.LodComponentData=H;var I=function(){function c(a,b){var c=this;this.components=[];this.minScreenSpaceRadius=b.minScreenSpaceRadius;b.components.forEach(function(b){c.components.push(new H(a,b))})}c.prototype.destroy=
function(){this.components.forEach(function(a){a.destroy()})};c.prototype.intersect=function(a,b,c,d,n){this.components.forEach(function(e){e.intersect(a,b,c,d,n)})};Object.defineProperty(c.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var a=w.empty();this.components.forEach(function(b){w.expand(a,b.boundingInfo.bbMin);w.expand(a,b.boundingInfo.bbMax)});this._boundingBox=a}return this._boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"boundingSphere",
{get:function(){if(!this._boundingSphere){var a=this.boundingBox,b=g.vec3d.create();w.center(a,b);this._boundingSphere={center:b,radius:.5*w.diameter(a)}}return this._boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"triangleCount",{get:function(){return this.components.reduce(function(a,b){return a+b.triangleCount},0)},enumerable:!0,configurable:!0});return c}();u.LodLevelData=I;E=function(){function c(a,b,c){var d=this;this._levels=[];this._renderInstanceData=[];
this._highlightRenderInstanceData=[];this._instanceIndex=0;this._lastCamera=new J;this._updateCyclesWithStaticCamera=-1;this.didRender=this._needFullCycle=!1;this._symbol=a;this._optionalFields=b;this._instanceToMetadata=c;this._instanceBufferLayout=M.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:b});this._instanceData=new l.InstanceData(this._optionalFields);this._instanceData.on("instance-added",function(a){d.resetUpdateCycle()});this._instanceData.on("instance-removed",function(a){d.resetUpdateCycle()});
this._instanceData.on("instance-transform-changed",function(a){d.resetUpdateCycle()});this._instanceData.on("instance-visibility-changed",function(a){d.resetUpdateCycle();d.requestFullCycle()});this._instanceData.on("instance-highlight-changed",function(a){d.resetUpdateCycle();d.requestFullCycle()});u.lodRenderers.push(this);window.lodRenderer=this}c.prototype.destroy=function(){u.lodRenderers.splice(u.lodRenderers.indexOf(this),1)};Object.defineProperty(c.prototype,"baseBoundingBox",{get:function(){return this._levels[0].boundingBox},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseBoundingSphere",{get:function(){return this._levels[0].boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"memoryUsage",{get:function(){var a={cpu:0,gpu:0};this._renderInstanceData.forEach(function(b){b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});this._highlightRenderInstanceData.forEach(function(b){b=
b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});return a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderStats",{get:function(){var a=this,b=this._instanceData.size,c=[];this._levels.forEach(function(b,f){f=a._renderInstanceData[f].size+a._highlightRenderInstanceData[f].size;b=b.triangleCount;c.push({renderedInstances:f,renderedTriangles:f*b,trianglesPerInstance:b})});return{totalInstances:b,renderedInstances:c.reduce(function(a,b){return a+b.renderedInstances},0),renderedTriangles:c.reduce(function(a,
b){return a+b.renderedTriangles},0),levels:c}},enumerable:!0,configurable:!0});c.prototype.initializeRenderContext=function(a){var b=this,c=a.rctx;this._symbol.levels.forEach(function(d){b._levels.push(new I(a,d));b._renderInstanceData.push(new F.RenderInstanceData(c,b._optionalFields,b._instanceBufferLayout));b._highlightRenderInstanceData.push(new F.RenderInstanceData(c,b._optionalFields,b._instanceBufferLayout))});var d=this._levels[0].boundingSphere.radius,n=this._levels.map(function(a){return a.minScreenSpaceRadius});
this._levelSelector=new L.LevelSelector(d,n);this._octree=new K.InstanceOctree(this._instanceData,this._levels[0].boundingSphere)};c.prototype.uninitializeRenderContext=function(a){this._levels.forEach(function(a){a.destroy()});this._renderInstanceData.forEach(function(a){a.destroy()});this._highlightRenderInstanceData.forEach(function(a){a.destroy()})};Object.defineProperty(c.prototype,"slots",{get:function(){return[v.OPAQUE_EXTERNAL,v.TRANSPARENT_EXTERNAL]},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"needsHighlight",{get:function(){return 0<this._highlightRenderInstanceData.reduce(function(a,b){return a+b.size},0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"needsRender",{get:function(){return 1>this._updateCyclesWithStaticCamera},enumerable:!0,configurable:!0});c.prototype.resetNeedsRender=function(){this.didRender&&(this.didRender=!1)};c.prototype.prepareRender=function(a){var b=a.equivalent(this._lastCamera);this._lastCamera.copyFrom(a);b||this.resetUpdateCycle();b=
this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,b)};c.prototype.render=function(a){var b=a.slot===v.OPAQUE_EXTERNAL?v.OPAQUE_MATERIAL:a.slot===v.TRANSPARENT_EXTERNAL?v.TRANSPARENT_MATERIAL:null;if(b){var c={view:a.camera.viewMatrix,proj:a.camera.projectionMatrix,origin:[0,0,0],viewInvTransp:a.camera.viewInverseTransposeMatrix,lightingData:a.lightingData,viewport:a.camera.viewport,fovY:a.camera.fovY,nearFar:[a.camera.near,a.camera.far],framebufferTex:a.offscreenRenderingHelper?
a.offscreenRenderingHelper.colorTexture:null,shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,pixelRatio:a.pixelRatio,cameraAboveGround:a.camera.aboveGround,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null};a.rctx.bindVAO();if(a.isHighlightPass)for(var d=0;d<this._levels.length;++d)this.renderLevel(a,b,c,this._highlightRenderInstanceData[d],this._levels[d]);else for(d=
0;d<this._levels.length;++d)this.renderLevel(a,b,c,this._renderInstanceData[d],this._levels[d]);return!0}};c.prototype.intersect=function(a,b,c,d){var f=this;d=g.vec3d.create();g.vec3d.subtract(c,b,d);this._octree.forEachAlongRay(b,d,function(d){f._instanceData.getTranslation(d,y);f._instanceData.getModel(d,r);g.vec3d.subtract(b,y,C);g.vec3d.subtract(c,y,D);g.mat3d.inverse(r,r);g.mat3d.multiplyVec3(r,C);g.mat3d.multiplyVec3(r,D);var e=f._instanceData.getState(d),n=f._instanceData.getLodLevel(d);x(e&
l.StateFlags.ACTIVE,"invalid instance state");x(0<=n&&n<f._levels.length,"invaid lod level");f._levels[n].intersect(a,C,D,d,f._instanceToMetadata)})};c.prototype.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};c.prototype.queryDepthRangeOctree=function(a){var b=a.eye,c=a.viewForward,d=this._octree.findClosest(c,"front-to-back",a.frustumPlanes),n=this._octree.findClosest(c,"back-to-front",a.frustumPlanes);return null!=d&&null!=n?(this._instanceData.view.boundingSphere.getVec(d,m),
g.vec3d.subtract(m,b),d=g.vec3d.dot(m,c)-m[3],this._instanceData.view.boundingSphere.getVec(n,m),g.vec3d.subtract(m,b),b=g.vec3d.dot(m,c)+m[3],{near:Math.max(a.near,d),far:Math.min(a.far,b)}):{near:Infinity,far:-Infinity}};c.prototype.updateInstances=function(a,b){var c=this._levelSelector;c.updateCamera(a);this._renderInstanceData.forEach(function(a){a.beginUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.beginUpdate()});a=this._instanceData;var d=this._instanceData.view,n=a.capacity,
e=this._instanceIndex;b=Math.min(a.size,b);for(var t=0;t<b;++t){0===e&&this.startUpdateCycle();var g=d.state.get(e),q=0;if(g&l.StateFlags.ALLOCATED){var h=d.lodLevel.get(e);g&l.StateFlags.ACTIVE&&this._renderInstanceData[h].freeTail();g&l.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[h].freeTail();if(g&l.StateFlags.REMOVE)a.notifyRemoved(e);else if(g&l.StateFlags.VISIBLE){d.modelOrigin.getVec(e,y);h=c.selectLevel(y,d.modelScaleFactor.get(e));q=g&~(l.StateFlags.ACTIVE|l.StateFlags.HIGHLIGHT_ACTIVE|
l.StateFlags.TRANSFORM_CHANGED);if(0<=h){var k=this._renderInstanceData[h],m=k.allocateHead();G(d,e,k.view,m);q|=l.StateFlags.ACTIVE;g&l.StateFlags.HIGHLIGHT&&(k=this._highlightRenderInstanceData[h],m=k.allocateHead(),G(d,e,k.view,m),q|=l.StateFlags.HIGHLIGHT_ACTIVE)}d.state.set(e,q);d.lodLevel.set(e,h)}else q=g&~(l.StateFlags.ACTIVE|l.StateFlags.HIGHLIGHT_ACTIVE|l.StateFlags.TRANSFORM_CHANGED),d.state.set(e,q);h=!!(g&l.StateFlags.ACTIVE);q=!!(q&l.StateFlags.ACTIVE);!h&&q?this._octree.addInstance(e):
h&&!q?this._octree.removeInstance(e):h&&q&&g&l.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(e),this._octree.addInstance(e));e=(e+1)%n}else e=(e+1)%n,b++}this._instanceIndex=e;this._renderInstanceData.forEach(function(a){a.endUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.endUpdate()})};c.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._renderInstanceData.forEach(function(a){a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(function(a){a.startUpdateCylce()})};
c.prototype.resetUpdateCycle=function(){this._updateCyclesWithStaticCamera=-1};c.prototype.requestFullCycle=function(){this._needFullCycle=!0};c.prototype.renderLevel=function(a,b,c,d,g){var e=this;g.components.forEach(function(f){e.renderComponent(a,b,c,d,f)})};c.prototype.renderComponent=function(a,b,c,d,g){var e=g.glMaterials[a.pass];if(e&&e.beginSlot(b)&&e.isVisible&&0!==d.size){var f=a.rctx,l=f.capabilities.instancing,m=e.getDrawMode(f);c.origin=[0,0,0];b===v.STENCIL_MATERIAL&&(a.stencilRenderingHelper.enabled=
!0,a.stencilRenderingHelper.prepareStencilWritePass());e.bind(f,c);f.bindVAO(g.vao);b=e.getProgram();z.assertCompatibleVertexAttributeLocations(g.vao,b);a.isHighlightPass&&(f.bindTexture(a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:null,5),b.setUniform1i("depthTex",5),b.setUniform4f("highlightViewportPixelSz",0,0,1/c.viewport[2],1/c.viewport[3]));e.bindView(f,c);a=d.capacity;b=d.headIndex;var h=d.tailIndex,k=d.firstIndex,n=this._instanceBufferLayout,p=function(a,b){z.bindVertexBufferLayout(f,
A.Default3D,d.buffer,n,a);l.drawArraysInstanced(m,0,g.vertexCount,b-a);z.unbindVertexBufferLayout(f,A.Default3D,d.buffer,n)};g.material.getParams().transparent&&null!=k?b>h?(x(k>=h&&k<=b,"invalid firstIndex"),p(k,b),p(h,k)):b<h&&(k<=b?(x(0<=k&&k<=b,"invalid firstIndex"),p(k,b),p(h,a),p(0,k)):(x(k>=h&&k<=a,"invalid firstIndex"),p(k,a),p(0,b),p(h,k))):b>h?p(h,b):b<h&&(p(0,b),p(h,a));f.bindVAO(null);e.release(f,c)}};return c}();u.LodRenderer=E;u.lodRenderers=[];var y=g.vec3d.create(),m=g.vec4d.create(),
r=g.mat3d.create(),C=g.vec3d.create(),D=g.vec3d.create(),P=g.mat4d.identity()});