// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/QueueProcessor ../../../../core/throttle ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../tasks/support/QuantizationParameters".split(" "),
function(w,n,G,l,H,x,y,I,z,J,K,A,L,M,N,h,k,B,O){Object.defineProperty(n,"__esModule",{value:!0});var C=K.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");w=function(g){function b(a){a=g.call(this,a)||this;a.displayLimitExceeded=!1;a.displayLimitExceededThrottle=1E3;a.handles=new J;a.idToFeatureTile=new Map;a.displayingFeatureReferences=new Map;a.suspended=!0;a.pendingEdits=null;return a}G(b,g);Object.defineProperty(b.prototype,"displayFeatureLimit",{set:function(a){var c=this._get("displayFeatureLimit");
if(!(a===c||a&&c&&a.min===c.min&&a.max===c.max&&a.perTile===c.perTile)){var c=c?c.perTile:Infinity,d=a?a.perTile:Infinity;this._set("displayFeatureLimit",H({},a));this.perTileLimitUpdated(c,d);this.update()}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this.fetchQueue.length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filterExtent",{set:function(a){if(a&&this.tilingScheme&&!a.spatialReference.equals(this.tilingScheme.spatialReference))C.error("#filterExtent\x3d",
"extent needs to be in the same spatial reference as the tiling scheme");else{var c=this._get("filterExtent");c===a||c&&a&&c.equals(a)||(a=a?a.clone():null,this._set("filterExtent",a),this.reclip(a,c))}},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this.updateDisplayLimitExceededThrottled=M.throttle(this.updateDisplayLimitExceeded,this.displayLimitExceededThrottle,this);this.capabilities=this.calculateCapabilities();this.fetchQueue=this.createFetchQueue();this.handles.add(N.on(this,
"tileDescriptors","change",function(){return a.update()},function(){return a.update()}));this.objectIdField=this.layer.objectIdField;this.update()};b.prototype.destroy=function(){var a=this;this.handles&&(this.handles.destroy(),this.handles=null);this.updateDisplayLimitExceededThrottled.remove();this.forEachFeatureTile(function(c){return a.cancelFetchTile(c)});this.fetchQueue.clear();this.pendingEdits&&(this.pendingEdits.edits.cancel(D),this.pendingEdits=null)};Object.defineProperty(b.prototype,"paused",
{get:function(){return this.suspended||!!this.pendingEdits},enumerable:!0,configurable:!0});b.prototype.filtersChanged=function(){var a=this;this.fetchQueue.clear();this.forEachFeatureTile(function(c){a.resetFetchTile(c);a.queueFetchTile(c)});this.update()};b.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.pause())};b.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.unpause())};b.prototype.pause=function(){this.paused&&(this.fetchQueue.pause(),this.fetchQueue.reset())};
b.prototype.unpause=function(){this.paused||(this.update(),this.fetchQueue.resume())};b.prototype.getFeatureTileById=function(a){return this.idToFeatureTile.get(a)||null};b.prototype.forEachFeatureTile=function(a){this.idToFeatureTile.forEach(a)};b.prototype.applyEdits=function(a){var c=this;this.pendingEdits||(this.pendingEdits={edits:A.resolve(),count:0},this.pause());this.pendingEdits.count++;this.pendingEdits.edits=this.pendingEdits.edits.then(function(){return a.result.catch(function(a){if(a===
D)throw a;return null}).then(function(a){if(a)return c.applyEditsDeleteFeatures(a.deletedFeatures),c.applyEditsAddUpdateFeatures(a.addedFeatures,a.updatedFeatures)}).then(function(){0===--c.pendingEdits.count&&(c.pendingEdits=null,c.unpause())})})};b.prototype.applyEditsDeleteFeatures=function(a){var c=this;if(0!==a.length){var d=new Set;a.forEach(function(a){return d.add(a.objectId)});this.forEachFeatureTile(function(a){if(a.features){var e=a.features.filter(function(a){return!d.has(c.getFeatureId(a))});
e.length!==a.features.length&&(a.features=e)}})}};b.prototype.applyEditsAddUpdateFeatures=function(a,c){var d=this,e=[],b=new Set;a.forEach(function(a){return e.push(a.objectId)});c.forEach(function(a){e.push(a.objectId);b.add(a.objectId)});if(0!==e.length){var m=[];this.forEachFeatureTile(function(a){var c=z.cancellable(function(c){return d.applyEditsAddUpdateTile(a,e,b,c)});c&&m.push(c)});return A.all(m)}};b.prototype.applyEditsAddUpdateTile=function(a,c,d,e){return x(this,void 0,void 0,function(){var b,
m,p,g,h,l,k,q=this;return y(this,function(f){switch(f.label){case 0:if(!a.features)return[2];b=this.createQuery(a);b.resultType=void 0;b.objectIds=c;return[4,e(this.queryFeatures(b))];case 1:m=f.sent();p=null;0<d.size&&(g=a.features.filter(function(a){return!d.has(q.getFeatureId(a))}),g.length!==a.features.length&&(p=g));if(0<m.features.length)for(p||(p=a.features.slice()),this.verticalScale.adjust(m.features),h=0,l=m.features;h<l.length;h++)k=l[h],p.push(k);p&&(a.features=p);return[2]}})})};b.prototype.queryFeatures=
function(a){return this.layer.queryFeaturesJSON?this.layer.queryFeaturesJSON(a).then(function(a){return{features:B.fromFeatureSetJSON(a),exceededTransferLimit:!!a.exceededTransferLimit}}):this.layer.queryFeatures(a).then(function(a){return{features:a.features,exceededTransferLimit:!!a.exceededTransferLimit}})};b.prototype.calculateCapabilities=function(){var a=this.layer,c=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsPagination),d=!!(a.capabilities&&a.capabilities.query&&
a.capabilities.query.supportsResultType),a=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantization);return{supportsMultipleResolutions:this.calculateSupportsMultipleResolutions(),supportsPagination:c,supportsResultType:d,supportsQuantization:a}};b.prototype.calculateSupportsMultipleResolutions=function(){var a=this.layer,c=a.geometryType;return"polyline"===c?!0:"polygon"===c?a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantization:!1};b.prototype.createFetchQueue=
function(){var a=this;return new L({concurrency:6,ordered:!0,peeker:function(c){return a.highestPriorityTile(c)},process:function(c){return a.fetchTile(c)}})};b.prototype.highestPriorityTile=function(a){return a.reduce(function(a,d){return a&&a.descriptor.loadPriority<=d.descriptor.loadPriority?a:d},null)};b.prototype.update=function(){if(!this.suspended&&this.constructed){var a=this.getListOfTiles();this.markTilesNotAlive(a);this.addTiles(a);a=this.sortTiles(a);this.removeTiles(a);this.displayTiles(a);
this.queueFetchTiles(a);this.updated()}};b.prototype.markTilesNotAlive=function(a){for(var c=0;c<a.length;c++)a[c].alive=0};b.prototype.addTiles=function(a){var c=this;this.tileDescriptors.forEach(function(d){var b=c.getFeatureTileById(d.id);b?b.alive=1:a.push(c.addTile(d))})};b.prototype.removeTiles=function(a){for(var c=0;c<a.length;c++){var d=a[c];0===d.alive||d.intersects(this.filterExtent)||this.clearTile(d)}for(var c=!1,b=a.length-1;0<=b;b--)d=a[b],d.displayingFeatures&&0<d.displayingFeatures.length&&
this.displayFeatureLimit&&this.displayingFeatureReferences.size<=this.displayFeatureLimit.min?0===d.alive&&(d.alive=2):0===d.alive&&(this.removeTile(d),b!==a.length-1&&(c=!0),a[b]=a[a.length-1],a.pop());c&&this.sortTiles(a)};b.prototype.sortTiles=function(a){a.sort(function(a,d){return a.descriptor.loadPriority-d.descriptor.loadPriority});return a};b.prototype.displayTiles=function(a){for(var c=0,d=a.length-1,b=null;c<=d;)if(!b&&this.isDisplayingFeaturesAtMaximumLimit()){var f=a[d--],m=this.featureCountDifferenceWhenHidingTile(f);
this.displayFeatureLimit&&this.displayingFeatureReferences.size-m>=this.displayFeatureLimit.max?this.hideTile(f):b=f}else f=a[c++],m=this.featureCountDifferenceWhenShowingTile(f),0<m&&b&&(this.hideTile(b),b=null),this.showTile(f);b&&this.showTile(b)};b.prototype.queueFetchTiles=function(a){var c=a.length-1;if(this.isDisplayingFeaturesAtMaximumLimit())for(var d=a.length-1;0<=d;d--){var b=a[d];if(b.displayingFeatures&&0<b.displayingFeatures.length){c=d;break}}for(d=0;d<=c;d++)this.queueFetchTile(a[d])};
b.prototype.reclip=function(a,c){var b=this;if(this.constructed){var e=[];this.forEachFeatureTile(function(d){d.displayingFeatures&&0!==d.displayingFeatures.length&&(d.intersection(c,r),d.intersection(a,E),k.equals(r,E)||(e.push(d),b.hideTileFeatures(d)))});for(var f=0;f<e.length;f++)this.showTile(e[f]);this.updated()}};b.prototype.updated=function(){this.notifyChange("updating");this.debugger&&this.debugger.update();this.updateDisplayLimitExceededThrottled()};b.prototype.updateDisplayLimitExceeded=
function(){if(!this.updating){var a=!1;this.forEachFeatureTile(function(c){if(c.perTileDisplayLimitExceeded&&2!==c.alive||!c.displayingFeatures&&!c.isFetchFetching)a=!0});this._set("displayLimitExceeded",a)}};b.prototype.perTileLimitUpdated=function(a,c){if(a!==c)if(c<a){a=0;for(var d=this.getListOfTiles();a<d.length;a++){var b=d[a];b.features&&b.features.length>c&&(b.features=b.features.slice(0,c),b.perTileDisplayLimitExceeded=!0)}}else for(c=0,d=this.getListOfTiles();c<d.length;c++)b=d[c],b.features&&
b.features.length>=a&&(this.cancelFetchTile(b),this.resetFetchTile(b))};b.prototype.addTile=function(a){a=new F(a);this.idToFeatureTile.set(a.id,a);this.resetFetchTile(a);this.referenceDisplayingFeaturesFromRelatedTiles(a);return a};b.prototype.referenceDisplayingFeaturesFromRelatedTiles=function(a){var c=this;this.forEachFeatureTile(function(b){if(b.displayingFeatures&&c.tilesAreRelated(a,b)){a.displayingFeatures||(a.displayingFeatures=[]);var d=0;for(b=b.displayingFeatures;d<b.length;d++){var f=
b[d];a.displayingFeatures.push(f);c.getDisplayingFeatureReference(f).ref()}}})};b.prototype.tilesAreRelated=function(a,c){if(a===c)return!1;a=a.descriptor.lij;var b=c.descriptor.lij;if(!a||!b)return!0;var e=a[0]<b[0];c=e?a:b;a=e?b:a;b=a[0]-c[0];if(0===b)return!1;b=1<<b;return Math.floor(a[1]/b)===c[1]&&Math.floor(a[2]/b)===c[2]};b.prototype.removeTile=function(a){this.clearTile(a);this.idToFeatureTile.delete(a.id)};b.prototype.resetFetchTile=function(a){a.intersects(this.filterExtent)?a.fetchStatus=
0:0===a.fetchStatus&&(a.fetchStatus=2)};b.prototype.cancelFetchTile=function(a){var b=a.fetchRequest;b&&(a.fetchRequest=null,a.fetchStatus=0,b.cancel())};b.prototype.fetchTile=function(a){var b=this;return z.cancellable(function(c){return b.fetchTileAll(a,c)})};b.prototype.setPagingParameters=function(a,b,d){if(!this.capabilities.supportsPagination)return!1;var c=this.capabilities.supportsResultType&&this.layer.tileMaxRecordCount||this.layer.maxRecordCount||P;a.start=b;0<d&&this.capabilities.supportsResultType?
(a.maxRecordCountFactor=Math.ceil(d/c),a.num=d):a.num=Math.min(c,d);return!0};b.prototype.fetchTileAll=function(a,b){return x(this,void 0,void 0,function(){var c,e,f,m,g,h,l,k,n,q;return y(this,function(d){switch(d.label){case 0:c=0,e=[],f=!1,a.perTileDisplayLimitExceeded=!1,d.label=1;case 1:return m=this.createQuery(a),g=this.displayFeatureLimit&&this.displayFeatureLimit.perTile,h=this.setPagingParameters(m,c,g),[4,b(this.queryFeatures(m))];case 2:l=d.sent();k=l.features;f=n=l.exceededTransferLimit;
e=0===e.length?k:e.concat(k);if(!h||!n||0<g&&e.length>=g)return[3,3];a.features=a.needsDisplayUpdate?a.features.concat(k):a.displayingFeatures?a.displayingFeatures.concat(k):k;this.update();c+=m.num;return[3,1];case 3:return b(null),(q=this.displayFeatureLimit&&this.displayFeatureLimit.perTile)&&e.length>q?(a.perTileDisplayLimitExceeded=!0,e=e.slice(0,q)):f&&(a.perTileDisplayLimitExceeded=!0),this.verticalScale.adjust(e),[2,e]}})})};b.prototype.createQuery=function(a){var b=this.tilingScheme.spatialReference,
d=a.descriptor.extent,e=this.createDefaultQuery();d&&(e.geometry=k.toExtent(d,b));this.setResolutionParams(e,a);this.capabilities.supportsResultType&&(e.resultType="tile");return e};b.prototype.createDefaultQuery=function(){var a=this.tilingScheme.spatialReference,b=this.layer.createQuery(),d=this.layer.capabilities&&this.layer.capabilities.data;d&&d.supportsZ&&null==b.returnZ&&(b.returnZ=!0);b.outSpatialReference=a;return b};b.prototype.setResolutionParams=function(a,b){if(this.capabilities.supportsMultipleResolutions){var c=
this.layer;b=b.descriptor.resolution;null!=b&&("polyline"===c.geometryType&&(a.maxAllowableOffset=b),this.capabilities.supportsQuantization&&(a.quantizationParameters=new O.default({mode:"view",originPosition:"upper-left",tolerance:b,extent:c.fullExtent})))}};b.prototype.queueFetchTile=function(a){var b=this;if(a.isFetchPending){var d=!1,e=this.fetchQueue.push(a).then(function(b){a.fetchRequest=null;a.fetchStatus=2;a.features=b}).catch(function(b){a.fetchRequest===e&&(a.fetchRequest=null,a.fetchStatus=
2);b&&"cancel"===b.dojoType?d=!0:(a.features=[],C.error("#fetchTile()",b&&b.message?b.message:b))}).then(function(){d||b.update()});e.isFulfilled()?a.fetchStatus=2:(a.fetchRequest=e,a.fetchStatus=1)}};b.prototype.getDisplayingFeatureReference=function(a){return this.displayingFeatureReferences.get(this.getFeatureId(a))};b.prototype.displayingFeatureNeedsReplacement=function(a,b,d){return this.capabilities.supportsMultipleResolutions&&d.descriptor.resolution>a.resolution?!0:!B.equals(a.feature,b)};
b.prototype.showTile=function(a){if(!a.displayingFeatures||a.needsDisplayUpdate)if(a.features){for(var b=a.descriptor.resolution,d=0,e=a.features;d<e.length;d++){var f=e[d],g=this.getFeatureId(f),h=this.displayingFeatureReferences.get(g);if(h)if(h.ref(),this.displayingFeatureNeedsReplacement(h,f,a))t.push(h.feature),h.feature=f,h.resolution=a.descriptor.resolution;else continue;else this.displayingFeatureReferences.set(g,new Q(f,b));u.push(f)}this.hideTileFeatures(a);0<t.length&&this.features.removeMany(t);
0<u.length&&this.features.addMany(u);t.length=0;u.length=0;a.displayingFeatures=a.features}else a.displayingFeatures=[]};b.prototype.featureCountDifferenceWhenShowingTile=function(a){if(!a.needsDisplayUpdate)return 0;for(var b=-this.featureCountDifferenceWhenHidingTile(a,!0),d=0,e=a.features;d<e.length;d++){var f=this.getDisplayingFeatureReference(e[d]);(!f||f.isSingle&&f.markedTile===a)&&b++}return b};b.prototype.getFeatureId=function(a){return null!=a.objectId?a.objectId:a.attributes[this.objectIdField]};
b.prototype.featureCountDifferenceWhenHidingTile=function(a,b){void 0===b&&(b=!1);if(!a.displayingFeatures)return 0;for(var c=0,e=0,f=a.displayingFeatures;e<f.length;e++){var g=this.getDisplayingFeatureReference(f[e]);g&&g.isSingle&&(b&&(g.markedTile=a),c++)}return c};b.prototype.hideTile=function(a){this.cancelFetchTile(a);this.hideTileFeatures(a)};b.prototype.hideTileFeatures=function(a){if(a.displayingFeatures){for(var b=0,d=a.displayingFeatures;b<d.length;b++){var e=this.getFeatureId(d[b]),f=
this.displayingFeatureReferences.get(e);f&&!f.unref()&&(this.displayingFeatureReferences.delete(e),v.push(f.feature))}0<v.length&&this.features.removeMany(v);v.length=0}a.displayingFeatures=null};b.prototype.clearTile=function(a){this.hideTile(a);a.features=null};b.prototype.isDisplayingFeaturesAtMaximumLimit=function(){return this.displayFeatureLimit&&this.displayingFeatureReferences.size>=this.displayFeatureLimit.max};b.prototype.getListOfTiles=function(){var a=Array(this.idToFeatureTile.size),
b=0;this.forEachFeatureTile(function(c){return a[b++]=c});return a};l([h.property({constructOnly:!0})],b.prototype,"features",void 0);l([h.property()],b.prototype,"tileDescriptors",void 0);l([h.property({constructOnly:!0})],b.prototype,"tilingScheme",void 0);l([h.property()],b.prototype,"displayFeatureLimit",null);l([h.property({constructOnly:!0})],b.prototype,"layer",void 0);l([h.property({readOnly:!0})],b.prototype,"updating",null);l([h.property({readOnly:!0})],b.prototype,"displayLimitExceeded",
void 0);l([h.property({constructOnly:!0})],b.prototype,"displayLimitExceededThrottle",void 0);l([h.property()],b.prototype,"filterExtent",null);l([h.property({constructOnly:!0})],b.prototype,"verticalScale",void 0);return b=l([h.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],b)}(h.declared(I));n.FeatureTileFetcher3D=w;var F=function(){function g(b){this.descriptor=b;this.fetchRequest=null;this.fetchStatus=0;this.displayingFeatures=this.features=null;this.perTileDisplayLimitExceeded=
!1;this.alive=1}Object.defineProperty(g.prototype,"id",{get:function(){return this.descriptor.id},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"isFetchFetching",{get:function(){return 1===this.fetchStatus},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"isFetchPending",{get:function(){return 0===this.fetchStatus},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"isFetchDone",{get:function(){return 2===this.fetchStatus},enumerable:!0,configurable:!0});
Object.defineProperty(g.prototype,"needsDisplayUpdate",{get:function(){return this.features&&this.displayingFeatures!==this.features},enumerable:!0,configurable:!0});g.prototype.intersects=function(b){if(!b||!this.descriptor.extent)return!0;k.fromExtent(b,r);return k.intersects(this.descriptor.extent,r)};g.prototype.intersection=function(b,a){void 0===a&&(a=k.create());if(!b&&!this.descriptor.extent)return a;b?(k.fromExtent(b,a),this.descriptor.extent&&k.intersection(a,this.descriptor.extent,a)):
k.set(a,this.descriptor.extent);return a};return g}();n.FeatureTile=F;var Q=function(){function g(b,a){this.feature=b;this.resolution=a;this.refCount=1}Object.defineProperty(g.prototype,"isReferenced",{get:function(){return 0!==this.refCount},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"isSingle",{get:function(){return 1===this.refCount},enumerable:!0,configurable:!0});g.prototype.ref=function(){this.refCount+=1};g.prototype.unref=function(){return 0<this.refCount?(--this.refCount,
this.isReferenced):!0};return g}(),P=2E3,r=k.create(),E=k.create(),u=[],t=[],v=[],D={};n.default=w});