// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/Error","../../core/Logger"],function(ha,r,E,ca){function A(a,b){return Math.round((b-a.translate[0])/a.scale[0])}function B(a,b){return Math.round((a.translate[1]-b)/a.scale[1])}function F(a,b){return b*a.scale[0]+a.translate[0]}function G(a,b){return a.translate[1]-b*a.scale[1]}function H(a){a=a.coords;return{x:a[0],y:a[1]}}function N(a){var b=new x;b.coords[0]=a.x;b.coords[1]=a.y;return b}function O(a){a=a.coords;return{x:a[0],y:a[1],z:a[2]}}function da(a){var b=
new x;b.coords[0]=a.x;b.coords[1]=a.y;b.coords[2]=a.z;return b}function P(a){a=a.coords;return{x:a[0],y:a[1],m:a[2]}}function ea(a){var b=new x;b.coords[0]=a.x;b.coords[1]=a.y;b.coords[2]=a.m;return b}function Q(a){a=a.coords;return{x:a[0],y:a[1],z:a[2],m:a[3]}}function fa(a){var b=new x;b.coords[0]=a.x;b.coords[1]=a.y;b.coords[2]=a.z;b.coords[3]=a.m;return b}function R(a,b,c){for(var d=b?c?4:3:c?3:2,f=[],e=0;e<a.coords.length;e+=d){for(var g=[],h=0;h<d;h++)g.push(a.coords[e+h]);f.push(g)}return b?
c?{points:f,hasZ:b,hasM:c}:{points:f,hasZ:b}:c?{points:f,hasM:c}:{points:f}}function S(a,b,c){var d=b?c?4:3:c?3:2,f=a.coords,e=[],g=0,h=0;for(a=a.lengths;h<a.length;h++){for(var m=a[h],l=[],n=0;n<m;n++){for(var k=[],p=0;p<d;p++)k.push(f[g++]);l.push(k)}e.push(l)}return b?c?{paths:e,hasZ:b,hasM:c}:{paths:e,hasZ:b}:c?{paths:e,hasM:c}:{paths:e}}function T(a,b,c){var d=b?c?4:3:c?3:2,f=a.coords,e=[],g=0,h=0;for(a=a.lengths;h<a.length;h++){for(var m=a[h],l=[],n=0;n<m;n++){for(var k=[],p=0;p<d;p++)k.push(f[g++]);
l.push(k)}e.push(l)}return b?c?{rings:e,hasZ:b,hasM:c}:{rings:e,hasZ:b}:c?{rings:e,hasM:c}:{rings:e}}function U(a,b,c,d){if(!b)return[];switch(b){case "esriGeometryPoint":b=N;d&&c?b=fa:d?b=da:c&&(b=ea);c=[];for(d=0;d<a.length;d++){var f=a[d],e=f.geometry,f=f.attributes,e=e?b(e):void 0;c.push(new C(e,f))}return c;case "esriGeometryMultipoint":b=c?d?4:3:d?3:2;c=[];for(d=0;d<a.length;d++){var e=a[d],g=e.geometry,e=e.attributes,f=void 0;if(g){f=new x;f.lengths[0]=g.points.length;for(var h=f.coords,m=
0,l=0,g=g.points;l<g.length;l++)for(var n=g[l],k=0;k<b;k++)h[m++]=n[k]}c.push(new C(f,e))}return c;case "esriGeometryPolyline":b=c?d?4:3:d?3:2;c=[];for(d=0;d<a.length;d++){e=a[d];n=e.geometry;e=e.attributes;f=void 0;if(n)for(f=new x,h=f.lengths,m=f.coords,g=l=0,n=n.paths;g<n.length;g++){for(var k=n[g],p=0,q=k;p<q.length;p++)for(var z=q[p],r=0;r<b;r++)m[l++]=z[r];h.push(k.length)}c.push(new C(f,e))}return c;case "esriGeometryPolygon":b=c?d?4:3:d?3:2;c=[];for(d=0;d<a.length;d++){f=a[d];k=f.geometry;
e=f.centroid;f=f.attributes;h=void 0;if(k)for(h=new x,m=h.lengths,l=h.coords,n=g=0,k=k.rings;n<k.length;n++){p=k[n];q=0;for(z=p;q<z.length;q++)for(var r=z[q],t=0;t<b;t++)l[g++]=r[t];m.push(p.length)}e?c.push(new C(h,f,N(e))):c.push(new C(h,f))}return c;default:return I.error("convertToFeatureSet:unknown-geometry",new E("Unable to parse unknown geometry type "+b)),[]}}function J(a,b,c,d,f,e){f=V[f];var g=b.coords;b=b.lengths;var h=c?d?4:3:d?3:2;c=c?d?K:D:d?D:L;a.lengths.length&&(a.lengths.length=0);
a.coords.length&&(a.coords.length=0);if(!g.length)return a;if(!b.length)return c(a.coords,g,0,0,A(e,g[0]),B(e,g[1])),a.lengths.length&&(a.lengths.length=0),a.coords.length=h,a;for(var m,l,n,k=0,p,q=0,z=0;z<b.length;z++){var r=b[z];if(!(r<f)){var t=0;p=q;l=d=A(e,g[k]);n=m=B(e,g[k+1]);c(a.coords,g,p,k,l,n);t++;k+=h;p+=h;for(var w=1;w<r;w++,k+=h)if(l=A(e,g[k]),n=B(e,g[k+1]),l!==d||n!==m)c(a.coords,g,p,k,l-d,n-m),p+=h,t++,d=l,m=n;t>=f&&(a.lengths.push(t),q=p)}}a.coords.length=q;return a.coords.length?
a:null}function M(a,b,c,d,f){var e=b.coords,g=b.lengths,h=c?d?K:D:d?D:L;c=c?d?4:3:d?3:2;if(!e.length)return a!==b&&(a.lengths.length=0,a.coords.length=0),a;if(!g.length)return h(a.coords,e,0,0,F(f,e[0]),G(f,e[1])),a!==b&&(a.lengths.length=0,a.coords.length=c),a;var m=f.scale;d=m[0];for(var m=m[1],l=0,n=0;n<g.length;n++){var k=g[n];a.lengths[n]=k;var p=F(f,e[l]),q=G(f,e[l+1]);h(a.coords,e,l,l,p,q);for(var l=l+c,r=1;r<k;r++,l+=c)p+=e[l]*d,q-=e[l+1]*m,h(a.coords,e,l,l,p,q)}a!==b&&(a.lengths.length=g.length,
a.coords.length=e.length);return a}function ga(a,b,c,d,f,e){e=f?e?4:3:e?3:2;var g=c,h=c+e,m=0,l=0,n=c=0,k=0,p=0;for(--d;p<d;p++,g+=e,h+=e){var q=b[g],r=b[g+1],v=b[g+2],t=b[h],w=b[h+1],y=b[h+2],u=q*w-t*r,n=n+u,m=m+(q+t)*u,l=l+(r+w)*u;f&&(u=q*y-t*v,c+=(v+y)*u,k+=u);q<a[0]&&(a[0]=q);q>a[1]&&(a[1]=q);r<a[2]&&(a[2]=r);r>a[3]&&(a[3]=r);f&&(v<a[4]&&(a[4]=v),v>a[5]&&(a[5]=v))}0<n&&(n*=-1);0<k&&(k*=-1);if(!n)return null;a=[m,l,.5*n];f&&(a[3]=c,a[4]=.5*k);return a}function W(a,b,c,d,f){f=d?f?4:3:f?3:2;for(var e=
b,g=b+f,h=0,m=0,l=0,n=0,k=0,p=c-1;k<p;k++,e+=f,g+=f){var q=a[e],r=a[e+1],v=a[e+2],t=a[g],w=a[g+1],y=a[g+2],u=d?X(q,r,v,t,w,y):Y(q,r,t,w);u&&(h+=u,d?(q=Z(q,r,v,t,w,y),m+=u*q[0],l+=u*q[1],n+=u*q[2]):(q=aa(q,r,t,w),m+=u*q[0],l+=u*q[1]))}return 0<h?d?[m/h,l/h,n/h]:[m/h,l/h]:0<c?d?[a[b],a[b+1],a[b+2]]:[a[b],a[b+1]]:null}function Y(a,b,c,d){a=c-a;b=d-b;return Math.sqrt(a*a+b*b)}function X(a,b,c,d,f,e){a=d-a;b=f-b;c=e-c;return Math.sqrt(a*a+b*b+c*c)}function aa(a,b,c,d){return[a+.5*(c-a),b+.5*(d-b)]}function Z(a,
b,c,d,f,e){return[a+.5*(d-a),b+.5*(f-b),c+.5*(e-c)]}Object.defineProperty(r,"__esModule",{value:!0});var I=ca.getLogger("esri.tasks.support.optimizedFeatureSet"),V={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},L=function(a,b,c,d,f,e){a[c]=f;a[c+1]=e},D=function(a,b,c,d,f,e){a[c]=f;a[c+1]=e;a[c+2]=b[d+2]},K=function(a,b,c,d,f,e){a[c]=f;a[c+1]=e;a[c+2]=b[d+2];a[c+3]=b[d+3]};r.quantizeX=A;r.quantizeY=B;r.hydrateX=F;r.hydrateY=G;var ba=function(){return function(){this.spatialReference=
this.geometryType=this.geometryProperties=this.geohashFieldName=this.globalIdFieldName=this.objectIdFieldName=null;this.hasM=this.hasZ=!1;this.features=[];this.fields=[];this.transform=null;this.exceededTransferLimit=!1}}();r.OptimizedFeatureSet=ba;var x=function(){return function(a,b){void 0===a&&(a=[]);void 0===b&&(b=[]);this.lengths=a;this.coords=b}}();r.OptimizedGeometry=x;var C=function(){return function(a,b,c){void 0===a&&(a=null);void 0===b&&(b={});this.geometry=a;this.attributes=b;c&&(this.centroid=
c)}}();r.OptimizedFeature=C;r.convertToPoint=function(a,b,c){return b?c?Q(a):O(a):c?P(a):H(a)};r.convertToMultipoint=R;r.convertToPolyline=S;r.convertToPolygon=T;r.convertFromFeatures=U;r.convertToFeatureSet=function(a){var b=[],c=a.objectIdFieldName,d=a.spatialReference,f=a.transform,e=a.fields,g=a.hasM,h=a.hasZ,m=a.features,l=a.geometryType;a=a.exceededTransferLimit;switch(l){case "esriGeometryPoint":b=H;g&&h?b=Q:g?b=O:h&&(b=P);for(var n=[],k=0;k<m.length;k++){var p=m[k],q=p.geometry,p=p.attributes,
q=q?b(q):null;n.push({attributes:p,geometry:q})}b=n;break;case "esriGeometryMultipoint":b=[];for(n=0;n<m.length;n++)q=m[n],k=q.geometry,q=q.attributes,p=void 0,k&&(p=R(k,h,g)),b.push({attributes:q,geometry:p});break;case "esriGeometryPolyline":b=[];for(n=0;n<m.length;n++)q=m[n],k=q.geometry,q=q.attributes,p=void 0,k&&(p=S(k,h,g)),b.push({attributes:q,geometry:p});break;case "esriGeometryPolygon":b=[];for(n=0;n<m.length;n++){var p=m[n],q=p.geometry,k=p.attributes,r=p.centroid,p=void 0;q&&(p=T(q,h,
g));r?(q=H(r),b.push({attributes:k,centroid:q,geometry:p})):b.push({attributes:k,geometry:p})}break;default:I.error("convertToFeatureSet:unknown-geometry",new E("Unable to parse unknown geometry type "+l))}c={features:b,fields:e,geometryType:l,objectIdFieldName:c,spatialReference:d};f&&(c.transform=f);a&&(c.exceededTransferLimit=a);g&&(c.hasM=g);h&&(c.hasZ=h);return c};r.convertFromFeatureSet=function(a){var b=new ba,c=a.hasM,d=a.hasZ,f=a.features,e=a.objectIdFieldName,g=a.spatialReference,h=a.geometryType,
m=a.exceededTransferLimit,l=a.transform;b.fields=a.fields;b.geometryType=h;b.objectIdFieldName=e;b.spatialReference=g;b.features=U(f,h,d,c);m&&(b.exceededTransferLimit=m);c&&(b.hasM=c);d&&(b.hasZ=d);l&&(b.transform=l);return b};r.hydrateOptimizedFeatureSet=function(a){var b=a.transform,c=a.hasM,d=a.hasZ;if(!b)return a;for(var f=0,e=a.features;f<e.length;f++){var g=e[f];M(g.geometry,g.geometry,c,d,b);g.centroid&&M(g.centroid,g.centroid,c,d,b)}a.transform=null;return a};r.quantizeOptimizedFeatureSet=
function(a,b){var c=b.geometryType,d=b.features,f=b.hasM,e=b.hasZ;if("esriGeometryEnvelope"===c)return I.error(new E("optimized-features:invalid-geometry-type",'FeatureSet with geometry type "'+c+'" is not supported')),b;if(!a)return b;for(var g=0;g<d.length;g++){var h=d[g],m=new C(new x,h.attributes);J(m.geometry,h.geometry,f,e,c,a);h.centroid&&(m.centroid=new x,J(m.centroid,h.centroid,f,e,"esriGeometryPoint",a));d[g]=m}b.transform=a;return b};r.quantizeOptimizedGeometry=J;r.quantizeOptimizedGeometryRemoveCollinear=
function(a,b,c,d,f,e){f=V[f];var g=b.coords;b=b.lengths;var h=c?d?4:3:d?3:2;c=c?d?K:D:d?D:L;a.lengths.length&&(a.lengths.length=0);a.coords.length&&(a.coords.length=0);if(!g.length)return a;if(!b.length)return c(a.coords,g,0,0,A(e,g[0]),B(e,g[1])),a.lengths.length&&(a.lengths.length=0),a.coords.length=h,a;for(var m,l,n,k=0,p,q=0,r=0;r<b.length;r++){var v=b[r];if(!(v<f)){var t=0;p=q;d=m=A(e,g[k]);n=l=B(e,g[k+1]);c(a.coords,g,p,k,d,n);t++;for(var k=k+h,w=!1,y=0,u=0,x=1;x<v;x++,k+=h)if(d=A(e,g[k]),n=
B(e,g[k+1]),d!==m||n!==l)m=d-m,l=n-l,w&&(0===y&&0===m||0===u&&0===l)?(y+=m,u+=l):(w=!0,y=m,u=l,p+=h,t++),c(a.coords,g,p,k,y,u),m=d,l=n;w&&(p+=h,c(a.coords,g,p,k,y,u));t>=f&&(a.lengths.push(t),q=p)}}a.coords.length!==q&&(a.coords.length=q);return a.coords.length?a:null};r.getBoundsOptimizedGeometry=function(a,b,c,d){c=c?d?4:3:d?3:2;b=b.coords;for(var f=d=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,g=Number.NEGATIVE_INFINITY,h=0;h<b.length;h+=c){var m=b[h],l=b[h+1];d=Math.min(d,m);e=Math.max(e,
m);f=Math.min(f,l);g=Math.max(g,l)}a[0]=d;a[1]=f;a[2]=e;a[3]=g;return a};r.getQuantizedBoundsOptimizedGeometry=function(a,b,c,d){c=c?d?4:3:d?3:2;d=b.coords;var f=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,m=0,l=0;for(b=b.lengths;l<b.length;l++)for(var n=b[l],k=d[m],p=d[m+1],f=Math.min(k,f),e=Math.min(p,e),g=Math.max(k,g),h=Math.max(p,h),m=m+c,q=1;q<n;q++,m+=c){var r=d[m],v=d[m+1],k=k+r,p=p+v;0>r&&(f=Math.min(f,k));0<r&&(g=Math.max(g,k));
0>v?e=Math.min(e,p):0<v&&(h=Math.max(h,p))}a[0]=f;a[1]=e;a[2]=g;a[3]=h;return a};r.hydrateOptimizedGeometry=M;r.getCentroidOptimizedGeometry=function(a,b,c,d){if(!b||!b.lengths.length)return null;a.lengths.length&&(a.lengths.length=0);a.coords.length&&(a.coords.length=0);for(var f=a.coords,e=[],g=c?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,
Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],h=b.lengths,m=b.coords,l=c?d?4:3:d?3:2,n=0,k=0;k<h.length;k++){var p=h[k],q=ga(g,m,n,p,c,d);q&&e.push(q);n+=p*l}e.sort(function(a,b){var d=a[2]-b[2];0===d&&c&&(d=a[4]-b[4]);return d});e.length&&(l=6*e[0][2],f[0]=e[0][0]/l,f[1]=e[0][1]/l,c&&(l=6*e[0][4],f[2]=0!==l?e[0][3]/l:0),f[0]<g[0]||f[0]>g[1]||f[1]<g[2]||f[1]>g[3]||c&&(f[2]<g[4]||f[2]>g[5]))&&(f.length=0);if(!f.length)if(b=b.lengths[0]?W(m,0,h[0],c,d):null)f[0]=b[0],f[1]=b[1],c&&2<b.length&&(f[2]=
b[2]);else return null;return a};r.lineCentroid=W;r.getLength2D=Y;r.getLength3D=X;r.getMidpoint2D=aa;r.getMidpoint3D=Z});