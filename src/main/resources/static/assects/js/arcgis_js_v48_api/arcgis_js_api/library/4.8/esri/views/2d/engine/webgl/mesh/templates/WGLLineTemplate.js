// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../color ../../definitions ../../enums ../../enums ../../LineTess ../../number ../../TileClipper ../../Utils ../../WGLDisplayRecord ./WGLMeshTemplate".split(" "),function(B,J,M,N,O,P,k,Q,c,z,R,K,S,T){Object.defineProperty(J,"__esModule",{value:!0});var H=N.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate"),E=c.allocTriangles(20),I=c.allocTriangles(20),F=[c.allocExtrudeVectors(),c.allocExtrudeVectors()],
L=c.allocExtrudeVectors(),G=P.TILE_SIZE+8,l=new c.Tessellator({distanceAlongCorrection:!0}),D=new R.TileClipper(0,0,0,1,8);D.setExtent(512);B=function(B){function p(d,b,a,e,f,g,x,h,v,c,r){var m=B.call(this)||this;m.capType=g;m.joinType=x;m.fillColor=h;m.tl=v;m.br=c;m.hasPattern=r;m.geometryType=k.WGLGeometryType.LINE;m.halfWidth=0<e?.5*(e+1/f):0;m._materialStore=d;m.vvFlags=b;m.materialId=m._materialStore.createSpriteMaterial(a,m.geometryType,b);return m}M(p,B);p.fromSimpleLine=function(d,b,a,e,f){var g=
a.color,x=K.getCapType(a.cap||"round"),h=K.getJoinType(a.join||"round"),g=g&&"none"!==a.style&&O.premultiplyAlphaRGBA(g)||0;"none"===a.style&&(g=0);if(!e)return new p(d,b,e,a.width,f,x,h,g,0,0,!1);var c=e.rect,q=c.x+1+e.width,r=c.y+1+e.height,c=z.i1616to32(c.x+1,c.y+1),q=z.i1616to32(q,r);return new p(d,b,e,a.width,f,x,h,g,c,q,!0)};p.fromPictureLineSymbol=function(d,b,a,e){H.error("PictureLineSymbol support does not exist!");return null};p.prototype.writeMesh=function(d,b,a,e,f,g,x){if(this.vvFlags&
Q.WGLVVFlag.COLOR||0!==this.fillColor){g=this._materialStore.get(this.materialId);var h=b.indexVector;b=b.get("geometry");var c=this.halfWidth,q=new S(e,this.geometryType,this.materialId),r=this._getOffset(b,g);q.vertexFrom=r;q.indexFrom=h.length;d.push(q);switch(a){case "esriGeometryPolyline":d=this._clipLines(f.geometry.paths);this._write(q,h,b,r,e,c,d,g,x);break;case "esriGeometryPolygon":d=this._clipLines(f.geometry.rings);this._write(q,h,b,r,e,c,d,g,x);break;default:H.error("Unable to handle geometryType: "+
a)}}};p.prototype._clipLines=function(d){for(var b=[],a=!1,e=0;e<d.length;){var f=[],g=d[e];D.reset(2);var c=g[0],h=c[0],c=c[1];if(a)D.moveTo(h,c);else{if(-8>h||h>G||-8>c||c>G){a=!0;continue}f.push({x:h,y:c})}for(var l=!1,q=g.length,r=1;r<q;++r)if(h+=g[r][0],c+=g[r][1],a)D.lineTo(h,c);else{if(-8>h||h>G||-8>c||c>G){l=!0;break}f.push({x:h,y:c})}if(l)a=!0;else{if(a){if(f=D.resultWithStarts())for(a=0;a<f.length;a++)b.push(f[a])}else b.push({line:f,start:0});e++;a=!1}}return b};p.prototype._getOffset=
function(d,b){b=b.materialKeyInfo.hasVV()?11:8;return d.length/b};p.prototype._write=function(d,b,a,e,f,g,x,h,p){for(var q=0,r=0;r<x.length;r++){var m=x[r],A=m.line;if(!(2>A.length))for(var n=A[0],w=A[A.length-1],C=w.x-n.x,n=w.y-n.y,C=1E-6>C*C+n*n,k=m.start%65535,m=F[1],n=0;n<A.length;n++){var y=A[n],w=m===F[n%2]?F[(n+1)%2]:F[n%2],t=0===n,u=n===A.length-1;u&&C&&!this.hasPattern?c.copyExtrudeVectors(w,L):(this._computeExtrudeVectors(w,n,A,C),q+=this._writeVertices(a,f,g,y.x,y.y,w,k,q,h,p),!w.capCenter||
C&&u||this._writePieIndices(d,b,e,w),C&&t&&!this.hasPattern&&c.copyExtrudeVectors(L,w));t||this._writeBridgeIndices(d,b,e,m,w);if(!u){var u=A[n+1],t=[u.x-y.x,u.y-y.y],v=c.length(t),t=[t[0]/v,t[1]/v],v=k+v;if(65535<v){var z=(65535-k)/(v-k),k=y.x+(u.x-y.x)*z,y=y.y+(u.y-y.y)*z,u=m;l.buttCap(u,t,t);q+=this._writeVertices(a,f,g,k,y,u,65535,q,h,p);l.bridge(E,w,u);this._writeBridgeIndices(d,b,e,w,u);l.buttCap(u,t,t);k=v-65535}else k=v,m=w}}}d.vertexCount=q};p.prototype._writeVertices=function(d,b,a,e,f,
c,x,h,l,p){var g=0,m=z.i1616to32(e,f),k=c.vectors;c=k.items;for(k=k.count;g<k;++g){var n=c[g].vector,q=n[0],n=n[1],v=c[g].texCoords,B=v[0],y=v[1],t=c[g].direction,v=t[0],u=t[1],t=z.i1616to32(x,31*a),q=z.i8888to32(Math.round(31*q),Math.round(31*n),Math.round(31*B),Math.round(31*y)),n=z.i8888to32(Math.round(31*v),Math.round(31*u),0,0);d.push(m);d.push(b);d.push(this.fillColor);d.push(q);d.push(t);d.push(this.tl);d.push(this.br);d.push(n);this._writeVV(d,p,l);c[g].base={index:h+g,point:[e,f]}}return g};
p.prototype._writeVV=function(d,b,a){a.materialKeyInfo.hasVV()&&(d.push(b[k.VVType.SIZE]),d.push(b[k.VVType.COLOR]),d.push(b[k.VVType.OPACITY]))};p.prototype._writeBridgeIndices=function(d,b,a,c,f){l.bridge(E,c,f);for(c=0;c<E.count;++c)f=E.items[c],b.push(a+f.v1.base.index),b.push(a+f.v2.base.index),b.push(a+f.v3.base.index),d.indexCount+=3};p.prototype._writePieIndices=function(c,b,a,e){l.pie(I,e);for(e=0;e<I.count;++e){var d=I.items[e];b.push(a+d.v1.base.index);b.push(a+d.v2.base.index);b.push(a+
d.v3.base.index);c.indexCount+=3}};p.prototype._computeExtrudeVectors=function(d,b,a,e){var f=a[b],g=[void 0,void 0],k=[void 0,void 0];if(0<b&&b<a.length-1){var h=a[(b+a.length-1)%a.length],l=a[(b+1)%a.length];c.normalize(g,[f.x-h.x,f.y-h.y]);c.normalize(k,[l.x-f.x,l.y-f.y])}else if(0===b)l=a[(b+1)%a.length],c.normalize(k,[l.x-f.x,l.y-f.y]),e?(h=a[a.length-2],c.normalize(g,[f.x-h.x,f.y-h.y])):g=k;else if(b===a.length-1)h=a[(b+a.length-1)%a.length],c.normalize(g,[f.x-h.x,f.y-h.y]),e?(h=a[1],c.normalize(k,
[h.x-f.x,h.y-f.y])):k=g;else{console.error("Vertex index 'i' out of range.");return}e||0!==b?e||b!==a.length-1?this._computeJoinExtrudeVectors(d,g,k):this._computeCapExtrudeVectors(d,g,k,c.CapPosition.END):this._computeCapExtrudeVectors(d,g,k,c.CapPosition.START)};p.prototype._computeCapExtrudeVectors=function(d,b,a,e){switch(this.capType){case k.CapType.BUTT:l.buttCap(d,b,a);break;case k.CapType.ROUND:var f=c.getNumberOfSlices(Math.PI);l.roundCap(d,b,a,e,f,e===c.CapPosition.START?-1:1);break;case k.CapType.SQUARE:l.squareCap(d,
b,a,e);break;default:H.error("Encountered unknown cap type: "+this.capType+", defaulting to BUTT"),l.buttCap(d,b,a)}};p.prototype._computeJoinExtrudeVectors=function(d,b,a){var e=c.getRads(b,a);if(e>Math.PI-.05)l.rectJoin(d,b,a);else if(this.joinType===k.JoinType.MITER||.1>e).05>e?l.fastMiterJoin(d,b,a):e<c.MITER_SAFE_RADS?l.miterJoin(d,b,a):l.bevelJoin(d,b,a,c.SYSTEM_MAG_LIMIT);else if(this.joinType===k.JoinType.BEVEL)l.bevelJoin(d,b,a,1);else if(this.joinType===k.JoinType.ROUND){var f=c.getNumberOfSlices(e);
2.3>e?2>f||.5>e?l.bevelJoin(d,b,a,1):l.roundJoin(d,b,a,f):l.unitRoundJoin(d,b,a,f)}};return p}(T.default);J.default=B});