// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper dojo/i18n!./Feature/nls/Feature dojo/keys ../core/promiseUtils ../core/watchUtils ../core/accessorSupport/decorators ./Widget ./Feature/FeatureViewModel ./Feature/support/attachmentUtils ./support/uriUtils ./support/widget".split(" "),function(w,D,x,l,p,r,y,z,q,A,t,u,B,d){function e(d,b){return void 0===b?"esri-feature__"+d:"esri-feature__"+d+"-"+b}return function(v){function b(a){a=v.call(this)||this;
a._chartMap=new Map;a._activeMediaMap=new Map;a._chartRequirePromise=null;a._refreshTimers=new Map;a._mediaInfo=new Map;a.contentEnabled=null;a.graphic=null;a.title=null;a.view=null;a.viewModel=new t;return a}x(b,v);b.prototype.postInitialize=function(){var a=this;this.own(z.init(this,"viewModel.content",function(){return a._setupMediaRefreshTimers()}))};b.prototype.destroy=function(){this._clearMediaRefreshTimers();this._activeMediaMap.clear();this._activeMediaMap=null;this._cancelChartModules();
this._destroyCharts()};b.prototype.render=function(){var a=d.tsx("div",{key:e("loading-container"),class:"esri-feature__loading-container"},d.tsx("span",{class:this.classes("esri-icon-loading-indicator esri-rotating","esri-feature__loading-spinner")})),a=this.viewModel.waitingForContent?a:this._renderContent();return d.tsx("div",{class:"esri-feature"},d.tsx("div",{class:"esri-feature__size-container"},d.tsx("div",{class:"esri-feature__main-container"},a)))};b.prototype.goToMedia=function(a,c){this._setContentElementMedia(a,
c)};b.prototype.nextMedia=function(a){this._pageContentElementMedia(a,"next")};b.prototype.previousMedia=function(a){this._pageContentElementMedia(a,"previous")};b.prototype._cancelChartModules=function(){var a=this._chartRequirePromise;a&&a.cancel();this._chartRequirePromise=null};b.prototype._destroyChart=function(a){var c=this._chartMap.get(a);c&&(c.chart.destroy(),c.tooltip.destroy());this._chartMap.delete(a)};b.prototype._destroyCharts=function(){this._chartMap.forEach(function(a){a.chart.destroy();
a.tooltip.destroy()});this._chartMap.clear()};b.prototype._renderContent=function(){this._destroyCharts();var a=this.viewModel.content;if("string"===typeof a)return d.tsx("div",{key:e("content-string"),innerHTML:a});if(d.isWidget(a))return d.tsx("div",{key:e("content-widget")},a.render());if(a instanceof HTMLElement)return d.tsx("div",{key:e("content-html-element"),bind:a,afterCreate:this._attachToNode});if(d.isWidgetBase(a))return d.tsx("div",{key:e("content-dijit"),bind:a.domNode,afterCreate:this._attachToNode});
if(Array.isArray(a))return a.length?d.tsx("div",{key:e("content-content-elements")},a.map(this._renderContentElement,this)):null};b.prototype._renderContentElement=function(a,c){switch(a.type){case "attachments":return this._renderAttachments(a,c);case "fields":return this._renderFields(a,c);case "media":return this._renderMedia(a,c);case "text":return this._renderText(a,c);default:return null}};b.prototype._renderAttachmentInfo=function(a){var c,m,f=a.attachmentInfo,b=a.supportsResizeAttachments,
g=f.contentType;a=f.name;var e=f.url,n=b&&u.isSupportedImage(g),C=-1===e.indexOf("?")?"?":"\x26",g=n?""+e+C+"w\x3d48":u.getIconPath(g),n=(c={},c["esri-feature__attachment-item-mask--icon"]=!n,c);c=(m={},m["esri-feature__attachments-image--resizable"]=b,m);return d.tsx("li",{class:"esri-feature__attachments-item",key:f},d.tsx("a",{class:"esri-feature__attachments-item-link",href:e,target:"_blank"},d.tsx("div",{class:this.classes(n,"esri-feature__attachment-item-mask")},d.tsx("img",{alt:a,class:this.classes(c,
"esri-feature__attachments-image"),title:a,src:g}),d.tsx("span",{class:"esri-feature__attachments-image-overlay"},d.tsx("span",{"aria-hidden":"true",class:"esri-feature__attachments-link-icon esri-icon-link-external"}))),d.tsx("span",{class:"esri-feature__attachments-filename"},a||p.noTitle)))};b.prototype._renderAttachments=function(a,c){var m=this,f,b=a.displayType,g=(c=a.attachmentInfos)&&c.length,k=this.get("graphic.layer.capabilities.operations.supportsResizeAttachments"),b=(f={},f["esri-feature__attachments--list"]=
"preview"!==b,f["esri-feature__attachments--preview"]="preview"===b,f);return g?d.tsx("div",{key:e("attachments-element"),class:this.classes("esri-feature__attachments","esri-feature__content-element",b)},d.tsx("div",{class:"esri-feature__attachments-title"},p.attach),d.tsx("ul",{class:"esri-feature__attachments-items"},c.map(function(c,b){return m._renderAttachmentInfo({attachmentInfo:c,attachmentInfoIndex:b,supportsResizeAttachments:k,contentElement:a})}))):null};b.prototype._forceLTR=function(a){return"\x26lrm;"+
a};b.prototype._renderFieldInfo=function(a,c){var m,b=this.viewModel.formattedAttributes,h=b?b.content[c]||b.global:null,g=a.fieldName,b=a.label||g,h=h?null==h[g]?"":h[g]:"";a=!(!a.format||!a.format.dateFormat);h="number"!==typeof h||a?B.autoLink(h):this._forceLTR(h);a=(m={},m["esri-feature__field-data--date"]=a,m);return d.tsx("tr",{key:e("fields-element-info-row",c)},d.tsx("th",{key:e("fields-element-info-row-header",c),class:"esri-feature__field-header",innerHTML:b}),d.tsx("td",{key:e("fields-element-info-row-data",
c),class:this.classes("esri-feature__field-data",a),innerHTML:h}))};b.prototype._renderFields=function(a,c){var b=this;return(a=a.fieldInfos)?d.tsx("div",{key:e("fields-element",c),class:this.classes("esri-feature__fields","esri-feature__content-element")},d.tsx("table",{class:"esri-widget__table",summary:p.fieldsSummary,key:e("fields-element-table",c)},d.tsx("tbody",{key:e("fields-element-table-body",c)},a.map(function(a){return b._renderFieldInfo(a,c)})))):null};b.prototype._shouldOpenInNewTab=
function(a){void 0===a&&(a="");return!/^(?:mailto:|tel:)/.test(a.trim().toLowerCase())};b.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(a){return clearTimeout(a)});this._refreshTimers.clear()};b.prototype._clearMediaRefreshTimer=function(a){var c=this._refreshTimers.get(a);c&&(clearTimeout(c),this._refreshTimers.delete(a))};b.prototype._getImageSource=function(a,c){var b=-1!==a.indexOf("?")?"\x26":"?";a=a.split("#");var d=a[1],d=void 0===d?"":d;return""+a[0]+b+
"timestamp\x3d"+c+(d?"#":"")+d};b.prototype._setupMediaRefreshTimer=function(a){var c=this.get("viewModel.content");if(Array.isArray(c)&&(c=c[a])&&"media"===c.type){var b=this._activeMediaMap.get(a);isNaN(b)&&(b=0);(c=c.mediaInfos[b])&&"image"===c.type&&c.refreshInterval&&this._setRefreshTimeout(a,c)}};b.prototype._setupMediaRefreshTimers=function(){var a=this;this._clearMediaRefreshTimers();var c=this.get("viewModel.content");Array.isArray(c)&&c.forEach(function(c,b){return a._setupMediaRefreshTimer(b)})};
b.prototype._updateMediaInfoTimestamp=function(a,c){var b=Date.now();this._mediaInfo.set(c,{timestamp:b,sourceURL:this._getImageSource(a,b)});this.scheduleRender()};b.prototype._setRefreshTimeout=function(a,c){var b=this,d=c.refreshInterval,e=c.value;d&&(c=6E4*d,this._updateMediaInfoTimestamp(e.sourceURL,a),c=setInterval(function(){b._updateMediaInfoTimestamp(e.sourceURL,a)},c),this._refreshTimers.set(a,c))};b.prototype._renderMediaInfoType=function(a,c){var b=a.value,f=a.title,f=void 0===f?"":f,
h=a.type,g=a.refreshInterval,k=b.sourceURL,b=b.linkURL;if("image"===h)return a=this._shouldOpenInNewTab(b)?"_self":"_blank",k=(g=g?this._mediaInfo.get(c):null)?g.sourceURL:k,c=d.tsx("img",{alt:f,key:e("media-image-"+(g?g.timestamp:0),c),src:k}),(f=b?d.tsx("a",{title:f,href:b,target:a},c):null)?f:c;if(-1!==h.indexOf("chart"))return d.tsx("div",{key:e("chart",c),bind:this,"data-media-info":a,"data-content-element-index":c,class:"esri-feature__media-chart",afterCreate:this._getChartDependencies,afterUpdate:this._getChartDependencies})};
b.prototype._getChartDependencies=function(a){var c=this,b=a["data-media-info"],d=a["data-content-element-index"],e=b.value,g=e.theme||"Claro",k=b.type,n=g;"string"===typeof g&&(n=g.replace(/\./g,"/"));this._cancelChartModules();this._chartRequirePromise=y.create(function(a){return w(["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip","dojox/charting/themes/"+n],function(){for(var c=[],b=0;b<arguments.length;b++)c[b]=arguments[b];return a(c)})}).then(function(b){c._renderChart(a,d,k,e,b[0],
b[1],b[2]);c._chartRequirePromise=null})};b.prototype._renderChart=function(a,c,b,d,e,g,k){a=new e(a,{margins:{l:4,t:4,r:4,b:4}});k&&a.setTheme(k);switch(b){case "pie-chart":a.addPlot("default",{type:"Pie",labels:!1});a.addSeries("Series A",d.chartOptions);break;case "line-chart":a.addPlot("default",{type:"Markers"});a.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1});a.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});d.chartOptions.forEach(function(a,c){a.x=
c+1});a.addSeries("Series A",d.chartOptions);break;case "column-chart":a.addPlot("default",{type:"Columns",gap:3});a.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});a.addSeries("Series A",d.chartOptions);break;case "bar-chart":a.addPlot("default",{type:"Bars",gap:3}),a.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),a.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),a.addSeries("Series A",d.chartOptions)}b=new g(a);a.render();this._chartMap.set(c,
{chart:a,tooltip:b})};b.prototype._renderMediaInfo=function(a,c){this._destroyChart(c);var b=this._renderMediaInfoType(a,c),f=a.title?d.tsx("div",{key:e("media-title",c),class:"esri-feature__media-item-title",innerHTML:a.title}):null;a=a.caption?d.tsx("div",{key:e("media-caption",c),class:"esri-feature__media-item-caption",innerHTML:a.caption}):null;return d.tsx("div",{key:e("media-container",c),class:"esri-feature__media-item-container"},d.tsx("div",{key:e("media-item-container",c),class:"esri-feature__media-item"},
b),f,a)};b.prototype._renderMediaStatsItem=function(a,c,b){b="chart"===b?this.classes("esri-feature__media-chart-icon","esri-icon-chart"):this.classes("esri-feature__media-image-icon","esri-icon-media");return d.tsx("li",{class:"esri-feature__media-image-summary"},d.tsx("span",{"aria-hidden":"true",class:b}),d.tsx("span",{class:"esri-feature__media-count","aria-label":a},"("+c+")"))};b.prototype._renderMediaPageButton=function(a,c){var b=(a="previous"===a)?p.previous:p.next,f=a?this.classes("esri-feature__button",
"esri-feature__media-previous"):this.classes("esri-feature__button","esri-feature__media-next"),h=a?this.classes("esri-feature__icon","esri-feature__media-previous-icon","esri-icon-left-triangle-arrow"):this.classes("esri-feature__icon","esri-feature__media-next-icon","esri-icon-right-triangle-arrow"),g=a?this.classes("esri-feature__icon","esri-feature__media-previous-icon--rtl","esri-icon-right-triangle-arrow"):this.classes("esri-feature__icon","esri-feature__media-next-icon--rtl","esri-icon-left-triangle-arrow"),
k=a?this._previousClick:this._nextClick;return d.tsx("div",{key:e(a?"previous":"next",c),title:b,tabIndex:0,role:"button",class:f,"data-content-element-index":c,bind:this,onkeydown:k,onclick:k},d.tsx("span",{"aria-hidden":"true",class:h}),d.tsx("span",{"aria-hidden":"true",class:g}),d.tsx("span",{class:"esri-icon-font-fallback-text"},b))};b.prototype._handleMediaKeyup=function(a){var c=a.currentTarget["data-content-element-index"],b=a.keyCode;b===r.LEFT_ARROW&&(a.stopPropagation(),this.previousMedia(c));
b===r.RIGHT_ARROW&&(a.stopPropagation(),this.nextMedia(c))};b.prototype._renderMedia=function(a,b){var c;a=a.mediaInfos;var f=this._getMediaStats(a),h=f.total,g=(c={},c["esri-feature--media-pagination-visible"]=1<f.total,c);c=this._renderMediaStatsItem(p.numImages,f.images,"image");var f=this._renderMediaStatsItem(p.numCharts,f.charts,"chart"),k=this._renderMediaPageButton("previous",b),n=this._renderMediaPageButton("next",b),l=this._activeMediaMap.get(b);isNaN(l)&&(this._activeMediaMap.set(b,0),
l=0);return h?d.tsx("div",{key:e("media-element",b),"data-content-element-index":b,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes("esri-feature__media","esri-feature__content-element",g)},d.tsx("ul",{class:"esri-feature__media-summary"},c,f),d.tsx("div",{key:e("media-element-container",b),class:"esri-feature__media-container"},k,this._renderMediaInfo(a[l],b),n)):null};b.prototype._renderText=function(a,b){return a.text?d.tsx("div",{key:e("text-element",b),innerHTML:a.text,class:this.classes("esri-feature__text",
"esri-feature__content-element")}):null};b.prototype._attachToNode=function(a){a.appendChild(this)};b.prototype._getMediaStats=function(a){var b=0,d=0;a.forEach(function(a){a=a.type;"image"===a?b++:-1!==a.indexOf("chart")&&d++});return{total:d+b,images:b,charts:d}};b.prototype._setContentElementMedia=function(a,b){this._clearMediaRefreshTimer(a);var c=this.viewModel.content;(c=(c=c&&c[a])&&c.mediaInfos)&&c.length&&(this._activeMediaMap.set(a,(b+c.length)%c.length),this._setupMediaRefreshTimer(a),
this.scheduleRender())};b.prototype._pageContentElementMedia=function(a,b){b="previous"===b?-1:1;b=this._activeMediaMap.get(a)+b;this._setContentElementMedia(a,b)};b.prototype._previousClick=function(a){this.previousMedia(a.currentTarget["data-content-element-index"])};b.prototype._nextClick=function(a){this.nextMedia(a.currentTarget["data-content-element-index"])};l([q.aliasOf("viewModel.contentEnabled")],b.prototype,"contentEnabled",void 0);l([q.aliasOf("viewModel.graphic")],b.prototype,"graphic",
void 0);l([q.aliasOf("viewModel.title")],b.prototype,"title",void 0);l([q.aliasOf("viewModel.view")],b.prototype,"view",void 0);l([q.property({type:t}),d.renderable(["viewModel.waitingForContent","viewModel.content"])],b.prototype,"viewModel",void 0);l([d.accessibleHandler()],b.prototype,"_previousClick",null);l([d.accessibleHandler()],b.prototype,"_nextClick",null);return b=l([q.subclass("esri.widgets.Feature")],b)}(q.declared(A))});