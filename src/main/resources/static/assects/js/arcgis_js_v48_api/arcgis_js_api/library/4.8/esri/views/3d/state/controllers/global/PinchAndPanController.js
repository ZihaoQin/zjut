// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../camera/constraintUtils ../../../input/util ../../../lib/glMatrix ../InteractiveController ../momentum/PanPlanarMomentumController ../momentum/PanSphericalMomentumController ../momentum/RotationMomentumController ../momentum/ZoomPlanarMomentumController ../momentum/ZoomSphericalMomentumController ../../utils/navigationUtils ../../utils/navigationUtils ../../../webgl-engine/lib/Camera ../../../../navigation/PanPlanarMomentumEstimator ../../../../navigation/PanSphericalMomentumEstimator ../../../../navigation/RotationMomentumEstimator ../../../../navigation/ZoomMomentumEstimator".split(" "),
function(h,l,n,g,m,d,p,q,r,t,u,v,e,k,w,x,y,z,A){Object.defineProperty(l,"__esModule",{value:!0});h=function(h){function f(a,c){var b=h.call(this)||this;b.view=a;b.pickingHelper=c;b.smoothRotation=new m.ExponentialFalloff(.05);b.rotationAxis=d.vec3d.create();b.panningPlane={normal:d.vec3d.create(),d:0};b.smoothScaling=new m.ExponentialFalloff(.05);b.zoomCenterScreen=d.vec2d.create();b.zoomMomentumEstimator=new A.ZoomMomentumEstimator;b.rotationMomentumEstimator=new z.RotationMomentumEstimator;b.panSphericalMomentumEstimator=
new y.PanSphericalMomentumEstimator;b.panPlanarMomentumEstimator=new x.PanPlanarMomentumEstimator;b.adjustedSphere={center:d.vec3d.create(),radius:0};b.tmp2d=d.vec2d.create();b.tmp3d=d.vec3d.create();b.tmpMat=d.mat4d.create();b.beginScreenPoint=d.vec2d.create();b.beginScenePoint=d.vec3d.create();b.screenPickPoint=d.vec2d.create();b.panMode=k.PanMode.Horizontal;b.tmpInteractionDirection=d.vec3d.create();b.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new w,
interactionDirection:null};return b}n(f,h);f.prototype.begin=function(a){if(this.active){this.beginRadius=a.radius;this.pointerCount=a.pointers.size;this.beginAngle=a.angle;this.smoothRotation.reset();e.navPointToScreenPoint(this.currentCamera,a.center,this.screenPickPoint);d.vec2d.set(this.screenPickPoint,this.beginScreenPoint);var c=e.pickPointAndInitSphere(this.pickingHelper,this.beginCamera,this.screenPickPoint,!0);this.scenePickPoint=c.scenePickPoint;this.sphere=c.sphere;d.vec3d.set(this.scenePickPoint,
this.beginScenePoint);this.panMode=e.decidePanMode(this.beginCamera,this.sphere,this.scenePickPoint);this.panMode===k.PanMode.Vertical&&(this.beginCamera.aboveGround?this.preparePlanarPanModeOverground(a):this.preparePlanarPanMode(a));this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}};f.prototype.preparePlanarPanModeOverground=function(a){d.vec3d.set(this.beginCamera.viewForward,this.panningPlane.normal);d.vec3d.normalize(this.panningPlane.normal);d.vec3d.negate(this.panningPlane.normal);
e.setPlane(this.scenePickPoint,this.panningPlane.normal,this.panningPlane);var c=d.vec3d.create();d.vec3d.set3(this.screenPickPoint[0],this.currentCamera.fullHeight,0,c);var b=d.vec3d.create(),f=d.vec3d.length(this.beginCamera.eye);this.adjustedSphere.radius=f<this.sphere.radius?f-100:this.sphere.radius;e.sphereOrSilhouettePointFromScreenPoint(this.adjustedSphere,this.beginCamera,c,b);this.beginCamera.projectPoint(b,c);this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],.9*c[1]);this.pickingHelper.pickPointInScreen(this.screenPickPoint,
this.scenePickPoint)&&e.setPlane(this.scenePickPoint,this.panningPlane.normal,this.panningPlane);e.navPointToScreenPoint(this.currentCamera,a.center,this.tmp2d);e.intersectPlaneFromScreenPoint(this.panningPlane,this.beginCamera,this.tmp2d,this.beginScenePoint)};f.prototype.preparePlanarPanMode=function(a){d.vec3d.set(this.beginCamera.viewForward,this.panningPlane.normal);d.vec3d.normalize(this.panningPlane.normal);d.vec3d.negate(this.panningPlane.normal);e.setPlane(this.scenePickPoint,this.panningPlane.normal,
this.panningPlane);var c=e.computeHorizonSphereCapAngle(this.sphere,this.currentCamera.eye),b=this.tmp3d,c=-e.rotationAndAxisFromPoints(this.currentCamera.eye,this.scenePickPoint,b)-(this.currentCamera.aboveGround?.25:.025)*c;if(0<c){var f=d.mat4d.identity(this.tmpMat);d.mat4d.rotate(f,-c,b);d.vec3d.subtract(this.scenePickPoint,this.sphere.center);d.mat4d.multiplyVec3(f,this.scenePickPoint,this.scenePickPoint);d.vec3d.add(this.scenePickPoint,this.sphere.center);e.setPlane(this.scenePickPoint,this.panningPlane.normal,
this.panningPlane);e.navPointToScreenPoint(this.currentCamera,a.center,this.tmp2d);e.intersectPlaneFromScreenPoint(this.panningPlane,this.beginCamera,this.tmp2d,this.beginScenePoint)}};f.prototype.update=function(a){if(this.active){this.currentCamera.copyFrom(this.beginCamera);var c=1<a.pointers.size;this.panMode===k.PanMode.Horizontal?(c&&this.zoomSpherical(a),this.panningSpherical(a),c&&this.rotateSpherical(a)):(c&&this.zoomPlanar(a),this.panningPlanar(a),c&&this.rotatePlanar(a));this.currentCamera.markViewDirty()}};
f.prototype.end=function(a){a.pointers.size===this.pointerCount&&this.update(a);this.finishController();if(a=this.zoomMomentumEstimator.evaluateMomentum())return this.panMode===k.PanMode.Horizontal?new v.ZoomSphericalMomentumController(this.view,a,this.zoomCenterScreen,this.beginScenePoint,this.sphere.radius):new u.ZoomPlanarMomentumController(this.view,a,this.beginScenePoint);if(a=this.rotationMomentumEstimator.evaluateMomentum())return new t.RotationMomentumController(this.view,a,this.sphere.center,
this.rotationAxis);if(this.panMode===k.PanMode.Horizontal){if(a=this.panSphericalMomentumEstimator.evaluateMomentum())return new r.PanSphericalMomentumController(this.view,a)}else if(a=this.panPlanarMomentumEstimator.evaluateMomentum())return new q.PanPlanarMomentumController(this.view,a);return null};f.prototype.zoomSpherical=function(a){var c=this.beginRadius/a.radius;this.smoothScaling.gain=.001875*Math.min(Math.max(a.radius,40),120);this.smoothScaling.update(c);e.applyZoomOnSphere(this.sphere,
this.currentCamera,this.smoothScaling.value);e.navPointToScreenPoint(this.currentCamera,a.center,this.zoomCenterScreen);this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*a.timestamp);this.constraintOptions.interactionType=1;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(a.radius-this.beginRadius);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};f.prototype.panningSpherical=function(a){e.navPointToScreenPoint(this.currentCamera,a.center,this.tmp2d);
e.sphereOrSilhouettePointFromScreenPoint(this.sphere,this.currentCamera,this.tmp2d,this.tmp3d);e.applyPanSpherical(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d);this.panSphericalMomentumEstimator.add(this.tmp2d,this.tmp3d,.001*a.timestamp);this.constraintOptions.interactionType=4;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(this.screenPickPoint,this.tmp2d);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};f.prototype.rotateSpherical=
function(a){d.vec3d.normalize(this.scenePickPoint,this.rotationAxis);var c=this.smoothRotation.value,b=e.normalizeRotationDelta(a.angle-c),c=c+b;this.smoothRotation.gain=.00125*Math.min(Math.max(a.radius,40),120);this.smoothRotation.update(c);b=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(b,.001*a.timestamp);e.applyRotation(this.currentCamera,this.sphere.center,this.rotationAxis,b);this.constraintOptions.interactionType=2;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(a.radius*
c);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};f.prototype.panningPlanar=function(a){e.navPointToScreenPoint(this.currentCamera,a.center,this.tmp2d);e.intersectPlaneFromScreenPoint(this.panningPlane,this.currentCamera,this.tmp2d,this.tmp3d)&&(e.applyPanPlanar(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(this.tmp2d,this.tmp3d,.001*a.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(this.beginScreenPoint,
this.tmp2d),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),g.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)};f.prototype.zoomPlanar=function(a){var c=this.beginRadius/a.radius;this.smoothScaling.gain=.001875*Math.min(Math.max(a.radius,40),120);this.smoothScaling.update(c);this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*a.timestamp);
e.applyZoomToPoint(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance);this.constraintOptions.interactionType=1;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(a.radius-this.beginRadius);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};f.prototype.rotatePlanar=function(a){d.vec3d.set(this.beginScenePoint,this.rotationAxis);var c=this.smoothRotation.value,b=a.angle-c,b=e.normalizeRotationDelta(b);
this.smoothRotation.gain=.00125*Math.min(Math.max(a.radius,40),120);this.smoothRotation.update(c+b);c=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(c,.001*a.timestamp);e.applyRotation(this.currentCamera,this.sphere.center,this.rotationAxis,c);this.constraintOptions.interactionType=2;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(a.radius*c);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};return f}(p.InteractiveController);
l.PinchAndPanController=h});