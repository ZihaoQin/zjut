// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/accessorSupport/decorators".split(" "),function(p,q,l,g,m,h){function k(d,b){return null!==d&&0<d&&8E7>d||50<b}return function(d){function b(){var a=d.call(this)||this;a._scaleRangeActive=!1;a._layerScaleRangeVisibilityDirty=!0;a.layerScaleRangeVisibilityQuery=!1;a.scaleChangeEventHandle=null;a.layerView=null;a.layer=null;a.queryGraphicUIDsInExtent=
null;a.extent=null;a.graphicsCore=null;a.basemapTerrain=null;a.suspended=!1;return a}l(b,d);Object.defineProperty(b.prototype,"layerScaleRangeVisibilityDirty",{get:function(){return this._layerScaleRangeVisibilityDirty},set:function(a){this._layerScaleRangeVisibilityDirty!==a&&(this._layerScaleRangeVisibilityDirty=a,this.notifyChange("updating"))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty},
enumerable:!0,configurable:!0});b.prototype.setup=function(a,f,b,n,d){this.layerView=a;this.layer=f;this.queryGraphicUIDsInExtent=b;this.graphicsCore=n;this.basemapTerrain=d;this.updateScaleRangeActive()};b.prototype.destroy=function(){this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null);this.graphicsCore=this.queryGraphicUIDsInExtent=this.extent=this.layerView=null};b.prototype.needsIdleUpdate=function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty};
b.prototype.setExtent=function(a){this.extent=a;this.layerScaleRangeVisibilityDirty=!0};b.prototype.idleUpdate=function(a){this.layerView.view.basemapTerrain&&!a.done()&&this.layerScaleRangeVisibilityDirty&&(this.updateSuspendScaleVisible(),this.layerScaleRangeVisibilityDirty=!1)};b.prototype.scaleRangeActive=function(){return this._scaleRangeActive};b.prototype.updateScaleRangeActive=function(){var a=this,f=this.layer,b=!1;f.labelingInfo&&(b=b||f.labelingInfo.some(function(a){return a&&k(a.minScale,
a.maxScale)}));b=b||k(f.minScale,f.maxScale);f=this._scaleRangeActive!==b;(this._scaleRangeActive=b)&&!this.scaleChangeEventHandle&&this.basemapTerrain?this.scaleChangeEventHandle=this.basemapTerrain.on("scale-change",function(b){return a.scaleUpdateHandler(b)}):!b&&this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null);return f};b.prototype.updateSuspendScaleVisibleFinish=function(a){this.layerScaleRangeVisibilityQuery=!1;this._set("suspended",!a)};b.prototype.updateSuspendScaleVisible=
function(){var a=this,b=this.layerView.view.basemapTerrain;this.extent&&b&&this._scaleRangeActive?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,b.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,function(b){return a.updateSuspendScaleVisibleFinish(b)})):this.updateSuspendScaleVisibleFinish(!0)};b.prototype.visibleAtScale=function(a,b,c){return null==a?!0:a>c&&(!b||a<b)};b.prototype.visibleAtLayerScale=function(a){return this.visibleAtScale(a,
this.layer.minScale,this.layer.maxScale)};b.prototype.visibleAtLabelScale=function(a,b){return this.visibleAtScale(a,b.minScale,b.maxScale)};b.prototype.graphicScale=function(a){var b;a.centroid?b=a.centroid:"point"===a.graphic.geometry.type&&(b=a.graphic.geometry);return b?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(b):1:null};b.prototype.graphicVisible=function(a){a=this.graphicScale(a);return this.visibleAtLayerScale(a)};b.prototype.updateGraphicScaleVisibility=
function(a){if(this._scaleRangeActive){var b=this.graphicVisible(a);return a.setVisibilityFlag(1,b)}return!1};b.prototype.updateGraphicLabelScaleVisibility=function(a){if(!this._scaleRangeActive||!a._labelGraphics||0===a._labelGraphics.length)return!1;var b=this.graphicScale(a);if(a=this.updateLabelScaleVisibility(a,b))this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty();return a};b.prototype.updateLabelScaleVisibility=function(a,b){if(!a._labelGraphics||0===a._labelGraphics.length)return!1;
var c=a._labelGraphics[0]._labelClass;return c&&null!=c.minScale&&null!=c.maxScale&&(b=this.visibleAtLabelScale(b,c),a.setVisibilityFlag(1,b,1))?!0:!1};b.prototype.scaleUpdateHandler=function(a){var b=this;if(!this.layerView.suspended){var c=a.extent,d=a.scale,h=this.visibleAtLayerScale(d),g=!1;this.queryGraphicUIDsInExtent(c,a.spatialReference,function(a){if(a=b.graphicsCore.getGraphics3DGraphicById(a)){var e=a.centroid;e&&(c[0]>e.x||c[1]>e.y||c[2]<e.x||c[3]<e.y)||(e=!1,a.setVisibilityFlag(1,h)&&
(e=!0),b.updateLabelScaleVisibility(a,d)&&(e=!0),e&&(g=!0))}});g&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}this.layerScaleRangeVisibilityDirty=!0};b.prototype.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&(this._scaleRangeActive?this.graphicsCore.updateAllGraphicsVisibility():this.graphicsCore.forEachGraphics3DGraphic(function(a){return a.setVisibilityFlag(1,void 0)}));this.layerScaleRangeVisibilityDirty=!0};g([h.property({readOnly:!0})],
b.prototype,"suspended",void 0);g([h.property({readOnly:!0})],b.prototype,"updating",null);return b=g([h.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],b)}(h.declared(m))});