// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/Logger","../layers/support/MemoryManagedLayerView","./Evented"],function(m,n,h,f,k){var l=h.getLogger("esri.views.3d.support.MemoryController");return function(){function b(a){this._view=a;this._minQuality=.1;this._memoryHWM=this._maxQuality=1;this._memoryLWM=.75;this._divideRate=1.3;this._throttle=5;this.events=new k.Evented;this._maxMemory=500;this._quality=1;this._memoryCached=this._memoryCommitted=this._memoryUsed=this._throttled=this._stableQuality=
0;this.updating=!1}b.prototype.setMaxGpuMemory=function(a){a&&0<a&&(this._maxMemory=a,this.setDirty())};b.prototype.getMemoryFactor=function(){return this._quality};b.prototype._updateQuality=function(a){a=Math.min(Math.max(a,this._minQuality),this._maxQuality);if(a===this._quality)return!1;this._quality=a;this.events.emit("quality-changed",this._quality);return!0};b.prototype.getUsedMemory=function(){return this._memoryUsed};b.prototype.setDirty=function(){this._stableQuality=0};b.prototype.update=
function(){this._updateMemory();if(!(0>=this._memoryCommitted)){this._unloadSuspended();this._throttled=Math.max(0,this._throttled-1);var a=this._layersUpdating();if(a){if(this._quality<=this._minQuality)return;if(this._memoryCommitted>1.1*this._memoryHWM||this._memoryUsed>this._memoryHWM)if(0<this._stableQuality)this._updateQuality(this._stableQuality);else if(0===this._throttled||1.05<this._memoryUsed)this._updateQuality(this._quality/this._divideRate),this._throttled=this._throttle}else this._memoryUsed>
this._memoryHWM&&(this._stableQuality=0,a=this._updateQuality(this._quality/this._divideRate)),this._memoryCommitted<this._memoryLWM&&this._quality<this._maxQuality&&this._stableQuality!==this._quality&&(this._stableQuality=this._quality,a=this._updateQuality(this._quality+.1*(this._memoryLWM-this._memoryCommitted+.1)));this.updating!==a&&(this.updating=a,this.events.emit("updating-changed",this.updating))}};b.prototype._layersUpdating=function(){var a=!1;this._view.allLayerViews.forEach(function(b){a=
a||b.updating});return a};b.prototype._unloadSuspended=function(){var a=this,b=function(){return 0===a._memoryCached?!1:a._memoryCommitted>1.1*a._memoryHWM||a._memoryUsed>a._memoryHWM||a._memoryUsed>=a._memoryLWM&&.9>a._quality};if(b())for(var e=this._view.allLayerViews.toArray().filter(function(a){return f.isMemoryManagedLayerView(a)&&(0<a.getCachedMemory()||a.suspended)}),c=function(){var a=null,b=-1;e.forEach(function(d){if(f.isMemoryManagedLayerView(d)){var c=d.getCachedMemory()+(d.suspended?
d.getUsedMemory():0);c>b&&(b=c,a=d)}});if(!a)return{value:void 0};a.removeCachedData();g._updateMemory()},g=this;b()&&0<e.length;){var d=c();if("object"===typeof d)return d.value}};b.prototype._updateMemory=function(){var a=0,b=0,e=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(a+=this._view.basemapTerrain.getUsedMemory());var c=this._view._stage&&this._view._stage.view&&this._view._stage.view.getEdgeView();c&&(a+=c.getGpuMemoryUsage());this._view.allLayerViews&&this._view.allLayerViews.forEach(function(d){if(f.isMemoryManagedLayerView(d)){var c=
d.getUsedMemory();d.suspended?e+=c:a+=c;b+=d.getUnloadedMemory();e+=d.getCachedMemory()}});if(a>this._maxMemory&&a!==this._warnMemoryUsage){this._warnMemoryUsage=a;var c=function(a){return a.toLocaleString(void 0,{maximumFractionDigits:1})+" Mb"},g=Math.round(100*this._quality);l.warn("GPU Memory Limit exceeded! Limit: "+c(this._maxMemory)+" Current: "+c(a)+" Projected: "+c(a+b)+" Quality: "+g+"%")}this._memoryUsed=(a+e)/this._maxMemory;this._memoryCommitted=(a+b)/this._maxMemory;this._memoryCached=
e/this._maxMemory};return b}()});