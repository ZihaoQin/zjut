// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","./tileUtils","./UpsampleInfo"],function(y,z,v,f){function p(a,b,h,d,e,k,l){if(!a.parent||6<l)return null;d*=.5;e*=.5;k*=.5;a.lij[2]&1&&(e+=.5);0===(a.lij[1]&1)&&(k+=.5);return a.parent.hasLayerData(b,h)?(b=f.Pool.acquire(),b.init(a.parent,e,k,d),b):p(a.parent,b,h,d,e,k,l+1)}var m=Error("Abstract method called on TileAgent");return function(){function a(){}a.prototype.init=function(b,a,d,e){this.tile=b;this.layerIdx=a;this.layerClass=d;this.suspended=e;this._tileLayerInfo=
b.getLayerInfo(a,d);this._dataRequested=null;(b=this._findAncestorWithData())?(this._setUpsamplingTile(b.tile),f.Pool.release(b)):(this._tileLayerInfo.upsampleFromTile&&f.Pool.release(this._tileLayerInfo.upsampleFromTile),this._tileLayerInfo.upsampleFromTile=null);return this._requestNext(!0)};a.prototype.dispose=function(){this._dataRequested&&(this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this),this._dataRequested=null);this._tileLayerInfo=this.tile=null};a.prototype.setSuspension=
function(b){b!==this.suspended&&((this.suspended=b)?this._dataRequested&&(this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this),this._dataRequested=null):this._tileLayerInfo.data||this.update())};a.prototype.update=function(){var b=this._findAncestorWithData();b&&this._tileLayerInfo.upsampleFromTile&&b.tile!==this._tileLayerInfo.upsampleFromTile.tile?this._setUpsamplingTile(b.tile):b&&f.Pool.release(b);return this._requestNext()};a.prototype.dataArrived=function(b){throw m;};
a.prototype.dataMissing=function(b){this._dataRequested=null;this._tileLayerInfo.disposeData();this._requestNext()};a.prototype._agentDone=function(){this.tile.agentDone(this.layerIdx,this.layerClass);this.dispose()};a.prototype._requestNext=function(b){void 0===b&&(b=!1);if(this.suspended)return!0;var a=this._findNextDownload();if(this._dataRequested){if(a===this._dataRequested)return!0;this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this);this._dataRequested=null}a?a.requestLayerData(this.layerIdx,
this.layerClass,this)&&(this._dataRequested=a):b||this._agentDone();return!!this._dataRequested};a.prototype._findNextDownload=function(){for(var b=this.layerIdx,h=this.layerClass,d=this.tile.parentSurface.layerViewByIndex(b,h),e=d.minDataLevel,k=d.maxDataLevel,l=this._desiredMinLevelDelta(),f=a.START_LOADING_LEVEL_DELTA+l,m=this._scaleRangeEnabled,g,c=this.tile,r=0,p=c.lij[0],w=this._tileLayerInfo.upsampleFromTile?this._tileLayerInfo.upsampleFromTile.tile.lij[0]:-1,t=this.tile.parentSurface,x=t.tilemapStats,
n=t.getTilemapTile(c),u=!1;c&&(!m||v.fallsWithinLayer(c,d.layer,!1))&&c.lij[0]>=e;){var q=c.layerInfo[h][b];if(q.data&&r>=l){c.lij[0]>w&&this._setUpsamplingTile(c);q.dataInvalidated&&(g=c);break}if(n&&!n.tileDataAvailable(c,b,h))u=!0;else if(c.lij[0]<=k&&!q.data&&!q.dataMissing&&(g=c,r>=f))break;(c=c.parent)&&n&&(n=n.parent||t.getTilemapTile(c));r++}g&&p-g.lij[0]<l&&this._tileLayerInfo.upsampleFromTile&&(g=null);!g&&u&&x.tilesNotPresent++;return g};a.prototype._findAncestorWithData=function(){return p(this.tile,
this.layerIdx,this.layerClass,1,0,0,0)};a.prototype._desiredMinLevelDelta=function(){throw m;};a.prototype._setUpsamplingTile=function(a){throw m;};a.prototype._unsetUpsamplingTile=function(){this._tileLayerInfo.upsampleFromTile&&f.Pool.release(this._tileLayerInfo.upsampleFromTile);this._tileLayerInfo.upsampleFromTile=null};a.START_LOADING_LEVEL_DELTA=4;a.AGENT_DONE=new a;return a}()});